<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<!-- PWA Meta -->
<meta name="application-name" content="GestorRenta">
<meta name="description" content="GestiÃ³n de rentas e inquilinos">
<meta name="theme-color" content="#24503e">
<meta name="background-color" content="#f5f0e8">

<!-- Apple / iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GestorRenta">
<link rel="apple-touch-icon" id="pwa-apple-icon" href="">

<!-- Android -->
<link rel="manifest" id="pwa-manifest" href="">

<!-- Splash color while loading -->
<meta name="msapplication-TileColor" content="#24503e">

<title>GestorRenta</title>
<!-- v2.6.1 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<noscript><link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"></noscript>
<style>
  :root {
    --bg: #f5f0e8;
    --surface: #fdfaf4;
    --surface2: #f0ead8;
    --border: #d9cfb8;
    --accent: #2d6a4f;
    --accent2: #1b4332;
    --accent-light: #e8f5e9;
    --danger: #c0392b;
    --danger-light: #fdf0ee;
    --success: #2d6a4f;
    --success-light: #e8f5e9;
    --warning: #b7791f;
    --warning-light: #fef9ec;
    --text: #2c2416;
    --text2: #5c4d3a;
    --text3: #9e8e76;
    --sidebar-bg: #24503e;
    --sidebar-text: #c8e0d4;
    --sidebar-text2: #7aaa92;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html {
    overflow-x: hidden;
    max-width: 100vw;
  }
  body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    max-width: 100vw;
  }

  /* Header */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    background: #fdfaf4;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    border-bottom: 1px solid #d9cfb8;
    box-sizing: border-box;
    overflow: visible;
  }
  /* Desktop: single row */
  .header-row1 {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 32px;
    gap: 16px;
  }
  /* Mobile stats row â€” hidden on desktop */
  .header-row2 { display: none; }
  .mobile-sync-badge { display: none; }
  .logo { font-family: 'DM Serif Display', Georgia, serif; font-size: 26px; color: #c8a85a; letter-spacing: -0.5px; }
  .logo span { color: var(--text3); font-style: italic; }
  .header { border-bottom: 1px solid var(--border); }
  .header-stats { display: flex; gap: 32px; }
  .hstat { text-align: right; }
  .hstat-val { font-family: 'DM Mono', monospace; font-size: 18px; font-weight: 600; color: var(--text); }
  .hstat-val.danger { color: var(--danger); }
  .hstat-val.success { color: var(--success); }
  .hstat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; font-weight: 500; }

  /* Layout */
  .layout { display: grid; grid-template-columns: 280px 1fr; flex: 1; overflow: hidden; padding-top: 51px; }
  .sidebar {
    border-right: 1px solid var(--border);
    background: #24503e;
    padding: 24px 16px;
    display: flex; flex-direction: column; gap: 2px;
    height: 100%;
    overflow-y: auto;
  }
  .nav-btn {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; border-radius: 8px;
    background: none; border: none; color: #a8c5b5;
    cursor: pointer; font-size: 14px; font-family: 'DM Sans', sans-serif;
    transition: all 0.15s; text-align: left; width: 100%;
  }
  .nav-btn:hover { background: rgba(255,255,255,0.08); color: #d4ede3; }
  .nav-btn.active { background: var(--accent); color: #fff; font-weight: 600; }
  .nav-icon { font-size: 16px; width: 20px; text-align: center; }
  .nav-section { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: #4a7a62; padding: 16px 14px 6px; }
  .main { padding: 32px; overflow-y: auto; overflow-x: hidden; background: var(--bg); height: 100%; max-width: 100%; box-sizing: border-box; contain: layout style; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
  /* Toast notifications */
  .toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: #1a3d2e; color: #fff; padding: 10px 20px; border-radius: 20px;
    font-size: 14px; font-weight: 500; z-index: 9999; opacity: 0;
    transition: all 0.3s ease; pointer-events: none; white-space: nowrap;
  }
  .dash-bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Tabs */
  .page { display: none; }
  .page.active { display: block; }

  /* Dashboard KPI cards */
  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    border-top: 3px solid transparent;
    overflow: hidden;
  }
  .kpi-card .kpi-inner-val {
    font-weight: 800;
    font-family: 'DM Mono', monospace;
    font-size: clamp(14px, 1.4vw, 18px);
    white-space: nowrap;
  }
  .kpi-card.green { border-top-color: var(--success); }
  .kpi-card.amber { border-top-color: var(--warning); }
  .kpi-card.red   { border-top-color: var(--danger); }
  .kpi-card.blue  { border-top-color: #2563eb; }
  .kpi-card.teal  { border-top-color: #0d9488; }
  .kpi-val { font-family: 'DM Mono', monospace; font-size: 26px; font-weight: 600; color: var(--text); line-height: 1.1; margin: 6px 0 4px; }
  .kpi-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text3); }
  .kpi-sub { font-size: 12px; color: var(--text3); margin-top: 4px; }
  .tipo-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .tipo-bar-wrap { flex: 1; background: var(--surface2); border-radius: 4px; height: 8px; overflow: hidden; }
  .tipo-bar { height: 100%; border-radius: 4px; background: var(--accent); transition: width 0.4s; }
  .tipo-name { font-size: 13px; color: var(--text2); width: 130px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tipo-count { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text3); width: 30px; text-align: right; flex-shrink: 0; }

  /* Cards grid */
  .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 24px; }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }
  .card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(37,99,235,0.12); }
  .card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 3px;
  }
  .card.al-dia::before { background: var(--success); }
  .card.atrasado::before { background: #8b0000; }
  .card.parcial::before { background: var(--warning); }
  .card.sin-rentar::before { background: #aaa; }
  .card.atrasado { border-color: rgba(139,0,0,0.25); background: #fffafa; }
  .card.sin-rentar { border-color: #ccc; background: #fafafa; }
  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .card-prop { font-family: 'DM Serif Display', serif; font-size: 18px; }
  .badge {
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    padding: 3px 8px; border-radius: 20px;
  }
  .badge.al-dia { background: var(--success-light); color: var(--success); border: 1px solid rgba(22,163,74,0.2); }
  .badge.atrasado { background: #fde8e8; color: #8b0000; border: 1px solid rgba(139,0,0,0.3); font-weight:700; }
  .badge.parcial { background: var(--warning-light); color: var(--warning); border: 1px solid rgba(217,119,6,0.2); }
  .badge.sin-rentar { background: #f0f0f0; color: #555; border: 1px solid #ccc; }
  .ayuda-quick-card:hover { border-color: var(--accent) !important; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .ayuda-section-header:hover { background: var(--surface2); }
  .card-client { color: var(--text2); font-size: 13px; margin-bottom: 16px; }
  .card-amounts { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .amt-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; }
  .amt-val { font-family: 'DM Mono', monospace; font-size: 15px; font-weight: 500; }
  .amt-val.danger { color: var(--danger); }
  .amt-val.success { color: var(--success); }
  .amt-label { font-size: 10px; color: var(--text3); margin-top: 2px; }

  /* Page title */
  .page-title { font-family: 'DM Serif Display', serif; font-size: 30px; margin-bottom: 4px; color: var(--text); }
  .page-sub { color: var(--text3); font-size: 14px; }

  /* Buttons */
  .btn {
    padding: 10px 20px; border-radius: 8px; border: none;
    cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500;
    transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-ghost { background: var(--surface); color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
  .btn-danger { background: var(--danger-light); color: var(--danger); border: 1px solid rgba(220,38,38,0.2); }
  .btn-danger:hover { background: #fee2e2; }
  .btn-success { background: var(--success-light); color: var(--success); border: 1px solid rgba(22,163,74,0.2); }
  .btn-success:hover { background: #dcfce7; }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center;
    z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    width: 560px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.95);
    transition: transform 0.2s;
    will-change: transform;
  }
  .modal-overlay.open .modal { transform: scale(1); }
  .modal-title { font-family: 'DM Serif Display', serif; font-size: 24px; margin-bottom: 24px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }
  label { font-size: 12px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
  input, select, textarea {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: 8px; padding: 10px 12px;
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px;
    transition: border-color 0.15s, box-shadow 0.15s; width: 100%;
    -webkit-appearance: none;
  }
  input:focus, select:focus, textarea:focus {
    outline: none; border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }
  textarea { resize: vertical; min-height: 80px; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

  /* Detail view */
  .detail-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 32px; }
  .detail-title { font-family: 'DM Serif Display', serif; font-size: 36px; }
  .detail-actions { display: flex; gap: 10px; }
  .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-bottom: 32px; }
  .info-box { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
  .info-val { font-family: 'DM Mono', monospace; font-size: 20px; font-weight: 500; }
  .info-val.big { font-size: 26px; }
  .info-val.danger { color: var(--danger); }
  .info-val.success { color: var(--success); }
  .info-val.warning { color: var(--warning); }
  .info-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

  .section-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text3); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; padding-top: 4px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* Payments table */
  .payments-table { width: 100%; border-collapse: collapse; }
  .payments-table th {
    text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text3); padding: 10px 14px; border-bottom: 2px solid var(--border); background: var(--surface2);
  }
  .payments-table td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text); }
  .payments-table tr:last-child td { border-bottom: none; }
  .payments-table tr:hover td { background: var(--accent-light); }
  .mono { font-family: 'DM Mono', monospace; }

  /* Alerts */
  .alert-list { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
  .alert-item {
    display: flex; align-items: center; gap: 16px;
    flex-wrap: wrap;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px 20px;
    cursor: pointer; transition: all 0.15s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .alert-item:hover { border-color: var(--danger); box-shadow: 0 2px 8px rgba(220,38,38,0.1); }
  .alert-item.warning { border-left: 4px solid var(--warning); background: var(--warning-light); }
  .alert-item.danger { border-left: 4px solid var(--danger); background: var(--danger-light); }
  .alert-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .alert-dot.danger { background: var(--danger); }
  .alert-dot.warning { background: var(--warning); animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }
  .alert-info { flex: 1; }
  .alert-name { font-weight: 500; }
  .alert-detail { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .alert-amount { font-family: 'DM Mono', monospace; font-weight: 500; }
  .alert-amount.danger { color: var(--danger); }
  .alert-amount.warning { color: var(--warning); }

  /* Alert follow-up styles */
  .alert-item.seguimiento { border-left: 4px solid #f59e0b; background: #fffbeb; }
  .alert-item.seguimiento:hover { border-color: #d97706; box-shadow: 0 2px 8px rgba(245,158,11,0.15); }
  .alert-dot.seguimiento { background: #f59e0b; animation: pulse 2s infinite; }
  .alert-actions { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
  .alert-action-btn {
    font-size: 11px; padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border);
    background: var(--surface2); cursor: pointer; display: inline-flex; align-items: center; gap: 4px;
    transition: all .15s;
  }
  .alert-action-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
  .alert-action-btn.active { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
  .alert-nota-preview {
    margin-top: 6px; font-size: 11px; color: #92400e; background: #fef3c7;
    padding: 4px 8px; border-radius: 5px; line-height: 1.4; display: flex; align-items: flex-start; gap: 4px;
  }
  .alert-fecha-badge {
    display: inline-flex; align-items: center; gap: 3px; font-size: 10px; font-weight: 600;
    padding: 2px 8px; border-radius: 10px; background: #fef3c7; color: #92400e;
  }
  .alert-fecha-badge.vencida { background: #fee2e2; color: #991b1b; }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--text3); background: var(--surface2); border-radius: 12px; border: 1px dashed var(--border); margin-top: 16px; }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-title { font-size: 18px; color: var(--text2); margin-bottom: 6px; }

  .top-bar { display: flex; justify-content: space-between; align-items: center; }
  .filter-bar { display: flex; gap: 8px; margin-top: 16px; }
  .filter-chip {
    padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer;
    border: 1.5px solid var(--border); background: var(--surface); color: var(--text2);
    transition: all 0.15s; font-family: 'DM Sans', sans-serif; font-weight: 500;
  }
  .filter-chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
  .filter-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; }

  .progress-bar { background: var(--surface2); border-radius: 4px; height: 6px; margin-top: 10px; overflow: hidden; }
  .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }

  .tag { 
    display: inline-block; font-size: 10px; padding: 2px 8px;
    border-radius: 4px; background: var(--surface2); color: var(--text2); border: 1px solid var(--border);
    margin-right: 4px; font-weight: 500;
  }

  select option { background: var(--surface); color: var(--text); }

  .del-pay-btn {
    background: none; border: none; color: var(--text3); cursor: pointer;
    font-size: 14px; transition: color 0.15s; padding: 4px;
  }
  .del-pay-btn:hover { color: var(--danger); }

  /* Detail tabs */
  .detail-tabs { display: flex; gap: 0; margin-bottom: 28px; border-bottom: 2px solid var(--border); padding-bottom: 0; background: var(--surface); border-radius: 8px 8px 0 0; padding: 4px 4px 0; }
  .detail-tab {
    padding: 10px 20px; background: none; border: none; color: var(--text3);
    cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500;
    border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; border-radius: 6px 6px 0 0;
  }
  .detail-tab:hover { color: var(--text); background: var(--surface2); }
  .detail-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; background: var(--accent-light); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* Servicios */
  .servicio-row {
    display: flex; align-items: center; gap: 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px; margin-bottom: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .servicio-icon { font-size: 24px; width: 40px; text-align: center; flex-shrink: 0; }
  .servicio-info { flex: 1; }
  .servicio-name { font-weight: 500; font-size: 14px; }
  .servicio-num { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--text2); margin-top: 2px; }
  .servicio-actions { display: flex; gap: 6px; }

  /* Media gallery */
  .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-top: 16px; }
  .media-item {
    border-radius: 10px; overflow: hidden; position: relative;
    background: var(--surface2); border: 1px solid var(--border);
    aspect-ratio: 4/3; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .media-item img { width: 100%; height: 100%; object-fit: cover; }
  .media-item .media-overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.5);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.2s;
  }
  .media-item:hover .media-overlay { opacity: 1; }
  .media-item .media-del {
    position: absolute; top: 6px; right: 6px;
    background: rgba(0,0,0,0.7); border: none; color: #fff;
    width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
    font-size: 11px; display: flex; align-items: center; justify-content: center;
  }
  .doc-item {
    display: flex; align-items: center; gap: 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 16px; margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .doc-icon { font-size: 24px; flex-shrink: 0; }
  .doc-info { flex: 1; min-width: 0; }
  .doc-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .doc-size { font-size: 11px; color: var(--text3); margin-top: 2px; }
  .upload-zone {
    border: 2px dashed var(--border); border-radius: 12px;
    padding: 32px; text-align: center; cursor: pointer;
    transition: all 0.2s; color: var(--text3); background: var(--surface2);
  }
  .upload-zone:hover, .upload-zone.drag { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
  .upload-zone-icon { font-size: 32px; margin-bottom: 8px; }
  .upload-zone-text { font-size: 14px; }
  .upload-zone-sub { font-size: 12px; margin-top: 4px; opacity: 0.7; }

  /* Lightbox */
  .lightbox {
    position: fixed; inset: 0; background: rgba(0,0,0,0.92);
    display: flex; align-items: center; justify-content: center;
    z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .lightbox.open { opacity: 1; pointer-events: all; }
  .lightbox img { max-width: 90vw; max-height: 90vh; border-radius: 8px; object-fit: contain; }
  .lightbox-close {
    position: absolute; top: 20px; right: 24px;
    background: none; border: none; color: #fff; font-size: 28px; cursor: pointer;
  }

  /* Predial */
  .predial-box {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px; margin-bottom: 12px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESPONSIVE / MOBILE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* Bottom nav bar for mobile */
  .mobile-nav {
    display: none;
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #24503e;
    border-top: 1px solid rgba(255,255,255,0.1);
    z-index: 200;
    padding: 6px 0 env(safe-area-inset-bottom, 6px);
  }
  .mobile-nav-inner {
    display: flex; justify-content: space-around; align-items: center;
  }
  .mobile-nav-btn {
    display: flex; flex-direction: column; align-items: center; gap: 2px;
    background: none; border: none; color: #9ac4ad;
    cursor: pointer; padding: 6px 12px; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 10px;
    transition: all 0.15s; position: relative; min-width: 56px;
  }
  .mobile-nav-btn .mnav-icon { font-size: 20px; line-height: 1; }
  .mobile-nav-btn .mnav-label { font-size: 10px; font-weight: 500; }
  .mobile-nav-btn.active { color: #fff; }
  .mobile-nav-btn.active .mnav-icon { transform: scale(1.15); }
  .mobile-nav-badge {
    position: absolute; top: 4px; right: 10px;
    background: var(--danger); color: #fff;
    font-size: 9px; font-weight: 700;
    border-radius: 8px; padding: 1px 4px; min-width: 14px; text-align: center;
  }

  /* Mobile header: compact */
  /* â”€â”€ Responsive grid utilities â”€â”€ */
  .g2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .g3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }

  @media (max-width: 768px) {
    /* â”€â”€ HEADER MOBILE â”€â”€ */
    .header { position: fixed !important; top: 0 !important; }
    .header-row1 { padding: 8px 14px 6px; gap: 10px; }
    .logo { font-size: 15px; }
    .header-stats { display: none !important; }
    /* Fila 2 con stats en mÃ³vil */
    .header-row2 {
      display: flex !important;
      align-items: center;
      padding: 5px 16px 8px;
      border-top: 1px solid rgba(0,0,0,0.07);
      gap: 0;
    }
    .m-hstat { text-align: center; flex: 1; }
    .m-hstat-val { font-size: 14px; font-weight: 700; line-height: 1.2; color: var(--text); }
    .m-hstat-val.danger { color: var(--danger); }
    .m-hstat-val.success { color: var(--success); }
    .m-hstat-label { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px; }
    .m-hstat-sep { width: 1px; background: var(--border); align-self: stretch; margin: 3px 0; flex-shrink: 0; }

    /* Dashboard 2-col grid â†’ stack on mobile */
    .dash-bottom-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
    /* Hide desktop sidebar, show bottom nav */
    .sidebar { display: none !important; }
    .mobile-nav { display: block; }
    .layout { grid-template-columns: 1fr; padding-top: 0; }

    /* Main padding + bottom nav clearance (extra for iPhone safe area) */
    .main { padding: 92px 14px calc(100px + env(safe-area-inset-bottom, 20px)); }

    /* Page title */
    .page-title { font-size: 22px; }
    .page-sub { font-size: 12px; }
    .top-bar { flex-direction: column; align-items: flex-start; gap: 10px; margin-bottom: 16px; }
    .top-bar > div:last-child { width: 100%; }
    .top-bar > div:last-child > div { width: 100%; justify-content: stretch; }
    .top-bar button { width: 100%; justify-content: center; }

    /* Cards: single column */
    .cards-grid { grid-template-columns: 1fr; gap: 12px; margin-top: 14px; }

    /* KPI grid: 2 cols */
    #dash-kpis { grid-template-columns: 1fr 1fr !important; gap: 10px !important; }
    #dash-kpis .kpi-card:first-child { grid-column: 1 / -1; }
    .kpi-val { font-size: 18px !important; }
    .kpi-label { font-size: 10px !important; }
    .kpi-sub { font-size: 11px !important; }

    /* Dashboard tipo/estado: stack vertically */
    #page-dashboard > div:nth-child(3) { grid-template-columns: 1fr !important; gap: 12px !important; }

    /* Filter bar: scrollable row */
    .filter-bar { overflow-x: auto; white-space: nowrap; padding-bottom: 4px; -webkit-overflow-scrolling: touch; gap: 6px; }
    .filter-chip { flex-shrink: 0; }
    .search-bar { max-width: none; }

    /* Info grid: 2 cols */
    .info-grid { grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .info-val.big { font-size: 20px; }
    .info-val { font-size: 16px; }

    /* Detail header: stack */
    .detail-header { flex-direction: column; gap: 14px; margin-bottom: 20px; }
    .detail-title { font-size: 24px; }
    .detail-actions { flex-wrap: wrap; gap: 8px; }
    .detail-actions .btn { font-size: 13px; padding: 8px 14px; }

    /* Detail tabs: scrollable */
    .detail-tabs { overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; padding: 4px 4px 0; }
    .detail-tab { flex-shrink: 0; padding: 8px 14px; font-size: 12px; }

    /* Modals: full width bottom sheet */
    .modal-overlay { align-items: flex-end; }
    .modal {
      width: 100% !important; max-width: 100% !important;
      border-radius: 20px 20px 0 0 !important;
      max-height: 92vh;
      padding: 24px 20px 32px;
    }
    .form-grid { grid-template-columns: 1fr !important; }
    .form-group.full { grid-column: 1 !important; }

    /* Payments table: horizontal scroll */
    .payments-table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }

    /* Alert items */
    .alert-item { padding: 12px 14px; gap: 10px; flex-wrap: wrap; }
    .alert-name { font-size: 14px; }
    .alert-amount { font-size: 15px !important; }
    .alert-actions { padding-left: 0 !important; }
    .alert-fecha-badge { margin-top: 3px; display: inline-flex; }

    /* Import modal */
    #modalImport .modal { padding: 20px 16px 28px; }

    /* Servicio row */
    .servicio-row { flex-wrap: wrap; }
    .servicio-actions { width: 100%; display: flex; justify-content: flex-end; margin-top: 4px; }

    /* â”€â”€ UNIVERSAL MOBILE OVERFLOW PREVENTION â”€â”€ */
    /* Responsive grid classes */
    .g2 { grid-template-columns: 1fr !important; }
    .g3 { grid-template-columns: 1fr 1fr !important; gap: 6px !important; }

    /* Action buttons: wrapping & compact */
    .detail-actions { gap: 6px !important; }
    .detail-actions .btn { flex: 1 1 auto; min-width: 0; font-size: 12px !important; padding: 7px 10px !important; text-align: center; }

    /* Tables: horizontal scroll & smaller text */
    .payments-table th { padding: 8px 6px; font-size: 10px; }
    .payments-table td { padding: 8px 6px; font-size: 12px; }

    /* Top bar */
    .top-bar { flex-wrap: wrap; gap: 8px; }
    .top-bar .btn { font-size: 12px; padding: 7px 10px; }

    /* Flex containers: force wrapping */
    .config-section div[style*="display:flex"] { flex-wrap: wrap; }
  }

  /* Medium screens â€” KPIs still need room */
  @media (min-width: 769px) and (max-width: 1100px) {
    #dash-kpis { grid-template-columns: repeat(3, 1fr) !important; gap: 10px !important; }
    .kpi-card .kpi-inner-val { font-size: clamp(13px, 1.6vw, 17px) !important; }
    .kpi-card { padding: 14px 12px; }
  }
  @media (min-width: 1101px) {
    .kpi-card .kpi-inner-val { font-size: 18px !important; }
  }

  @media (max-width: 400px) {
    #dash-kpis { grid-template-columns: 1fr !important; }
    .header-stats { gap: 6px; }
    .hstat:nth-child(3) { display: none; }
    .hstat-val { font-size: 11px; }
    .g3 { grid-template-columns: 1fr !important; }
    .g2 { grid-template-columns: 1fr !important; }
    .info-grid { grid-template-columns: 1fr !important; }
  }

  /* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .login-screen {
    position: fixed; inset: 0; z-index: 9999;
    background: linear-gradient(135deg, #24503e 0%, #152e22 100%);
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }
  .login-box {
    background: #fdfaf4; border-radius: 20px;
    padding: 40px 36px; width: 100%; max-width: 380px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.4);
    text-align: center;
  }
  .login-logo { font-family: 'DM Serif Display', Georgia, serif; font-size: 32px; color: #c8a85a; margin-bottom: 4px; }
  .login-sub { font-size: 13px; color: var(--text3); margin-bottom: 32px; }
  .login-box input {
    width: 100%; padding: 12px 14px; border-radius: 10px;
    border: 1.5px solid var(--border); background: var(--surface2);
    font-size: 15px; margin-bottom: 12px; color: var(--text);
    font-family: inherit;
  }
  .login-box input:focus { outline: none; border-color: var(--accent); }
  .login-btn {
    width: 100%; padding: 13px; background: #2d6a4f; color: #fff;
    border: none; border-radius: 10px; font-size: 16px; font-weight: 600;
    cursor: pointer; font-family: inherit; transition: background 0.2s;
    margin-top: 4px;
  }
  .login-btn:hover { background: #1e4d39; }
  .login-error { color: var(--danger); font-size: 13px; margin-top: 8px; min-height: 18px; }

  /* â”€â”€â”€ USER PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .user-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--accent); color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; cursor: pointer;
    flex-shrink: 0; border: 2px solid transparent;
    transition: border-color 0.15s;
  }
  .user-avatar:hover { border-color: rgba(255,255,255,0.4); }
  .user-dropdown {
    position: absolute; top: calc(100% + 8px); right: 0;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; min-width: 200px; z-index: 300;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15); overflow: hidden;
    opacity: 0; pointer-events: none; transform: translateY(-6px);
    transition: all 0.18s;
  }
  .user-dropdown.open { opacity: 1; pointer-events: all; transform: translateY(0); }
  .user-dropdown-item {
    padding: 11px 16px; font-size: 13px; cursor: pointer;
    display: flex; align-items: center; gap: 8px; color: var(--text2);
    transition: background 0.12s;
  }
  .user-dropdown-item:hover { background: var(--surface2); color: var(--text); }
  .user-dropdown-item.danger { color: var(--danger); }
  .user-dropdown-sep { border: none; border-top: 1px solid var(--border); margin: 4px 0; }

  /* â”€â”€â”€ USERS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .perm-toggle {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 0; border-bottom: 1px solid var(--border);
  }
  .perm-toggle:last-child { border-bottom: none; }
  .perm-name { font-size: 14px; color: var(--text); }
  .perm-desc { font-size: 11px; color: var(--text3); margin-top: 1px; }
  .toggle-switch { position: relative; width: 42px; height: 24px; flex-shrink: 0; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-track {
    position: absolute; inset: 0; border-radius: 12px;
    background: var(--border); cursor: pointer; transition: background 0.2s;
  }
  .toggle-track::after {
    content: ''; position: absolute; width: 18px; height: 18px;
    border-radius: 50%; background: #fff; top: 3px; left: 3px;
    transition: transform 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .toggle-switch input:checked + .toggle-track { background: var(--accent); }
  .toggle-switch input:checked + .toggle-track::after { transform: translateX(18px); }
  .user-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px; margin-bottom: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }
  .user-card-top {
    display: flex; align-items: center; gap: 12px; margin-bottom: 10px;
  }
  .user-card-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    background: var(--accent); color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px; font-weight: 700; flex-shrink: 0;
  }
  .user-card-info { flex: 1; min-width: 0; }
  .user-card-name { font-weight: 700; font-size: 15px; }
  .user-card-role { font-size: 11px; color: var(--text3); margin-top: 1px; }
  .user-card-perms { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
  .perm-chip {
    font-size: 10px; padding: 5px 8px; border-radius: 8px;
    background: var(--accent-light); color: var(--accent);
    border: 1px solid rgba(45,106,79,0.15); font-weight: 500;
    text-align: center;
  }
  .user-card-actions { display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
  .user-card-tipos { font-size: 11px; color: var(--text3); margin-top: 8px; padding: 6px 10px; background: var(--surface2); border-radius: 8px; }
  /* â”€â”€â”€ RECOVERY CODE DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .recovery-code-box {
    background: #24503e; color: #a8ffcc;
    font-family: 'DM Mono', monospace; font-size: 28px;
    font-weight: 700; letter-spacing: 6px; text-align: center;
    padding: 20px; border-radius: 12px; margin: 16px 0;
    border: 2px dashed #2d6a4f; user-select: all; cursor: pointer;
  }
  .recovery-code-box:active { background: #0f2318; }
  .recovery-warning {
    background: var(--warning-light); border: 1px solid rgba(183,121,31,0.3);
    border-radius: 8px; padding: 12px 14px; font-size: 13px;
    color: var(--warning); margin-top: 8px; line-height: 1.5;
  }
  .login-link {
    background: none; border: none; color: var(--accent);
    font-size: 13px; cursor: pointer; text-decoration: underline;
    font-family: inherit; margin-top: 10px; display: block; width: 100%;
    text-align: center; padding: 4px;
  }
  .login-link:hover { color: var(--accent2); }
  /* â”€â”€â”€ SEGMENT HEADERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .segment-header {
    display: flex; align-items: center; flex-wrap: wrap; gap: 8px;
    margin: 28px 0 12px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--border);
  }
  .segment-header:first-child { margin-top: 0; }
  .segment-title {
    display: flex; align-items: center; gap: 10px;
    font-family: 'DM Serif Display', Georgia, serif;
    font-size: 20px; color: var(--text);
    flex-shrink: 0;
  }
  .segment-icon {
    width: 36px; height: 36px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; flex-shrink: 0;
  }
  .segment-meta {
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; color: var(--text3);
    margin-left: auto;
    flex-wrap: wrap;
    justify-content: flex-end;
  }
  .segment-count {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 2px 10px;
    font-weight: 600; color: var(--text2); font-size: 12px;
    white-space: nowrap;
  }
  .segment-sum {
    font-family: 'DM Mono', monospace; font-weight: 600;
    color: var(--success); font-size: 13px;
    white-space: nowrap;
  }

  /* â”€â”€â”€ VIEW TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .view-toggle {
    display: flex; gap: 4px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px; padding: 3px;
  }
  .view-btn {
    padding: 5px 10px; border-radius: 6px; border: none;
    background: none; cursor: pointer; font-size: 14px;
    color: var(--text3); transition: all 0.15s;
  }
  .view-btn.active { background: var(--surface); color: var(--accent); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

  /* â”€â”€â”€ LIST VIEW CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .list-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 16px;
    display: flex; align-items: center; gap: 14px;
    cursor: pointer; transition: all 0.15s; margin-bottom: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .list-card:hover { border-color: var(--accent); background: var(--accent-light); }
  .list-card-left { flex: 1; min-width: 0; overflow: hidden; }
  .list-card-name {
    font-weight: 600; font-size: 14px; color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .list-card-sub { font-size: 12px; color: var(--text3); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .list-card-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  .list-amount {
    font-family: 'DM Mono', monospace; font-size: 14px;
    font-weight: 600; text-align: right;
  }
  .list-amount-sub { font-size: 10px; color: var(--text3); text-align: right; }

  /* â”€â”€â”€ SEARCH BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .search-bar {
    position: relative; flex: 1; max-width: 300px;
  }
  .search-bar input {
    padding-left: 32px; font-size: 13px; height: 36px;
    border-radius: 8px; width: 100%;
  }
  .search-bar::before {
    content: 'ğŸ”'; position: absolute; left: 10px; top: 50%;
    transform: translateY(-50%); font-size: 13px; pointer-events: none;
    z-index: 1;
  }
  /* â”€â”€â”€ CONFIG PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .config-section {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 22px; margin-bottom: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }
  .config-section-title {
    font-size: 13px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.8px; color: var(--text3); margin-bottom: 14px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .config-tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
  .config-tag {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 5px 12px; font-size: 13px; color: var(--text2);
  }
  .config-tag .tag-del {
    background: none; border: none; color: var(--text3); cursor: pointer;
    font-size: 14px; line-height: 1; padding: 0 0 0 2px;
    transition: color 0.1s;
  }
  .config-tag .tag-del:hover { color: var(--danger); }
  .config-add-row {
    display: flex; gap: 8px; margin-top: 12px;
  }
  .config-add-row input {
    flex: 1; font-size: 13px; padding: 8px 12px;
  }
  .config-add-row button { flex-shrink: 0; }

  /* â”€â”€â”€ GASTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gasto-row {
    display: flex; align-items: center; gap: 12px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 16px; margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .gasto-icon { font-size: 22px; width: 36px; text-align: center; flex-shrink: 0; }
  .gasto-info { flex: 1; min-width: 0; }
  .gasto-nombre { font-weight: 600; font-size: 14px; }
  .gasto-meta { font-size: 12px; color: var(--text3); margin-top: 2px; }
  .gasto-monto { font-family: 'DM Mono',monospace; font-weight: 700; font-size: 15px; color: var(--danger); flex-shrink: 0; }
  /* â”€â”€â”€ MODAL TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal-tabs {
    display: flex; border-bottom: 2px solid var(--border);
    margin: -4px -4px 20px; padding: 0 4px;
    gap: 0;
  }
  .modal-tab {
    padding: 10px 18px; font-size: 13px; font-weight: 500;
    border: none; background: none; cursor: pointer;
    color: var(--text3); border-bottom: 2px solid transparent;
    margin-bottom: -2px; transition: all 0.15s; font-family: inherit;
  }
  .modal-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }
  .modal-tab:hover:not(.active) { color: var(--text); }
  .modal-tab-panel { display: none; }
  .modal-tab-panel.active { display: block; }

  /* â”€â”€â”€ CONTRACT VIEWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .contract-area {
    width: 100%; min-height: 280px; max-height: 440px;
    font-size: 13px; line-height: 1.7; padding: 14px;
    border: 1.5px solid var(--border); border-radius: 10px;
    resize: vertical; font-family: inherit;
    background: var(--surface); color: var(--text);
    box-sizing: border-box;
  }
  .contract-area:focus { outline: none; border-color: var(--accent); }
  .contract-viewer {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 18px 20px;
    font-size: 13px; line-height: 1.8; color: var(--text2);
    white-space: pre-wrap; max-height: 500px; overflow-y: auto;
    font-family: inherit;
  }
  .contract-badge {
    display: inline-flex; align-items: center; gap: 5px;
    background: #e8f4fd; color: #1d6fa4; border: 1px solid rgba(29,111,164,0.2);
    border-radius: 20px; padding: 3px 10px; font-size: 11px; font-weight: 600;
  }
  /* â”€â”€â”€ PWA INSTALL BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #pwa-banner {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999;
    background: var(--accent2); color: #fff;
    padding: 14px 20px; display: none;
    align-items: center; gap: 12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.25);
    font-family: 'DM Sans', sans-serif;
    padding-bottom: max(14px, env(safe-area-inset-bottom));
  }
  #pwa-banner.show { display: flex; }
  #pwa-banner-icon { font-size: 30px; flex-shrink: 0; }
  #pwa-banner-text { flex: 1; }
  #pwa-banner-text strong { display: block; font-size: 14px; margin-bottom: 2px; }
  #pwa-banner-text span { font-size: 12px; opacity: 0.8; }
  #pwa-banner-install {
    background: #fff; color: var(--accent2); border: none;
    padding: 9px 18px; border-radius: 8px; font-weight: 700;
    font-size: 13px; cursor: pointer; white-space: nowrap;
    font-family: inherit; flex-shrink: 0;
  }
  #pwa-banner-close {
    background: none; border: none; color: rgba(255,255,255,0.7);
    font-size: 20px; cursor: pointer; padding: 4px; flex-shrink: 0;
  }

  /* â”€â”€â”€ iOS INSTALL INSTRUCTIONS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #ios-install-modal {
    position: fixed; inset: 0; z-index: 10000;
    background: rgba(0,0,0,0.6); display: none;
    align-items: flex-end; justify-content: center;
    padding: 0 12px 12px;
  }
  #ios-install-modal.show { display: flex; }
  #ios-install-box {
    background: var(--surface); border-radius: 20px;
    padding: 28px 24px 32px; max-width: 420px; width: 100%;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
    position: relative;
  }
  #ios-install-box h3 { margin: 0 0 6px; font-size: 18px; color: var(--text); }
  #ios-install-box p { margin: 0 0 20px; font-size: 14px; color: var(--text2); line-height: 1.5; }
  .ios-step {
    display: flex; align-items: flex-start; gap: 12px;
    margin-bottom: 16px;
  }
  .ios-step-num {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--accent); color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; flex-shrink: 0; margin-top: 1px;
  }
  .ios-step-text { font-size: 14px; color: var(--text2); line-height: 1.5; }
  .ios-step-text strong { color: var(--text); }
  #ios-install-close {
    position: absolute; top: 16px; right: 18px;
    background: var(--surface2); border: none; border-radius: 50%;
    width: 30px; height: 30px; font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .ios-arrow {
    text-align: center; font-size: 28px; margin-top: 8px;
    animation: bounce 1.2s ease infinite;
  }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(6px)} }
  /* â”€â”€â”€ NOTIF BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notif-dot {
    position:absolute; top:4px; right:4px; width:8px; height:8px;
    border-radius:50%; background:var(--danger); display:none;
  }
  .notif-dot.show { display:block; }

  /* â”€â”€â”€ ALERTAS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notif-panel {
    position:fixed; top:0; right:0; bottom:0; width:360px; max-width:100vw;
    background:var(--surface); border-left:1px solid var(--border);
    box-shadow:-8px 0 32px rgba(0,0,0,0.15); z-index:1200;
    display:flex; flex-direction:column; transform:translateX(100%);
    transition:transform 0.3s cubic-bezier(.4,0,.2,1);
  }
  .notif-panel.open { transform:translateX(0); }
  .notif-panel-header {
    padding:20px; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
  }
  .notif-panel-title { font-weight:700; font-size:16px; }
  .notif-panel-body { flex:1; overflow-y:auto; padding:16px; }
  .notif-item {
    border-radius:10px; padding:12px 14px; margin-bottom:10px;
    border:1px solid var(--border); background:var(--surface);
  }
  .notif-item.danger { border-color:rgba(192,57,43,.3); background:#fffafa; }
  .notif-item.warning { border-color:rgba(217,119,6,.3); background:#fffdf5; }
  .notif-item.info { border-color:rgba(29,111,164,.2); background:#f0f7ff; }
  .notif-item-title { font-weight:600; font-size:13px; margin-bottom:3px; }
  .notif-item-sub { font-size:12px; color:var(--text3); }
  .notif-overlay { position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:1199;display:none; }
  .notif-overlay.open { display:block; }

  /* â”€â”€â”€ INCREMENTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .inc-badge {
    display:inline-flex; align-items:center; gap:4px;
    background:#fff8e1; color:#b7791f; border:1px solid #f6c84b;
    border-radius:20px; padding:2px 10px; font-size:11px; font-weight:600;
  }

  /* â”€â”€â”€ ESTADO DE RESULTADOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .er-table { width:100%; border-collapse:collapse; font-size:13px; }
  .er-table th {
    text-align:left; padding:8px 10px; font-size:10px;
    text-transform:uppercase; letter-spacing:.6px; color:var(--text3);
    border-bottom:2px solid var(--border);
  }
  .er-table td { padding:9px 10px; border-bottom:1px solid var(--border); }
  .er-table tr:last-child td { border-bottom:none; }
  .er-table .total-row td {
    border-top:2px solid var(--border); font-weight:700;
    font-size:14px; padding-top:12px;
  }
  .er-table .mono { font-family:'DM Mono',monospace; }
  .er-month-selector {
    display:flex; align-items:center; gap:8px; margin-bottom:20px;
  }
  .er-month-selector select { font-size:14px; padding:8px 12px; }

  /* â”€â”€â”€ FOTO INQUILINO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .foto-avatar {
    width:72px; height:72px; border-radius:50%;
    object-fit:cover; border:2px solid var(--border);
  }
  .foto-placeholder {
    width:72px; height:72px; border-radius:50%;
    background:var(--surface2); border:2px dashed var(--border);
    display:flex; align-items:center; justify-content:center;
    font-size:28px; cursor:pointer; flex-shrink:0;
  }
  /* â”€â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .dash-chart-wrap {
    background:var(--surface); border:1px solid var(--border);
    border-radius:12px; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,.04);
  }
  .dash-chart-title {
    font-size:11px; font-weight:700; text-transform:uppercase;
    letter-spacing:1px; color:var(--text3); margin-bottom:14px;
  }
  .bar-chart-wrap { display:flex; align-items:flex-end; gap:4px; height:120px; }
  .bar-col { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; min-width:0; }
  .bar-seg-wrap { flex:1; width:100%; display:flex; flex-direction:column; justify-content:flex-end; gap:1px; }
  .bar-seg {
    width:100%; border-radius:3px 3px 0 0; min-height:2px;
    transition:height .4s ease;
  }
  .bar-label { font-size:9px; color:var(--text3); white-space:nowrap; margin-top:2px; }
  .bar-val { font-size:8px; color:var(--text3); font-family:'DM Mono',monospace; }

  /* â”€â”€â”€ INVENTARIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .inv-row {
    display:grid; grid-template-columns:1fr 60px 80px 120px auto;
    gap:8px; align-items:center; padding:9px 12px;
    border-bottom:1px solid var(--border); font-size:13px;
  }
  .inv-row:last-child { border-bottom:none; }
  .inv-row.header {
    font-size:10px; font-weight:700; text-transform:uppercase;
    letter-spacing:.6px; color:var(--text3); padding-bottom:6px;
    border-bottom:2px solid var(--border);
  }
  .inv-estado {
    display:inline-flex; align-items:center; gap:4px;
    border-radius:12px; padding:2px 8px; font-size:11px; font-weight:600;
  }
  .inv-estado.bueno  { background:#e8f5e9; color:#2d6a4f; }
  .inv-estado.regular{ background:#fff8e1; color:#b7791f; }
  .inv-estado.malo   { background:#fef2f2; color:#8b0000; }
  @media(max-width:600px){
    .inv-row { grid-template-columns:1fr auto auto; }
    .inv-row .inv-cant, .inv-row .inv-val { display:none; }
  }
  /* â”€â”€â”€ BANNER RECUPERACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .recovery-banner {
    background: linear-gradient(135deg, #1b3a2d 0%, #2d6a4f 100%);
    color: #fff; border-radius: 16px; padding: 28px 32px;
    margin-bottom: 24px; display: flex; align-items: center;
    gap: 24px; flex-wrap: wrap;
  }
  .recovery-banner-icon { font-size: 52px; flex-shrink: 0; }
  .recovery-banner-text { flex: 1; min-width: 200px; }
  .recovery-banner-text h2 { font-size: 20px; margin-bottom: 6px; }
  .recovery-banner-text p  { font-size: 13px; opacity: .85; line-height: 1.6; margin: 0; }
  .recovery-banner-actions { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
  .btn-import-big {
    background: #fff; color: #1b3a2d; border: none;
    border-radius: 10px; padding: 12px 20px; font-weight: 700;
    font-size: 14px; cursor: pointer; white-space: nowrap;
    font-family: inherit; display: flex; align-items: center; gap: 8px;
  }
  .btn-import-big:hover { background: #f5f0e8; }
  .btn-skip { background: rgba(255,255,255,.15); color:#fff; border: 1px solid rgba(255,255,255,.3); border-radius:10px; padding:10px 18px; font-size:13px; cursor:pointer; font-family:inherit; }
  .btn-skip:hover { background: rgba(255,255,255,.25); }

  /* â”€â”€â”€ AUTOSAVE INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #autosave-indicator {
    position: fixed; bottom: 70px; right: 16px; z-index: 900;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 6px 14px; font-size: 12px;
    color: var(--text3); box-shadow: 0 2px 8px rgba(0,0,0,.1);
    display: none; align-items: center; gap: 6px;
    transition: opacity .3s;
  }
  #autosave-indicator.show { display: flex; }
  /* â”€â”€â”€ EXTRA PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .doc-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; padding: 22px; display: flex;
    flex-direction: column; gap: 10px; cursor: pointer;
    transition: box-shadow .2s, transform .2s;
  }
  .doc-card:hover { box-shadow: 0 4px 18px rgba(0,0,0,.1); transform: translateY(-2px); }
  .doc-card-icon { font-size: 36px; }
  .doc-card-title { font-size: 15px; font-weight: 700; color: var(--text); }
  .doc-card-desc  { font-size: 12px; color: var(--text3); line-height: 1.5; flex: 1; }
  .doc-card-btn   { align-self: flex-start; margin-top: 4px; }
  .doc-preview-wrap {
    font-family: 'Georgia', serif; font-size: 13px; line-height: 1.9;
    color: #111; max-height: 65vh; overflow-y: auto;
    padding: 20px; background: #fff; border-radius: 8px;
    border: 1px solid var(--border); white-space: pre-wrap;
  }
  .doc-preview-wrap h1 { font-size: 17px; text-align: center; margin-bottom: 4px; letter-spacing: 1px; }
  .doc-preview-wrap h2 { font-size: 14px; margin: 16px 0 4px; text-transform: uppercase; letter-spacing: .5px; }
  .doc-preview-wrap .firma-row { display: flex; justify-content: space-around; margin-top: 40px; gap: 20px; }
  .doc-preview-wrap .firma-col { text-align: center; flex: 1; }
  .doc-preview-wrap .firma-line { border-top: 1px solid #333; margin-bottom: 6px; padding-top: 6px; font-size: 12px; }
  /* â”€â”€â”€ BIOMETRIC LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .bio-btn {
    width: 100%; padding: 14px; margin-top: 10px;
    background: var(--surface2); border: 2px solid var(--border);
    border-radius: 12px; font-size: 15px; font-weight: 600;
    cursor: pointer; display: flex; align-items: center;
    justify-content: center; gap: 10px; color: var(--text);
    font-family: inherit; transition: all .2s;
  }
  .bio-btn:hover { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
  .bio-btn:active { transform: scale(.97); }
  .bio-btn.loading { opacity: .6; pointer-events: none; }
  .bio-divider {
    display: flex; align-items: center; gap: 10px;
    margin: 14px 0 4px; color: var(--text3); font-size: 12px;
  }
  .bio-divider::before, .bio-divider::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }
  .bio-setup-row {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 14px; margin-top: 12px;
  }
  /* â”€â”€â”€ SYNC STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #hstat-sync .hstat-val { transition: color .3s; }
  .sync-ok    { color: #6ee7b7 !important; }
  .sync-error { color: #fca5a5 !important; }
  .sync-saving { animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">

    <!-- â”€â”€ PANEL: Login â”€â”€ -->
    <div id="login-panel">
      <div class="login-logo">Gestor<span style="color:#9e8e76;font-style:italic">Renta</span></div>
      <div class="login-sub">Acceso al sistema</div>
      <div style="font-size:10px;color:#aaa;text-align:center;margin-top:-4px;margin-bottom:4px">v2.7.0</div>

      <!-- Biometric button (shown when registered) -->
      <div id="bio-login-wrap" style="display:none;margin-bottom:4px">
        <button class="bio-btn" id="bio-login-btn" onclick="bioLogin()">
          <span id="bio-icon" style="font-size:28px">ğŸ”’</span>
          <div style="text-align:left">
            <div id="bio-btn-label" style="font-size:14px">Entrar con Face ID / Huella</div>
            <div id="bio-btn-user" style="font-size:11px;color:var(--text3);font-weight:400"></div>
          </div>
        </button>
        <div class="bio-divider">o ingresa con contraseÃ±a</div>
      </div>

      <input type="text" id="login-user" placeholder="Usuario" autocomplete="username" />
      <input type="password" id="login-pass" placeholder="ContraseÃ±a" autocomplete="current-password"
        onkeydown="if(event.key==='Enter') doLogin()" />
      <button class="login-btn" onclick="doLogin()">Entrar</button>
      <div class="login-error" id="login-error"></div>
      <button class="login-link" onclick="showForgotPanel()">Â¿Olvidaste tu contraseÃ±a?</button>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);text-align:center">
        <span style="font-size:13px;color:var(--text3)">Â¿No tienes cuenta?</span>
        <button class="login-link" style="display:inline;margin-left:6px;font-weight:600" onclick="showRegisterPanel()">RegÃ­strate gratis</button>
      </div>
    </div>

    <!-- â”€â”€ PANEL: Registro nuevo cliente â”€â”€ -->
    <div id="register-panel" style="display:none">
      <div class="login-logo" style="font-size:22px;margin-bottom:4px">âœ¨ Crear cuenta</div>
      <div class="login-sub" style="margin-bottom:16px">15 dÃ­as gratis, sin tarjeta</div>
      <input type="text" id="reg-nombre" placeholder="Tu nombre completo" style="width:100%" />
      <input type="text" id="reg-empresa" placeholder="Nombre de tu empresa (opcional)" style="width:100%" />
      <input type="email" id="reg-email" placeholder="Correo electrÃ³nico" autocomplete="email" style="width:100%" />
      <input type="tel" id="reg-tel" placeholder="TelÃ©fono (10 dÃ­gitos)" style="width:100%" />
      <input type="password" id="reg-pass" placeholder="ContraseÃ±a (mÃ­nimo 6 caracteres)" style="width:100%" />
      <select id="reg-plan" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:14px;margin-bottom:8px;background:var(--surface);color:var(--text)">
        <option value="basico">BÃ¡sico â€” $199/mes (hasta 10 propiedades)</option>
        <option value="pro" selected>Pro â€” $499/mes (hasta 50 propiedades)</option>
        <option value="enterprise">Enterprise â€” $899/mes (ilimitadas)</option>
      </select>
      <button class="login-btn" onclick="doRegister()" id="reg-btn">Crear cuenta gratis</button>
      <div class="login-error" id="reg-error" style="margin-top:8px"></div>
      <button class="login-link" style="margin-top:12px" onclick="showLoginPanel()">â† Ya tengo cuenta</button>
    </div>

    <!-- â”€â”€ PANEL: Plan vencido â”€â”€ -->
    <div id="plan-expired-panel" style="display:none;text-align:center;padding:20px 0">
      <div style="font-size:48px;margin-bottom:12px">ğŸ˜”</div>
      <div style="font-size:20px;font-weight:700;margin-bottom:8px">SuscripciÃ³n suspendida</div>
      <div style="font-size:14px;color:var(--text3);margin-bottom:20px">Tu cuenta estÃ¡ suspendida por falta de pago. ContÃ¡ctanos para reactivarla.</div>
      <a href="https://wa.me/528711786102?text=Quiero+reactivar+mi+cuenta+GestorRentas" target="_blank"
         style="display:block;background:var(--accent);color:#fff;padding:12px;border-radius:8px;text-decoration:none;font-weight:600;margin-bottom:12px">
        ğŸ“± Contactar soporte
      </a>
      <button class="login-link" onclick="doLogout()">Cerrar sesiÃ³n</button>
    </div>

    <!-- â”€â”€ PANEL: Recuperar contraseÃ±a â”€â”€ -->
    <div id="forgot-panel" style="display:none">
      <div class="login-logo" style="font-size:24px;margin-bottom:4px">ğŸ”‘ Recuperar contraseÃ±a</div>
      <div class="login-sub" id="forgot-sub" style="margin-bottom:20px">Ingresa tu correo electrÃ³nico para recuperar tu acceso</div>
      <input type="email" id="forgot-email" placeholder="Tu correo electrÃ³nico" autocomplete="email"
        onkeydown="if(event.key==='Enter') doSendResetEmail()" />
      <button class="login-btn" id="forgot-btn" onclick="doSendResetEmail()" style="margin-top:12px">Recuperar contraseÃ±a</button>
      <div class="login-error" id="forgot-error"></div>
      <div id="forgot-success" style="display:none;margin-top:12px;padding:12px;background:#e8f5e9;border-radius:8px;color:#2e7d32;font-size:13px;line-height:1.5">
        ğŸ“§ Â¡Correo enviado! Revisa tu bandeja de entrada (y spam). Haz clic en el enlace del correo para crear una nueva contraseÃ±a.
      </div>
      <!-- Sub-user code recovery -->
      <div id="forgot-subuser-panel" style="display:none;margin-top:16px">
        <div style="font-size:13px;color:var(--text2);margin-bottom:10px;line-height:1.5">
          Este correo pertenece a un <strong>usuario secundario</strong>.<br>Ingresa tu cÃ³digo de recuperaciÃ³n de 8 dÃ­gitos para cambiar la contraseÃ±a.
        </div>
        <input type="text" id="forgot-sub-code" placeholder="CÃ³digo de 8 dÃ­gitos" maxlength="8" style="text-align:center;letter-spacing:3px;font-size:18px;font-weight:600"
          onkeydown="if(event.key==='Enter') doSubuserRecover()" />
        <input type="password" id="forgot-sub-newpass" placeholder="Nueva contraseÃ±a (mÃ­n. 4 caracteres)" style="margin-top:8px"
          onkeydown="if(event.key==='Enter') doSubuserRecover()" />
        <button class="login-btn" onclick="doSubuserRecover()" style="margin-top:10px">Cambiar contraseÃ±a</button>
        <div style="margin-top:12px;font-size:11px;color:var(--text3);text-align:center">Â¿No tienes cÃ³digo? Pide al titular que te genere uno desde su cuenta.</div>
      </div>
      <button class="login-link" onclick="showLoginPanel()">â† Volver al inicio de sesiÃ³n</button>
    </div>

  </div>
</div>

<header class="header">

  <!-- Fila 1: logo + stats desktop + avatar -->
  <div class="header-row1">
    <div class="logo">Gestor<span>Renta</span></div>

    <!-- Stats solo desktop -->
    <div class="header-stats" id="desktop-header-stats">
      <div class="hstat" id="hstat-sync" style="cursor:default" title="Estado de sincronizaciÃ³n">
        <div class="hstat-val" id="hstat-sync-icon" style="font-size:14px">â˜ï¸</div>
        <div class="hstat-label" id="hstat-sync-label">En lÃ­nea</div>
      </div>
      <div class="hstat">
        <div class="hstat-val" id="hstat-rentas">0</div>
        <div class="hstat-label">Propiedades activas</div>
      </div>
      <div class="hstat" id="hstat-atrasadas-wrap">
        <div class="hstat-val danger" id="hstat-atrasadas">0</div>
        <div class="hstat-label">Rentas vencidas</div>
      </div>
      <div class="hstat">
        <div class="hstat-val danger" id="hstat-adeudo">$0</div>
        <div class="hstat-label">Total adeudado</div>
      </div>
      <div class="hstat">
        <div class="hstat-val success" id="hstat-cobrado">$0</div>
        <div class="hstat-label">Cobrado este mes</div>
      </div>
    </div>

    <!-- Avatar (siempre visible) -->
    <div style="position:relative" id="user-menu-wrap">
      <span id="notif-dot" class="notif-dot" style="position:absolute;top:-2px;right:-2px;z-index:10"></span>
      <div class="user-avatar" id="user-avatar-btn" onclick="toggleUserDropdown()">?</div>
      <div class="user-dropdown" id="user-dropdown">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border)">
          <div style="font-weight:600;font-size:14px" id="dd-username">â€”</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px" id="dd-role">â€”</div>
        </div>
        <div class="user-dropdown-item" id="dd-manage-users" onclick="nav('pagos');closeUserDropdown()" style="display:none">
          ğŸ‘¥ Administrar usuarios
        </div>
        <div class="user-dropdown-item" onclick="bioSetupFromDropdown();closeUserDropdown()">
          <span id="dd-bio-label">ğŸ”’ Activar Face ID / Huella</span>
        </div>
        <hr class="user-dropdown-sep" id="dd-sep" style="display:none">
        <div class="user-dropdown-item danger" onclick="doLogout()">ğŸšª Cerrar sesiÃ³n</div>
      </div>
    </div>
  </div>

  <!-- Fila 2: stats mÃ³vil (oculta en desktop) -->
  <div class="header-row2" id="mobile-header-stats">
    <div class="m-hstat">
      <div class="m-hstat-val" id="m-hstat-rentas">0</div>
      <div class="m-hstat-label">Propiedades</div>
    </div>
    <div class="m-hstat-sep"></div>
    <div class="m-hstat">
      <div class="m-hstat-val danger" id="m-hstat-adeudo">$0</div>
      <div class="m-hstat-label">Adeudado</div>
    </div>
    <div class="m-hstat-sep"></div>
    <div class="m-hstat">
      <div class="m-hstat-val success" id="m-hstat-cobrado">$0</div>
      <div class="m-hstat-label">Cobrado</div>
    </div>
  </div>

</header>

<!-- Mobile bottom navigation -->
<nav class="mobile-nav">
  <div class="mobile-nav-inner">
    <button class="mobile-nav-btn active" id="mnav-dashboard" onclick="nav('dashboard');setMobileNav('dashboard')">
      <span class="mnav-icon">ğŸ </span>
      <span class="mnav-label">Inicio</span>
    </button>
    <button class="mobile-nav-btn" id="mnav-rentas" onclick="nav('rentas');setMobileNav('rentas')">
      <span class="mnav-icon">ğŸ¢</span>
      <span class="mnav-label">Propiedades</span>
    </button>
    <button class="mobile-nav-btn" id="mnav-clientes" onclick="nav('clientes');setMobileNav('clientes')">
      <span class="mnav-icon">ğŸ‘¥</span>
      <span class="mnav-label">Clientes</span>
    </button>
    <button class="mobile-nav-btn" id="mnav-alertas" onclick="nav('alertas');setMobileNav('alertas')" style="position:relative">
      <span class="mnav-icon">âš ï¸</span>
      <span class="mnav-label">Alertas</span>
      <span id="mnav-alertas-badge" class="mobile-nav-badge" style="display:none"></span>
    </button>
    <button class="mobile-nav-btn" id="mnav-pagos" onclick="nav('pagos');setMobileNav('pagos')">
      <span class="mnav-icon">âš™ï¸</span>
      <span class="mnav-label">Config</span>
    </button>
    <button class="mobile-nav-btn" id="mnav-facturacion" onclick="nav('facturacion');setMobileNav('facturacion')">
      <span class="mnav-icon">ğŸ§¾</span>
      <span class="mnav-label">FacturaciÃ³n</span>
    </button>
    <button class="mobile-nav-btn" id="mnav-extra" onclick="nav('extra');setMobileNav('extra')">
      <span class="mnav-icon">ğŸ“„</span>
      <span class="mnav-label">Extra</span>
    </button>
  </div>
</nav>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="nav-section">MenÃº</div>
    <button class="nav-btn active" id="nav-dashboard" onclick="nav('dashboard')">
      <span class="nav-icon">ğŸ </span> Inicio
    </button>
    <button class="nav-btn" id="nav-rentas" onclick="nav('rentas')">
      <span class="nav-icon">ğŸ¢</span> Propiedades
    </button>
    <button class="nav-btn" id="nav-clientes" onclick="nav('clientes')">
      <span class="nav-icon">ğŸ‘¥</span> Clientes
    </button>
    <button class="nav-btn" onclick="nav('alertas')" id="nav-alertas">
      <span class="nav-icon">âš ï¸</span> Alertas de cobro
      <span id="alertas-badge" style="display:none;background:var(--danger);color:#fff;font-size:10px;font-weight:700;border-radius:10px;padding:2px 6px;margin-left:auto"></span>
    </button>
    <button class="nav-btn" id="nav-pagos" onclick="nav('pagos')">
      <span class="nav-icon">âš™ï¸</span> ConfiguraciÃ³n
    </button>
    <button class="nav-btn" onclick="nav('facturacion')" id="nav-facturacion">
      <span class="nav-icon">ğŸ§¾</span> FacturaciÃ³n
    </button>
    <button class="nav-btn" id="nav-extra" onclick="nav('extra')">
      <span class="nav-icon">ğŸ“„</span> Extra
    </button>
    <button class="nav-btn" onclick="nav('ayuda')" style="margin-top:auto">
      <span class="nav-icon">â“</span> Ayuda
    </button>

  </aside>

  <!-- Main -->
  <main class="main" id="main-content">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="top-bar">
        <div>
          <div class="page-title">Inicio</div>
          <div class="page-sub">Resumen general de tu portafolio</div>
        </div>

      </div>
      <!-- KPI summary strip -->
      <div id="dash-kpis" style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:18px"></div>
      <!-- Compact summary (tipos + estado) -->
      <div id="dash-summary" style="margin-bottom:24px"></div>
      <!-- Formas de pago resumen -->
      <div id="dash-fp-section" style="margin-bottom:24px"></div>
      <!-- Propiedades sin rentar (hidden - user can access via KPI card) -->
      <div id="dash-vacant-section" style="display:none">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:14px" id="dash-vacant-title">ğŸ”“ Propiedades sin rentar</div>
        <div id="dashboard-cards"></div>
      </div>

      <!-- Reportes Excel â€” al fondo -->
      <div id="dash-reportes-section" style="margin-top:32px;border-top:1px solid var(--border);padding-top:24px">
        <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:14px">ğŸ“Š Reportes</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">
          <button class="btn btn-ghost" onclick="mostrarEstadoResultados()" style="display:flex;align-items:center;gap:10px;padding:14px 16px;justify-content:flex-start">
            <span style="font-size:22px">ğŸ“ˆ</span>
            <div style="text-align:left">
              <div style="font-weight:600;font-size:13px">Estado de resultados</div>
              <div style="font-size:11px;color:var(--text3)">Ingresos vs gastos por mes</div>
            </div>
          </button>
          <button class="btn btn-ghost" onclick="descargarReportePagos()" style="display:flex;align-items:center;gap:10px;padding:14px 16px;justify-content:flex-start">
            <span style="font-size:22px">ğŸ“Š</span>
            <div style="text-align:left">
              <div style="font-weight:600;font-size:13px">Reporte de pagos <span style="font-size:10px;background:var(--accent-light);color:var(--accent);border-radius:4px;padding:1px 6px">XLS</span></div>
              <div style="font-size:11px;color:var(--text3)">Todos los pagos registrados</div>
            </div>
          </button>
          <button class="btn btn-ghost" onclick="descargarReporteGastos()" style="display:flex;align-items:center;gap:10px;padding:14px 16px;justify-content:flex-start">
            <span style="font-size:22px">ğŸ”§</span>
            <div style="text-align:left">
              <div style="font-weight:600;font-size:13px">Reporte de gastos <span style="font-size:10px;background:var(--accent-light);color:var(--accent);border-radius:4px;padding:1px 6px">XLS</span></div>
              <div style="font-size:11px;color:var(--text3)">Gastos por propiedad</div>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- RENTAS -->
    <div class="page" id="page-rentas">
      <div class="top-bar">
        <div>
          <div class="page-title">Propiedades</div>
          <div class="page-sub">GestiÃ³n de contratos de renta</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="triggerImport('propiedades')" title="Importar desde Excel">ğŸ“¥ Importar Excel</button>
          <button class="btn btn-primary" onclick="openModal('modalRenta')">+ Agregar Propiedad</button>
        </div>
      </div>
      <!-- Row 1: Filter chips -->
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
        <button class="filter-chip active" onclick="setFilter('all',this)">Todas</button>
        <button class="filter-chip" onclick="setFilter('atrasado',this)">ğŸ”´ Atrasadas</button>
        <button class="filter-chip" onclick="setFilter('parcial',this)">ğŸ”¶ Parciales</button>
        <button class="filter-chip" onclick="setFilter('al-dia',this)">âœ… Al dÃ­a</button>
        <button class="filter-chip" onclick="setFilter('sin-rentar',this)">ğŸ”“ Sin rentar</button>
      </div>
      <!-- Row 2: Search + view toggle -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div class="search-bar" style="flex:1">
          <input id="rentas-search" type="text" placeholder="Buscar propiedad..." oninput="clearTimeout(this._t);this._t=setTimeout(()=>renderRentas(),250)" style="width:100%" />
        </div>
        <div class="view-toggle">
          <button class="view-btn" id="vbtn-grid" onclick="setRentasView('grid')" title="CuadrÃ­cula">âŠ</button>
          <button class="view-btn" id="vbtn-list" onclick="setRentasView('list')" title="Lista">â˜°</button>
        </div>
      </div>
      <!-- Active filter badge -->
      <div style="margin-bottom:10px">
        <span id="rentas-tipo-badge" style="display:none;align-items:center;gap:6px;font-size:12px;font-weight:600;padding:5px 12px;border-radius:20px;cursor:pointer;white-space:nowrap;background:var(--accent-light);color:var(--accent)" onclick="_rentaTipoFiltro=null;this.style.display='none';renderRentas()" title="Quitar filtro"><span id="rentas-tipo-badge-label"></span> âœ•</span>
      </div>
      <div id="rentas-cards"></div>
    </div>

    <!-- CLIENTES -->
    <div class="page" id="page-clientes">
      <div class="top-bar">
        <div>
          <div class="page-title">Clientes</div>
          <div class="page-sub">Directorio de inquilinos</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="triggerImport('clientes')" title="Importar desde Excel">ğŸ“¥ Importar Excel</button>
          <button class="btn btn-primary" onclick="openModal('modalCliente')">+ Nuevo Cliente</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:16px;flex-wrap:wrap">
        <div class="search-bar">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <input id="clientes-search" type="text" placeholder="Buscar cliente..." oninput="clearTimeout(this._t);this._t=setTimeout(()=>renderClientes(),250)" />
          <span id="clientes-filtro-badge" style="display:none;align-items:center;gap:6px;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:600;padding:5px 10px;border-radius:20px;cursor:pointer;white-space:nowrap" onclick="_clienteEstadoFiltro=null;this.style.display='none';renderClientes()" title="Quitar filtro">
            <span id="clientes-filtro-label"></span> âœ•
          </span>
        </div>
        </div>
        <div class="view-toggle">
          <button class="view-btn" id="cvbtn-grid" onclick="setClientesView('grid')" title="CuadrÃ­cula">âŠ</button>
          <button class="view-btn" id="cvbtn-list" onclick="setClientesView('list')" title="Lista">â˜°</button>
        </div>
      </div>
      <div id="clientes-cards"></div>
    </div>

    <!-- ALERTAS -->
    <div class="page" id="page-alertas">
      <div>
        <div class="page-title">Alertas de Cobro</div>
        <div class="page-sub">Seguimiento de cobros y compromisos de pago</div>
      </div>
      <div class="alert-list" id="alertas-list"></div>
    </div>

    <!-- FORMAS DE PAGO -->
    <div class="page" id="page-pagos">
      <div class="top-bar">
        <div>
          <div class="page-title">ConfiguraciÃ³n</div>
          <div class="page-sub">CatÃ¡logos y ajustes del sistema</div>
        </div>
      </div>

      <!-- Formas de pago -->
      <div class="config-section">
        <div class="config-section-title">
          ğŸ’³ Formas de pago
          <span onclick="document.getElementById('help-fp').style.display=document.getElementById('help-fp').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
          <button class="btn btn-primary" style="font-size:12px;padding:6px 12px" onclick="openModal('modalFormaPago')">+ Agregar</button>
        </div>
        <div id="help-fp" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿QuÃ© son las formas de pago?</div>
          <div style="margin-bottom:8px">Son las cuentas bancarias o mÃ©todos donde recibes las rentas de tus inquilinos (transferencia, depÃ³sito, efectivo, etc.).</div>
          <div style="margin-bottom:8px">Al registrar un abono, puedes seleccionar a quÃ© cuenta/forma llegÃ³ el pago. Esto te permite ver en el dashboard cuÃ¡nto has cobrado por cada mÃ©todo.</div>
          <div style="font-size:11px;color:var(--text3)">Ejemplo: "Banorte 1234", "BBVA Empresarial", "Efectivo oficina".</div>
        </div>
        <div id="pagos-list"></div>
      </div>

      <!-- Tipos de gasto -->
      <div class="config-section">
        <div class="config-section-title">
          ğŸ”§ Tipos de gasto
          <span onclick="document.getElementById('help-gastos').style.display=document.getElementById('help-gastos').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
          <div style="font-size:11px;color:var(--text3);font-weight:400">CategorÃ­as para gastos de propiedades</div>
        </div>
        <div id="help-gastos" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿QuÃ© son los tipos de gasto?</div>
          <div style="margin-bottom:8px">Son las categorÃ­as con las que clasificas los gastos de mantenimiento o reparaciÃ³n de cada propiedad.</div>
          <div style="margin-bottom:8px">Al registrar un gasto en una propiedad, eliges una de estas categorÃ­as. Esto te ayuda a saber en quÃ© se va tu dinero.</div>
          <div style="font-size:11px;color:var(--text3)">Ejemplo: "PlomerÃ­a", "Electricidad", "Pintura", "Limpieza", "Impuestos".</div>
        </div>
        <div class="config-tag-list" id="cfg-tipos-gasto"></div>
        <div class="config-add-row">
          <input id="cfg-gasto-input" placeholder="Ej: PlomerÃ­a, Pintura..." onkeydown="if(event.key==='Enter')addCfgItem('tiposGasto','cfg-gasto-input')" />
          <button class="btn btn-ghost" onclick="addCfgItem('tiposGasto','cfg-gasto-input')">+ Agregar</button>
        </div>
      </div>

      <!-- Tipos de propiedad -->
      <div class="config-section">
        <div class="config-section-title">
          ğŸ—ï¸ Tipos de propiedad
          <span onclick="document.getElementById('help-tipos').style.display=document.getElementById('help-tipos').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
          <div style="font-size:11px;color:var(--text3);font-weight:400">CategorÃ­as para clasificar propiedades</div>
        </div>
        <div id="help-tipos" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿QuÃ© son los tipos de propiedad?</div>
          <div style="margin-bottom:8px">Son las categorÃ­as para organizar tu portafolio segÃºn el tipo de inmueble: local comercial, casa, departamento, nave industrial, terreno, etc.</div>
          <div style="margin-bottom:8px">Esto te permite filtrar propiedades por tipo en la vista principal, ver estadÃ­sticas por categorÃ­a en el dashboard, y asignar permisos por tipo a tus usuarios.</div>
          <div style="font-size:11px;color:var(--text3)">Puedes agregar los que necesites. Se eliminan con la âœ• al lado de cada uno.</div>
        </div>
        <div class="config-tag-list" id="cfg-tipos-prop"></div>
        <div class="config-add-row">
          <input id="cfg-prop-input" placeholder="Ej: Nave industrial, Suite..." onkeydown="if(event.key==='Enter')addCfgItem('tiposProp','cfg-prop-input')" />
          <button class="btn btn-ghost" onclick="addCfgItem('tiposProp','cfg-prop-input')">+ Agregar</button>
        </div>
      </div>

      <!-- DÃ­as de gracia -->
      <div class="config-section">
        <div class="config-section-title">
          â³ DÃ­as de gracia y recordatorios
          <span onclick="document.getElementById('gracia-help').style.display=document.getElementById('gracia-help').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
          <div style="font-size:11px;color:var(--text3);font-weight:400">Tolerancia de pago y avisos por WhatsApp</div>
        </div>
        <div id="gracia-help" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿CÃ³mo funciona?</div>
          <div style="margin-bottom:8px"><strong>Marcar como vencido:</strong> DespuÃ©s del dÃ­a de pago de cada propiedad, se esperan estos dÃ­as antes de marcar el cobro como "vencido" en alertas. Ejemplo: si el pago es dÃ­a 1 y pones 6, se marca vencido el dÃ­a 7.</div>
          <div style="margin-bottom:8px"><strong>Recordatorios WhatsApp:</strong> Se configuran individualmente en cada cliente. Al dar de alta o editar un cliente, puedes activar hasta 2 mensajes automÃ¡ticos con la fecha y texto que tÃº elijas.</div>
          <div style="margin-bottom:8px">Desde aquÃ­ puedes activar o desactivar los recordatorios de forma global para todos los clientes.</div>
          <div style="font-size:11px;color:var(--text3)">Aunque estÃ©n activados aquÃ­, cada cliente necesita tener su telÃ©fono registrado y los recordatorios activados en su ficha.</div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;margin-bottom:14px">
          <label style="font-size:11px;display:block;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);font-weight:600">Marcar como vencido</label>
          <input id="cfg-gracia-dias" type="number" min="0" max="30" value="6" style="width:70px;text-align:center;font-size:20px;font-weight:700;padding:8px;margin:0 auto;display:block" onchange="guardarDiasGracia()" />
          <div style="font-size:11px;color:var(--text3);margin-top:6px">dÃ­as despuÃ©s del dÃ­a de pago</div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="display:flex;align-items:center;gap:10px">
              <span style="font-size:22px">ğŸ’¬</span>
              <div>
                <div style="font-size:13px;font-weight:700;color:var(--text)">Recordatorios WhatsApp</div>
                <div style="font-size:11px;color:var(--text3)">Activar/desactivar para todos los clientes</div>
              </div>
            </div>
            <div id="cfg-wa-global-toggle" onclick="toggleGlobalWa()" style="width:44px;height:24px;background:#25D366;border-radius:12px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0">
              <div id="cfg-wa-global-thumb" style="width:20px;height:20px;background:#fff;border-radius:50%;position:absolute;top:2px;left:22px;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)"></div>
            </div>
          </div>
          <div id="cfg-wa-global-status" style="font-size:11px;color:var(--success);margin-top:8px;text-align:center">âœ… Activados â€” Los mensajes se configuran en cada cliente</div>
        </div>
      </div>

      <!-- Usuarios (solo visible para titular) -->
      <div class="config-section" id="cfg-usuarios-section" style="display:none">
        <div class="config-section-title">
          ğŸ‘¤ Usuarios del sistema
          <span onclick="document.getElementById('help-users').style.display=document.getElementById('help-users').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
          <button class="btn btn-primary" style="font-size:12px;padding:6px 12px" onclick="openModal('modalUsuario');prepNuevoUsuario()">+ Nuevo usuario</button>
        </div>
        <div id="help-users" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿CÃ³mo funcionan los usuarios?</div>
          <div style="margin-bottom:8px">Puedes crear cuentas adicionales para tu equipo (administradores, contadores, cobradores) con permisos especÃ­ficos.</div>
          <div style="margin-bottom:8px"><strong>Facultades:</strong> Cada usuario puede tener acceso solo a lo que necesita â€” ver propiedades, registrar abonos, ver alertas, etc. TambiÃ©n puedes limitar quÃ© tipos de propiedad puede ver.</div>
          <div style="margin-bottom:8px"><strong>CÃ³digo de recuperaciÃ³n:</strong> Genera un cÃ³digo para que el usuario pueda recuperar su acceso si olvida su contraseÃ±a.</div>
          <div style="font-size:11px;color:var(--text3)">El titular siempre tiene acceso completo y no se puede eliminar.</div>
        </div>
        <div id="usuarios-list"></div>
      </div>

      <!-- FacturaciÃ³n ElectrÃ³nica CFDI -->

      <!-- Respaldo de datos -->
      <div class="config-section">
        <div class="config-section-title">
          ğŸ’¾ Respaldo de datos
          <span onclick="document.getElementById('help-backup').style.display=document.getElementById('help-backup').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
          <div style="font-size:11px;color:var(--text3);font-weight:400">Exporta o importa todos tus datos</div>
        </div>
        <div id="help-backup" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿CÃ³mo funciona el respaldo?</div>
          <div style="margin-bottom:8px"><strong>Exportar:</strong> Descarga un archivo JSON con toda tu informaciÃ³n (propiedades, clientes, abonos, configuraciÃ³n). GuÃ¡rdalo como respaldo de seguridad.</div>
          <div style="margin-bottom:8px"><strong>Importar:</strong> Carga un archivo JSON previamente exportado para restaurar tus datos. TambiÃ©n puedes importar propiedades y clientes desde Excel.</div>
          <div style="font-size:11px;color:var(--text3)">Se recomienda hacer un respaldo periÃ³dico como precauciÃ³n adicional, aunque tus datos se guardan automÃ¡ticamente en la nube.</div>
        </div>

        <div class="g2" style="gap:12px;margin-bottom:14px">
          <!-- Exportar -->
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">ğŸ“¤ Exportar datos</div>
            <div style="font-size:12px;color:var(--text3);margin-bottom:12px;line-height:1.5">Descarga un archivo JSON con todas tus propiedades, clientes y pagos.</div>
            <button class="btn btn-primary" style="width:100%" onclick="exportarDatos()">â¬‡ï¸ Descargar respaldo</button>
          </div>
          <!-- Importar -->
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px">
            <div style="font-size:13px;font-weight:600;margin-bottom:6px">ğŸ“¥ Importar datos</div>
            <div style="font-size:12px;color:var(--text3);margin-bottom:12px;line-height:1.5">Carga un respaldo previo. <strong style="color:var(--danger)">Reemplaza todos los datos actuales.</strong></div>
            <label class="btn btn-ghost" style="width:100%;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
              ğŸ“‚ Cargar respaldo
              <input type="file" accept=".json" style="display:none" onchange="importarDatos(this)" />
            </label>
          </div>
        </div>

        <!-- Importar abonos Excel -->
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px">
          <div style="font-size:13px;font-weight:600;margin-bottom:6px">ğŸ’° Importar Abonos desde Excel</div>
          <div style="font-size:12px;color:var(--text3);margin-bottom:10px;line-height:1.5">Descarga la plantilla, llena los montos de cada propiedad y sÃºbela. Los abonos se agregan sin borrar los existentes.</div>
          <div class="g2" style="gap:8px">
            <button class="btn btn-ghost" style="width:100%" onclick="descargarPlantillaAbonos()">â¬‡ï¸ Descargar plantilla</button>
            <label class="btn btn-primary" style="width:100%;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
              ğŸ“¥ Importar abonos (.xlsx)
              <input type="file" accept=".xlsx" style="display:none" onchange="importarAbonos(this)" />
            </label>
          </div>
        </div>

      </div>

    </div>

        <!-- EXTRA â€” DOCUMENTOS LEGALES -->

    <!-- â•â•â•â•â•â• PAGE: FACTURACIÃ“N â•â•â•â•â•â• -->
    <div class="page" id="page-facturacion">
      <div class="main">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px">
          <div>
            <h2 style="margin:0;font-size:22px;font-weight:800">ğŸ§¾ FacturaciÃ³n ElectrÃ³nica</h2>
            <div style="font-size:13px;color:var(--text3);margin-top:4px">Configura y emite CFDI 4.0 directamente desde GestorRenta</div>
          </div>
        </div>

        <!-- Pasos para facturar -->
        <div style="background:linear-gradient(135deg,rgba(99,102,241,.06),rgba(99,102,241,.12));border:2px solid var(--accent);border-radius:16px;padding:20px;margin-bottom:24px">
          <div style="font-size:14px;font-weight:700;color:var(--accent);margin-bottom:14px">ğŸ“‹ Â¿CÃ³mo funciona?</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px">
            <div style="background:var(--surface);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:28px;margin-bottom:6px">1ï¸âƒ£</div>
              <div style="font-size:12px;font-weight:700;margin-bottom:4px">Sube tu CSD</div>
              <div style="font-size:11px;color:var(--text3)">Archivos .cer y .key de tu Certificado de Sello Digital del SAT</div>
            </div>
            <div style="background:var(--surface);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:28px;margin-bottom:6px">2ï¸âƒ£</div>
              <div style="font-size:12px;font-weight:700;margin-bottom:4px">Datos del emisor</div>
              <div style="font-size:11px;color:var(--text3)">RFC, razÃ³n social y rÃ©gimen fiscal del arrendador</div>
            </div>
            <div style="background:var(--surface);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:28px;margin-bottom:6px">3ï¸âƒ£</div>
              <div style="font-size:12px;font-weight:700;margin-bottom:4px">Compra timbres</div>
              <div style="font-size:11px;color:var(--text3)">Adquiere paquetes de timbres CFDI para facturar</div>
            </div>
            <div style="background:var(--surface);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:28px;margin-bottom:6px">4ï¸âƒ£</div>
              <div style="font-size:12px;font-weight:700;margin-bottom:4px">Â¡Factura!</div>
              <div style="font-size:11px;color:var(--text3)">Desde cada abono, da clic en "ğŸ§¾ Facturar" y listo</div>
            </div>
          </div>
        </div>

        <!-- Balance de timbres -->
        <div id="timbres-panel" style="background:linear-gradient(135deg,#1b3a2d,#234d3b);border-radius:16px;padding:24px;margin-bottom:24px;color:#fff">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:14px">
            <div>
              <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:.7;margin-bottom:4px">Timbres CFDI disponibles</div>
              <div style="display:flex;align-items:baseline;gap:8px">
                <span id="timbres-count" style="font-family:'DM Mono',monospace;font-size:42px;font-weight:800">0</span>
                <span style="font-size:14px;opacity:.6">timbres</span>
              </div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button onclick="openModal('modalComprarTimbres')" style="background:#22c55e;color:#fff;border:none;border-radius:10px;padding:10px 20px;font-size:13px;font-weight:700;cursor:pointer">ğŸ›’ Comprar timbres</button>
              <button onclick="verHistorialTimbres()" style="background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:10px 16px;font-size:13px;font-weight:600;cursor:pointer">ğŸ“‹ Historial</button>
            </div>
          </div>
          <div id="timbres-plan-info" style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.15);font-size:12px;opacity:.7"></div>
        </div>

        <div class="config-section" style="border:2px solid var(--accent);background:linear-gradient(135deg,rgba(99,102,241,.04),rgba(99,102,241,.08))">
        <div class="config-section-title" style="color:var(--accent)">
          ğŸ§¾ FacturaciÃ³n ElectrÃ³nica CFDI 4.0
          <span onclick="document.getElementById('help-cfdi').style.display=document.getElementById('help-cfdi').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
          <div style="font-size:11px;color:var(--text3);font-weight:400">IntegraciÃ³n con FiscalAPI â€” Timbra facturas directo desde GestorRenta</div>
        </div>
        <div id="help-cfdi" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿CÃ³mo funciona la facturaciÃ³n?</div>
          <div style="margin-bottom:8px"><strong>FiscalAPI:</strong> Es el servicio externo que timbra tus facturas ante el SAT. Necesitas crear una cuenta gratuita en fiscalapi.com y obtener tu API Key y Tenant.</div>
          <div style="margin-bottom:8px"><strong>Entidades emisoras:</strong> Son las personas fÃ­sicas o morales desde las que emites facturas. Cada una necesita su RFC, CSD (Certificado de Sello Digital) y contraseÃ±a.</div>
          <div style="margin-bottom:8px"><strong>Timbres:</strong> Cada factura requiere un timbre. Puedes comprar paquetes de timbres dentro de la app.</div>
          <div style="font-size:11px;color:var(--text3)">Una vez configurado, puedes facturar directamente desde cada abono con un solo clic en "ğŸ§¾ Facturar".</div>
        </div>
        <div id="fiscal-status" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px">
          <div style="display:flex;align-items:center;gap:10px">
            <div id="fiscal-dot" style="width:10px;height:10px;border-radius:50%;background:var(--text3)"></div>
            <div>
              <div id="fiscal-status-text" style="font-size:13px;font-weight:600">No configurado</div>
              <div id="fiscal-status-sub" style="font-size:11px;color:var(--text3)">Configura tus credenciales para habilitar la facturaciÃ³n</div>
            </div>
          </div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px" id="fiscal-api-creds-section">
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--accent);margin-bottom:12px">ğŸ”‘ Credenciales FiscalAPI (Admin)</div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:10px;line-height:1.5">ObtÃ©n tu API Key y Tenant en <a href="https://fiscalapi.com" target="_blank" style="color:var(--accent)">fiscalapi.com</a>. Prueba gratis 90 dÃ­as.</div>
          <div class="g2" style="margin-bottom:10px">
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">API Key</label><input id="cfg-fiscal-apikey" type="password" placeholder="sk_live_xxxx..." style="width:100%;font-size:12px" /></div>
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Tenant Key</label><input id="cfg-fiscal-tenant" type="password" placeholder="tu-tenant-key..." style="width:100%;font-size:12px" /></div>
          </div>
          <div style="margin-bottom:10px"><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Ambiente</label>
            <select id="cfg-fiscal-env" style="font-size:12px;padding:6px 10px"><option value="test">ğŸ§ª Pruebas (test.fiscalapi.com)</option><option value="live">ğŸŸ¢ ProducciÃ³n (live.fiscalapi.com)</option></select>
          </div>
          <button class="btn btn-primary" style="width:100%" onclick="guardarCredencialesFiscal()">ğŸ’¾ Guardar credenciales</button>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px">
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--accent);margin-bottom:12px">ğŸ¢ Entidades Emisoras</div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:12px;line-height:1.5">Agrega las personas fÃ­sicas o morales desde las que facturas. Cada propiedad se vincula a una entidad.</div>
          <div id="emisores-list"></div>
          <button class="btn btn-primary" style="width:100%;margin-top:10px" onclick="abrirEditorEmisor()">+ Agregar entidad emisora</button>
        </div>

        <!-- Editor de emisor (oculto) -->
        <div id="emisor-editor" style="display:none;background:var(--surface);border:2px solid var(--accent);border-radius:10px;padding:16px;margin-bottom:14px">
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--accent);margin-bottom:12px" id="emisor-editor-title">Nueva entidad emisora</div>
          <input type="hidden" id="edit-emisor-id" />
          <div class="g2" style="margin-bottom:10px">
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">RFC</label><input id="ed-emisor-rfc" placeholder="XAXX010101000" style="width:100%;font-size:12px;text-transform:uppercase" /></div>
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">CÃ³digo postal fiscal</label><input id="ed-emisor-cp" placeholder="06600" style="width:100%;font-size:12px" maxlength="5" /></div>
          </div>
          <div style="margin-bottom:10px"><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">RazÃ³n social</label><input id="ed-emisor-razon" placeholder="NOMBRE COMPLETO o EMPRESA" style="width:100%;font-size:12px;text-transform:uppercase" /></div>
          <div class="g2" style="margin-bottom:10px">
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">RÃ©gimen fiscal</label>
              <select id="ed-emisor-regimen" style="font-size:12px;padding:6px 10px;width:100%"><option value="">â€” Seleccionar â€”</option><option value="605">605 - Sueldos y salarios</option><option value="606">606 - Arrendamiento</option><option value="612">612 - Personas fÃ­sicas con act. empresarial</option><option value="621">621 - IncorporaciÃ³n fiscal</option><option value="625">625 - RESICO</option><option value="601">601 - General de Ley PM</option><option value="603">603 - PM sin fines de lucro</option><option value="626">626 - RESICO PM</option></select></div>
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Serie para facturas</label><input id="ed-emisor-serie" value="RENTA" style="width:100%;font-size:12px;text-transform:uppercase" maxlength="25" /></div>
          </div>
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin:14px 0 8px">ğŸ“œ Certificado de Sello Digital (CSD)</div>
          <div class="g2" style="margin-bottom:10px">
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Archivo .cer</label>
              <label class="btn btn-ghost" style="width:100%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;gap:4px"><span id="ed-csd-cer-label">ğŸ“‚ Seleccionar .cer</span><input type="file" accept=".cer" style="display:none" onchange="cargarCSDEmisor(this,'cer')" /></label></div>
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Archivo .key</label>
              <label class="btn btn-ghost" style="width:100%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;gap:4px"><span id="ed-csd-key-label">ğŸ“‚ Seleccionar .key</span><input type="file" accept=".key" style="display:none" onchange="cargarCSDEmisor(this,'key')" /></label></div>
          </div>
          <div style="margin-bottom:10px"><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">ContraseÃ±a del CSD</label><input id="ed-csd-password" type="password" placeholder="ContraseÃ±a de la llave privada" style="width:100%;font-size:12px" /></div>
          <div id="ed-csd-status" style="font-size:11px;color:var(--text3);margin-bottom:10px"></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" style="flex:1" onclick="guardarEmisor()">ğŸ’¾ Guardar entidad</button>
            <button class="btn btn-ghost" style="flex-shrink:0" onclick="cerrarEditorEmisor()">Cancelar</button>
          </div>
        </div>

        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px">
          <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--accent);margin-bottom:12px">ğŸ“¦ Concepto por defecto</div>
          <div class="g2">
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Clave producto SAT</label><input id="cfg-prod-clave" value="80131502" style="width:100%;font-size:12px" /><div style="font-size:10px;color:var(--text3);margin-top:2px">80131502 = Arrendamiento de instalaciones</div></div>
            <div><label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Unidad de medida</label>
              <select id="cfg-prod-unidad" style="font-size:12px;padding:6px 10px;width:100%"><option value="E48">E48 - Unidad de servicio</option><option value="MON">MON - Mes</option><option value="ACT">ACT - Actividad</option></select></div>
          </div>
        </div>
      </div>

        <!-- Historial de facturas emitidas -->
        <div class="config-section">
          <div class="config-section-title">
            ğŸ“Š Facturas emitidas
            <span onclick="document.getElementById('help-histfac').style.display=document.getElementById('help-histfac').style.display==='none'?'block':'none'" style="display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--accent-light);color:var(--accent);font-size:12px;font-weight:700;cursor:pointer;margin-left:6px;border:1px solid rgba(45,106,79,.2)" title="Â¿QuÃ© es esto?">?</span>
            <div style="font-size:11px;color:var(--text3);font-weight:400">Historial de CFDI timbrados desde GestorRenta</div>
          </div>
          <div id="help-histfac" style="display:none;background:var(--accent-light);border:1px solid rgba(45,106,79,.2);border-radius:10px;padding:14px;margin-bottom:14px;font-size:12px;color:var(--text2);line-height:1.6">
            <div style="font-weight:700;color:var(--accent);margin-bottom:6px">ğŸ“– Â¿QuÃ© es esta secciÃ³n?</div>
            <div style="margin-bottom:8px">AquÃ­ se muestra el historial de todas las facturas CFDI que has emitido desde GestorRenta, con el UUID, monto, fecha, cliente y emisor.</div>
            <div style="font-size:11px;color:var(--text3)">Puedes descargar el XML de cada factura para tus archivos contables.</div>
          </div>
          <div id="facturacion-historial">
            <div class="empty-state" style="padding:30px">
              <div class="empty-icon">ğŸ§¾</div>
              <div class="empty-title">Sin facturas emitidas</div>
              <div class="empty-sub">Las facturas aparecerÃ¡n aquÃ­ cuando timbres abonos desde el detalle de cada propiedad</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="page" id="page-extra">
      <div class="top-bar">
        <div>
          <div class="page-title">ğŸ“„ Extra</div>
          <div class="page-sub">Documentos legales generados automÃ¡ticamente con tus datos</div>
        </div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span style="font-size:22px">ğŸ </span>
        <div style="flex:1;min-width:180px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:4px">Propiedad</div>
          <select id="extra-prop-sel" onchange="extraCambiarPropiedad()" style="width:100%;font-size:14px;font-weight:500;background:transparent;border:none;padding:0;color:var(--text)">
            <option value="">â€” Seleccionar propiedad â€”</option>
          </select>
        </div>
        <div id="extra-prop-info" style="font-size:12px;color:var(--text3)">
          <span id="extra-prop-inquilino"></span>
        </div>
      </div>
      <div id="extra-doc-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px"></div>
    </div>

    <!-- DETALLE RENTA -->
    <div class="page" id="page-detalle">
      <div id="detalle-content"></div>
    </div>

    <div class="page" id="page-detalle-cliente">
      <div id="detalle-cliente-content"></div>
    </div>

    <!-- AYUDA -->
    <div class="page" id="page-ayuda">
      <div class="top-bar">
        <div>
          <div class="page-title">â“ Centro de Ayuda</div>
          <div class="page-sub">Aprende a usar GestorRenta en minutos</div>
        </div>
      </div>

      <!-- Quick links -->
      <div id="ayuda-quick" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:10px;margin-bottom:24px">
        <div class="ayuda-quick-card" onclick="nav('dashboard')" style="cursor:pointer;background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .2s">
          <div style="font-size:28px;margin-bottom:6px">ğŸ </div>
          <div style="font-size:13px;font-weight:700;color:var(--text)">Inicio</div>
          <div style="font-size:11px;color:var(--text3)">Ir al dashboard</div>
        </div>
        <div class="ayuda-quick-card" onclick="nav('rentas')" style="cursor:pointer;background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .2s">
          <div style="font-size:28px;margin-bottom:6px">ğŸ¢</div>
          <div style="font-size:13px;font-weight:700;color:var(--text)">Propiedades</div>
          <div style="font-size:11px;color:var(--text3)">Ir a propiedades</div>
        </div>
        <div class="ayuda-quick-card" onclick="nav('clientes')" style="cursor:pointer;background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .2s">
          <div style="font-size:28px;margin-bottom:6px">ğŸ‘¥</div>
          <div style="font-size:13px;font-weight:700;color:var(--text)">Clientes</div>
          <div style="font-size:11px;color:var(--text3)">Ir a clientes</div>
        </div>
        <div class="ayuda-quick-card" onclick="nav('alertas')" style="cursor:pointer;background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .2s">
          <div style="font-size:28px;margin-bottom:6px">âš ï¸</div>
          <div style="font-size:13px;font-weight:700;color:var(--text)">Alertas</div>
          <div style="font-size:11px;color:var(--text3)">Ir a alertas</div>
        </div>
        <div class="ayuda-quick-card" onclick="nav('pagos')" style="cursor:pointer;background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .2s">
          <div style="font-size:28px;margin-bottom:6px">âš™ï¸</div>
          <div style="font-size:13px;font-weight:700;color:var(--text)">ConfiguraciÃ³n</div>
          <div style="font-size:11px;color:var(--text3)">Ir a config</div>
        </div>
        <div class="ayuda-quick-card" onclick="nav('extra')" style="cursor:pointer;background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:14px;text-align:center;transition:all .2s">
          <div style="font-size:28px;margin-bottom:6px">ğŸ“„</div>
          <div style="font-size:13px;font-weight:700;color:var(--text)">Extra</div>
          <div style="font-size:11px;color:var(--text3)">Ir a documentos</div>
        </div>
      </div>

      <!-- Help sections -->
      <div id="ayuda-sections" style="display:flex;flex-direction:column;gap:12px">

        <div class="ayuda-section" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
          <div class="ayuda-section-header" onclick="toggleAyuda(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:700;font-size:15px;color:var(--text)">
            <span style="font-size:22px">ğŸ </span> Inicio (Dashboard)
            <span style="margin-left:auto;font-size:18px;transition:transform .2s" class="ayuda-chevron">â–¸</span>
          </div>
          <div class="ayuda-section-body" style="display:none;padding:0 20px 16px;font-size:13px;line-height:1.8;color:var(--text2)">
            <p>Tu panel principal con 3 tarjetas interactivas:</p>
            <p>â€¢ <b>ğŸ  Mi Portafolio:</b> Muestra Total, Rentadas y Sin rentar. Cada nÃºmero es clickeable y te lleva a Propiedades filtradas. TambiÃ©n muestra tu % de ocupaciÃ³n.</p>
            <p>â€¢ <b>ğŸ’° Ingresos mensuales:</b> Muestra el ingreso Actual (lo que cobras hoy) vs el Potencial (si todo estuviera rentado).</p>
            <p>â€¢ <b>â³ Cobranza pendiente:</b> Muestra el total Por cobrar y el monto de rentas Atrasadas. Da clic en Atrasadas para ir directo a esas propiedades.</p>
            <p style="margin-top:8px">Abajo verÃ¡s las tablas de <b>Por tipo</b> (con totales por categorÃ­a) y <b>Estado de pagos</b> (Al dÃ­a, A favor, Parcial, Atrasado). Da clic en cualquier fila para filtrar.</p>
            <p style="margin-top:8px"><b>ğŸ’³ Ingresos por forma de pago:</b></p>
            <p>â€¢ Muestra un resumen de cobros por cada forma de pago: esperado, cobrado y pendiente.</p>
            <p>â€¢ Cada fila tiene una barra de progreso con colores segÃºn el porcentaje cobrado (verde, amarillo, rojo).</p>
            <p>â€¢ Da clic en una fila para ir a Propiedades filtradas por esa forma de pago.</p>
            <p>â€¢ Da clic en el monto "cobrado" para ver el detalle de todos los abonos recibidos con esa forma de pago en el mes.</p>
            <div style="margin-top:10px"><button class="btn btn-ghost" style="font-size:12px" onclick="nav('dashboard')">ğŸ  Ir a Inicio â†’</button></div>
          </div>
        </div>

        <div class="ayuda-section" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
          <div class="ayuda-section-header" onclick="toggleAyuda(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:700;font-size:15px;color:var(--text)">
            <span style="font-size:22px">ğŸ¢</span> Propiedades
            <span style="margin-left:auto;font-size:18px;transition:transform .2s" class="ayuda-chevron">â–¸</span>
          </div>
          <div class="ayuda-section-body" style="display:none;padding:0 20px 16px;font-size:13px;line-height:1.8;color:var(--text2)">
            <p><b>Agregar propiedad:</b></p>
            <p>1. Da clic en <b>+ Agregar Propiedad</b></p>
            <p>2. Escribe el nombre (ej: "Depto 3B Torre Ãmbar")</p>
            <p>3. Selecciona el tipo: Casa, Departamento, Local, etc.</p>
            <p>4. Pon el monto de renta mensual y fecha de pago</p>
            <p>5. Asigna un inquilino (si ya lo tienes en Clientes)</p>
            <p>6. Guarda</p>
            <p style="margin-top:8px"><b>ğŸ“‹ Historial de pagos al dar de alta:</b></p>
            <p>Si el inquilino tiene un contrato que iniciÃ³ en meses anteriores, al crear la propiedad aparecerÃ¡ una secciÃ³n para indicar si ya pagÃ³ los meses previos. Puedes marcar "Al dÃ­a" (genera abonos automÃ¡ticos por todos los meses) o "Tiene deuda" (indica cuÃ¡ntos meses debe). Esto evita que aparezca como atrasado al darlo de alta.</p>
            <p style="margin-top:8px"><b>Filtros:</b> Arriba verÃ¡s chips para filtrar: Todas, ğŸ”´ Atrasadas, ğŸ”¶ Parciales, âœ… Al dÃ­a, ğŸ”“ Sin rentar. Abajo hay una barra de bÃºsqueda y botones para cambiar entre vista cuadrÃ­cula y lista.</p>
            <p style="margin-top:8px"><b>Agrupadas por tipo:</b> Las propiedades se agrupan por tipo. Cada grupo muestra su Ã­cono, nombre, cantidad y monto total.</p>
            <p style="margin-top:8px"><b>Registrar un pago:</b></p>
            <p>1. Da clic en la tarjeta de la propiedad</p>
            <p>2. Da clic en <b>+ Registrar abono</b></p>
            <p>3. Si el cliente factura, verÃ¡s el panel de <b>Llenado rÃ¡pido</b>: usa los botones + y âˆ’ para elegir cuÃ¡ntos meses paga y el monto se llena automÃ¡ticamente con el desglose fiscal</p>
            <p>4. Si no factura, usa el mismo panel para llenar por meses de renta</p>
            <p>5. Completa fecha, forma de pago y mes que cubre</p>
            <p>6. <b>ğŸ“ Comprobante (opcional):</b> Puedes adjuntar una foto o archivo del comprobante de pago. Selecciona un archivo desde tu dispositivo o toma una foto directamente con la cÃ¡mara. La imagen se comprime automÃ¡ticamente para no ocupar espacio.</p>
            <p>7. Guarda y el estado se actualiza automÃ¡ticamente</p>
            <p style="margin-top:8px"><b>ğŸ“ Ver comprobantes:</b> En el historial de abonos, los pagos con comprobante muestran un botÃ³n "ğŸ“ Ver" para abrir la imagen en grande y descargarla.</p>
            <p style="margin-top:8px"><b>Estados:</b> âœ… Al dÃ­a Â· âœ¨ Saldo a favor Â· ğŸ”¶ Parcial Â· ğŸ”´ Atrasado Â· ğŸ”“ Sin rentar</p>
            <div style="margin-top:10px"><button class="btn btn-ghost" style="font-size:12px" onclick="nav('rentas')">ğŸ¢ Ir a Propiedades â†’</button></div>
          </div>
        </div>

        <div class="ayuda-section" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
          <div class="ayuda-section-header" onclick="toggleAyuda(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:700;font-size:15px;color:var(--text)">
            <span style="font-size:22px">ğŸ‘¥</span> Clientes
            <span style="margin-left:auto;font-size:18px;transition:transform .2s" class="ayuda-chevron">â–¸</span>
          </div>
          <div class="ayuda-section-body" style="display:none;padding:0 20px 16px;font-size:13px;line-height:1.8;color:var(--text2)">
            <p><b>Agregar cliente:</b></p>
            <p>1. Da clic en <b>+ Nuevo cliente</b></p>
            <p>2. Llena nombre, telÃ©fono, email, direcciÃ³n</p>
            <p>3. Agrega datos del aval (nombre y telÃ©fono)</p>
            <p>4. Asigna una propiedad y el monto/fecha de pago</p>
            <p>5. Puedes subir documentos (INE, comprobante, contrato) o escanearlos con la cÃ¡mara</p>
            <p style="margin-top:8px"><b>FacturaciÃ³n y desglose fiscal:</b></p>
            <p>1. Activa el toggle de "Requiere factura"</p>
            <p>2. Llena RFC, razÃ³n social, rÃ©gimen fiscal, uso de CFDI</p>
            <p>3. En el <b>Desglose de pago mensual</b>, ingresa el Subtotal (renta base)</p>
            <p>4. El sistema calcula automÃ¡ticamente: IVA (16%), RetenciÃ³n ISR y RetenciÃ³n IVA segÃºn el rÃ©gimen</p>
            <p>5. El <b>Neto a depositar</b> es lo que realmente paga el inquilino</p>
            <p>6. Al registrar abonos, el llenado rÃ¡pido usarÃ¡ estos montos automÃ¡ticamente</p>
            <p style="margin-top:8px"><b>Tip:</b> Para RESICO (625), el ISR es 1.25% y no hay retenciÃ³n de IVA. Para personas morales, ISR 10% y retenciÃ³n IVA 2/3.</p>
            <div style="margin-top:10px"><button class="btn btn-ghost" style="font-size:12px" onclick="nav('clientes')">ğŸ‘¥ Ir a Clientes â†’</button></div>
          </div>
        </div>

        <div class="ayuda-section" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
          <div class="ayuda-section-header" onclick="toggleAyuda(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:700;font-size:15px;color:var(--text)">
            <span style="font-size:22px">âš ï¸</span> Alertas de cobro
            <span style="margin-left:auto;font-size:18px;transition:transform .2s" class="ayuda-chevron">â–¸</span>
          </div>
          <div class="ayuda-section-body" style="display:none;padding:0 20px 16px;font-size:13px;line-height:1.8;color:var(--text2)">
            <p>Muestra <b>propiedades con pagos pendientes</b>, incluyendo atrasadas y parciales con plazo vencido.</p>
            <p>â€¢ <b>ğŸ”´ Requiere acciÃ³n:</b> Pagos totalmente vencidos sin seguimiento</p>
            <p>â€¢ <b>ğŸŸ¡ En espera:</b> Ya agendaste una fecha de compromiso de pago</p>
            <p>â€¢ <b>ğŸŸ  Dentro de plazo:</b> Parciales que aÃºn estÃ¡n en periodo de gracia</p>
            <p style="margin-top:8px"><b>ğŸ“ Nota:</b> Registra tus gestiones de cobro. Ej: "HablÃ© con el inquilino, dice que paga el viernes".</p>
            <p><b>ğŸ“… Reagendar:</b> Pon una fecha futura para dar seguimiento. La alerta pasarÃ¡ a amarilla.</p>
            <p style="margin-top:8px"><b>Tip:</b> El nÃºmero en el menÃº te dice cuÃ¡ntas alertas activas hay. TambiÃ©n puedes llegar aquÃ­ desde la tarjeta de Cobranza en el Dashboard.</p>
            <div style="margin-top:10px"><button class="btn btn-ghost" style="font-size:12px" onclick="nav('alertas')">âš ï¸ Ir a Alertas â†’</button></div>
          </div>
        </div>

        <div class="ayuda-section" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
          <div class="ayuda-section-header" onclick="toggleAyuda(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:700;font-size:15px;color:var(--text)">
            <span style="font-size:22px">âš™ï¸</span> ConfiguraciÃ³n
            <span style="margin-left:auto;font-size:18px;transition:transform .2s" class="ayuda-chevron">â–¸</span>
          </div>
          <div class="ayuda-section-body" style="display:none;padding:0 20px 16px;font-size:13px;line-height:1.8;color:var(--text2)">
            <p><b>ğŸ’³ Formas de pago:</b> Agrega o edita mÃ©todos de pago (efectivo, transferencia, depÃ³sito, tarjeta).</p>
            <p><b>ğŸ—ï¸ Tipos de propiedad:</b> Crea categorÃ­as personalizadas como "Plaza JuÃ¡rez" para agrupar locales en el dashboard.</p>
            <p><b>ğŸ”§ Tipos de gasto:</b> CategorÃ­as para gastos: mantenimiento, luz, agua, predial, etc.</p>
            <p><b>ğŸ‘¤ Usuarios:</b> Con plan Pro o Enterprise, crea usuarios adicionales con permisos limitados.</p>
            <p><b>ğŸ’¾ Respaldos:</b> Tres opciones separadas:</p>
            <p>&nbsp;&nbsp;1. <b>Exportar datos</b> â€” Descarga todos tus datos en un archivo JSON</p>
            <p>&nbsp;&nbsp;2. <b>Importar datos</b> â€” Restaura un respaldo completo (se sube a Firebase automÃ¡ticamente)</p>
            <p>&nbsp;&nbsp;3. <b>Importar abonos desde Excel</b> â€” Descarga la plantilla, llÃ©nala y sube pagos masivos</p>
            <div style="margin-top:10px"><button class="btn btn-ghost" style="font-size:12px" onclick="nav('pagos')">âš™ï¸ Ir a ConfiguraciÃ³n â†’</button></div>
          </div>
        </div>

        <div class="ayuda-section" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
          <div class="ayuda-section-header" onclick="toggleAyuda(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:700;font-size:15px;color:var(--text)">
            <span style="font-size:22px">ğŸ“„</span> Extra (Documentos legales)
            <span style="margin-left:auto;font-size:18px;transition:transform .2s" class="ayuda-chevron">â–¸</span>
          </div>
          <div class="ayuda-section-body" style="display:none;padding:0 20px 16px;font-size:13px;line-height:1.8;color:var(--text2)">
            <p>Genera documentos legales automÃ¡ticamente con los datos de la propiedad e inquilino:</p>
            <p>â€¢ <b>ğŸ“ Contrato de arrendamiento</b> â€” Listo para firmar</p>
            <p>â€¢ <b>ğŸ  Ficha de presentaciÃ³n</b> â€” Para publicar la propiedad</p>
            <p>â€¢ <b>ğŸ”‘ Acta de entrega</b> â€” Estado de la propiedad al inicio</p>
            <p>â€¢ <b>ğŸ’° Recibo de depÃ³sito</b> â€” DepÃ³sito en garantÃ­a</p>
            <p>â€¢ <b>ğŸšª Acta de devoluciÃ³n</b> â€” Cuando el inquilino sale</p>
            <p>â€¢ <b>âš–ï¸ RescisiÃ³n de contrato</b> â€” Por incumplimiento</p>
            <p style="margin-top:8px">Solo selecciona la propiedad y da clic en el documento que necesitas.</p>
            <div style="margin-top:10px"><button class="btn btn-ghost" style="font-size:12px" onclick="nav('extra')">ğŸ“„ Ir a Extra â†’</button></div>
          </div>
        </div>

        <div class="ayuda-section" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden">
          <div class="ayuda-section-header" onclick="toggleAyuda(this)" style="padding:16px 20px;cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:700;font-size:15px;color:var(--text)">
            <span style="font-size:22px">ğŸ’¡</span> Consejos Ãºtiles
            <span style="margin-left:auto;font-size:18px;transition:transform .2s" class="ayuda-chevron">â–¸</span>
          </div>
          <div class="ayuda-section-body" style="display:none;padding:0 20px 16px;font-size:13px;line-height:1.8;color:var(--text2)">
            <p>ğŸ“± <b>Instala la app:</b> Desde el navegador del celular puedes instalar GestorRenta como app nativa.</p>
            <p>ğŸ‘† <b>Usa huella dactilar:</b> Registra tu huella para entrar rÃ¡pido sin contraseÃ±a.</p>
            <p>ğŸ“‹ <b>Revisa Alertas a diario:</b> El badge rojo en el menÃº te dice cuÃ¡ntas hay pendientes.</p>
            <p>ğŸ’° <b>Llenado rÃ¡pido de abonos:</b> Al registrar pagos, usa los botones + y âˆ’ para seleccionar meses. Si el cliente factura, el desglose fiscal se aplica automÃ¡tico.</p>
            <p>ğŸ“ <b>Adjunta comprobantes:</b> Al registrar un abono puedes tomar foto o seleccionar el comprobante de pago. Se comprime automÃ¡ticamente para no ocupar espacio. DespuÃ©s puedes verlo o descargarlo desde el historial de abonos.</p>
            <p>ğŸ“Š <b>Dashboard interactivo:</b> Todos los nÃºmeros del dashboard son clickeables. Toca cualquiera para ir al detalle.</p>
            <p>ğŸ’³ <b>Ingresos por forma de pago:</b> En el Dashboard puedes ver cuÃ¡nto se ha cobrado por cada mÃ©todo de pago, con barras de progreso y acceso al detalle de cada abono.</p>
            <p>ğŸ—ï¸ <b>Crea tipos personalizados:</b> Si tienes plazas, crea tipos como "Plaza JuÃ¡rez" en ConfiguraciÃ³n.</p>
            <p>ğŸ“‹ <b>Alta de inquilinos existentes:</b> Si das de alta un inquilino con contrato iniciado hace meses, el sistema te pregunta si ya pagÃ³ los meses anteriores para generar el historial automÃ¡ticamente.</p>
            <p>ğŸ’¾ <b>Haz respaldos semanales:</b> Descarga un respaldo JSON desde ConfiguraciÃ³n. Al importar, los datos se sincronizan automÃ¡ticamente a Firebase.</p>
            <p>ğŸ” <b>Usa filtros:</b> En Propiedades puedes filtrar por estado, forma de pago y buscar por nombre. Los filtros del dashboard tambiÃ©n te llevan directo.</p>
          </div>
        </div>

      </div>

    </div>

  </main>
</div>

<!-- MODAL: Nueva Renta -->
<div class="modal-overlay" id="modalRenta">
  <div class="modal">
    <div class="modal-title">Agregar Propiedad</div>
    <div class="form-grid">
      <div class="form-group full">
        <label>Nombre / DirecciÃ³n de la propiedad</label>
        <input id="r-nombre" placeholder="Ej: Depto 3B - Av. Reforma 120" />
      </div>
      <div class="form-group">
        <label>Tipo de propiedad</label>
        <select id="r-tipo">
          <option>Departamento</option>
          <option>Casa</option>
          <option>Local comercial</option>
          <option>Bodega</option>
          <option>Oficina</option>
          <option>Otro</option>
        </select>
      </div>
      <div class="form-group">
        <label>Cliente / Inquilino</label>
        <select id="r-cliente"><option value="">â€” Seleccionar â€”</option></select>
      </div>
      <div class="form-group">
        <label>Precio de renta ($)</label>
        <input id="r-monto" type="number" placeholder="5000" oninput="updateHistPreview()" />
      </div>

      <div class="form-group full">
        <label>Notas adicionales de la propiedad</label>
        <textarea id="r-notas" placeholder="Ej: 2 recÃ¡maras, 1 baÃ±o, estacionamiento incluido..."></textarea>
      </div>

      <!-- Incremento anual -->
      <div class="form-group">
        <label>ğŸ“ˆ Incremento anual (%)</label>
        <input id="r-incremento-pct" type="number" placeholder="Ej: 5" min="0" max="100" step="0.5" />
      </div>
      <div class="form-group">
        <label>Fecha prÃ³ximo incremento</label>
        <input id="r-incremento-fecha" type="date" />
      </div>

      <!-- DepÃ³sito en garantÃ­a -->
      <div class="form-group">
        <label>ğŸ’° DepÃ³sito en garantÃ­a ($)</label>
        <input id="r-deposito-monto" type="number" placeholder="Ej: 10000" min="0" />
      </div>
      <div class="form-group">
        <label>Fecha del depÃ³sito</label>
        <input id="r-deposito-fecha" type="date" />
      </div>
      <!-- Entidad emisora para facturaciÃ³n -->
      <div class="form-group full">
        <label>ğŸ§¾ Entidad emisora (facturaciÃ³n)</label>
        <select id="r-emisor-id" style="font-size:13px">
          <option value="">â€” Sin facturaciÃ³n â€”</option>
        </select>
        <div style="font-size:10px;color:var(--text3);margin-top:3px">Selecciona desde quÃ© persona fÃ­sica o moral se factura esta propiedad</div>
      </div>

      <!-- SecciÃ³n: Historial de pagos al dar de alta -->
      <div id="r-historial-section" class="form-group full" style="display:none;margin-top:4px">
        <div style="background:var(--warning-light);border:1px solid rgba(183,121,31,0.3);border-radius:10px;padding:14px">
          <div style="font-size:12px;font-weight:700;color:var(--warning);margin-bottom:10px">ğŸ“‹ Historial de pagos del inquilino</div>
          <div style="font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.5">
            Si el contrato empezÃ³ hace meses, indica si el inquilino ya pagÃ³ las mensualidades anteriores para que el sistema no las marque como adeudo.
          </div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--text);text-transform:none;letter-spacing:0">
              <input type="radio" name="r-hist-tipo" value="al-dia" checked onchange="toggleHistDeuda()">
              <span>âœ… <strong>Al dÃ­a</strong> â€” ya pagÃ³ todo hasta hoy</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--text);text-transform:none;letter-spacing:0">
              <input type="radio" name="r-hist-tipo" value="debe" onchange="toggleHistDeuda()">
              <span>âš ï¸ <strong>Tiene deuda</strong> â€” debe algunos meses</span>
            </label>
          </div>
          <div id="r-hist-deuda-detail" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid rgba(183,121,31,0.2)">
            <label style="font-size:12px;color:var(--text2);text-transform:none;letter-spacing:0;margin-bottom:6px;display:block">Â¿CuÃ¡ntos meses debe?</label>
            <div style="display:flex;align-items:center;gap:10px">
              <button type="button" class="btn btn-ghost" style="padding:6px 12px;font-size:16px" onclick="ajustarMesesDeuda(-1)">âˆ’</button>
              <span id="r-hist-meses-debe" style="font-family:'DM Mono',monospace;font-size:22px;font-weight:800;color:var(--danger);min-width:40px;text-align:center">1</span>
              <button type="button" class="btn btn-ghost" style="padding:6px 12px;font-size:16px" onclick="ajustarMesesDeuda(1)">+</button>
              <span style="font-size:12px;color:var(--text3)">mes(es) sin pagar</span>
            </div>
            <div id="r-hist-preview" style="font-size:11px;color:var(--text3);margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalRenta')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarRenta()">Guardar Propiedad</button>
    </div>
  </div>
</div>

<!-- MODAL: Nuevo Cliente -->
<div class="modal-overlay" id="modalCliente">
  <div class="modal" style="width:600px;max-width:98vw">
    <div class="modal-title">Nuevo Cliente</div>

    <!-- Tabs -->
    <div class="modal-tabs">
      <button class="modal-tab active" id="ctab-btn-datos" onclick="switchClienteTab('datos')">ğŸ‘¤ Datos</button>
      <button class="modal-tab" id="ctab-btn-docs" onclick="switchClienteTab('docs')">ğŸ“ Documentos</button>
      <button class="modal-tab" id="ctab-btn-contrato" onclick="switchClienteTab('contrato')">ğŸ“„ Contrato</button>
      <button class="modal-tab" id="ctab-btn-factura" onclick="switchClienteTab('factura')">ğŸ§¾ FacturaciÃ³n</button>
    </div>

    <!-- TAB: Datos -->
    <div class="modal-tab-panel active" id="ctab-datos">
    <div style="display:flex;gap:16px;align-items:flex-start;margin-bottom:14px">
      <div>
        <label style="display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:6px">Foto</label>
        <div id="c-foto-preview" class="foto-placeholder" onclick="document.getElementById('c-foto-file').click()" title="Agregar foto">ğŸ‘¤</div>
        <input type="file" id="c-foto-file" accept="image/*" style="display:none" onchange="cargarFotoCliente(this)" />
        <input type="hidden" id="c-foto-data" />
        <div style="font-size:10px;color:var(--text3);margin-top:4px;text-align:center">Toca para cambiar</div>
      </div>
      <div class="form-grid" style="flex:1;margin:0">
        <div class="form-group">
          <label>Nombre completo *</label>
          <input id="c-nombre" placeholder="Nombre del inquilino" />
        </div>
        <div class="form-group">
          <label>TelÃ©fono</label>
          <input id="c-tel" placeholder="614-123-4567" />
        </div>
        <div class="form-group">
          <label>Correo electrÃ³nico</label>
          <input id="c-email" type="email" placeholder="correo@ejemplo.com" />
        </div>
      </div>
    </div>
    <!-- nacimiento removed -->
    <div class="form-grid">
      <div class="form-group full">
        <label>DirecciÃ³n</label>
        <input id="c-direccion" placeholder="Calle, No., Col., Ciudad" />
      </div>
      <div class="form-group">
        <label>Nombre del aval</label>
        <input id="c-aval-nombre" placeholder="Nombre completo del aval" />
      </div>
      <div class="form-group">
        <label>TelÃ©fono del aval</label>
        <input id="c-aval-tel" placeholder="614-000-0000" />
      </div>
      <div class="form-group full">
        <label>Notas / Referencias</label>
        <textarea id="c-notas" placeholder="Observaciones, referencias, etc."></textarea>
      </div>

      <!-- WhatsApp Reminders -->
      <div class="form-group full" style="border-top:1px solid var(--border);padding-top:16px;margin-top:8px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:18px">ğŸ’¬</span>
            <div>
              <div style="font-size:13px;font-weight:700;color:var(--text)">Recordatorios WhatsApp</div>
              <div style="font-size:11px;color:var(--text3)">Mensajes automÃ¡ticos de cobro</div>
            </div>
          </div>
          <div id="c-wa-toggle" onclick="toggleWaReminders()" style="width:44px;height:24px;background:var(--border);border-radius:12px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0">
            <div id="c-wa-thumb" style="width:20px;height:20px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:left .2s;box-shadow:0 1px 4px rgba(0,0,0,.3)"></div>
          </div>
        </div>

        <div id="c-wa-config" style="display:none">
          <!-- Mensaje 1 -->
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div style="font-size:12px;font-weight:700;color:var(--accent)">ğŸ“© Mensaje 1 â€” Recordatorio</div>
            </div>
            <div style="margin-bottom:8px">
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;font-weight:600">Â¿CuÃ¡ndo enviar?</label>
              <select id="c-wa-msg1-when" style="width:100%;font-size:12px;padding:6px 10px" onchange="toggleWaCustomDays(1)">
                <option value="dia_pago">El dÃ­a de pago</option>
                <option value="antes_vencimiento" selected>DÃ­as antes del vencimiento</option>
                <option value="dia_vencimiento">El dÃ­a de vencimiento</option>
              </select>
            </div>
            <div id="c-wa-msg1-days-wrap" style="margin-bottom:8px">
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;font-weight:600">Â¿CuÃ¡ntos dÃ­as antes?</label>
              <input id="c-wa-msg1-days" type="number" min="1" max="30" value="3" style="width:80px;text-align:center;font-size:13px;padding:6px" />
            </div>
            <div>
              <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;font-weight:600">Mensaje (puedes editar)</label>
              <textarea id="c-wa-msg1-text" rows="4" style="width:100%;font-size:12px;line-height:1.5;padding:8px 10px;border-radius:8px;border:1px solid var(--border);resize:vertical" placeholder="Escribe tu mensaje...">Hola {nombre}, te recordamos que tu pago de renta por {monto} de la propiedad {propiedad} estÃ¡ prÃ³ximo. La fecha lÃ­mite es el dÃ­a {dia_vencimiento} de este mes. Â¡Gracias por tu puntualidad!</textarea>
              <div style="font-size:10px;color:var(--text3);margin-top:4px">Variables: {nombre}, {monto}, {propiedad}, {mes}, {dia_pago}, {dia_vencimiento}, {saldo}</div>
            </div>
          </div>

          <!-- Mensaje 2 -->
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div style="font-size:12px;font-weight:700;color:var(--danger)">ğŸ“© Mensaje 2 â€” Cobro vencido</div>
              <div id="c-wa-msg2-toggle" onclick="toggleWaMsg2()" style="width:38px;height:20px;background:var(--border);border-radius:10px;position:relative;cursor:pointer;transition:background .2s;flex-shrink:0">
                <div id="c-wa-msg2-thumb" style="width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)"></div>
              </div>
            </div>
            <div id="c-wa-msg2-config" style="display:none">
              <div style="margin-bottom:8px">
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;font-weight:600">Â¿CuÃ¡ndo enviar?</label>
                <select id="c-wa-msg2-when" style="width:100%;font-size:12px;padding:6px 10px" onchange="toggleWaCustomDays(2)">
                  <option value="dia_vencimiento">El dÃ­a de vencimiento</option>
                  <option value="despues_vencimiento" selected>DÃ­as despuÃ©s del vencimiento</option>
                </select>
              </div>
              <div id="c-wa-msg2-days-wrap" style="margin-bottom:8px">
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;font-weight:600">Â¿CuÃ¡ntos dÃ­as despuÃ©s?</label>
                <input id="c-wa-msg2-days" type="number" min="1" max="30" value="3" style="width:80px;text-align:center;font-size:13px;padding:6px" />
              </div>
              <div>
                <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px;font-weight:600">Mensaje (puedes editar)</label>
                <textarea id="c-wa-msg2-text" rows="4" style="width:100%;font-size:12px;line-height:1.5;padding:8px 10px;border-radius:8px;border:1px solid var(--border);resize:vertical" placeholder="Escribe tu mensaje...">Hola {nombre}, tu pago de renta por {monto} de la propiedad {propiedad} correspondiente a {mes} se encuentra vencido. Tu saldo pendiente es de {saldo}. Te pedimos realizar tu pago a la brevedad. Quedo al pendiente para cualquier duda.</textarea>
                <div style="font-size:10px;color:var(--text3);margin-top:4px">Variables: {nombre}, {monto}, {propiedad}, {mes}, {dia_pago}, {dia_vencimiento}, {saldo}</div>
              </div>
            </div>
            <div id="c-wa-msg2-off" style="font-size:11px;color:var(--text3)">Segundo mensaje desactivado. ActÃ­valo con el switch â†’</div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>ğŸ  Propiedad que renta</label>
        <select id="c-propiedad" style="font-size:14px" onfocus="populatePropiedadSelectCliente()" onchange="onClientePropiedadChange();generarConceptoPreview()">
          <option value="">â€” Sin propiedad asignada â€”</option>
        </select>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">Al guardar queda ligado automÃ¡ticamente</div>
      </div>
      <div class="form-group">
        <label>ğŸ“… Fecha de pago</label>
        <input id="c-dia" type="number" min="1" max="31" placeholder="Ej: 5" />
        <div style="font-size:11px;color:var(--text3);margin-top:4px">DÃ­a del mes en que debe pagar</div>
      </div>
      <div class="form-group">
        <label>ğŸ“† Inicio de contrato</label>
        <input id="c-inicio-contrato" type="date" />
      </div>
      <div class="form-group">
        <label>ğŸ Fin de contrato</label>
        <input id="c-fin-contrato" type="date" />
        <div style="font-size:11px;color:var(--text3);margin-top:4px">Si vence y sigue rentando se renueva automÃ¡ticamente</div>
      </div>
      <div class="form-group full">
        <label>ğŸ’² Monto de renta mensual ($)</label>
        <input id="c-monto-renta" type="number" placeholder="Ej: 5000" oninput="checkMontoCambio()" />
        <div id="c-monto-info" style="font-size:11px;color:var(--text3);margin-top:4px">Se actualizarÃ¡ en la propiedad vinculada al guardar</div>
        <!-- Fecha de aplicaciÃ³n â€” aparece si cambia el monto -->
        <div id="c-monto-fecha-wrap" style="display:none;margin-top:10px;padding:10px 12px;background:#fff8e1;border:1px solid #f6c84b;border-radius:8px">
          <div style="font-size:12px;font-weight:600;color:#7c4a03;margin-bottom:6px">âš ï¸ EstÃ¡s cambiando el monto de renta</div>
          <label style="font-size:12px;color:#7c4a03;display:block;margin-bottom:4px">Â¿A partir de quÃ© fecha aplica este nuevo monto?</label>
          <input id="c-monto-fecha" type="date" style="font-size:13px;padding:6px 10px;border:1px solid #f6c84b;border-radius:6px;background:#fffdf0;width:100%" />
          <div style="font-size:11px;color:#a06020;margin-top:4px">Los perÃ­odos anteriores a esta fecha seguirÃ¡n con el monto anterior.</div>
        </div>
      </div>

      <!-- â”€â”€ Deuda existente â”€â”€ -->
      <div class="form-group full" id="c-deuda-wrap">
        <div style="display:flex;align-items:center;gap:10px;margin-top:8px;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;cursor:pointer" onclick="document.getElementById('c-tiene-deuda').checked=!document.getElementById('c-tiene-deuda').checked;toggleDeudaCliente()">
          <label class="toggle-switch" style="flex-shrink:0" onclick="event.stopPropagation()">
            <input type="checkbox" id="c-tiene-deuda" onchange="toggleDeudaCliente()">
            <span class="toggle-track"></span>
          </label>
          <div>
            <div style="font-size:13px;font-weight:600;color:var(--text)">ğŸ’° El inquilino tiene deuda acumulada</div>
            <div style="font-size:11px;color:var(--text3)">Si ya debÃ­a meses al momento de darlo de alta</div>
          </div>
        </div>
        <div id="c-deuda-fields" style="display:none;margin-top:10px;padding:14px;background:#fef9ec;border:1px solid rgba(183,121,31,0.3);border-radius:10px">
          <div class="form-grid" style="gap:12px">
            <div class="form-group">
              <label>Meses que debe</label>
              <input id="c-deuda-meses" type="number" min="1" max="36" placeholder="Ej: 3" />
            </div>
            <div class="form-group">
              <label>Monto total adeudado ($)</label>
              <input id="c-deuda-monto" type="number" placeholder="Se calcula automÃ¡tico" />
              <div style="font-size:10px;color:var(--text3);margin-top:2px">Si es distinto al monto Ã— meses, ajÃºstalo</div>
            </div>
          </div>
          <div style="font-size:11px;color:#7c4a03;margin-top:8px;line-height:1.5">âš¡ Al guardar se generarÃ¡n abonos automÃ¡ticos por los meses <strong>ya pagados</strong> desde el inicio del contrato, marcados como "Alta automÃ¡tica". Los meses adeudados quedarÃ¡n sin abonar.</div>
        </div>
      </div>

    </div>
    </div><!-- /ctab-datos -->

    <!-- TAB: Documentos (INE, comprobantes, etc.) -->
    <div class="modal-tab-panel" id="ctab-docs">
      <div id="docs-list" style="display:flex;flex-direction:column;gap:10px;margin-bottom:14px"></div>
      <label class="btn btn-ghost" style="cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-size:13px">
        ğŸ“ Agregar documento
        <input type="file" id="c-doc-file" accept=".pdf,.jpg,.jpeg,.png,.webp"
          style="display:none" multiple onchange="agregarDocumentoCliente(this)" />
      </label>
      <div style="font-size:11px;color:var(--text3);margin-top:8px">INE, comprobante de domicilio, referencias, etc. (PDF o imagen, mÃ¡x 8 MB c/u)</div>
    </div>

    <!-- TAB: Contrato -->
    <div class="modal-tab-panel" id="ctab-contrato">

      <!-- Estado: sin archivo -->
      <div id="contrato-empty" style="text-align:center;padding:36px 20px">
        <div style="font-size:48px;margin-bottom:12px">ğŸ“‚</div>
        <div style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px">Sin contrato adjunto</div>
        <div style="font-size:13px;color:var(--text3);margin-bottom:20px">Sube el contrato firmado escaneado<br>(PDF, JPG, PNG â€” mÃ¡x. 8 MB)</div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <label class="btn btn-primary" style="cursor:pointer;display:inline-flex;align-items:center;gap:8px">
            ğŸ“ Seleccionar archivo
            <input type="file" id="c-contrato-file" accept=".pdf,.jpg,.jpeg,.png,.webp"
              style="display:none" onchange="cargarContratoArchivo(this)" />
          </label>
          <!-- Input nativo para iOS (capture="environment") -->
          <input type="file" id="scan-native-input"
            accept="image/*" capture="environment" multiple
            style="display:none" onchange="scanNativoHandler(this)" />
          <button class="btn btn-secondary" style="display:inline-flex;align-items:center;gap:8px" onclick="abrirEscanerAdaptivo()">
            ğŸ“· Escanear con cÃ¡mara
          </button>
        </div>
      </div>

      <!-- Estado: archivo cargado -->
      <div id="contrato-loaded" style="display:none">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <div style="display:flex;align-items:center;gap:10px">
            <span id="contrato-file-icon" style="font-size:28px">ğŸ“„</span>
            <div>
              <div style="font-weight:600;font-size:14px" id="contrato-filename">archivo.pdf</div>
              <div style="font-size:11px;color:var(--text3)" id="contrato-filesize">â€”</div>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px" onclick="verContratoArchivo()">ğŸ‘ï¸ Ver</button>
            <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px" onclick="descargarContratoArchivo()">â¬‡ï¸ Descargar</button>
            <label class="btn btn-ghost" style="font-size:12px;padding:5px 12px;cursor:pointer">
              ğŸ”„ Reemplazar
              <input type="file" accept=".pdf,.jpg,.jpeg,.png,.webp"
                style="display:none" onchange="cargarContratoArchivo(this)" />
            </label>
            <button class="btn btn-danger" style="font-size:12px;padding:5px 12px" onclick="clearContrato()">ğŸ—‘ï¸</button>
          </div>
        </div>
        <!-- Preview area -->
        <div id="contrato-preview-wrap" style="border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#f5f5f5;min-height:200px;display:flex;align-items:center;justify-content:center">
          <img id="contrato-preview-img" style="max-width:100%;max-height:420px;display:none;border-radius:10px" />
          <iframe id="contrato-preview-pdf" style="width:100%;height:420px;border:none;display:none"></iframe>
          <div id="contrato-preview-placeholder" style="text-align:center;padding:40px;color:var(--text3)">
            <div style="font-size:40px">ğŸ“„</div>
            <div style="font-size:13px;margin-top:8px">Toca "Ver" para abrir el archivo</div>
          </div>
        </div>
      </div>

      <!-- Input oculto para mantener el base64 -->
      <input type="hidden" id="c-contrato-data" />
      <input type="hidden" id="c-contrato-meta" />

    </div><!-- /ctab-contrato -->

    <!-- TAB: FacturaciÃ³n -->
    <div class="modal-tab-panel" id="ctab-factura">
      <div style="display:flex;align-items:center;gap:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px">
        <label style="text-transform:none;letter-spacing:0;font-size:14px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:10px;flex:1;margin:0">
          <div class="toggle-wrap" onclick="toggleFactura()">
            <input type="checkbox" id="c-factura" style="display:none" />
            <div id="toggle-track" style="width:40px;height:22px;background:var(--border);border-radius:11px;position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0">
              <div id="toggle-thumb" style="width:18px;height:18px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:left 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.4)"></div>
            </div>
          </div>
          ğŸ§¾ Â¿Requiere factura?
        </label>
      </div>
      <div id="factura-section" style="display:none">
        <div class="g2" style="background:var(--surface2);border:1px solid var(--accent);border-radius:12px;padding:20px;gap:14px;">
          <div style="grid-column:1/-1;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:600;margin-bottom:4px">Datos de FacturaciÃ³n</div>
          <div class="form-group full">
            <label>Tipo de persona</label>
            <select id="c-fac-tipo">
              <option value="fisica">Persona FÃ­sica</option>
              <option value="moral">Persona Moral</option>
            </select>
          </div>
          <div class="form-group">
            <label>RFC</label>
            <input id="c-fac-rfc" placeholder="XAXX010101000" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()" />
          </div>
          <div class="form-group">
            <label>RazÃ³n social</label>
            <input id="c-fac-razon" placeholder="Nombre fiscal completo" />
          </div>
          <div class="form-group">
            <label>CÃ³digo postal fiscal</label>
            <input id="c-fac-cp" placeholder="Ej: 06600" maxlength="5" style="font-size:16px;text-align:center;letter-spacing:2px" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,5)" />
          </div>
          <div class="form-group full">
            <label>Correo para envÃ­o de factura</label>
            <input id="c-fac-email" type="email" placeholder="facturacion@empresa.com" />
          </div>
          <div class="form-group">
            <label>Uso de CFDI</label>
            <select id="c-fac-cfdi">
              <option value="G03">G03 - Gastos en general</option>
              <option value="P01">P01 - Por definir</option>
              <option value="D10">D10 - Pagos por servicios educativos</option>
              <option value="S01">S01 - Sin efectos fiscales</option>
              <option value="CP01">CP01 - Pagos</option>
            </select>
          </div>
          <div class="form-group">
            <label>RÃ©gimen fiscal</label>
            <select id="c-fac-regimen" onchange="calcDesglosePreview()">
              <option value="612">612 - Personas FÃ­sicas con Act. Emp.</option>
              <option value="601">601 - General de Ley Personas Morales</option>
              <option value="606">606 - Arrendamiento</option>
              <option value="621">621 - IncorporaciÃ³n Fiscal</option>
              <option value="625">625 - RÃ©gimen Simplificado de Confianza</option>
            </select>
          </div>

          <!-- Desglose fiscal -->
          <div style="grid-column:1/-1;margin-top:8px;border-top:1px solid var(--border);padding-top:16px">
            <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:600;margin-bottom:10px">ğŸ“ Concepto de la factura</div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:8px">Configura el concepto que aparecerÃ¡ por defecto en cada factura. Puedes editarlo antes de timbrar.</div>
            <div class="form-group" style="margin-bottom:8px">
              <label>Tipo de perÃ­odo</label>
              <select id="c-fac-periodo-tipo" onchange="generarConceptoPreview()" style="font-size:12px">
                <option value="mes">Mes completo (Enero 2026)</option>
                <option value="contrato">Por contrato (del 15 al 14 del siguiente)</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom:6px">
              <label>Concepto personalizado</label>
              <textarea id="c-fac-concepto" rows="2" style="width:100%;font-size:12px;resize:vertical" placeholder="Se generarÃ¡ automÃ¡ticamente..."></textarea>
            </div>
            <div style="font-size:10px;color:var(--text3);margin-bottom:6px">Variables disponibles: <code>{propiedad}</code> <code>{mes}</code> <code>{anio}</code> <code>{periodo}</code></div>
            <button type="button" class="btn btn-ghost" style="font-size:11px;padding:4px 10px" onclick="generarConceptoDefault()">ğŸ”„ Regenerar concepto por defecto</button>
            <div id="c-fac-concepto-preview" style="font-size:11px;color:var(--accent);margin-top:6px;font-style:italic"></div>
          </div>

          <div style="grid-column:1/-1;margin-top:8px;border-top:1px solid var(--border);padding-top:16px">
            <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:600;margin-bottom:10px">ğŸ›ï¸ Cuenta predial</div>
            <div style="font-size:11px;color:var(--text3);margin-bottom:8px">NÃºmero de cuenta predial del inmueble. Requerido por el SAT para facturas de arrendamiento.</div>
            <div class="form-group" style="margin-bottom:0">
              <input id="c-fac-predial" placeholder="Ej: 1234567890" style="width:100%;font-size:13px;font-family:'DM Mono',monospace" />
            </div>
          </div>

          <div style="grid-column:1/-1;margin-top:8px;border-top:1px solid var(--border);padding-top:16px">
            <div style="font-size:11px;color:var(--text3);margin-bottom:12px">Configura los impuestos que aplican a la renta de este cliente. El neto es lo que deposita el inquilino.</div>
            <div class="g2">
              <div class="form-group">
                <label>Subtotal (renta)</label>
                <input id="c-fac-subtotal" type="number" placeholder="0" oninput="calcDesgloseFromSubtotal()" />
              </div>
              <div class="form-group">
                <label>IVA trasladado (16%)</label>
                <input id="c-fac-iva" type="number" placeholder="0" style="background:var(--surface2)" readonly />
              </div>
              <div class="form-group">
                <label>RetenciÃ³n ISR
                  <select id="c-fac-ret-isr-pct" onchange="calcDesgloseFromSubtotal()" style="display:inline;width:auto;padding:2px 4px;font-size:11px;margin-left:4px">
                    <option value="0">Sin ret.</option>
                    <option value="10" selected>10%</option>
                    <option value="1.25">1.25% (RESICO)</option>
                  </select>
                </label>
                <input id="c-fac-ret-isr" type="number" placeholder="0" style="background:var(--surface2)" readonly />
              </div>
              <div class="form-group">
                <label>RetenciÃ³n IVA
                  <select id="c-fac-ret-iva-pct" onchange="calcDesgloseFromSubtotal()" style="display:inline;width:auto;padding:2px 4px;font-size:11px;margin-left:4px">
                    <option value="0">Sin ret.</option>
                    <option value="10.6667" selected>2/3 IVA</option>
                  </select>
                </label>
                <input id="c-fac-ret-iva" type="number" placeholder="0" style="background:var(--surface2)" readonly />
              </div>
            </div>
            <div style="margin-top:10px;padding:12px;background:var(--accent-light);border:2px solid var(--accent);border-radius:10px;display:flex;justify-content:space-between;align-items:center">
              <span style="font-weight:700;color:var(--accent);font-size:14px">ğŸ’µ Neto a depositar</span>
              <span id="c-fac-neto-display" style="font-family:'DM Mono',monospace;font-size:22px;font-weight:800;color:var(--accent)">$0</span>
              <input id="c-fac-neto" type="hidden" value="0" />
            </div>
          </div>
        </div>
      </div>
    </div><!-- /ctab-factura -->

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalCliente')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarCliente()">Guardar Cliente</button>
    </div>
  </div>
</div>

<!-- MODAL: Nuevo Abono -->
<div class="modal-overlay" id="modalAbono">
  <div class="modal">
    <div class="modal-title">Registrar Abono</div>
    <!-- Quick fill for factura clients -->
    <div id="abono-quick-fill" style="display:none;margin-bottom:14px;padding:12px;background:var(--accent-light);border:1px solid var(--accent);border-radius:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <span style="font-size:12px;font-weight:700;color:var(--accent)">ğŸ’° Llenado rÃ¡pido</span>
        <div style="display:flex;align-items:center;gap:6px">
          <button class="btn btn-ghost" onclick="abonoQuickMeses(-1)" style="padding:4px 10px;font-size:16px;font-weight:800;min-width:32px">âˆ’</button>
          <span id="abono-quick-meses" style="font-family:'DM Mono',monospace;font-size:18px;font-weight:800;color:var(--accent);min-width:60px;text-align:center">1 mes</span>
          <button class="btn btn-ghost" onclick="abonoQuickMeses(1)" style="padding:4px 10px;font-size:16px;font-weight:800;min-width:32px">+</button>
        </div>
      </div>
      <div id="abono-quick-desglose" style="font-size:12px;color:var(--text2);line-height:1.8"></div>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>Monto ($)</label>
        <input id="a-monto" type="number" placeholder="1000" />
      </div>
      <div class="form-group">
        <label>Fecha</label>
        <input id="a-fecha" type="date" />
      </div>
      <div class="form-group">
        <label>Forma de pago</label>
        <select id="a-metodo"></select>
      </div>
      <div class="form-group">
        <label>Mes al que aplica</label>
        <input id="a-mes" type="month" />
      </div>
      <div class="form-group full">
        <label>Concepto / Nota</label>
        <input id="a-nota" placeholder="Renta de enero, depÃ³sito, etc." />
      </div>
      <div class="form-group full">
        <label>ğŸ“ Comprobante <span style="font-size:11px;color:var(--text3);font-weight:400">(opcional)</span></label>
        <div id="a-comprobante-area" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <label style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface2);border:1px dashed var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .2s" onmouseenter="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">
            ğŸ“ Seleccionar archivo
            <input id="a-comprobante-file" type="file" accept="image/*" onchange="onComprobanteSelected(this)" style="display:none" />
          </label>
          <label style="display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--surface2);border:1px dashed var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .2s" onmouseenter="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseleave="this.style.borderColor='var(--border)';this.style.color='var(--text2)'">
            ğŸ“· Tomar foto
            <input id="a-comprobante-camera" type="file" accept="image/*" capture="environment" onchange="onComprobanteSelected(this)" style="display:none" />
          </label>
          <div id="a-comprobante-preview" style="display:none;position:relative">
            <img id="a-comprobante-img" style="height:60px;border-radius:6px;border:1px solid var(--border);cursor:pointer" onclick="verComprobanteTemp()" />
            <button onclick="clearComprobanteInput()" style="position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:var(--danger);color:#fff;border:none;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1">âœ•</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAbono')">Cancelar</button>
      <button class="btn btn-success" onclick="guardarAbono()">Registrar Abono</button>
    </div>
  </div>
</div>

<!-- MODAL: Servicio -->
<div class="modal-overlay" id="modalServicio">
  <div class="modal" style="width:460px;max-width:98vw">
    <div class="modal-title">Agregar Servicio</div>
    <div style="margin-bottom:16px">
      <label style="font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3)">Tipo de servicio</label>
      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px" id="sv-tipos">
        <button class="filter-chip" onclick="selTipo('ğŸ’§','Agua',this)">ğŸ’§ Agua</button>
        <button class="filter-chip" onclick="selTipo('âš¡','Luz / Electricidad',this)">âš¡ Luz</button>
        <button class="filter-chip" onclick="selTipo('ğŸ”¥','Gas',this)">ğŸ”¥ Gas</button>
        <button class="filter-chip" onclick="selTipo('ğŸŒ','Internet',this)">ğŸŒ Internet</button>
        <button class="filter-chip" onclick="selTipo('ğŸ“','TelÃ©fono',this)">ğŸ“ TelÃ©fono</button>
        <button class="filter-chip" onclick="selTipo('ğŸ“º','Cable / TV',this)">ğŸ“º Cable</button>
        <button class="filter-chip" onclick="selTipo('ğŸ”Œ','Otro',this)">ğŸ”Œ Otro</button>
      </div>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label>Nombre</label>
        <input id="sv-nombre" placeholder="Ej: Agua potable" />
      </div>
      <div class="form-group">
        <label>Icono / emoji</label>
        <input id="sv-icono" placeholder="ğŸ’§" maxlength="4" style="font-size:20px" />
      </div>
      <div class="form-group">
        <label>NÃºmero de cuenta / medidor</label>
        <input id="sv-numero" placeholder="123456789" />
      </div>
      <div class="form-group">
        <label>Proveedor</label>
        <input id="sv-proveedor" placeholder="CFE, JMAS, Telmex..." />
      </div>
      <div class="form-group full">
        <label>Notas</label>
        <input id="sv-notas" placeholder="Fecha de corte, instrucciones..." />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalServicio')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarServicio()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL: Predial -->
<div class="modal-overlay" id="modalPredial">
  <div class="modal" style="width:500px;max-width:98vw">
    <div class="modal-title">InformaciÃ³n de Predial</div>
    <div class="form-grid">
      <div class="form-group">
        <label>NÃºmero de cuenta predial</label>
        <input id="pd-cuenta" placeholder="1234-567-890" />
      </div>
      <div class="form-group">
        <label>Municipio / DelegaciÃ³n</label>
        <input id="pd-municipio" placeholder="Ej: TorreÃ³n, Coahuila" />
      </div>
      <div class="form-group">
        <label>Valor catastral ($)</label>
        <input id="pd-valor" type="number" placeholder="1500000" />
      </div>
      <div class="form-group">
        <label>Monto a pagar ($)</label>
        <input id="pd-monto" type="number" placeholder="3500" />
      </div>
      <div class="form-group">
        <label>Fecha de vencimiento</label>
        <input id="pd-vencimiento" type="date" />
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:10px;padding-top:20px">
        <input id="pd-pagado" type="checkbox" style="width:18px;height:18px;accent-color:var(--success)" />
        <label style="text-transform:none;letter-spacing:0;font-size:14px;color:var(--text)">Predial pagado</label>
      </div>
      <div class="form-group full">
        <label>Notas</label>
        <textarea id="pd-notas" placeholder="Descuentos, referencias de pago, historial..."></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalPredial')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarPredial()">Guardar</button>
    </div>
  </div>
</div>

<!-- SheetJS for Excel parsing -->
<script>
// SheetJS lazy loader - won't block app if CDN unavailable
window._xlsxReady = false;
function loadSheetJS(cb) {
  if (window.XLSX) { cb && cb(); return; }
  var s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  s.onload = function() { window._xlsxReady = true; cb && cb(); };
  s.onerror = function() { console.warn('SheetJS no disponible (sin conexiÃ³n)'); };
  document.head.appendChild(s);
}
</script>

<!-- MODAL: Importar Excel -->
<div class="modal-overlay" id="modalImport">
  <div class="modal" style="width:600px;max-width:98vw">
    <div class="modal-title" id="import-title">Importar desde Excel</div>
    <div id="import-step-1">
      <p style="color:var(--text2);font-size:14px;margin-bottom:20px">Selecciona o arrastra tu archivo Excel (.xlsx). Usa la plantilla oficial para asegurar una importaciÃ³n correcta.</p>

      <!-- Download template buttons -->
      <div style="display:flex;gap:10px;margin-bottom:20px">
        <a id="dl-template-link" href="#" onclick="descargarPlantilla(event)" style="flex:1">
          <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;text-align:center;transition:border-color 0.15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
            <div style="font-size:22px;margin-bottom:6px">ğŸ“Š</div>
            <div style="font-size:13px;font-weight:600" id="dl-template-label">Descargar plantilla</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px">Machote oficial</div>
          </div>
        </a>
      </div>

      <!-- Drop zone -->
      <div class="upload-zone" id="import-drop"
        ondragover="event.preventDefault();this.classList.add('drag')"
        ondragleave="this.classList.remove('drag')"
        ondrop="handleImportDrop(event)"
        onclick="document.getElementById('import-file-input').click()">
        <div class="upload-zone-icon">ğŸ“‚</div>
        <div class="upload-zone-text">Seleccionar archivo Excel</div>
        <div class="upload-zone-sub">.xlsx Â· Arrastra o haz clic</div>
      </div>
      <input type="file" id="import-file-input" accept=".xlsx,.xls" style="display:none" onchange="handleImportFile(this.files[0])" />
    </div>

    <!-- Preview step -->
    <div id="import-step-2" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
        <div style="font-size:20px">ğŸ“Š</div>
        <div>
          <div style="font-weight:600;font-size:14px" id="import-filename"></div>
          <div style="font-size:12px;color:var(--text3)" id="import-rowcount"></div>
        </div>
      </div>

      <div id="import-preview" style="max-height:280px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-bottom:16px"></div>
      <div id="import-errors" style="display:none;background:rgba(224,82,82,0.1);border:1px solid rgba(224,82,82,0.3);border-radius:8px;padding:12px;margin-bottom:14px;font-size:12px;color:var(--danger)"></div>
      <div id="import-warnings" style="display:none;background:rgba(232,148,71,0.1);border:1px solid rgba(232,148,71,0.3);border-radius:8px;padding:12px;margin-bottom:14px;font-size:12px;color:var(--warning)"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="resetImport()">Cancelar</button>
      <button class="btn btn-primary" id="import-confirm-btn" style="display:none" onclick="confirmarImport()">âœ… Importar datos</button>
    </div>
  </div>
</div>

<!-- MODAL: Forma de Pago -->
<div class="modal-overlay" id="modalFormaPago">
  <div class="modal" style="width:440px;max-width:98vw">
    <div class="modal-title" id="fp-modal-title">Nueva Forma de Pago</div>
    <div class="form-grid">
      <div class="form-group full">
        <label>Nombre de la forma de pago</label>
        <input id="fp-nombre" placeholder="Ej: Transferencia BBVA, Efectivo, Tarjeta Visa..." />
      </div>
      <div class="form-group full">
        <label>Icono / emoji (opcional)</label>
        <input id="fp-icono" placeholder="ğŸ’³ ğŸ¦ ğŸ’µ ğŸ”„" style="font-size:20px" maxlength="4" />
      </div>
      <div class="form-group full">
        <label>DescripciÃ³n / datos bancarios (opcional)</label>
        <textarea id="fp-desc" placeholder="CLABE: 012345678901234567&#10;Banco: BBVA" style="min-height:90px"></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalFormaPago')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarFormaPago()">Guardar</button>
    </div>
  </div>
</div>

<script>

// ============================================================
// FIREBASE CONFIG & SYNC
// ============================================================
const firebaseConfig = {
  apiKey: "AIzaSyAzaBAZDjTPSocVdjulehwONu0cTtJVpLo",
  authDomain: "gestor-rentas.firebaseapp.com",
  projectId: "gestor-rentas",
  storageBucket: "gestor-rentas.firebasestorage.app",
  messagingSenderId: "228651565464",
  appId: "1:228651565464:web:22eb96c51104575c93abed"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// â”€â”€ Sync state to Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// We store everything in one document: gestorrenta/main
// and users in gestorrenta/users
// Real-time listener updates all clients instantly

let _fbUnsubscribe = null;   // listener cleanup
let _fbSyncing = false;      // prevent echo writes
let _fbJustSaved = 0;        // timestamp of last save â€” ignore onSnapshot for 3s after
let _fbReady = false;        // true once first snapshot received
let _fbAuth = null;          // Firebase Auth user

// â”€â”€ Get tenant Firestore path for current user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tenantDoc() {
  const uid = _fbAuth ? _fbAuth.uid : null;
  if (!uid) return null;
  return db.collection('tenants').doc(uid).collection('data').doc('main');
}
function tenantUsersDoc() {
  const uid = _fbAuth ? _fbAuth.uid : null;
  if (!uid) return null;
  return db.collection('tenants').doc(uid).collection('data').doc('users');
}
function tenantPlanDoc() {
  const uid = _fbAuth ? _fbAuth.uid : null;
  if (!uid) return null;
  return db.collection('tenants').doc(uid);
}

// â”€â”€ Sub-user â†’ tenant mapping (enables login from any device) â”€â”€
// Collection: subuser_map/{username_lowercase} â†’ { tenantUid, tenantEmail, encTenantPass, userId }
// The tenant password is encrypted with AES-GCM using the sub-user's password as key.
// Only someone who knows the sub-user's password can decrypt the tenant credentials.

// â”€â”€ AES-GCM Crypto Utilities (Web Crypto API) â”€â”€
async function _deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function _aesEncrypt(plainText, password) {
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await _deriveKey(password, salt);
  const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(plainText));
  // Pack: salt(16) + iv(12) + ciphertext â†’ base64
  const packed = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
  packed.set(salt, 0);
  packed.set(iv, salt.length);
  packed.set(new Uint8Array(encrypted), salt.length + iv.length);
  return btoa(String.fromCharCode(...packed));
}

async function _aesDecrypt(base64Data, password) {
  const raw = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
  const salt = raw.slice(0, 16);
  const iv = raw.slice(16, 28);
  const ciphertext = raw.slice(28);
  const key = await _deriveKey(password, salt);
  const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext);
  return new TextDecoder().decode(decrypted);
}

// â”€â”€ Tenant password holder (in-memory only, never persisted in plain text) â”€â”€
let _tenantPassPlain = null; // Set during titular login, used to encrypt for sub-users

async function fbSaveSubUserMapping(username, subEmail, subUserPass, userId) {
  if (!_fbAuth) return;
  const tenantEmail = _fbAuth.email;
  const tenantUid = _fbAuth.uid;
  const tenantPass = _tenantPassPlain || localStorage.getItem('gestorrenta_tenant_pass');
  if (!tenantPass) { console.warn('No tenant password available for sub-user mapping'); return; }

  try {
    // Encrypt tenant password with the sub-user's plain-text password
    const encTenantPass = await _aesEncrypt(tenantPass, subUserPass);
    const data = { tenantUid, tenantEmail, encTenantPass, userId, updatedAt: new Date().toISOString() };

    if (username) {
      await db.collection('subuser_map').doc(username.toLowerCase()).set(data);
    }
    if (subEmail) {
      await db.collection('subuser_map').doc(subEmail.toLowerCase()).set(data);
    }
  } catch(e) {
    console.warn('fbSaveSubUserMapping error:', e);
  }
}

async function fbDeleteSubUserMapping(username, subEmail) {
  try {
    if (username) {
      await db.collection('subuser_map').doc(username.toLowerCase()).delete();
    }
    if (subEmail) {
      await db.collection('subuser_map').doc(subEmail.toLowerCase()).delete();
    }
  } catch(e) {
    console.warn('fbDeleteSubUserMapping error:', e);
  }
}

async function fbLookupSubUserMapping(usernameOrEmail) {
  try {
  
    const docRef = db.collection('subuser_map').doc(usernameOrEmail.toLowerCase());
    const doc = await docRef.get();
  
    if (doc.exists) return doc.data();
  } catch(e) {
    console.error('[SubUserMap] Lookup ERROR:', e.code || '', e.message || e);
    // Re-throw permission errors so the caller can show a useful message
    if (e.code === 'permission-denied' || (e.message && e.message.includes('permission'))) {
      throw { code: 'firestore/permission-denied', message: 'Reglas de Firestore no permiten lectura de subuser_map. Agrega la regla: match /subuser_map/{docId} { allow read: if true; allow write: if request.auth != null; }' };
    }
  }
  return null;
}

// Sync ALL sub-user mappings for this tenant (called on titular login)
// Requires _tenantPassPlain and each sub-user's passHash to derive their passwords.
// Since we only have the HASH (not the plain password), we re-encrypt using
// the sub-user's passHash as the decryption key instead of their plain password.
// This means during login, the sub-user's passHash (derived from their typed password)
// will be used as the decryption key.
async function fbSyncAllSubUserMappings() {
  if (!_fbAuth) return;
  const tenantPass = _tenantPassPlain || localStorage.getItem('gestorrenta_tenant_pass');
  if (!tenantPass) return;
  try {
    const users = loadUsers();
    for (const u of users) {
      if (u.role !== 'titular' && u.username && u.passHash) {
        // Use passHash as the encryption key (sub-user will derive the same from their password)
        await fbSaveSubUserMapping(u.username, u.subEmail || '', u.passHash, u.id);
      }
    }
  } catch(e) {
    console.warn('fbSyncAllSubUserMappings error:', e);
  }
}

function fbStartSync() {
  if (_fbUnsubscribe) return; // Already listening
  const docRef = tenantDoc();
  if (!docRef) return;
  _fbUnsubscribe = docRef.onSnapshot(snap => {
    if (!snap.exists) {
      // New user â€” clear any stale localStorage data so they start fresh
      state.rentas = [];
      state.clientes = [];
      state.formasPago = JSON.parse(JSON.stringify(DEFAULT_FORMAS_PAGO));
      state.tiposGasto = [...DEFAULT_TIPOS_GASTO];
      state.tiposProp  = [...DEFAULT_TIPOS_PROP];
      state.alertaSeguimiento = {};
      _fbReady = true;
      var mc2 = document.getElementById('main-content');
      if (mc2) { mc2.style.opacity = ''; mc2.style.pointerEvents = ''; }
      if (currentUser) render();
      return;
    }
    const data = snap.data();
    if (!data) return;
    // SAFETY: Never overwrite a populated state with empty data from Firestore
    if (state.rentas.length > 0 && (!data.rentas || data.rentas.length === 0) && (!data.clientes || data.clientes.length === 0)) {
      console.warn('[Sync] BLOCKED: Firestore returned empty data but local has ' + state.rentas.length + ' rentas. Refusing overwrite.');
      _fbReady = true;
      var mc00 = document.getElementById('main-content');
      if (mc00) { mc00.style.opacity = ''; mc00.style.pointerEvents = ''; }
      return;
    }
    // Skip onSnapshot if we saved recently â€” our own write echoing back
    if (Date.now() - _fbJustSaved < 8000) {
      _fbReady = true;
      var mc0 = document.getElementById('main-content');
      if (mc0) { mc0.style.opacity = ''; mc0.style.pointerEvents = ''; }
      return;
    }
    _fbSyncing = true;
    state.rentas     = data.rentas     || [];
    state.clientes   = data.clientes   || [];
    state.formasPago = data.formasPago || JSON.parse(JSON.stringify(DEFAULT_FORMAS_PAGO));
    state.tiposGasto = data.tiposGasto || [...DEFAULT_TIPOS_GASTO];
    state.tiposProp  = data.tiposProp  || [...DEFAULT_TIPOS_PROP];
    state.alertaSeguimiento = data.alertaSeguimiento || {};
    if (data.fiscalConfig) state.fiscalConfig = data.fiscalConfig;
    if (data.timbresBalance !== undefined) state.timbresBalance = data.timbresBalance;
    if (data.timbresHistorial) state.timbresHistorial = data.timbresHistorial;
    if (data.timbresPrecio) state.timbresPrecio = data.timbresPrecio;

    // Merge local binary data back (stripped before Firestore sync)
    try {
      var localBackup = JSON.parse(localStorage.getItem('gestorrenta_v2') || '{}');
      if (localBackup.clientes) {
        state.clientes.forEach(function(c) {
          var localC = localBackup.clientes.find(function(lc){ return lc.id === c.id; });
          if (!localC) return;
          // Restore foto
          if ((c.hasFoto || !c.foto) && localC.foto) c.foto = localC.foto;
          // Restore contrato
          if ((c.hasContrato || !c.contrato) && localC.contrato) c.contrato = localC.contrato;
          if (!c.contratoData && localC.contratoData) c.contratoData = localC.contratoData;
          // Restore docs with data
          if (localC.docs && localC.docs.length > 0 && localC.docs[0].data) {
            c.docs = localC.docs;
          }
        });
      }
      if (localBackup.rentas) {
        state.rentas.forEach(function(r) {
          var localR = localBackup.rentas.find(function(lr){ return lr.id === r.id; });
          if (!localR || !localR.abonos) return;
          (r.abonos||[]).forEach(function(a) {
            var localA = localR.abonos.find(function(la){ return la.id === a.id; });
            if (!localA) return;
            if ((a.hasXml || !a.xmlBase64) && localA.xmlBase64) { a.xmlBase64 = localA.xmlBase64; a.qrBase64 = localA.qrBase64 || ''; }
            if ((a.hasComprobante || !a.comprobante) && localA.comprobante) a.comprobante = localA.comprobante;
          });
        });
      }
    } catch(mergeErr) { console.warn('Doc merge from localStorage:', mergeErr); }

    _fbSyncing = false;
    _fbReady = true;
    // Remove loading indicator
    var mc = document.getElementById('main-content');
    if (mc) { mc.style.opacity = ''; mc.style.pointerEvents = ''; }
    if (currentUser) render();
  }, err => {
    console.error('Firestore listener error:', err);
    mostrarToastExito('âš ï¸ Error de conexiÃ³n. Trabajando sin red.');
  });
}

function fbStopSync() {
  if (_fbUnsubscribe) { _fbUnsubscribe(); _fbUnsubscribe = null; }
}

async function fbSave() {
  if (_fbSyncing) { setTimeout(fbSave, 300); return; }
  const docRef = tenantDoc();
  if (!docRef) return;
  try {
    // Strip large base64 data to avoid exceeding Firestore 1MB limit
    // Fotos, contratos, docs, comprobantes are kept in localStorage only
    var clientesForSync = state.clientes.map(function(c) {
      var cleaned = Object.assign({}, c);
      // Strip foto base64
      if (cleaned.foto) { cleaned.hasFoto = true; cleaned.foto = null; }
      // Strip contrato base64
      if (cleaned.contrato) { cleaned.hasContrato = true; cleaned.contrato = null; }
      if (cleaned.contratoData) { cleaned.hasContrato = true; cleaned.contratoData = null; }
      // Strip docs base64
      if (cleaned.docs && cleaned.docs.length > 0) {
        cleaned.docs = cleaned.docs.map(function(d) {
          return { id: d.id, name: d.name, size: d.size, type: d.type, hasData: !!d.data };
        });
      }
      return cleaned;
    });

    // Strip xmlBase64/qrBase64 and comprobante from abonos
    var rentasForSync = state.rentas.map(function(r) {
      var cleaned = Object.assign({}, r);
      if (cleaned.abonos && cleaned.abonos.length > 0) {
        cleaned.abonos = cleaned.abonos.map(function(a) {
          var aClean = Object.assign({}, a);
          if (aClean.xmlBase64) { aClean.hasXml = true; delete aClean.xmlBase64; }
          if (aClean.qrBase64) { delete aClean.qrBase64; }
          if (aClean.comprobante) { aClean.hasComprobante = true; delete aClean.comprobante; }
          return aClean;
        });
      }
      return cleaned;
    });

    await docRef.set({
      rentas:     rentasForSync,
      clientes:   clientesForSync,
      formasPago: state.formasPago,
      tiposGasto: state.tiposGasto,
      tiposProp:  state.tiposProp,
      alertaSeguimiento: state.alertaSeguimiento || {},
      fiscalConfig: state.fiscalConfig || null,
      timbresBalance: state.timbresBalance || 0,
      timbresHistorial: state.timbresHistorial || [],
      timbresPrecio: state.timbresPrecio || null,
      updatedAt:  firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy:  currentUser?.username || 'unknown'
    });
  } catch(e) {
    console.error('fbSave error:', e);
    localStorage.setItem('gestorrenta_v2', JSON.stringify(state));
    if (e.message && e.message.indexOf('exceeds the maximum') >= 0) {
      mostrarToastExito('âš ï¸ Datos muy grandes para sincronizar â€” archivos adjuntos solo disponibles en esta computadora');
    } else {
      mostrarToastExito('âš ï¸ Error al guardar â€” guardado local temporalmente');
    }
  }
}

async function fbSaveUsers(users) {
  const docRef = tenantUsersDoc();
  if (!docRef) return;
  try {
    await docRef.set({ list: users });
  } catch(e) {
    console.error('fbSaveUsers error:', e);
    localStorage.setItem('gestorrenta_users', JSON.stringify(users));
  }
}

async function fbLoadUsers() {
  const docRef = tenantUsersDoc();
  if (!docRef) return null;
  try {
    const snap = await docRef.get();
    if (snap.exists && snap.data().list) return snap.data().list;
  } catch(e) {
    console.error('fbLoadUsers error:', e);
  }
  const raw = localStorage.getItem('gestorrenta_users');
  return raw ? JSON.parse(raw) : null;
}

// â”€â”€ Save tenant plan info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fbSavePlan(planData) {
  const docRef = tenantPlanDoc();
  if (!docRef) return;
  try { await docRef.set(planData, { merge: true }); }
  catch(e) { console.error('fbSavePlan error:', e); }
}

// â”€â”€ Load tenant plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fbLoadPlan() {
  const docRef = tenantPlanDoc();
  if (!docRef) return null;
  try {
    const snap = await docRef.get();
    return snap.exists ? snap.data() : null;
  } catch(e) { return null; }
}
// â”€â”€ Connection status indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fbShowStatus(online) {
  // Bottom indicator
  const ind = document.getElementById('autosave-indicator');
  const txt = document.getElementById('autosave-text');
  if (ind && txt) {
    ind.style.borderColor = online ? 'rgba(45,106,79,.3)' : 'rgba(200,0,0,.3)';
    txt.textContent = online ? 'â˜ï¸ Sincronizado' : 'âš ï¸ Sin conexiÃ³n';
    ind.classList.add('show');
    if (online) setTimeout(() => ind.classList.remove('show'), 2500);
  }
  // Header stat
  const icon  = document.getElementById('hstat-sync-icon');
  const label = document.getElementById('hstat-sync-label');
  if (icon && label) {
    icon.textContent  = online ? 'â˜ï¸' : 'âš¡';
    icon.className    = online ? 'hstat-val sync-ok' : 'hstat-val sync-error';
    label.textContent = online ? 'En lÃ­nea' : 'Sin red';
  }
}

// Listen to connection state
db.collection('gestorrenta').doc('.info')
  .onSnapshot(() => {}, () => {});

// â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fbShowLoading(msg) {
  let el = document.getElementById('fb-loading');
  if (!el) {
    el = document.createElement('div');
    el.id = 'fb-loading';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(27,58,45,.92);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:#fff;font-family:inherit';
    el.innerHTML = '<div style="font-size:48px">â˜ï¸</div><div style="font-size:16px;font-weight:600" id="fb-loading-msg">Conectando...</div><div style="font-size:13px;opacity:.7">GestorRenta â€” SincronizaciÃ³n en la nube</div>';
    document.body.appendChild(el);
  }
  document.getElementById('fb-loading-msg').textContent = msg || 'Conectando...';
  el.style.display = 'flex';
}
function fbHideLoading() {
  const el = document.getElementById('fb-loading');
  if (el) el.style.display = 'none';
}

// ============================================================
// AUTH & USER MANAGEMENT
// ============================================================
const PERM_LIST = ['prop_read', 'prop_write', 'cli_read', 'cli_write', 'abono_write', 'abono_delete', 'factura_write', 'dash_read', 'alertas_read', 'alertas_write', 'vacant_read', 'config_read'];
const PERM_LABELS = {
  'prop_read': 'Ver Propiedades', 'prop_write': 'Alta y modificaciÃ³n de Propiedades',
  'cli_read': 'Ver Clientes', 'cli_write': 'Alta y modificaciÃ³n de Clientes',
  'abono_write': 'Registrar Abonos', 'abono_delete': 'Eliminar Abonos registrados',
  'factura_write': 'Emitir Facturas (CFDI)',
  'dash_read': 'Ver Resumen / Resultados (Dashboard)',
  'alertas_read': 'Ver Alertas',
  'alertas_write': 'Modificar Alertas (reagendar, notas)',
  'vacant_read': 'Ver Propiedades sin Rentar',
  'config_read': 'Ver ConfiguraciÃ³n (solo lectura)'
};

// Users stored separately from main state to keep data isolated
function loadUsers() {
  const raw = localStorage.getItem('gestorrenta_users');
  if (raw) return JSON.parse(raw);
  // First run on this device: create default titular locally ONLY
  // Do NOT call saveUsers() here â€” it would try to write to Firestore
  // and could overwrite real tenant data if _fbAuth happens to be set
  const users = [{
    id: 'titular',
    nombre: 'Titular',
    username: 'admin',
    // password hashed simply with btoa for obfuscation (not cryptographic)
    passHash: btoa('admin1234'),
    role: 'titular',
    perms: ['prop_read','prop_write','cli_read','cli_write','abono_write','abono_delete','factura_write','dash_read','alertas_read','alertas_write','vacant_read','config_read'], // all perms
    createdAt: new Date().toISOString(),
  }];
  localStorage.setItem('gestorrenta_users', JSON.stringify(users));
  return users;
}
function saveUsers(users) {
  // Save locally immediately
  localStorage.setItem('gestorrenta_users', JSON.stringify(users));
  // And to Firebase (async)
  fbSaveUsers(users);
}

let currentUser = null;

function hashPass(p) { return btoa(unescape(encodeURIComponent(p))); }
// ============================================================
// PASSWORD RECOVERY
// ============================================================
function genCode() {
  // 8 random digits
  return Array.from({length:8}, () => Math.floor(Math.random()*10)).join('');
}

function showForgotPanel() {
  document.getElementById('login-panel').style.display = 'none';
  document.getElementById('forgot-panel').style.display = '';
  document.getElementById('forgot-email').value = document.getElementById('login-user').value || '';
  document.getElementById('forgot-email').disabled = false;
  document.getElementById('forgot-error').textContent = '';
  document.getElementById('forgot-success').style.display = 'none';
  document.getElementById('forgot-btn').disabled = false;
  document.getElementById('forgot-btn').style.display = '';
  document.getElementById('forgot-btn').textContent = 'Recuperar contraseÃ±a';
  document.getElementById('forgot-subuser-panel').style.display = 'none';
  _forgotSubUserId = null;
}

// showLoginPanel defined below in Panel navigation section

async function doSendResetEmail() {
  const email = document.getElementById('forgot-email').value.trim().toLowerCase();
  const errEl = document.getElementById('forgot-error');
  const successEl = document.getElementById('forgot-success');
  const subPanel = document.getElementById('forgot-subuser-panel');
  errEl.textContent = '';
  errEl.style.color = 'var(--danger)';
  successEl.style.display = 'none';
  subPanel.style.display = 'none';

  if (!email) { errEl.textContent = 'Ingresa tu correo electrÃ³nico.'; return; }
  if (!email.includes('@')) { errEl.textContent = 'Correo electrÃ³nico no vÃ¡lido.'; return; }

  // Check if it's a sub-user email
  const users = loadUsers();
  const subUser = users.find(u => u.role !== 'titular' && u.subEmail && u.subEmail.toLowerCase() === email);
  if (subUser) {
    // Show sub-user recovery panel with code input
    _forgotSubUserId = subUser.id;
    document.getElementById('forgot-btn').style.display = 'none';
    document.getElementById('forgot-email').disabled = true;
    subPanel.style.display = '';
    document.getElementById('forgot-sub-code').value = '';
    document.getElementById('forgot-sub-newpass').value = '';
    document.getElementById('forgot-sub-code').focus();
    return;
  }

  const btn = document.getElementById('forgot-btn');
  btn.disabled = true;
  btn.textContent = 'Enviando...';

  try {
    await auth.sendPasswordResetEmail(email);
    successEl.style.display = '';
    btn.textContent = 'Correo enviado âœ“';
  } catch (e) {
    btn.disabled = false;
    btn.textContent = 'Recuperar contraseÃ±a';
    if (e.code === 'auth/user-not-found') {
      errEl.textContent = 'No existe una cuenta con ese correo.';
    } else if (e.code === 'auth/too-many-requests') {
      errEl.textContent = 'Demasiados intentos. Espera unos minutos.';
    } else if (e.code === 'auth/invalid-email') {
      errEl.textContent = 'Correo electrÃ³nico no vÃ¡lido.';
    } else {
      errEl.textContent = 'Error: ' + e.message;
    }
  }
}

let _forgotSubUserId = null;

function doSubuserRecover() {
  const code = document.getElementById('forgot-sub-code').value.trim();
  const newPass = document.getElementById('forgot-sub-newpass').value;
  const errEl = document.getElementById('forgot-error');
  errEl.textContent = '';

  if (!code) { errEl.textContent = 'Ingresa el cÃ³digo de recuperaciÃ³n.'; return; }
  if (!newPass || newPass.length < 4) { errEl.textContent = 'La contraseÃ±a debe tener al menos 4 caracteres.'; return; }

  const users = loadUsers();
  const user = users.find(u => u.id === _forgotSubUserId);
  if (!user) { errEl.textContent = 'Usuario no encontrado.'; return; }

  if (!user.recoveryCode || user.recoveryCode !== code) {
    errEl.textContent = 'CÃ³digo de recuperaciÃ³n incorrecto.';
    return;
  }

  // Reset password
  user.passHash = hashPass(newPass);
  saveUsers(users);

  _forgotSubUserId = null;
  document.getElementById('forgot-subuser-panel').style.display = 'none';
  document.getElementById('forgot-btn').style.display = '';
  document.getElementById('forgot-email').disabled = false;

  const successEl = document.getElementById('forgot-success');
  successEl.innerHTML = 'âœ… <strong>Â¡ContraseÃ±a actualizada!</strong> Ya puedes iniciar sesiÃ³n con tu nueva contraseÃ±a.';
  successEl.style.display = '';
}

// â”€â”€â”€ Recovery code management in modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateRecoveryCode() {
  const users = loadUsers();
  const titular = users.find(u => u.id === editandoUsuarioId);
  if (!titular) return;
  titular.recoveryCode = genCode();
  saveUsers(users);
  showRecoveryCode(titular.recoveryCode);
}

function regenerateCode() {
  if (!confirm('Â¿Generar un nuevo cÃ³digo? El cÃ³digo anterior dejarÃ¡ de funcionar.')) return;
  generateRecoveryCode();
}

function showRecoveryCode(code) {
  document.getElementById('u-recovery-code-display').textContent = code;
  document.getElementById('u-recovery-code-wrap').style.display = '';
  document.getElementById('u-recovery-no-code').style.display = 'none';
}

function copyRecoveryCode() {
  const code = document.getElementById('u-recovery-code-display').textContent;
  if (code === 'â€”â€”') return;
  navigator.clipboard?.writeText(code).then(() => {
    const el = document.getElementById('u-recovery-code-display');
    const prev = el.textContent;
    el.textContent = 'Â¡Copiado!';
    setTimeout(() => { el.textContent = prev; }, 1200);
  }).catch(() => {
    // Fallback for mobile without clipboard API
    const el = document.getElementById('u-recovery-code-display');
    const range = document.createRange();
    range.selectNode(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
  });
}

// â”€â”€ Sub-user recovery code functions â”€â”€
function generateSubRecoveryCode() {
  if (!editandoUsuarioId) return;
  const users = loadUsers();
  const u = users.find(x => x.id === editandoUsuarioId);
  if (!u) return;
  u.recoveryCode = genCode();
  saveUsers(users);
  showSubRecoveryCode(u.recoveryCode);
}

function regenerateSubRecoveryCode() {
  if (!confirm('Â¿Generar un nuevo cÃ³digo? El cÃ³digo anterior dejarÃ¡ de funcionar.')) return;
  generateSubRecoveryCode();
}

function showSubRecoveryCode(code) {
  document.getElementById('u-sub-recovery-code-display').textContent = code;
  document.getElementById('u-sub-recovery-code-wrap').style.display = '';
  document.getElementById('u-sub-recovery-no-code').style.display = 'none';
}

function copySubRecoveryCode() {
  const code = document.getElementById('u-sub-recovery-code-display').textContent;
  if (code === 'â€”â€”') return;
  navigator.clipboard?.writeText(code).then(() => {
    const el = document.getElementById('u-sub-recovery-code-display');
    const prev = el.textContent;
    el.textContent = 'Â¡Copiado!';
    setTimeout(() => { el.textContent = prev; }, 1200);
  }).catch(() => {
    const el = document.getElementById('u-sub-recovery-code-display');
    const range = document.createRange();
    range.selectNode(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
  });
}

async function doLogin() {
  const emailOrUser = document.getElementById('login-user').value.trim();
  const pass = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  if (!emailOrUser || !pass) { errEl.textContent = 'Ingresa usuario y contraseÃ±a.'; return; }

  const loginBtn = document.querySelector('.login-btn');
  if (loginBtn) { loginBtn.disabled = true; loginBtn.textContent = 'Entrando...'; }

  try {
    _loginInProgress = true; // Prevent onAuthStateChanged from interfering
    const inputLower = emailOrUser.toLowerCase();

    // Step 1: Check if it's a sub-user (by username or subEmail)
    let localUsers = loadUsers();
    let subUser = localUsers.find(u =>
      u.role !== 'titular' && (
        (u.username && u.username.toLowerCase() === inputLower) ||
        (u.subEmail && u.subEmail.toLowerCase() === inputLower)
      )
    );

    // If not found locally, try loading from Firestore (users may not be synced yet)
    if (!subUser && _fbAuth) {
      try {
        const fbUsers = await fbLoadUsers();
        if (fbUsers && fbUsers.length > 0) {
          localStorage.setItem('gestorrenta_users', JSON.stringify(fbUsers));
          localUsers = fbUsers;
          subUser = localUsers.find(u =>
            u.role !== 'titular' && (
              (u.username && u.username.toLowerCase() === inputLower) ||
              (u.subEmail && u.subEmail.toLowerCase() === inputLower)
            )
          );
        }
      } catch(e) { console.warn('Firestore user load failed:', e); }
    }

    // Step 1b: If STILL not found locally, try the subuser_map in Firestore
    // This enables sub-users to login from ANY device â€” fully independent
    if (!subUser) {
      try {

        const mapping = await fbLookupSubUserMapping(inputLower);

        if (mapping && mapping.tenantUid && mapping.tenantEmail && mapping.encTenantPass) {
          // Decrypt tenant password using the sub-user's passHash as key
          let tenantPass = null;
          const subPassHash = hashPass(pass);
          try {
            tenantPass = await _aesDecrypt(mapping.encTenantPass, subPassHash);
    
          } catch(decErr) {
            console.warn('[Login] Step 1b: Decryption FAILED (wrong password?):', decErr.message);
            throw { code: 'auth/wrong-password' };
          }

          // Now authenticate Firebase with the decrypted tenant credentials
          let fbSignedIn = false;
          const existing = auth ? auth.currentUser : null;
          if (existing && existing.uid === mapping.tenantUid) {
            _fbAuth = existing;
            fbSignedIn = true;
    
          }
          if (!fbSignedIn) {
            try {
              const cred = await auth.signInWithEmailAndPassword(mapping.tenantEmail, tenantPass);
              _fbAuth = cred.user;
              fbSignedIn = true;
      
              // Store tenant credentials locally for session restore
              _tenantPassPlain = tenantPass;
              localStorage.setItem('gestorrenta_tenant_pass', tenantPass);
              localStorage.setItem('gestorrenta_tenant_uid', _fbAuth.uid);
              // Store email map so _restoreFirebaseForSubUser works on page reload
              const emailMap = JSON.parse(localStorage.getItem('gestorrenta_email_map') || '{}');
              emailMap[mapping.tenantEmail.toLowerCase()] = mapping.tenantEmail;
              localStorage.setItem('gestorrenta_email_map', JSON.stringify(emailMap));
            } catch(authErr) {
              console.warn('[Login] Step 1b: Firebase auth FAILED:', authErr.code, authErr.message);
              throw { code: 'auth/invalid-credential' };
            }
          }

          // Load the full user list from Firestore
          if (fbSignedIn) {
            const fbUsers = await fbLoadUsers();
    
            if (fbUsers && fbUsers.length > 0) {
              localStorage.setItem('gestorrenta_users', JSON.stringify(fbUsers));
              localUsers = fbUsers;
              subUser = localUsers.find(u =>
                u.role !== 'titular' && (
                  (u.username && u.username.toLowerCase() === inputLower) ||
                  (u.subEmail && u.subEmail.toLowerCase() === inputLower)
                )
              );
      
              // Password verification happens in the subUser block below
            }
          }
        }
      } catch(e) {
        if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') throw e;
        if (e.code === 'firestore/permission-denied') {
          errEl.textContent = 'âš ï¸ Error de configuraciÃ³n: las reglas de Firestore no permiten acceso. Contacta al administrador.';
          console.error(e.message);
          if (loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Entrar'; }
          _loginInProgress = false;
          return;
        }
        console.warn('[Login] Step 1b failed:', e.code || '', e.message || e);
      }
    }

    if (subUser) {
      if (subUser.passHash !== hashPass(pass)) {
        throw { code: 'auth/wrong-password' };
      }
      currentUser = subUser;
      const fbOk = await _restoreFirebaseForSubUser();
      if (!fbOk) {
        currentUser = null;
        errEl.textContent = 'âš ï¸ ConexiÃ³n no disponible. El titular debe iniciar sesiÃ³n primero en este dispositivo para activar la conexiÃ³n.';
        if (loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Entrar'; }
        _loginInProgress = false;
        return;
      }
      // Refresh user perms from Firestore (localStorage may be stale)
      try {
        const freshUsers = await fbLoadUsers();
        if (freshUsers && freshUsers.length > 0) {
          localStorage.setItem('gestorrenta_users', JSON.stringify(freshUsers));
          const freshUser = freshUsers.find(u => u.id === subUser.id);
          if (freshUser) {
            // Keep the password hash from local (Firestore might not have it)
            freshUser.passHash = freshUser.passHash || subUser.passHash;
            currentUser = freshUser;
          }
        }
      } catch(e) { /* Use local perms if Firestore fails */ }
      _finishLogin(currentUser);
      return;
    }

    // Step 2: Not a sub-user. Resolve email for Firebase Auth.
    let email = emailOrUser.includes('@') ? emailOrUser : null;
    if (!email) {
      const stored = localStorage.getItem('gestorrenta_email_map');
      const map = stored ? JSON.parse(stored) : {};
      email = map[inputLower] || null;
    }

    if (email) {
      // Step 3: Try Firebase Auth (titular login)
      // If already authenticated with same email, reuse session to avoid triggering onAuthStateChanged
      const existingAuth = auth ? auth.currentUser : null;
      if (existingAuth && existingAuth.email && existingAuth.email.toLowerCase() === email.toLowerCase()) {
        try {
          const credential = firebase.auth.EmailAuthProvider.credential(email, pass);
          await existingAuth.reauthenticateWithCredential(credential);
          _fbAuth = existingAuth;
        } catch(reErr) {
          const cred = await auth.signInWithEmailAndPassword(email, pass);
          _fbAuth = cred.user;
        }
      } else {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        _fbAuth = cred.user;
      }
      // Store credentials so sub-users can restore Firebase session later
      try {
        _tenantPassPlain = pass; // Keep in memory for sub-user mapping encryption
        localStorage.setItem('gestorrenta_tenant_pass', pass);
        localStorage.setItem('gestorrenta_tenant_uid', _fbAuth.uid);
      } catch(e) {}
      await _afterFirebaseLogin();
    } else {
      // Step 4: No email, no sub-user match â€” try legacy with username
      await _legacyLogin(emailOrUser, pass);
    }
  } catch(e) {
    console.error('Login error:', e);
    let msg = 'Usuario o contraseÃ±a incorrectos.';
    if (e.code === 'auth/too-many-requests') msg = 'Demasiados intentos. Espera un momento.';
    if (e.code === 'auth/network-request-failed') msg = 'Sin conexiÃ³n a internet.';
    if (e.code === 'auth/invalid-credential') msg = 'Credenciales invÃ¡lidas. Verifica tu correo y contraseÃ±a.';
    if (e.code === 'auth/user-not-found') msg = 'No existe una cuenta con ese correo.';
    // Show real error for debugging (helps identify JS crashes vs auth errors)
    if (!e.code) msg = 'Error interno: ' + (e.message || e.toString()).substring(0, 150);
    console.warn('Login failed â€” code:', e.code, 'msg:', e.message, 'user:', emailOrUser);
    errEl.textContent = msg;
    document.getElementById('login-pass').value = '';
  } finally {
    _loginInProgress = false;
    if (loginBtn) { loginBtn.disabled = false; loginBtn.textContent = 'Entrar'; }
  }
}

// Restore Firebase Auth session for sub-users using stored titular credentials
async function _restoreFirebaseForSubUser() {
  if (_fbAuth) return true;
  try {
    // Method 1: Check if Firebase already has an active session
    const existing = auth ? auth.currentUser : null;
    if (existing) { _fbAuth = existing; return true; }

    // Method 2: Use stored tenant credentials from localStorage
    const emailMap = JSON.parse(localStorage.getItem('gestorrenta_email_map') || '{}');
    const tenantEmail = Object.values(emailMap).find(e => e);
    const tenantPass = localStorage.getItem('gestorrenta_tenant_pass');
    if (tenantEmail && tenantPass) {
      const cred = await auth.signInWithEmailAndPassword(tenantEmail, tenantPass);
      _fbAuth = cred.user;
      return true;
    }
  } catch(e) {
    console.warn('Sub-user Firebase restore failed:', e);
    if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
      localStorage.removeItem('gestorrenta_tenant_pass');
    }
  }
  // Firebase not available â€” data won't load
  return false;
}

// Finish login after authentication (shared by all login paths)
function _finishLogin(user) {
  currentUser = user; // Ensure currentUser is always the latest user object
  sessionStorage.setItem('gestorrenta_session', JSON.stringify({id: user.id, ts: Date.now()}));
  document.getElementById('loginScreen').style.display = 'none';
  applyPermissions();
  fbStartSync();
  history.replaceState({ page: 'dashboard' }, '', window.location.href);
  var savedPage = null;
  try { savedPage = sessionStorage.getItem('gr_cur_page'); } catch(e) {}
  var validPages = ['dashboard','rentas','clientes','pagos','alertas','reportes','extra','ajustes','gastos','ayuda','facturacion'];
  if (savedPage && validPages.includes(savedPage)) currentPage = savedPage;
  // Always render immediately. If data hasn't loaded yet, fbStartSync's 
  // onSnapshot will call render() again when data arrives.
  render();
  history.replaceState({ page: currentPage }, '', '#' + currentPage);
  fbShowStatus(true);
  ofrecerBioRegistro(user);

  // Auto-apply pending rent increments after data loads
  setTimeout(function() {
    if (state.rentas.length > 0) autoAplicarIncrementos();
    // Monthly plan timbres bonus
    acreditarTimbresmensuales();
  }, 3000);

  // Backup: if onSnapshot hasn't delivered data in 2s, do a direct read
  setTimeout(function() {
    if (state.rentas.length === 0 && _fbAuth) {
      var docRef = tenantDoc();
      if (docRef) {
        docRef.get().then(function(snap) {
          if (snap.exists) {
            var data = snap.data();
            if (data.rentas && data.rentas.length > 0) {
              state.rentas = data.rentas;
              state.clientes = data.clientes || [];
              state.formasPago = data.formasPago || JSON.parse(JSON.stringify(DEFAULT_FORMAS_PAGO));
              state.tiposGasto = data.tiposGasto || [...DEFAULT_TIPOS_GASTO];
              state.tiposProp  = data.tiposProp  || [...DEFAULT_TIPOS_PROP];
              state.alertaSeguimiento = data.alertaSeguimiento || {};
              _fbReady = true;
              render();
            }
          }
        }).catch(function(err) { console.warn('Backup read failed:', err); });
      }
    }
  }, 2000);
}

async function _afterFirebaseLogin() {
  // Clear any stale state from localStorage before loading this user's data
  state.rentas = [];
  state.clientes = [];
  state.formasPago = JSON.parse(JSON.stringify(DEFAULT_FORMAS_PAGO));
  state.tiposGasto = [...DEFAULT_TIPOS_GASTO];
  state.tiposProp  = [...DEFAULT_TIPOS_PROP];
  state.alertaSeguimiento = {};

  // Load users list for this tenant
  const users = await fbLoadUsers();
  // Sync Firestore users to localStorage so sub-users can login
  if (users && users.length > 0) {
    localStorage.setItem('gestorrenta_users', JSON.stringify(users));
  }
  // Find or create titular user
  let user = users ? users.find(u => u.role === 'titular') : null;
  if (!user) {
    user = {
      id: 'titular',
      nombre: 'Titular',
      username: _fbAuth.email,
      role: 'titular',
      perms: ['prop_read','prop_write','cli_read','cli_write','abono_write','abono_delete','factura_write','dash_read','alertas_read','alertas_write','vacant_read','config_read'],
      createdAt: new Date().toISOString(),
    };
    saveUsers([user]);
  }
  currentUser = user;

  // Store tenant UID for sub-user Firebase restoration
  try { localStorage.setItem('gestorrenta_tenant_uid', _fbAuth.uid); } catch(e) {}

  // Sync sub-user mappings to Firestore (enables sub-user login from any device)
  // This runs every time the titular logs in, keeping mappings up-to-date
  fbSyncAllSubUserMappings();

  // Load plan info
  const plan = await fbLoadPlan();
  if (plan) {
    state.plan = plan.plan || 'basico';
    state.planLimites = getPlanLimites(plan.plan || 'basico');
    if (plan.stripeStatus === 'canceled' || plan.stripeStatus === 'past_due') {
      _showPlanExpiredScreen();
      return;
    }
  } else {
    state.plan = 'basico';
    state.planLimites = getPlanLimites('basico');
    await fbSavePlan({
      plan: 'basico',
      email: _fbAuth.email,
      createdAt: new Date().toISOString(),
      stripeStatus: 'trialing',
      trialEnds: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString(),
    });
  }

  _finishLogin(user);
}

async function _legacyLogin(username, pass) {
  let users = loadUsers();
  let user = users.find(u =>
    (u.username && u.username.toLowerCase() === username.toLowerCase()) ||
    (u.subEmail && u.subEmail.toLowerCase() === username.toLowerCase())
  );

  if (!user || user.passHash !== hashPass(pass)) {
    throw { code: 'auth/wrong-password' };
  }
  currentUser = user;

  // Restore Firebase Auth for data access
  if (user.role !== 'titular') {
    await _restoreFirebaseForSubUser();
    // Refresh perms from Firestore (localStorage may be stale)
    try {
      const freshUsers = await fbLoadUsers();
      if (freshUsers && freshUsers.length > 0) {
        localStorage.setItem('gestorrenta_users', JSON.stringify(freshUsers));
        const freshUser = freshUsers.find(u => u.id === user.id);
        if (freshUser) {
          freshUser.passHash = freshUser.passHash || user.passHash;
          currentUser = freshUser;
        }
      }
    } catch(e) { /* Use local perms if Firestore fails */ }
  }

  _finishLogin(currentUser);
}

// â”€â”€ Panel navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoginPanel() {
  document.getElementById('login-panel').style.display = '';
  document.getElementById('register-panel').style.display = 'none';
  document.getElementById('forgot-panel').style.display = 'none';
  document.getElementById('plan-expired-panel').style.display = 'none';
}
function showRegisterPanel() {
  document.getElementById('login-panel').style.display = 'none';
  document.getElementById('register-panel').style.display = '';
  document.getElementById('forgot-panel').style.display = 'none';
}
function _showPlanExpiredScreen() {
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('login-panel').style.display = 'none';
  document.getElementById('register-panel').style.display = 'none';
  document.getElementById('plan-expired-panel').style.display = '';
}

// â”€â”€ New customer registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doRegister() {
  const nombre  = document.getElementById('reg-nombre').value.trim();
  const empresa = document.getElementById('reg-empresa').value.trim();
  const email   = document.getElementById('reg-email').value.trim();
  const tel     = document.getElementById('reg-tel').value.trim();
  const pass    = document.getElementById('reg-pass').value;
  const plan    = document.getElementById('reg-plan').value;
  const errEl   = document.getElementById('reg-error');
  const btn     = document.getElementById('reg-btn');
  errEl.textContent = '';

  if (!nombre || !email || !pass) { errEl.textContent = 'Nombre, correo y contraseÃ±a son obligatorios.'; return; }
  if (pass.length < 6)            { errEl.textContent = 'La contraseÃ±a debe tener mÃ­nimo 6 caracteres.'; return; }
  if (!email.includes('@'))       { errEl.textContent = 'Ingresa un correo vÃ¡lido.'; return; }

  btn.disabled = true; btn.textContent = 'Creando cuenta...';

  try {
    _loginInProgress = true;
    // Create Firebase Auth user
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    _fbAuth = cred.user;
    _tenantPassPlain = pass; // Keep in memory for sub-user mapping encryption

    // Set up tenant plan in Firestore
    const trialEnds = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString();
    await fbSavePlan({
      plan,
      nombre,
      empresa: empresa || nombre,
      email,
      tel,
      createdAt: new Date().toISOString(),
      stripeStatus: 'trialing',
      trialEnds,
      stripeCustomerId: null,
      stripeSubscriptionId: null,
    });

    // Save email mapping for username login
    const map = JSON.parse(localStorage.getItem('gestorrenta_email_map') || '{}');
    map[email.toLowerCase()] = email;
    localStorage.setItem('gestorrenta_email_map', JSON.stringify(map));

    // Create initial titular user for this tenant
    const titularUser = {
      id: 'titular',
      nombre,
      username: email,
      role: 'titular',
      perms: ['prop_read','prop_write','cli_read','cli_write','abono_write','abono_delete','factura_write','dash_read','alertas_read','alertas_write','vacant_read','config_read'],
      createdAt: new Date().toISOString(),
    };
    await fbSaveUsers([titularUser]);

    // Log in automatically
    await _afterFirebaseLogin();

    mostrarToastExito(`Â¡Bienvenido ${nombre}! Tu prueba gratuita de 15 dÃ­as ha comenzado.`);
    _loginInProgress = false;
  } catch(e) {
    console.error('Register error:', e);
    let msg = 'Error al crear la cuenta.';
    if (e.code === 'auth/email-already-in-use') msg = 'Este correo ya tiene una cuenta. Inicia sesiÃ³n.';
    if (e.code === 'auth/weak-password')         msg = 'La contraseÃ±a es muy dÃ©bil.';
    if (e.code === 'auth/invalid-email')          msg = 'Correo invÃ¡lido.';
    errEl.textContent = msg;
    btn.disabled = false; btn.textContent = 'Crear cuenta gratis';
    _loginInProgress = false;
  }
}

// â”€â”€ Auth state observer â€” auto-login on page refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€
// _loginInProgress prevents race condition: when doLogin calls
// signInWithEmailAndPassword, it triggers onAuthStateChanged which
// would also call _afterFirebaseLogin, causing double execution
// that clears already-loaded data.
let _loginInProgress = false;

auth.onAuthStateChanged(async (firebaseUser) => {
  if (firebaseUser) {
    _fbAuth = firebaseUser;
    try { localStorage.setItem('gestorrenta_tenant_uid', firebaseUser.uid); } catch(e) {}

    if (_loginInProgress) return;

    // If login screen is showing (user explicitly logged out), don't auto-login
    const loginScreen = document.getElementById('loginScreen');
    if (loginScreen && loginScreen.style.display !== 'none') {
      return;
    }

    // If currentUser already exists (restored by checkSession in initApp),
    // but fbStartSync couldn't connect because _fbAuth wasn't ready yet,
    // retry now that _fbAuth is set.
    if (currentUser && !_fbUnsubscribe) {
      fbStartSync();
      if (_fbReady) render();
      // Sync users from Firestore to localStorage AND update currentUser perms
      fbLoadUsers().then(function(users) {
        if (users && users.length > 0) {
          localStorage.setItem('gestorrenta_users', JSON.stringify(users));
          // CRITICAL: Also refresh currentUser's perms/tiposPropPermitidos
          // Without this, sub-users keep stale perms from localStorage on page reload
          if (currentUser && currentUser.role !== 'titular') {
            var freshUser = users.find(function(u) { return u.id === currentUser.id; });
            if (freshUser) {
              freshUser.passHash = freshUser.passHash || currentUser.passHash;
              currentUser = freshUser;
              applyPermissions();
              render();
            }
          }
        }
      }).catch(function(){});
      return;
    }

    if (!currentUser) {
      const sessRaw = sessionStorage.getItem('gestorrenta_session');
      if (sessRaw) {
        try {
          const sess = JSON.parse(sessRaw);
          if (Date.now() - sess.ts < 8 * 60 * 60 * 1000) {
            const users = loadUsers();
            const subUser = users.find(u => u.id === sess.id);
            if (subUser && subUser.role !== 'titular') {
              currentUser = subUser;
              document.getElementById('loginScreen').style.display = 'none';
              applyPermissions();
              fbStartSync();
              render();
              fbShowStatus(true);
              // Async refresh perms from Firestore (localStorage may be stale)
              fbLoadUsers().then(function(freshUsers) {
                if (freshUsers && freshUsers.length > 0) {
                  localStorage.setItem('gestorrenta_users', JSON.stringify(freshUsers));
                  var freshUser = freshUsers.find(function(u) { return u.id === subUser.id; });
                  if (freshUser) {
                    freshUser.passHash = freshUser.passHash || subUser.passHash;
                    currentUser = freshUser;
                    applyPermissions();
                    render();
                  }
                }
              }).catch(function(){});
              return;
            }
          }
        } catch(e) {}
      }
      try {
        await _afterFirebaseLogin();
      } catch(e) {
        console.error('Auto-login error:', e);
      }
    }
  }
});

function doLogout() {
  fbStopSync();
  currentUser = null;
  // DO NOT clear _fbAuth or call auth.signOut()
  // Firebase Auth is the TENANT session shared by titular + sub-users
  _fbReady = false;
  _statusCache = {}; // Clear status cache to prevent stale data for next user
  state.rentas = [];
  state.clientes = [];
  state.formasPago = JSON.parse(JSON.stringify(DEFAULT_FORMAS_PAGO));
  state.tiposGasto = [...DEFAULT_TIPOS_GASTO];
  state.tiposProp  = [...DEFAULT_TIPOS_PROP];
  state.alertaSeguimiento = {};
  localStorage.removeItem('gestorrenta_v2');
  sessionStorage.removeItem('gestorrenta_session');
  closeUserDropdown();
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-error').textContent = '';
  document.getElementById('loginScreen').style.display = 'flex';
  bioInit();
}

function checkSession() {
  const raw = sessionStorage.getItem('gestorrenta_session');
  if (!raw) return false;
  try {
    const sess = JSON.parse(raw);
    // Session valid for 8 hours
    if (Date.now() - sess.ts > 8 * 60 * 60 * 1000) { sessionStorage.removeItem('gestorrenta_session'); return false; }
    const users = loadUsers();
    const user = users.find(u => u.id === sess.id);
    if (!user) return false;
    currentUser = user;
    // Async refresh from Firestore (perms may be stale in localStorage)
    if (user.role !== 'titular') {
      fbLoadUsers().then(function(freshUsers) {
        if (freshUsers && freshUsers.length > 0) {
          localStorage.setItem('gestorrenta_users', JSON.stringify(freshUsers));
          var freshUser = freshUsers.find(function(u) { return u.id === user.id; });
          if (freshUser) {
            freshUser.passHash = freshUser.passHash || user.passHash;
            currentUser = freshUser;
            applyPermissions();
            render();
          }
        }
      }).catch(function(){});
    }
    return true;
  } catch(e) { return false; }
}

function hasPerm(perm) {
  if (!currentUser) return false;
  if (currentUser.role === 'titular') return true;
  return (currentUser.perms || []).includes(perm);
}

function applyPermissions() {
  if (!currentUser) return;
  // Update header avatar
  const initials = currentUser.nombre.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('user-avatar-btn').textContent = initials;
  document.getElementById('dd-username').textContent = currentUser.nombre;
  document.getElementById('dd-role').textContent = currentUser.role === 'titular' ? 'ğŸ‘‘ Titular â€” acceso completo' : 'ğŸ‘¤ Usuario';

  const isTitular = currentUser.role === 'titular';

  // Show/hide nav items based on perms
  // Propiedades: always visible (read) â€” hide add button if no prop_write
  // Dashboard: hide if no dash_read (and not titular)
  // Alertas: hide if no alertas_read (and not titular)
  // Usuarios page: only titular
  // Show usuarios section inside config only for titular
  const cfgUsuariosSection = document.getElementById('cfg-usuarios-section');
  if (cfgUsuariosSection) cfgUsuariosSection.style.display = isTitular ? '' : 'none';

  const ddManage = document.getElementById('dd-manage-users');
  const ddSep = document.getElementById('dd-sep');
  if (ddManage) ddManage.style.display = isTitular ? '' : 'none';
  if (ddSep) ddSep.style.display = isTitular ? '' : 'none';

  // â”€â”€ Hide/show nav buttons based on perms (using IDs for reliability) â”€â”€
  const navRules = {
    'nav-dashboard': isTitular || hasPerm('dash_read') || hasPerm('vacant_read'),
    'nav-rentas':    isTitular || hasPerm('prop_read') || hasPerm('vacant_read'),
    'nav-clientes':  isTitular || hasPerm('cli_read') || hasPerm('alertas_read') || hasPerm('abono_write'),
    'nav-alertas':   isTitular || hasPerm('alertas_read'),
    'nav-pagos':     isTitular || hasPerm('config_read'),
    'nav-facturacion': isTitular,
    'nav-extra':     true,
    // Mobile nav
    'mnav-dashboard': isTitular || hasPerm('dash_read') || hasPerm('vacant_read'),
    'mnav-rentas':    isTitular || hasPerm('prop_read') || hasPerm('vacant_read'),
    'mnav-clientes':  isTitular || hasPerm('cli_read') || hasPerm('alertas_read') || hasPerm('abono_write'),
    'mnav-alertas':   isTitular || hasPerm('alertas_read'),
    'mnav-pagos':     isTitular || hasPerm('config_read'),
    'mnav-facturacion': isTitular,
    'mnav-extra':     true,
  };
  Object.entries(navRules).forEach(([id, show]) => {
    const el = document.getElementById(id);
    if (el) el.style.display = show ? '' : 'none';
  });

  // â”€â”€ Hide header stats for users without dash_read â”€â”€
  const showStats = isTitular || hasPerm('dash_read');
  const desktopStats = document.getElementById('desktop-header-stats');
  if (desktopStats) desktopStats.style.display = showStats ? '' : 'none';
  const mobileStats = document.getElementById('mobile-header-stats');
  if (mobileStats) mobileStats.style.display = showStats ? '' : 'none';

  // â”€â”€ Config page: make read-only for non-titular â”€â”€
  if (!isTitular) {
    // Hide all edit controls in config
    document.querySelectorAll('.config-add-row').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.config-tag .tag-del').forEach(el => el.style.display = 'none');
    // Hide fiscal config edit buttons
    const fiscalBtns = document.querySelectorAll('#page-pagos button.btn-primary, #page-pagos button.btn-danger');
    fiscalBtns.forEach(b => {
      const txt = (b.textContent||'').toLowerCase();
      if (txt.includes('guardar') || txt.includes('eliminar') || txt.includes('nuevo') || txt.includes('agregar') || txt.includes('+')) b.style.display = 'none';
    });
    // Hide dias gracia save button
    const dgBtn = document.querySelector('#page-pagos [onclick*="guardarDiasGracia"]');
    if (dgBtn) dgBtn.style.display = 'none';
    // Hide plantilla universal section
    const plantillaSection = document.querySelector('#page-pagos .config-section[style*="border:2px solid var(--accent)"]');
    if (plantillaSection) plantillaSection.style.display = 'none';
  } else {
    // Restore for titular
    document.querySelectorAll('.config-add-row').forEach(el => el.style.display = '');
    document.querySelectorAll('.config-tag .tag-del').forEach(el => el.style.display = '');
  }
}

// â”€â”€â”€ User dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleUserDropdown() {
  document.getElementById('user-dropdown').classList.toggle('open');
}
function closeUserDropdown() {
  document.getElementById('user-dropdown').classList.remove('open');
}
document.addEventListener('click', e => {
  const wrap = document.getElementById('user-menu-wrap');
  if (wrap && !wrap.contains(e.target)) closeUserDropdown();
});

// â”€â”€â”€ Render Usuarios page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsuarios() {
  const el = document.getElementById('usuarios-list');
  if (!el) return;
  const users = loadUsers();
  el.innerHTML = users.map(u => {
    const isSelf = u.id === currentUser?.id;
    let permChips = '';
    let tiposHtml = '';
    if (u.role === 'titular') {
      permChips = '<span class="perm-chip">ğŸ‘‘ Acceso completo</span>';
      if (u.email) permChips += ` <span class="perm-chip">ğŸ“§ ${u.email}</span>`;
      permChips += u.recoveryCode
        ? ' <span class="perm-chip" style="background:#e8f5e9;color:#2d6a4f">ğŸ”‘ CÃ³digo activo</span>'
        : ' <span class="perm-chip" style="background:#fef9ec;color:#b7791f">âš ï¸ Sin cÃ³digo de recuperaciÃ³n</span>';
    } else {
      const permsPart = (u.perms||[]).map(p => `<span class="perm-chip">${PERM_LABELS[p]||p}</span>`).join('');
      const tiposPart = (u.tiposPropPermitidos||[]).length ? '<div class="user-card-tipos">ğŸ¢ Solo ve: ' + u.tiposPropPermitidos.join(', ') + '</div>' : '';
      const emailPart = u.subEmail ? ` <span class="perm-chip">ğŸ“§ ${u.subEmail}</span>` : '';
      const recoveryPart = u.recoveryCode
        ? ' <span class="perm-chip" style="background:#e8f5e9;color:#2d6a4f">ğŸ”‘ CÃ³digo activo</span>'
        : '';
      permChips = (permsPart + emailPart + recoveryPart) ||
        '<span style="font-size:12px;color:var(--text3)">Sin facultades asignadas</span>';
      tiposHtml = tiposPart;
    }
    return `
    <div class="user-card">
      <div class="user-card-top">
        <div class="user-card-avatar" style="background:${u.role==='titular'?'#b7791f':u.id.charCodeAt(0)%2?'#2d6a4f':'#2563eb'}">${u.nombre.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</div>
        <div class="user-card-info">
          <div class="user-card-name">${u.nombre} ${isSelf?'<span style="font-size:11px;color:var(--text3)">(tÃº)</span>':''}</div>
          <div class="user-card-role">@${u.username} Â· ${u.role==='titular'?'ğŸ‘‘ Titular':'Usuario'}</div>
        </div>
      </div>
      <div class="user-card-perms">${permChips}</div>
      ${tiposHtml||''}
      <div class="user-card-actions">
        <button class="btn btn-ghost" style="font-size:11px;padding:6px 12px;flex:1" onclick="editarUsuario('${u.id}')">âœï¸ Editar</button>
        ${u.role !== 'titular' ? `<button class="btn btn-danger" style="font-size:11px;padding:6px 12px" onclick="eliminarUsuario('${u.id}')">ğŸ—‘ï¸</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ CRUD Usuarios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editandoUsuarioId = null;

function prepNuevoUsuario() {
  editandoUsuarioId = null;
  document.getElementById('modal-usuario-title').textContent = 'Nuevo Usuario';
  document.getElementById('u-nombre').value = '';
  document.getElementById('u-user').value = '';
  document.getElementById('u-pass').value = '';
  document.getElementById('u-pass').placeholder = 'MÃ­nimo 4 caracteres';
  document.getElementById('u-subemail').value = '';
  PERM_LIST.forEach(p => { const el = document.getElementById('perm-'+p); if(el) el.checked = false; });
  const allToggle = document.getElementById('perm-all');
  if (allToggle) allToggle.checked = false;
  const permsDiv = document.getElementById('modal-perms-section');
  if (permsDiv) permsDiv.style.display = '';
  const tiposDiv = document.getElementById('modal-tipos-section');
  if (tiposDiv) tiposDiv.style.display = '';
  populateTiposPermSection([]);
  const recSection = document.getElementById('u-recovery-section');
  if (recSection) recSection.style.display = 'none';
  const subEmailSection = document.getElementById('u-subemail-section');
  if (subEmailSection) subEmailSection.style.display = '';
  document.getElementById('u-sub-recovery-code-wrap').style.display = 'none';
  document.getElementById('u-sub-recovery-no-code').style.display = '';
}

function editarUsuario(id) {
  const users = loadUsers();
  const u = users.find(x => x.id === id);
  if (!u) return;
  editandoUsuarioId = id;
  document.getElementById('modal-usuario-title').textContent = u.role === 'titular' ? 'âœï¸ Editar Titular' : 'Editar Usuario';
  document.getElementById('u-nombre').value = u.nombre;
  document.getElementById('u-user').value = u.username;
  document.getElementById('u-pass').value = '';
  document.getElementById('u-pass').placeholder = 'Dejar vacÃ­o para no cambiar';
  PERM_LIST.forEach(p => { const el = document.getElementById('perm-'+p); if(el) el.checked = (u.perms||[]).includes(p); });
  syncAccesoCompletoToggle();
  populateTiposPermSection(u.tiposPropPermitidos || []);
  const tiposDivEdit = document.getElementById('modal-tipos-section');
  if (tiposDivEdit) tiposDivEdit.style.display = u.role === 'titular' ? 'none' : '';
  populateTiposPermSection(u.tiposPropPermitidos || []);
  syncAccesoCompletoToggle();
  // Ocultar secciÃ³n de facultades para el titular
  const permsDiv = document.getElementById('modal-perms-section');
  if (permsDiv) permsDiv.style.display = u.role === 'titular' ? 'none' : '';
  const tiposDivHide = document.getElementById('modal-tipos-section');
  if (tiposDivHide) tiposDivHide.style.display = u.role === 'titular' ? 'none' : '';
  const tiposDiv = document.getElementById('modal-tipos-section');
  if (tiposDiv) tiposDiv.style.display = u.role === 'titular' ? 'none' : '';
  // Show/hide recovery section (only for titular)
  const recSection = document.getElementById('u-recovery-section');
  if (recSection) recSection.style.display = u.role === 'titular' ? '' : 'none';
  // Show/hide sub-user email section
  const subEmailSection = document.getElementById('u-subemail-section');
  if (subEmailSection) subEmailSection.style.display = u.role === 'titular' ? 'none' : '';
  document.getElementById('u-subemail').value = u.subEmail || '';
  // Show/hide sub-user recovery code
  if (u.role !== 'titular') {
    if (u.recoveryCode) {
      showSubRecoveryCode(u.recoveryCode);
    } else {
      document.getElementById('u-sub-recovery-code-wrap').style.display = 'none';
      document.getElementById('u-sub-recovery-no-code').style.display = '';
    }
  }
  if (u.role === 'titular') {
    document.getElementById('u-email').value = u.email || '';
    if (u.recoveryCode) {
      showRecoveryCode(u.recoveryCode);
    } else {
      document.getElementById('u-recovery-code-wrap').style.display = 'none';
      document.getElementById('u-recovery-no-code').style.display = '';
    }
  }
  openModal('modalUsuario');
}

function populateTiposPermSection(tiposPermitidos) {
  const wrap = document.getElementById('tipos-prop-checks');
  if (!wrap) return;
  const tipos = state.tiposProp || DEFAULT_TIPOS_PROP;
  wrap.innerHTML = '';
  tipos.forEach(t => {
    let activo = !tiposPermitidos || tiposPermitidos.length === 0 || tiposPermitidos.includes(t);
    const row = document.createElement('div');
    row.dataset.tipo = t;
    row.dataset.activo = activo ? '1' : '0';
    const updateStyle = () => {
      const on = row.dataset.activo === '1';
      row.style.cssText = 'display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.15s;' +
        (on ? 'background:#e8f5ef;border:2px solid #2d6a4f;color:#1b3a2d;'
            : 'background:#f0ece4;border:2px solid #ccc;color:#555;');
      box.style.cssText = 'width:22px;height:22px;border-radius:5px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:900;transition:all 0.15s;' +
        (on ? 'background:#2d6a4f;color:#fff;' : 'background:#ccc;color:transparent;');
      box.textContent = 'âœ“';
    };
    const box = document.createElement('div');
    const txt = document.createElement('span');
    txt.textContent = t;
    row.appendChild(box);
    row.appendChild(txt);
    updateStyle();
    row.addEventListener('click', e => {
      e.stopPropagation();
      row.dataset.activo = row.dataset.activo === '1' ? '0' : '1';
      updateStyle();
    });
    wrap.appendChild(row);
  });
}

function getTiposPermitidosFromModal() {
  const rows = document.querySelectorAll('#tipos-prop-checks [data-tipo]');
  const all = Array.from(rows);
  const selected = all.filter(r => r.dataset.activo === '1').map(r => r.dataset.tipo);
  return selected.length === all.length ? [] : selected;
}

// getTiposPermitidosFromModal redefined in populateTiposPermSection

function toggleAccesoCompleto(checked) {
  PERM_LIST.forEach(p => {
    const el = document.getElementById('perm-' + p);
    if (el) el.checked = checked;
  });
}

// When individual perms change, uncheck "all" if not all checked
function syncAccesoCompletoToggle() {
  const all = PERM_LIST.every(p => {
    const el = document.getElementById('perm-' + p);
    return el && el.checked;
  });
  const allToggle = document.getElementById('perm-all');
  if (allToggle) allToggle.checked = all;
}

function guardarUsuario() {
  const nombre = document.getElementById('u-nombre').value.trim();
  const username = document.getElementById('u-user').value.trim().toLowerCase();
  const pass = document.getElementById('u-pass').value;
  const subEmail = (document.getElementById('u-subemail').value || '').trim().toLowerCase();

  if (!nombre || !username) return alert('El nombre y el usuario son obligatorios.');
  if (subEmail && !subEmail.includes('@')) return alert('El correo electrÃ³nico no es vÃ¡lido.');

  const users = loadUsers();

  // Check username uniqueness (also against subEmails of other users)
  const duplicate = users.find(u => u.id !== editandoUsuarioId && (
    u.username.toLowerCase() === username ||
    (u.subEmail && u.subEmail.toLowerCase() === username)
  ));
  if (duplicate) return alert('Ese nombre de usuario ya existe.');

  // Check subEmail uniqueness (also against usernames of other users)
  if (subEmail) {
    const emailDup = users.find(u => u.id !== editandoUsuarioId && (
      u.username.toLowerCase() === subEmail ||
      (u.subEmail && u.subEmail.toLowerCase() === subEmail)
    ));
    if (emailDup) return alert('Ese correo ya estÃ¡ asignado a otro usuario.');
  }

  const perms = PERM_LIST.filter(p => { const el = document.getElementById('perm-'+p); return el && el.checked; });
  const tiposPermitidos = getTiposPermitidosFromModal();

  if (editandoUsuarioId) {
    const u = users.find(x => x.id === editandoUsuarioId);
    if (!u) return;
    u.nombre = nombre;
    u.username = username;
    if (pass) {
      if (pass.length < 4) return alert('La contraseÃ±a debe tener al menos 4 caracteres.');
      u.passHash = hashPass(pass);
    }
    u.perms = perms;
    u.tiposPropPermitidos = tiposPermitidos;
    // Save email for titular
    if (u.role === 'titular') {
      const emailEl = document.getElementById('u-email');
      if (emailEl) u.email = emailEl.value.trim();
    }
    // Save subEmail for sub-users
    if (u.role !== 'titular') {
      u.subEmail = subEmail || '';
    }
  } else {
    if (!pass || pass.length < 4) return alert('La contraseÃ±a debe tener al menos 4 caracteres.');
    users.push({
      id: uid(),
      nombre,
      username,
      subEmail: subEmail || '',
      passHash: hashPass(pass),
      role: 'usuario',
      perms,
      tiposPropPermitidos: tiposPermitidos,
      createdAt: new Date().toISOString(),
    });
  }

  saveUsers(users);
  // Sync sub-user mapping to Firestore (enables login from any device)
  // The encryption key is the sub-user's passHash (derived from their password)
  if (editandoUsuarioId) {
    const savedUser = users.find(x => x.id === editandoUsuarioId);
    if (savedUser && savedUser.role !== 'titular') {
      fbSaveSubUserMapping(savedUser.username, savedUser.subEmail || '', savedUser.passHash, savedUser.id);
    }
  } else {
    // New user â€” the last one pushed
    const newUser = users[users.length - 1];
    if (newUser && newUser.role !== 'titular') {
      fbSaveSubUserMapping(newUser.username, newUser.subEmail || '', newUser.passHash, newUser.id);
    }
  }
  showToast('âœ… Usuario guardado');
  closeModal('modalUsuario');
  renderUsuarios();
}

function eliminarUsuario(id) {
  if (!confirm('Â¿Eliminar este usuario?')) return;
  const allUsers = loadUsers();
  const deletedUser = allUsers.find(u => u.id === id);
  const users = allUsers.filter(u => u.id !== id);
  saveUsers(users);
  // Remove sub-user mapping from Firestore
  if (deletedUser && deletedUser.role !== 'titular') {
    fbDeleteSubUserMapping(deletedUser.username, deletedUser.subEmail || '');
  }
  renderUsuarios();
}

// ============================================================
// STATE
// ============================================================
const DEFAULT_FORMAS_PAGO = [
  { id: 'fp-efectivo', nombre: 'Efectivo', icono: 'ğŸ’µ', desc: '' },
  { id: 'fp-transferencia', nombre: 'Transferencia', icono: 'ğŸ”„', desc: '' },
  { id: 'fp-deposito', nombre: 'DepÃ³sito', icono: 'ğŸ¦', desc: '' },
  { id: 'fp-tarjeta', nombre: 'Tarjeta', icono: 'ğŸ’³', desc: '' },
];
const DEFAULT_TIPOS_GASTO = [
  'Mantenimiento', 'Pago de luz', 'Pago de agua', 'Predial',
  'ComisiÃ³n corredor', 'ReparaciÃ³n', 'Pintura', 'FumigaciÃ³n', 'JardinerÃ­a', 'Otro'
];
const DEFAULT_TIPOS_PROP = [
  'Departamento', 'Casa', 'Local comercial', 'Bodega', 'Oficina', 'Otro'
];

// â”€â”€ Plan definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPlanLimites(plan) {
  const planes = {
    basico:     { propiedades: 10,  usuarios: 1,  storage: 1,   whatsapp: false, timbres: 0,   nombre: 'BÃ¡sico',     precio: 199 },
    pro:        { propiedades: 50,  usuarios: 3,  storage: 5,   whatsapp: true,  timbres: 10,  nombre: 'Pro',        precio: 499 },
    enterprise: { propiedades: 999, usuarios: 99, storage: 20,  whatsapp: true,  timbres: 50,  nombre: 'Enterprise', precio: 899 },
    // Admin plan - for gestorrentas.com owner
    admin:      { propiedades: 999, usuarios: 99, storage: 999, whatsapp: true,  timbres: 999, nombre: 'Admin',      precio: 0   },
  };
  return planes[plan] || planes.basico;
}

let state = {
  rentas: [],
  clientes: [],
  formasPago: JSON.parse(JSON.stringify(DEFAULT_FORMAS_PAGO)),
  tiposGasto: [...DEFAULT_TIPOS_GASTO],
  tiposProp:  [...DEFAULT_TIPOS_PROP],
  alertaSeguimiento: {}, // { rentaId: { nota, fechaAccion, creadoEl } }
  plan: 'basico',
  planLimites: getPlanLimites('basico'),
  timbresBalance: 0,
  timbresHistorial: [], // { fecha, tipo:'compra'|'uso'|'bonus', cantidad, saldo, detalle }
  timbresPrecio: { precio1: 15, precio10: 12, precio50: 9, precio100: 7 }, // precios por timbre
};
let currentFilter = 'all';
let currentRentaId = null;
let currentClienteId = null;
let _prevPage = null;
let _clienteEstadoFiltro = null; // filtro activo en lista clientes
let _rentaTipoFiltro    = null; // filtro activo en lista rentas (desde dashboard)
let _rentaEstadoFiltro  = null; // filtro: 'rentadas' | 'vacias' | null
let editandoRentaId = null;

function load() {
  // Load from localStorage as fast initial state
  // Firebase real-time listener will override with cloud data shortly after
  const s = localStorage.getItem('gestorrenta_v2');
  if (s) {
    try {
      state = JSON.parse(s);
      if (!state.formasPago) state.formasPago = JSON.parse(JSON.stringify(DEFAULT_FORMAS_PAGO));
      if (!state.tiposGasto) state.tiposGasto = [...DEFAULT_TIPOS_GASTO];
      if (!state.tiposProp)  state.tiposProp  = [...DEFAULT_TIPOS_PROP];
      if (!state.alertaSeguimiento) state.alertaSeguimiento = {};
      if (state.timbresBalance === undefined) state.timbresBalance = 0;
      if (!state.timbresHistorial) state.timbresHistorial = [];
      if (!state.timbresPrecio) state.timbresPrecio = { precio1: 15, precio10: 12, precio50: 9, precio100: 7 };
    } catch(e) {}
  }
}
let _fbSaveTimer = null;
function _saveCore() {
  _clearStatusCache();
  _fbJustSaved = Date.now();
  try {
    localStorage.setItem('gestorrenta_v2', JSON.stringify(state));
  } catch(e) {
    console.warn('[Save] localStorage write failed:', e.message);
    // Try to free space by removing old keys
    try {
      localStorage.removeItem('gestorrenta_v1');
      localStorage.setItem('gestorrenta_v2', JSON.stringify(state));
    } catch(e2) {
      showToast('âš ï¸ Almacenamiento local lleno. Los datos se guardarÃ¡n en la nube.', 4000);
    }
  }
  clearTimeout(_fbSaveTimer);
  _fbSaveTimer = setTimeout(() => fbSave(), 400);
}

function recuperarDesdeLocalStorage() {
  try {
    var backup = localStorage.getItem('gestorrenta_v2');
    if (!backup) { alert('No se encontrÃ³ respaldo local.'); return; }
    var parsed = JSON.parse(backup);
    if (!parsed.rentas || parsed.rentas.length === 0) { alert('El respaldo no tiene datos.'); return; }
    // Restore state
    state.rentas = parsed.rentas || [];
    state.clientes = parsed.clientes || [];
    state.formasPago = parsed.formasPago || state.formasPago;
    state.tiposGasto = parsed.tiposGasto || state.tiposGasto;
    state.tiposProp = parsed.tiposProp || state.tiposProp;
    state.alertaSeguimiento = parsed.alertaSeguimiento || {};
    if (parsed.fiscalConfig) state.fiscalConfig = parsed.fiscalConfig;
    if (parsed.timbresBalance !== undefined) state.timbresBalance = parsed.timbresBalance;
    if (parsed.timbresHistorial) state.timbresHistorial = parsed.timbresHistorial;
    if (parsed.timbresPrecio) state.timbresPrecio = parsed.timbresPrecio;
    // Save to Firestore immediately
    _fbJustSaved = Date.now();
    save();
    alert('âœ… Â¡Datos recuperados!\n\n' + state.rentas.length + ' propiedades\n' + state.clientes.length + ' clientes\n\nTodos los datos han sido restaurados.');
    render();
  } catch(e) {
    alert('Error al recuperar: ' + e.message);
  }
}

function showToast(msg, duration=2500) {
  const t = document.getElementById('app-toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), duration);
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
function escHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

load();

// ============================================================
// NAVIGATION
// ============================================================
let currentPage = 'dashboard';
function setMobileNav(page) {
  document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
  // Map sub-pages to their parent nav button
  const parentMap = {'detalle':'rentas','detalle-cliente':'clientes'};
  const navPage = parentMap[page] || page;
  const btn = document.getElementById('mnav-' + navPage);
  if (btn) btn.classList.add('active');
}

function _isPageAllowed(page) {
  if (!currentUser || currentUser.role === 'titular') return true;
  const rules = {
    'dashboard': hasPerm('dash_read') || hasPerm('vacant_read'),
    'rentas': hasPerm('prop_read') || hasPerm('vacant_read'),
    'clientes': hasPerm('cli_read') || hasPerm('alertas_read') || hasPerm('abono_write'),
    'alertas': hasPerm('alertas_read'),
    'pagos': hasPerm('config_read'),
    'facturacion': false, // titular only
    'extra': true,
    'ayuda': true,
    'detalle': hasPerm('prop_read') || hasPerm('vacant_read') || hasPerm('abono_write'),
    'detalle-cliente': hasPerm('cli_read') || hasPerm('alertas_read') || hasPerm('abono_write'),
  };
  return rules[page] !== undefined ? rules[page] : true;
}

function _getFirstAllowedPage() {
  const order = ['dashboard','rentas','clientes','alertas','extra','pagos','ayuda'];
  for (const p of order) {
    if (_isPageAllowed(p)) return p;
  }
  return 'ayuda'; // Absolute fallback
}

function nav(page, _skipHistory) {
  // â”€â”€ Permission gate: block nav to pages user can't access â”€â”€
  if (currentUser && currentUser.role !== 'titular') {
    const allowed = _isPageAllowed(page);
    if (!allowed) {
      const fallback = _getFirstAllowedPage();
      if (fallback && fallback !== page) { nav(fallback); return; }
      // If no page allowed at all, show rentas as minimum
    }
  }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const pageEl = document.getElementById('page-' + page);
  if (!pageEl) { console.warn('nav: page not found:', page); return; }
  pageEl.classList.add('active');
  if (page !== 'detalle') currentRentaId = null;
  if (page !== 'detalle-cliente') currentClienteId = null;
  document.querySelectorAll('.nav-btn').forEach(b => {
    const lbl = pageLabel(page);
    if (lbl && b.textContent.trim().toLowerCase().includes(lbl)) b.classList.add('active');
  });
  setMobileNav(page);
  currentPage = page;
  // BUG1: History API para botÃ³n AtrÃ¡s de Android
  if (!_skipHistory) {
    history.pushState({ page: page }, '', '#' + page);
  }
  // BUG3: Persistir pÃ¡gina en sessionStorage para sobrevivir refresh
  try { sessionStorage.setItem('gr_cur_page', page); } catch(e) {}
  render();
}

// BUG1: Interceptar botÃ³n AtrÃ¡s del sistema (Android / iOS / navegador)
window.addEventListener('popstate', function(e) {
  var pg = (e.state && e.state.page) ? e.state.page : 'dashboard';
  nav(pg, true); // _skipHistory=true para no hacer pushState de nuevo
});
function pageLabel(p) {
  return {dashboard:'inicio',rentas:'propiedades',clientes:'clientes',alertas:'alertas',pagos:'configuraciÃ³n',facturacion:'facturaciÃ³n',extra:'extra',ayuda:'ayuda',detalle:'','detalle-cliente':''}[p]||'';
}

// ============================================================
// MODALS
// ============================================================
function openModal(id) {
  if (id === 'modalRenta') {
    if (!editandoRentaId) { clearRentaForm(); }
    populateClienteSelect();
    populateEmisorSelect();
  }
  if (id === 'modalAbono') {
    populateFormaPagoSelectAbono();
    initAbonoQuickFill();
    clearComprobanteInput();
  }
  document.getElementById(id).classList.add('open');
  // Populate tipo propiedad select dynamically
  if (id === 'modalRenta') {
    const tipoSel = document.getElementById('r-tipo');
    if (tipoSel) {
      const cur = tipoSel.value;
      tipoSel.innerHTML = (state.tiposProp||DEFAULT_TIPOS_PROP).map(t =>
        `<option value="${t}">${t}</option>`).join('');
      if (cur) tipoSel.value = cur;
    }
  }
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  editandoRentaId = null;
  if (id === 'modalCliente') {
    if (!_skipClearCliente) {
      editandoClienteId = null;
      clearClienteForm();
    }
    _skipClearCliente = false;
    populatePropiedadSelectCliente();
    setTimeout(populatePropiedadSelectCliente, 300);
  }
}
// Modal overlay listeners are set up in initApp;

// ============================================================
// FORMATO
// ============================================================
function fmt(n) {
  return '$' + Number(n).toLocaleString('es-MX', {minimumFractionDigits: 0, maximumFractionDigits: 0});
}
function fmtDate(d) {
  if (!d) return '-';
  const [y,m,dia] = d.split('-');
  return `${dia}/${m}/${y}`;
}

// ============================================================
// LOGICA DE ESTADO DE RENTA
// Regla: La renta se paga POR ADELANTADO. El inquilino tiene
// hasta (dia_cobro + 6 dias) del mes en curso para pagar el
// mes SIGUIENTE. Si vence ese plazo sin pago -> ATRASADO.
// Ejemplo: dia cobro = 1, debe pagar antes del dia 7.
// ============================================================
function getMesQueDebePagarseHoy(renta) {
  const hoy = new Date();
  const diaCobro = Number(renta.dia || 1);
  const plazoFinal = diaCobro + 6;
  let mesDebido;
  if (hoy.getDate() > plazoFinal) {
    // Vencio la gracia: debe el mes proximo pagado
    const sig = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 1);
    mesDebido = sig.getFullYear() + '-' + String(sig.getMonth()+1).padStart(2,'0');
  } else {
    // Dentro del plazo: solo debe el mes actual
    mesDebido = hoy.getFullYear() + '-' + String(hoy.getMonth()+1).padStart(2,'0');
  }
  return mesDebido;
}

function diasRestantesParaPagar(renta) {
  const hoy = new Date();
  const plazoFinal = Number(renta.dia || 1) + 6;
  return hoy.getDate() <= plazoFinal ? plazoFinal - hoy.getDate() : 0;
}

// Cache busted on each render() call
let _statusCache = {};

function getRentasVisibles() {
  const rentas = state.rentas || [];
  if (!currentUser || currentUser.role === 'titular') return rentas;
  const tipos = currentUser.tiposPropPermitidos || [];
  if (tipos.length === 0) return rentas; // empty = all
  return rentas.filter(r => tipos.includes(r.tipo));
}

function _clearStatusCache() { _statusCache = {}; }

function getStatusRenta(renta) {
  if (_statusCache[renta.id]) return _statusCache[renta.id];
  // Sin cliente asignado â†’ sin rentar
  if (!renta.clienteId || renta.clienteId === '') {
    return { estado: 'sin-rentar', saldo: 0, totalPagado: 0, totalEsperado: 0,
      pagadoMes: 0, pagadoMesDebido: 0, mesDebido: '', plazoVencio: false, diasRestantes: 0, diaCobro: 1,
      saldoFavor: 0, mesesAdelanto: 0, mesesDebidos: 0 };
  }

  const hoy = new Date();
  const diaCobro   = Number(renta.dia || 1);
  const plazoFinal = diaCobro + 6; // 6-day grace period
  const monto      = Number(renta.monto || 0);

  // â”€â”€ Determine how many rental periods are actually due â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // A period is due when its grace date (diaCobro + 6 days) has passed.
  // We count from the contract start date forward.
  // If there's no inicio, use createdAt or today as fallback.
  // Get contract start date â€” check property first, then linked client, then createdAt
  const clienteLinked = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  const inicioRaw = renta.inicio
    || (clienteLinked && clienteLinked.inicioContrato)
    || renta.createdAt
    || hoy.toISOString().slice(0,10);
  const inicioDate = new Date(inicioRaw + 'T12:00:00'); // noon to avoid TZ issues
  if (isNaN(inicioDate.getTime())) {
    // Fallback if date is invalid
    return { estado: 'al-dia', saldo: 0, totalPagado: 0, totalEsperado: 0,
      pagadoMes: 0, pagadoMesDebido: 0, mesDebido: '', plazoVencio: false, diasRestantes: 0, diaCobro: Number(renta.dia||1),
      saldoFavor: 0, mesesAdelanto: 0, mesesDebidos: 0 };
  }

  let periodsDue = 0;
  let lastDueMes = '';

  // Walk forward month by month from start
  let periodStart = new Date(inicioDate);
  for (let i = 0; i < 120; i++) { // max 10 years safety
    // Due date for this period = diaCobro of the same month as periodStart
    const dueYear  = periodStart.getFullYear();
    const dueMonth = periodStart.getMonth(); // 0-indexed
    const graceDate = new Date(dueYear, dueMonth, plazoFinal);

    if (graceDate > hoy) break; // this period's grace hasn't expired yet

    periodsDue++;
    lastDueMes = dueYear + '-' + String(dueMonth + 1).padStart(2, '0');

    // Advance to next period (same day next month)
    periodStart = new Date(dueYear, dueMonth + 1, inicioDate.getDate());
  }

  // If no periods are due yet (contract just started, still in grace)
  // then we're looking at the current month as the upcoming due period
  const mesDebido = lastDueMes ||
    (hoy.getFullYear() + '-' + String(hoy.getMonth() + 1).padStart(2, '0'));

  const totalEsperado = periodsDue * monto;
  const totalPagado   = (renta.abonos||[]).reduce((s,a) => s + Number(a.monto), 0);
  const saldo         = totalEsperado - totalPagado;

  // Is today still within the grace period for the NEXT upcoming payment?
  const plazoVencio = hoy.getDate() > plazoFinal;

  const pagadoMesDebido = (renta.abonos||[])
    .filter(a => a.mes === mesDebido)
    .reduce((s,a) => s + Number(a.monto), 0);

  const mesActual = hoy.getFullYear() + '-' + String(hoy.getMonth()+1).padStart(2,'0');
  const pagadoMes = (renta.abonos||[])
    .filter(a => a.mes === mesActual || a.mes === mesDebido)
    .reduce((s,a) => s + Number(a.monto), 0);

  // Saldo a favor: pagÃ³ mÃ¡s de lo que debÃ­a
  const saldoFavor = totalPagado > totalEsperado ? totalPagado - totalEsperado : 0;
  // Meses cubiertos por adelantado
  const mesesAdelanto = monto > 0 ? Math.floor(saldoFavor / monto) : 0;

  let estado;
  if (saldo <= 0) {
    estado = 'al-dia'; // incluye saldo a favor
  } else if (periodsDue > 0 && saldo > 0) {
    estado = saldo >= monto ? 'atrasado' : 'parcial';
  } else {
    estado = 'parcial';
  }

  // Meses adeudados sin pagar
  const mesesDebidos = monto > 0 ? Math.ceil(Math.max(0, saldo) / monto) : 0;

  const result = {
    estado, saldo: Math.max(0, saldo),
    saldoFavor, mesesAdelanto, mesesDebidos,
    totalPagado, totalEsperado, pagadoMes,
    pagadoMesDebido, mesDebido, plazoVencio,
    diasRestantes: diasRestantesParaPagar(renta), diaCobro,
  };
  _statusCache[renta.id] = result;
  return result;
}

function getClienteNombre(id) {
  const c = state.clientes.find(c => c.id === id);
  return c ? c.nombre : 'Sin asignar';
}

function clienteLink(id, prefix) {
  if (!id) return (prefix||'ğŸ‘¤ ') + 'Sin asignar';
  var c = state.clientes.find(function(c){ return c.id === id; });
  if (!c) return (prefix||'ğŸ‘¤ ') + 'Sin asignar';
  return '<span onclick="event.stopPropagation();verDetalleCliente(\''+id+'\')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px" title="Ver '+escHtml(c.nombre)+'">'+(prefix||'ğŸ‘¤ ')+escHtml(c.nombre)+'</span>';
}

function propLink(id, prefix) {
  if (!id) return (prefix||'ğŸ  ') + 'Sin propiedad';
  var r = state.rentas.find(function(r){ return r.id === id; });
  if (!r) return (prefix||'ğŸ  ') + 'Sin propiedad';
  return '<span onclick="event.stopPropagation();verDetalle(\''+id+'\')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px" title="Ver '+escHtml(r.nombre)+'">'+(prefix||'ğŸ  ')+escHtml(r.nombre)+'</span>';
}

// ============================================================
// RENDER
// ============================================================
var _renderTimer = null;
function render() {
  // Debounce rapid render calls
  if (_renderTimer) return;
  _renderTimer = setTimeout(function(){ _renderTimer = null; }, 16);
  _clearStatusCache();
  renderHeaderStats();
  if (currentPage === 'dashboard') {
    if (hasPerm('dash_read') || hasPerm('vacant_read')) renderDashboard();
    else { nav(_getFirstAllowedPage()); return; }
  }
  if (currentPage === 'rentas') {
    if (hasPerm('prop_read') || hasPerm('vacant_read')) renderRentas();
    else { nav(_getFirstAllowedPage()); return; }
  }
  if (currentPage === 'clientes') {
    if (hasPerm('cli_read') || hasPerm('alertas_read') || hasPerm('abono_write')) renderClientes();
    else { nav(_getFirstAllowedPage()); return; }
  }
  if (currentPage === 'alertas') {
    if (hasPerm('alertas_read')) renderAlertas();
    else { nav(_getFirstAllowedPage()); return; }
  }
  if (currentPage === 'pagos') renderConfig();
  if (currentPage === 'facturacion') renderFacturacion();
  if (currentPage === 'extra') renderExtra();
  if (currentPage === 'migracion') renderMigracion();

  if (currentPage === 'detalle' && currentRentaId) renderDetalle(currentRentaId);
  if (currentPage === 'detalle-cliente' && currentClienteId) renderDetalleCliente(currentClienteId);

  // Show/hide action buttons based on perms
  const btnNuevaProp = document.querySelector('#page-rentas .btn-primary');
  if (btnNuevaProp) btnNuevaProp.style.display = hasPerm('prop_write') ? '' : 'none';
  const btnImportProp = document.querySelector('#page-rentas .btn-ghost');
  if (btnImportProp) btnImportProp.style.display = hasPerm('prop_write') ? '' : 'none';
  const btnNuevoCli = document.querySelector('#page-clientes .btn-primary');
  if (btnNuevoCli) btnNuevoCli.style.display = hasPerm('cli_write') ? '' : 'none';
  const btnImportCli = document.querySelector('#page-clientes .btn-ghost');
  if (btnImportCli) btnImportCli.style.display = hasPerm('cli_write') ? '' : 'none';
}

function renderHeaderStats() {
  const _visibles = getRentasVisibles();
  document.getElementById('hstat-rentas').textContent = _visibles.length;
  let totalSaldo = 0;
  const hoy = new Date();
  const mesActual = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}`;
  let cobradoMes = 0;
  let atrasadas = 0;
  _visibles.forEach(r => {
    const st = getStatusRenta(r);
    totalSaldo += st.saldo;
    cobradoMes += (r.abonos||[]).filter(a => (a.fecha||'').startsWith(mesActual) || a.mes === mesActual).reduce((s,a) => s+Number(a.monto), 0);
    if (st.estado === 'atrasado' || (st.estado === 'parcial' && st.plazoVencio)) atrasadas++;
  });
  const atrasadasEl = document.getElementById('hstat-atrasadas');
  if (atrasadasEl) { atrasadasEl.textContent = atrasadas; }
  const badge = document.getElementById('alertas-badge');
  if (badge) { badge.textContent = atrasadas; badge.style.display = atrasadas > 0 ? 'inline-block' : 'none'; }
  const mbadge = document.getElementById('mnav-alertas-badge');
  if (mbadge) { mbadge.textContent = atrasadas; mbadge.style.display = atrasadas > 0 ? '' : 'none'; }
  document.getElementById('hstat-adeudo').textContent = fmt(totalSaldo);
  document.getElementById('hstat-cobrado').textContent = fmt(cobradoMes);
  // Update mobile stats row
  const mRentas = document.getElementById('m-hstat-rentas');
  const mAdeudo = document.getElementById('m-hstat-adeudo');
  const mCobrado = document.getElementById('m-hstat-cobrado');
  if (mRentas) mRentas.textContent = _visibles.length;
  if (mAdeudo) mAdeudo.textContent = fmt(totalSaldo);
  if (mCobrado) mCobrado.textContent = fmt(cobradoMes);
  // Update mobile sync badge
  const mSync = document.getElementById('mobile-sync-badge');
  const syncIcon = document.getElementById('hstat-sync-icon');
  if (mSync && syncIcon) mSync.textContent = syncIcon.textContent;
}

function renderDashboard() {
  const el = document.getElementById('dashboard-cards');
  const _visibles = getRentasVisibles();

  // â”€â”€ Compute stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const total = _visibles.length;
  const rentadas = _visibles.filter(r => r.clienteId && r.clienteId !== '').length;
  const vacias   = total - rentadas;

  let ingresoActual = 0, ingresoPotencial = 0, saldoPendiente = 0;
  let alDia = 0, atrasadas = 0, parciales = 0, aFavor = 0, montoAtrasadas = 0, montoParciales = 0;

  _visibles.forEach(r => {
    const monto = Number(r.monto) || 0;
    ingresoPotencial += monto;
    if (r.clienteId && r.clienteId !== '') {
      ingresoActual += monto;
      const st = getStatusRenta(r);
      saldoPendiente += st.saldo;
      if (st.saldoFavor > 0) { alDia++; aFavor++; }
      else if (st.estado === 'al-dia') alDia++;
      else if (st.estado === 'atrasado') { atrasadas++; montoAtrasadas += st.saldo; }
      else { parciales++; montoParciales += st.saldo; }
    }
  });

  const ocupacion = total > 0 ? Math.round((rentadas / total) * 100) : 0;

  // Type breakdown: total, rentadas, vacias per tipo
  const tipoMap = {};
  _visibles.forEach(r => {
    const t = r.tipo || 'Otro';
    if (!tipoMap[t]) tipoMap[t] = { total: 0, rentadas: 0 };
    tipoMap[t].total++;
    if (r.clienteId && r.clienteId !== '') tipoMap[t].rentadas++;
  });

  const showKpis = hasPerm('dash_read');

  // â”€â”€ Hide reportes for non-dash_read users â”€â”€
  const reportesEl = document.getElementById('dash-reportes-section');
  if (reportesEl) reportesEl.style.display = showKpis ? '' : 'none';

  // â”€â”€ KPIs strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const kpiEl = document.getElementById('dash-kpis');
  if (kpiEl) {
    kpiEl.style.display = showKpis ? 'grid' : 'none';
    if (showKpis) kpiEl.innerHTML = [
      { label: 'Total',        val: total, sub: '', color: 'teal',  icon: 'ğŸ ', custom: `
        <div class="kpi-label">ğŸ  Mi portafolio</div>
        <div style="display:flex;gap:0;margin-top:8px;border-radius:10px;overflow:hidden;border:1px solid var(--border)">
          <div onclick="dashGoRentas('all')" style="flex:1;text-align:center;padding:10px 6px;cursor:pointer;background:var(--surface2);transition:background .2s" onmouseover="this.style.background='var(--accent-light)'" onmouseout="this.style.background='var(--surface2)'">
            <div style="font-size:22px;font-weight:800;color:var(--text)">${total}</div>
            <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px">Total</div>
            <div style="font-size:9px;color:var(--text3);margin-top:2px;text-transform:none;letter-spacing:0">Propiedades</div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div onclick="dashGoRentas('rentadas')" style="flex:1;text-align:center;padding:10px 6px;cursor:pointer;background:var(--surface2);transition:background .2s" onmouseover="this.style.background='var(--accent-light)'" onmouseout="this.style.background='var(--surface2)'">
            <div style="font-size:22px;font-weight:800;color:var(--success)">${rentadas}</div>
            <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px">Rentadas</div>
            <div style="font-size:9px;color:var(--text3);margin-top:2px;text-transform:none;letter-spacing:0">Con inquilino</div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div onclick="dashGoRentas('sin-rentar')" style="flex:1;text-align:center;padding:10px 6px;cursor:pointer;background:var(--surface2);transition:background .2s" onmouseover="this.style.background='var(--accent-light)'" onmouseout="this.style.background='var(--surface2)'">
            <div style="font-size:22px;font-weight:800;color:#b91c1c">${vacias}</div>
            <div style="font-size:10px;color:#b91c1c;font-weight:600;text-transform:uppercase;letter-spacing:.3px">Sin rentar</div>
            <div style="font-size:9px;color:var(--text3);margin-top:2px;text-transform:none;letter-spacing:0">Disponibles</div>
          </div>
        </div>
        <div style="margin-top:10px;text-align:center">
          <span style="font-size:22px;font-weight:800;color:var(--accent);font-family:'DM Mono',monospace">${ocupacion}%</span>
          <span style="font-size:12px;color:var(--text3);margin-left:4px">de ocupaciÃ³n</span>
        </div>
      ` },
      { label: 'Ingresos', color: 'green', icon: 'ğŸ’°', custom: `
        <div class="kpi-label">ğŸ’° Ingresos mensuales</div>
        <div style="display:flex;gap:0;margin-top:8px;border-radius:10px;overflow:hidden;border:1px solid var(--border)">
          <div style="flex:1;text-align:center;padding:10px 6px;background:var(--surface2)">
            <div style="font-weight:800;color:${ingresoActual >= ingresoPotencial ? 'var(--success)' : 'var(--text)'};font-family:'DM Mono',monospace" class="kpi-inner-val">${fmt(ingresoActual)}</div>
            <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px">Actual</div>
            <div style="font-size:9px;color:var(--text3);margin-top:2px">Propiedades rentadas</div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="flex:1;text-align:center;padding:10px 6px;background:var(--surface2)">
            <div style="font-weight:800;color:var(--warning);font-family:'DM Mono',monospace" class="kpi-inner-val">${fmt(ingresoPotencial)}</div>
            <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px">Potencial</div>
            <div style="font-size:9px;color:var(--text3);margin-top:2px">Si se rentaran todas</div>
          </div>
        </div>
        <div style="margin-top:10px;text-align:center"><span onclick="dashGoRentas('sin-rentar')" style="font-weight:800;color:#b91c1c;font-family:'DM Mono',monospace;cursor:pointer" class="kpi-inner-val">${fmt(ingresoPotencial - ingresoActual)}</span> <span style="font-size:12px;color:var(--text3)">sin rentar</span></div>
      ` },
      { label: 'Cobranza', color: saldoPendiente > 0 ? 'red' : 'green', icon: 'â³', custom: (() => {
        const totalVencidas = atrasadas + parciales;
        const montoVencidas = montoAtrasadas + montoParciales;
        return `
        <div class="kpi-label">â³ Cobranza pendiente</div>
        <div style="display:flex;gap:0;margin-top:8px;border-radius:10px;overflow:hidden;border:1px solid var(--border)">
          <div style="flex:1;text-align:center;padding:10px 6px;background:var(--surface2)">
            <div style="font-weight:800;color:var(--text);font-family:'DM Mono',monospace" class="kpi-inner-val">${fmt(saldoPendiente)}</div>
            <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px">Por cobrar</div>
            <div style="font-size:9px;color:var(--text3);margin-top:2px">Adeudo total</div>
          </div>
          <div style="width:1px;background:var(--border)"></div>
          <div onclick="dashGoRentas('vencidas')" style="flex:1;text-align:center;padding:10px 6px;cursor:pointer;background:var(--surface2);transition:background .2s" onmouseover="this.style.background='#fde8e8'" onmouseout="this.style.background='var(--surface2)'">
            <div style="font-weight:800;color:#b91c1c;font-family:'DM Mono',monospace" class="kpi-inner-val">${fmt(montoVencidas)}</div>
            <div style="font-size:10px;color:#b91c1c;font-weight:600;text-transform:uppercase;letter-spacing:.3px">âš ï¸ Vencidas (${totalVencidas})</div>
            <div style="font-size:9px;color:var(--text3);margin-top:2px">Pago incompleto</div>
          </div>
        </div>
        <div style="margin-top:10px;text-align:center;font-size:12px;color:var(--text3)">${totalVencidas > 0 ? `<span style="font-weight:700">ğŸ”´ ${atrasadas}</span> atrasada${atrasadas!==1?'s':''} Â· <span style="font-weight:700">ğŸ”¶ ${parciales}</span> parcial${parciales!==1?'es':''}` : 'Â¡Todo al dÃ­a!'}</div>
      `; })() },
    ].map(k => k.custom ? `<div class="kpi-card ${k.color}">${k.custom}</div>` : `
      <div class="kpi-card ${k.color}" ${k.click ? `onclick="${k.click}" style="cursor:pointer"` : ''}>
        <div class="kpi-label">${k.icon} ${k.label}</div>
        <div class="kpi-val" style="${k.mono?'font-size:20px':''}">${k.val}</div>
        <div class="kpi-sub">${k.sub}</div>
      </div>`).join('');
  }

  // â”€â”€ Compact summary table (tipos + estado) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const summaryEl = document.getElementById('dash-summary');
  if (summaryEl) {
    if (!showKpis) { summaryEl.style.display = 'none'; }
    else {
      summaryEl.style.display = '';
      const tiposOrdenados = Object.entries(tipoMap).sort((a,b) => b[1].total - a[1].total);

      summaryEl.innerHTML = `
      <div style="display:grid;gap:14px" class="dash-bottom-grid">

        <!-- Tipos compacto -->
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.04)">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:10px">ğŸ—ï¸ Por tipo</div>
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead>
              <tr style="color:var(--text3);font-size:10px;text-transform:uppercase;letter-spacing:0.5px">
                <th style="text-align:left;padding:0 0 6px;font-weight:600">Tipo</th>
                <th style="text-align:center;padding:0 0 6px;font-weight:600">Total</th>
                <th style="text-align:center;padding:0 0 6px;font-weight:600;color:var(--success)">Rentadas</th>
                <th style="text-align:center;padding:0 0 6px;font-weight:600;color:var(--warning)">Libres</th>
              </tr>
            </thead>
            <tbody>
              ${tiposOrdenados.map(([tipo, d]) => {
                const cfg = tipoConfig(tipo);
                const libres = d.total - d.rentadas;
                const tipoSafe = tipo.replace(/'/g, "\\'");
                return `<tr onclick="filtrarRentasPorTipo('${tipoSafe}')" style="border-top:1px solid var(--border);cursor:pointer;transition:background 0.15s" onmouseenter="this.style.background='var(--surface2)'" onmouseleave="this.style.background=''">
                  <td style="padding:9px 0;display:flex;align-items:center;gap:6px">
                    <span style="background:${cfg.bg};color:${cfg.color};border-radius:6px;padding:2px 5px;font-size:13px">${cfg.icon}</span>
                    <span style="color:var(--text2);font-weight:500">${tipo}</span>
                  </td>
                  <td style="text-align:center;font-family:'DM Mono',monospace;font-weight:600;color:var(--text)">${d.total}</td>
                  <td style="text-align:center;font-family:'DM Mono',monospace;font-weight:600;color:var(--success)">${d.rentadas}</td>
                  <td style="text-align:center;font-family:'DM Mono',monospace;font-weight:600;color:${libres>0?'var(--warning)':'var(--text3)'}">${libres}</td>
                  <td style="text-align:right;color:var(--text3);font-size:13px;padding-left:2px">â€º</td>
                </tr>`;
              }).join('')}
              <tr style="border-top:2px solid var(--border);font-weight:700">
                <td style="padding:7px 0;color:var(--text)">Total</td>
                <td style="text-align:center;font-family:'DM Mono',monospace;color:var(--text)">${total}</td>
                <td style="text-align:center;font-family:'DM Mono',monospace;color:var(--success)">${rentadas}</td>
                <td style="text-align:center;font-family:'DM Mono',monospace;color:${vacias>0?'var(--warning)':'var(--text3)'}">${vacias}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Estado de pagos compacto -->
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.04)">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:10px">ğŸ“Š Estado de pagos</div>
          ${rentadas === 0 ? '<div style="color:var(--text3);font-size:13px;padding-top:8px">No hay propiedades rentadas</div>' : `
          <table style="width:100%;border-collapse:collapse;font-size:13px">
            <tbody>
              ${[
                {label:'âœ… Al dÃ­a',    val:alDia,    color:'var(--success)', filtro:'al-dia'},
                {label:'âœ¨ A favor',   val:aFavor,    color:'var(--success)', filtro:'a-favor'},
                {label:'ğŸ”¶ Parcial',   val:parciales, color:'var(--warning)', filtro:'parcial'},
                {label:'âš ï¸ Atrasado',  val:atrasadas, color:'var(--danger)',  filtro:'atrasado'},
              ].map(row => `
              <tr onclick="filtrarClientesPorEstado('${row.filtro}')" style="border-top:1px solid var(--border);cursor:pointer;transition:background 0.15s" onmouseenter="this.style.background='var(--surface2)'" onmouseleave="this.style.background=''">
                <td style="padding:9px 6px 9px 0;color:${row.color};font-weight:600">${row.label}</td>
                <td style="text-align:right;font-family:'DM Mono',monospace;font-weight:700;font-size:18px;color:${row.color};padding:9px 4px">${row.val}</td>
                <td style="text-align:right;font-size:11px;color:var(--text3);padding-left:8px">${rentadas>0?Math.round(row.val/rentadas*100):0}%</td>
                <td style="text-align:right;padding-left:4px;color:var(--text3);font-size:13px">â€º</td>
              </tr>`).join('')}
            </tbody>
          </table>
          <div style="margin-top:12px;background:var(--surface2);border-radius:6px;height:10px;overflow:hidden;display:flex">
            <div style="height:100%;width:${ocupacion}%;background:var(--success);border-radius:6px 0 0 6px;transition:width 0.5s" title="Ocupadas: ${ocupacion}%"></div>
            <div style="height:100%;width:${100-ocupacion}%;background:#ddd;transition:width 0.5s" title="Libres: ${100-ocupacion}%"></div>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:5px;display:flex;justify-content:space-between">
            <span style="color:var(--success);font-weight:600">â— ${ocupacion}% ocupado</span>
            <span style="color:var(--text3)">â— ${100-ocupacion}% disponible</span>
          </div>
          `}
        </div>
      </div>`;
    }
  }

  // â”€â”€ Propiedades sin rentar segmentadas por tipo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!_visibles.length) {
    el.innerHTML = `
      <div class="recovery-banner">
        <div class="recovery-banner-icon">ğŸ’¾</div>
        <div class="recovery-banner-text">
          <h2>Â¿Ya tenÃ­as datos ingresados?</h2>
          <p>Si descargaste una versiÃ³n nueva de la app, tus datos quedaron en el archivo anterior.<br>
          Carga tu archivo de respaldo <strong>(.json)</strong> para recuperar todo al instante.</p>
        </div>
        <div class="recovery-banner-actions">
          <label class="btn-import-big">
            ğŸ“‚ Cargar respaldo .json
            <input type="file" accept=".json" style="display:none" onchange="importarDatos(this)" />
          </label>
          <button class="btn-skip" onclick="this.closest('.recovery-banner').style.display='none'">
            Empezar desde cero
          </button>
        </div>
      </div>
      <div class="empty-state" style="margin-top:0">
        <div class="empty-icon">ğŸ </div>
        <div class="empty-title">Sin propiedades</div>
        <p>Ve a "Propiedades" y agrega tu primera renta.</p>
      </div>`;

    // Auto-check localStorage for lost data
    try {
      var localBackup = localStorage.getItem('gestorrenta_v2');
      if (localBackup) {
        var parsed = JSON.parse(localBackup);
        if (parsed.rentas && parsed.rentas.length > 0) {
          dashEl.innerHTML += '<div style="background:#fff3cd;border:2px solid #f59e0b;border-radius:14px;padding:20px;margin:20px auto;max-width:500px;text-align:center">' +
            '<div style="font-size:32px;margin-bottom:8px">ğŸ”„</div>' +
            '<div style="font-size:16px;font-weight:700;color:#92400e;margin-bottom:6px">Â¡Se encontraron datos guardados!</div>' +
            '<div style="font-size:13px;color:#78350f;margin-bottom:14px">' + parsed.rentas.length + ' propiedades y ' + (parsed.clientes||[]).length + ' clientes encontrados en este dispositivo.</div>' +
            '<button onclick="recuperarDesdeLocalStorage()" style="background:#f59e0b;color:#fff;border:none;border-radius:10px;padding:12px 28px;font-size:15px;font-weight:700;cursor:pointer">ğŸ”„ Recuperar mis datos</button>' +
            '</div>';
        }
      }
    } catch(e) {}
    return;
  }

  // Hide vacant section â€” user accesses via "Sin rentar" in KPI card
  const vacantSection = document.getElementById('dash-vacant-section');
  if (vacantSection) vacantSection.style.display = 'none';

  // â”€â”€ Formas de Pago resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const fpSection = document.getElementById('dash-fp-section');
  if (fpSection && showKpis && hasPerm('dash_read') && rentadas > 0) {
    const hoy = new Date();
    const mesActual = hoy.getFullYear() + '-' + String(hoy.getMonth()+1).padStart(2,'0');
    const fpData = {};
    // Build data per forma de pago
    _visibles.forEach(r => {
      if (!r.clienteId || r.clienteId === '') return;
      const fpId = r.formaPagoId || 'sin-fp';
      const fp = r.formaPagoId ? state.formasPago.find(f => f.id === r.formaPagoId) : null;
      if (!fpData[fpId]) fpData[fpId] = {
        nombre: fp ? fp.nombre : 'Sin asignar',
        icono: fp ? (fp.icono || 'ğŸ’³') : 'â“',
        id: fpId,
        esperado: 0,
        cobrado: 0,
        propiedades: 0,
        abonos: []
      };
      fpData[fpId].esperado += Number(r.monto) || 0;
      fpData[fpId].propiedades++;
      // Abonos de este mes
      (r.abonos || []).forEach(a => {
        if ((a.fecha || '').startsWith(mesActual) || a.mes === mesActual) {
          fpData[fpId].cobrado += Number(a.monto) || 0;
          fpData[fpId].abonos.push({
            id: a.id,
            monto: Number(a.monto),
            fecha: a.fecha || '',
            metodo: a.metodo || '',
            mes: a.mes || '',
            nota: a.nota || '',
            propiedad: r.nombre,
            propiedadId: r.id,
            cliente: getClienteNombre(r.clienteId),
            comprobante: !!a.comprobante
          });
        }
      });
    });
    const fpArr = Object.values(fpData).sort((a,b) => b.esperado - a.esperado);
    const totalEsperado = fpArr.reduce((s,f) => s + f.esperado, 0);
    const totalCobrado = fpArr.reduce((s,f) => s + f.cobrado, 0);
    const totalPendiente = totalEsperado - totalCobrado;

    fpSection.style.display = '';
    fpSection.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.04)">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:14px">ğŸ’³ Ingresos por forma de pago</div>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;border-radius:10px;overflow:hidden;border:1px solid var(--border);margin-bottom:14px;background:var(--border)">
        <div style="text-align:center;padding:12px 4px;background:var(--surface2)">
          <div style="font-weight:800;font-family:'DM Mono',monospace;color:var(--text);font-size:clamp(13px,3.2vw,20px);word-break:break-all;line-height:1.2">${fmt(totalEsperado)}</div>
          <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px;margin-top:4px">Esperado</div>
          <div style="font-size:9px;color:var(--text3);margin-top:1px">Mensual</div>
        </div>
        <div style="text-align:center;padding:12px 4px;background:var(--surface2)">
          <div style="font-weight:800;font-family:'DM Mono',monospace;color:var(--success);font-size:clamp(13px,3.2vw,20px);word-break:break-all;line-height:1.2">${fmt(totalCobrado)}</div>
          <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px;margin-top:4px">Cobrado</div>
          <div style="font-size:9px;color:var(--text3);margin-top:1px">Este mes</div>
        </div>
        <div style="text-align:center;padding:12px 4px;background:var(--surface2)">
          <div style="font-weight:800;font-family:'DM Mono',monospace;color:${totalPendiente > 0 ? 'var(--danger)' : 'var(--success)'};font-size:clamp(13px,3.2vw,20px);word-break:break-all;line-height:1.2">${totalPendiente > 0 ? fmt(totalPendiente) : 'âœ… $0'}</div>
          <div style="font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px;margin-top:4px">Pendiente</div>
          <div style="font-size:9px;color:var(--text3);margin-top:1px">Por cobrar</div>
        </div>
      </div>

      ${fpArr.map(fp => {
        const pend = fp.esperado - fp.cobrado;
        const pct = fp.esperado > 0 ? Math.round(fp.cobrado / fp.esperado * 100) : 0;
        const barColor = pct >= 100 ? 'var(--success)' : pct >= 60 ? 'var(--warning)' : 'var(--danger)';
        const fpIdSafe = fp.id.replace(/'/g, "\\\\'");
        return `
      <div style="padding:12px 6px;border-top:1px solid var(--border);cursor:pointer;transition:background 0.15s" onclick="dashGoFP('${fpIdSafe}')" onmouseenter="this.style.background='var(--surface2)'" onmouseleave="this.style.background=''">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <div style="font-size:20px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;background:var(--surface2);border-radius:8px;flex-shrink:0">${fp.icono}</div>
          <div style="flex:1;min-width:0;overflow:hidden">
            <div style="font-weight:700;font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(fp.nombre)}</div>
            <div style="font-size:11px;color:var(--text3)">${fp.propiedades} propiedad${fp.propiedades !== 1 ? 'es' : ''}</div>
          </div>
          <div style="font-family:'DM Mono',monospace;font-size:clamp(14px,3.2vw,18px);font-weight:800;color:var(--text);flex-shrink:0">${fmt(fp.esperado)}</div>
          <div style="color:var(--text3);font-size:13px;flex-shrink:0">â€º</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding-left:42px">
          <div style="flex:1;height:5px;background:var(--surface2);border-radius:3px;overflow:hidden"><div style="height:100%;border-radius:3px;width:${pct}%;background:${barColor};transition:width 0.5s"></div></div>
          <div onclick="event.stopPropagation();verAbonosFP('${fpIdSafe}')" style="font-size:11px;color:var(--success);font-weight:600;cursor:pointer;text-decoration:underline;text-decoration-style:dotted;white-space:nowrap;flex-shrink:0">âœ“ ${fmt(fp.cobrado)}</div>
        </div>
        ${pend > 0 ? '<div style="padding-left:42px;margin-top:3px;font-size:11px;color:var(--danger);font-weight:600">â³ ' + fmt(pend) + ' pendiente</div>' : '<div style="padding-left:42px;margin-top:3px;font-size:11px;color:var(--success);font-weight:600">âœ… Completo</div>'}
      </div>`;
      }).join('')}

      <div style="font-size:10px;color:var(--text3);text-align:center;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">Toca forma de pago â†’ ver propiedades Â· Toca âœ“ cobrado â†’ ver abonos</div>
    </div>`;

    // Store fpData globally for modal access
    window._dashFPData = fpData;
  } else if (fpSection) {
    fpSection.style.display = 'none';
    fpSection.innerHTML = '';
  }
}

let rentasView = window.innerWidth <= 768 ? 'list' : 'grid';
function setRentasView(v) {
  rentasView = v;
  document.getElementById('vbtn-grid').classList.toggle('active', v === 'grid');
  document.getElementById('vbtn-list').classList.toggle('active', v === 'list');
  renderRentas();
}

const TIPO_CFG = {
  'Bodega':          {icon:'ğŸ­', color:'#0d9488', bg:'#e6f7f5'},
  'Local comercial': {icon:'ğŸª', color:'#2563eb', bg:'#eff6ff'},
  'Local Comercial': {icon:'ğŸª', color:'#2563eb', bg:'#eff6ff'},
  'Oficina':         {icon:'ğŸ¢', color:'#7c3aed', bg:'#f5f3ff'},
  'Departamento':    {icon:'ğŸ ', color:'#2d6a4f', bg:'#e8f5e9'},
  'Casa':            {icon:'ğŸ¡', color:'#b7791f', bg:'#fef9ec'},
  'Otro':            {icon:'ğŸ“¦', color:'#6b7280', bg:'#f3f4f6'},
};
function tipoConfig(tipo) {
  return TIPO_CFG[tipo] || {icon:'ğŸ“¦', color:'#6b7280', bg:'#f3f4f6'};
}

function renderRentas() {
  const el = document.getElementById('rentas-cards');
  const q = (document.getElementById('rentas-search')?.value||'').toLowerCase();
  const _visibles = getRentasVisibles();
  let filtered = _visibles;

  // If user only has vacant_read (not prop_read), show only vacant properties
  const _onlyVacant = !hasPerm('prop_read') && hasPerm('vacant_read');
  if (_onlyVacant) {
    filtered = filtered.filter(r => !r.clienteId || r.clienteId === '');
  }

  if (currentFilter !== 'all') filtered = filtered.filter(r => getStatusRenta(r).estado === currentFilter);
  // Filtro por tipo (desde dashboard)
  if (_rentaTipoFiltro) {
    filtered = filtered.filter(r => (r.tipo||'Otro') === _rentaTipoFiltro);
  }
  // Filtro por estado ocupaciÃ³n (desde dashboard KPI)
  if (_rentaEstadoFiltro === 'rentadas') {
    filtered = filtered.filter(r => r.clienteId && r.clienteId !== '');
  } else if (_rentaEstadoFiltro === 'vacias') {
    filtered = filtered.filter(r => !r.clienteId || r.clienteId === '');
  } else if (_rentaEstadoFiltro === 'vencidas') {
    filtered = filtered.filter(r => {
      var st = getStatusRenta(r);
      return st.estado === 'atrasado' || st.estado === 'parcial';
    });
  } else if (_rentaEstadoFiltro === 'sin-fp') {
    filtered = filtered.filter(r => !r.formaPagoId || r.formaPagoId === '');
  } else if (_rentaEstadoFiltro && _rentaEstadoFiltro.startsWith('fp:')) {
    var fpFilterId = _rentaEstadoFiltro.slice(3);
    filtered = filtered.filter(r => r.formaPagoId === fpFilterId);
  }
  // Show badge for estado filter
  var estadoBadge = document.getElementById('rentas-tipo-badge');
  if (estadoBadge) {
    if (_rentaEstadoFiltro) {
      var lblMap = {'rentadas':'ğŸ”‘ Rentadas', 'vacias':'ğŸ”“ Sin rentar', 'vencidas':'âš ï¸ Vencidas', 'sin-fp':'â“ Sin forma de pago'};
      var badgeLbl = lblMap[_rentaEstadoFiltro];
      if (!badgeLbl && _rentaEstadoFiltro.startsWith('fp:')) {
        var _fpObj = state.formasPago.find(function(f){ return f.id === _rentaEstadoFiltro.slice(3); });
        badgeLbl = _fpObj ? (_fpObj.icono || 'ğŸ’³') + ' ' + _fpObj.nombre : 'ğŸ’³ Forma de pago';
      }
      document.getElementById('rentas-tipo-badge-label').textContent = badgeLbl || _rentaEstadoFiltro;
      estadoBadge.style.display = 'inline-flex';
      estadoBadge.onclick = function(){ _rentaEstadoFiltro = null; _rentaTipoFiltro = null; this.style.display='none'; renderRentas(); };
    } else if (!_rentaTipoFiltro) {
      estadoBadge.style.display = 'none';
    }
  }
  if (q) filtered = filtered.filter(r =>
    r.nombre.toLowerCase().includes(q) ||
    (r.tipo||'').toLowerCase().includes(q) ||
    getClienteNombre(r.clienteId).toLowerCase().includes(q)
  );

  if (!filtered.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”</div><div class="empty-title">Sin resultados</div></div>`;
    return;
  }

  // Group by tipo, sorted alphabetically
  const grupos = {};
  filtered.forEach(r => {
    const t = r.tipo || 'Otro';
    if (!grupos[t]) grupos[t] = [];
    grupos[t].push(r);
  });

  // Sort each group: atrasado first, then parcial, then al-dia
  const estadoOrder = {atrasado:0, parcial:1, 'al-dia':2, 'sin-rentar':3};
  Object.values(grupos).forEach(arr => arr.sort((a,b) => {
    const sa = estadoOrder[getStatusRenta(a).estado]??2;
    const sb = estadoOrder[getStatusRenta(b).estado]??2;
    return sa - sb || a.nombre.localeCompare(b.nombre);
  }));

  const tiposOrdenados = Object.keys(grupos).sort((a,b) => a.localeCompare(b));
  let html = '';

  tiposOrdenados.forEach(tipo => {
    const rents = grupos[tipo];
    const cfg = tipoConfig(tipo);
    const totalMonto = rents.reduce((s,r) => s + Number(r.monto||0), 0);
    const atrasadasCnt = rents.filter(r => getStatusRenta(r).estado === 'atrasado').length;

    html += `
    <div class="segment-header">
      <div class="segment-title">
        <div class="segment-icon" style="background:${cfg.bg};color:${cfg.color}">${cfg.icon}</div>
        ${tipo}
        ${atrasadasCnt > 0 ? `<span style="background:var(--danger-light);color:var(--danger);border:1px solid rgba(192,57,43,0.2);border-radius:20px;padding:2px 10px;font-size:11px;font-weight:600;white-space:nowrap">âš ï¸ ${atrasadasCnt}</span>` : ''}
      </div>
      <div class="segment-meta">
        <span class="segment-count">${rents.length} prop.</span>
        <span class="segment-sum">${fmt(totalMonto)}/mes</span>
      </div>
    </div>
    ${rentasView === 'grid'
      ? `<div class="cards-grid" style="margin-top:0">${rents.map(r => renderCard(r)).join('')}</div>`
      : `<div>${rents.map(r => renderListCard(r)).join('')}</div>`
    }`;
  });

  el.innerHTML = (_onlyVacant ? '<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:#92400e">ğŸ”“ Solo se muestran las <strong>propiedades sin rentar</strong> segÃºn tus permisos.</div>' : '') + html;
}

function renderListCard(renta) {
  const st = getStatusRenta(renta);
  const statusColor = st.estado === 'sin-rentar' ? '#aaa' : st.estado === 'atrasado' ? '#8b0000' : st.estado === 'parcial' ? 'var(--warning)' : 'var(--success)';
  const statusLabel = st.estado === 'sin-rentar' ? 'ğŸ”“ Sin rentar'
    : st.estado === 'atrasado' ? 'ğŸ”´ Atrasado'
    : st.estado === 'parcial'  ? 'ğŸ”¶ Parcial'
    : st.saldoFavor > 0
      ? 'âœ¨ +' + fmt(st.saldoFavor) + (st.mesesAdelanto > 0 ? ' Â· ' + st.mesesAdelanto + ' mes' + (st.mesesAdelanto > 1 ? 'es' : '') + ' adelantado' + (st.mesesAdelanto > 1 ? 's' : '') : '')
      : 'âœ… Al dÃ­a';
  return `
  <div class="list-card" onclick="verDetalle('${renta.id}')" style="border-left:4px solid ${statusColor};padding-left:12px;align-items:center">
    <div class="list-card-left">
      <div class="list-card-name">${escHtml(renta.nombre)}</div>
      <div class="list-card-sub">${renta.clienteId ? '<span onclick="event.stopPropagation();verDetalleCliente(\''+renta.clienteId+'\')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px" title="Ver cliente">ğŸ‘¤ '+escHtml(getClienteNombre(renta.clienteId))+'</span>' : 'ğŸ‘¤ '+escHtml(getClienteNombre(renta.clienteId))} Â· Cobro dÃ­a ${renta.dia||1}</div>
    </div>
    <div style="flex-shrink:0;text-align:right;min-width:120px">
      <div class="list-amount">${fmt(renta.monto)}</div>
      <div class="list-amount-sub">por mes</div>
      ${st.saldoFavor > 0
        ? `<div style="font-size:12px;font-weight:700;color:var(--success);margin-top:3px">âœ¨ +${fmt(st.saldoFavor)}</div><div style="font-size:10px;color:var(--success)">${st.mesesAdelanto > 0 ? st.mesesAdelanto+' mes'+(st.mesesAdelanto>1?'es':'')+' adelantado'+(st.mesesAdelanto>1?'s':'') : 'a favor'}</div>`
        : `<div style="font-size:12px;font-weight:600;color:${statusColor};margin-top:3px">${statusLabel}</div>${st.saldo > 0 ? '<div style="font-size:11px;color:var(--text3)">Debe '+fmt(st.saldo)+'</div>' : ''}`
      }
    </div>
  </div>`;
}

function renderCard(renta) {
  const st = getStatusRenta(renta);
  const badgeLabel = st.estado === 'sin-rentar' ? 'ğŸ”“ Sin rentar' :
    st.estado === 'atrasado' ? 'ğŸ”´ Atrasado' :
    st.estado === 'parcial' && !st.plazoVencio && st.diasRestantes > 0 ? `â³ ${st.diasRestantes}d restantes` :
    st.estado === 'parcial' ? 'ğŸ”¶ Parcial' :
    st.saldoFavor > 0 ? 'âœ¨ A favor +' + fmt(st.saldoFavor) + (st.mesesAdelanto > 0 ? ' Â· ' + st.mesesAdelanto + ' mes' + (st.mesesAdelanto > 1 ? 'es' : '') : '') :
    'âœ… Al dÃ­a';
  // Barra: al dÃ­a/a favor = 100% verde | atrasado = 100% rojo
  // parcial = % de lo pagado del mes vencido actual
  const pct = (st.estado === 'al-dia' || st.saldoFavor > 0) ? 100
    : st.estado === 'atrasado' ? 100
    : Number(renta.monto) > 0 ? Math.min(99, Math.round((st.pagadoMesDebido / Number(renta.monto)) * 100))
    : 0;
  const fpCard = renta.formaPagoId ? state.formasPago.find(f => f.id === renta.formaPagoId) : null;
  return `
  <div class="card ${st.estado}" onclick="verDetalle('${renta.id}')">
    <div class="card-top">
      <div class="card-prop">${escHtml(renta.nombre)}</div>
      <span class="badge ${st.estado}">${badgeLabel}</span>
    </div>
    <div class="card-client">${renta.clienteId ? '<span onclick="event.stopPropagation();verDetalleCliente(\''+renta.clienteId+'\')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px" title="Ver cliente">ğŸ‘¤ '+escHtml(getClienteNombre(renta.clienteId))+'</span>' : 'ğŸ‘¤ '+escHtml(getClienteNombre(renta.clienteId))} &nbsp;Â·&nbsp; <span class="tag">${escHtml(renta.tipo||'Propiedad')}</span>${fpCard ? ` &nbsp;Â·&nbsp; <span class="tag">${fpCard.icono||'ğŸ’³'} ${escHtml(fpCard.nombre)}</span>` : ''}${renta.fichaPDF ? ` &nbsp;<span class="badge" style="background:#fff8e1;color:#b7791f;border:1px solid #f6c84b;font-size:10px">ğŸ“ PDF</span>` : ''}</div>
    <div class="card-amounts">
      <div class="amt-box">
        <div class="amt-val">${fmt(renta.monto)}</div>
        <div class="amt-label">Renta mensual</div>
      </div>
      <div class="amt-box">
        <div class="amt-val ${
          st.estado === 'sin-rentar' ? '' :
          st.saldoFavor > 0 ? 'success' :
          st.saldo > 0 ? 'danger' : 'success'
        }">${
          st.estado === 'sin-rentar' ? 'â€” Disponible' :
          st.saldoFavor > 0 ? 'âœ¨ +' + fmt(st.saldoFavor) :
          st.saldo > 0 ? fmt(st.saldo) : 'âœ“ Pagado'
        }</div>
        <div class="amt-label" style="line-height:1.3">${
          st.estado === 'sin-rentar' ? 'Sin inquilino' :
          st.saldoFavor > 0 ? 'Saldo a favor' + (st.mesesAdelanto > 0 ? '<br><span style="font-size:10px;opacity:0.8">' + st.mesesAdelanto + ' mes' + (st.mesesAdelanto > 1 ? 'es' : '') + ' adelantado' + (st.mesesAdelanto > 1 ? 's' : '') + '</span>' : '') :
          st.saldo > 0
            ? 'Saldo pendiente' + (st.mesesDebidos > 1 ? '<br><span style="font-size:10px;opacity:0.75">' + st.mesesDebidos + ' meses sin pagar</span>' : '')
            : 'Saldo pendiente'
        }</div>
      </div>
    </div>
    ${st.estado !== 'sin-rentar' ? `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${st.estado==='al-dia'?'var(--success)':st.estado==='parcial'?'var(--warning)':'#8b0000'}"></div></div>` : ''}
  </div>`;
}

let clientesView = window.innerWidth <= 768 ? 'list' : 'grid';
function setClientesView(v) {
  clientesView = v;
  document.getElementById('cvbtn-grid').classList.toggle('active', v === 'grid');
  document.getElementById('cvbtn-list').classList.toggle('active', v === 'list');
  renderClientes();
}

function renderClientes() {
  const el = document.getElementById('clientes-cards');
  const q = (document.getElementById('clientes-search')?.value||'').toLowerCase();

  if (!state.clientes.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><div class="empty-title">Sin clientes</div></div>`;
    return;
  }

  let clientes = state.clientes;

  // If user has alertas_read or abono_write but NOT cli_read, only show atrasados/parciales
  const _onlyOverdue = !hasPerm('cli_read') && (hasPerm('alertas_read') || hasPerm('abono_write'));
  if (_onlyOverdue) {
    clientes = clientes.filter(c => {
      const rentas = state.rentas.filter(r => r.clienteId === c.id);
      if (!rentas.length) return false;
      return rentas.some(r => {
        const st = getStatusRenta(r);
        return st.estado === 'atrasado' || st.estado === 'parcial';
      });
    });
  }

  // Filtro por estado (viene de dashboard Estado de Pagos)
  if (_clienteEstadoFiltro) {
    clientes = clientes.filter(c => {
      const rentas = state.rentas.filter(r => r.clienteId === c.id);
      if (!rentas.length) return _clienteEstadoFiltro === 'al-dia';
      const saldoFav = rentas.reduce((s,r) => s + (getStatusRenta(r).saldoFavor||0), 0);
      const saldo    = rentas.reduce((s,r) => s + getStatusRenta(r).saldo, 0);
      if (_clienteEstadoFiltro === 'a-favor') return saldoFav > 0;
      if (saldo === 0) return _clienteEstadoFiltro === 'al-dia';
      const tieneParcial = rentas.some(r => getStatusRenta(r).estado === 'parcial');
      const estadoCliente = tieneParcial ? 'parcial' : 'atrasado';
      return estadoCliente === _clienteEstadoFiltro;
    });
  }

  // Filtro por texto de bÃºsqueda
  if (q) clientes = clientes.filter(c =>
    c.nombre.toLowerCase().includes(q) ||
    (c.email||'').toLowerCase().includes(q) ||
    (c.tel||'').includes(q) ||
    state.rentas.filter(r=>r.clienteId===c.id).some(r=>r.nombre.toLowerCase().includes(q))
  );

  if (!clientes.length) {
    const emptyMsg = _onlyOverdue ? 'No hay clientes con pagos atrasados' : 'Sin resultados';
    const emptyIcon = _onlyOverdue ? 'âœ…' : 'ğŸ”';
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">${emptyIcon}</div><div class="empty-title">${emptyMsg}</div></div>`;
    return;
  }

  // Group clients by the tipo of their rented property
  // A client can have multiple rentas of different tipos â€” put them in each group
  const grupos = {};
  const sinPropiedad = [];

  clientes.forEach(c => {
    const rentas = state.rentas.filter(r => r.clienteId === c.id);
    if (!rentas.length) {
      sinPropiedad.push(c);
      return;
    }
    const tipos = [...new Set(rentas.map(r => r.tipo || 'Otro'))];
    tipos.forEach(tipo => {
      if (!grupos[tipo]) grupos[tipo] = [];
      if (!grupos[tipo].find(x => x.id === c.id)) grupos[tipo].push(c);
    });
  });

  const tiposOrdenados = Object.keys(grupos).sort((a,b) => a.localeCompare(b));
  if (sinPropiedad.length) tiposOrdenados.push('__sin_propiedad__');
  grupos['__sin_propiedad__'] = sinPropiedad;

  let html = '';
  tiposOrdenados.forEach(tipo => {
    const clis = grupos[tipo];
    if (!clis || !clis.length) return;
    const cfg = tipo === '__sin_propiedad__'
      ? {icon:'ğŸ‘¤', color:'#6b7280', bg:'#f3f4f6'}
      : tipoConfig(tipo);
    const labelTipo = tipo === '__sin_propiedad__' ? 'Sin propiedad asignada' : tipo;
    const totalMensual = clis.reduce((s,c) => {
      return s + state.rentas.filter(r=>r.clienteId===c.id && (r.tipo||'Otro')===tipo).reduce((ss,r)=>ss+Number(r.monto||0),0);
    }, 0);

    html += `
    <div class="segment-header">
      <div class="segment-title">
        <div class="segment-icon" style="background:${cfg.bg};color:${cfg.color}">${cfg.icon}</div>
        ${labelTipo}
      </div>
      <div class="segment-meta">
        <span class="segment-count">${clis.length} cliente${clis.length!==1?'s':''}</span>
        ${totalMensual > 0 ? `<span class="segment-sum">${fmt(totalMensual)}/mes</span>` : ''}
      </div>
    </div>
    ${clientesView === 'grid'
      ? `<div class="cards-grid" style="margin-top:0">${clis.map(c => renderClienteCard(c)).join('')}</div>`
      : `<div>${clis.map(c => renderClienteListCard(c)).join('')}</div>`
    }`;
  });

  el.innerHTML = (_onlyOverdue ? '<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:13px;color:#92400e">âš ï¸ Solo se muestran <strong>clientes con pagos atrasados o parciales</strong> segÃºn tus permisos.</div>' : '') + html;
}

function renderClienteCard(c) {
  const rentas = state.rentas.filter(r => r.clienteId === c.id);
  const fac = c.factura && c.facturacion;
  // Compute total saldo vencido for this client
  const saldoTotal = rentas.reduce((s,r) => s + getStatusRenta(r).saldo, 0);
  const statusClass = saldoTotal > 0 ? 'atrasado' : 'al-dia';
  return `<div class="card ${statusClass}" style="cursor:default">
    <div class="card-top">
      <div class="card-prop" style="font-size:16px">ğŸ‘¤ ${c.nombre}</div>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        ${c.factura ? `<span class="badge" style="background:var(--accent-light);color:var(--accent)">ğŸ§¾ Factura</span>` : ''}
        ${rentas.length >= 2 ? `<span class="badge ${statusClass}">${rentas.length} rentas</span>` : ``}
      </div>
    </div>
    ${c.tel ? `<div class="card-client" style="margin-bottom:8px">ğŸ“ ${c.tel}</div>` : ''}
    ${rentas.length ? `
    <div style="margin-bottom:10px">
      ${rentas.map(r => {
        const st = getStatusRenta(r);
        const cfg = tipoConfig(r.tipo||'Otro');
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--surface2);border-radius:8px;margin-bottom:4px;font-size:12px">
          <span onclick="event.stopPropagation();verDetalle('${r.id}')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px">${cfg.icon} ${r.nombre}</span>
          <span style="font-family:'DM Mono',monospace;font-weight:600;color:${st.saldo>0?'var(--danger)':'var(--success)'}">${st.saldoFavor>0?'âœ¨ +'+fmt(st.saldoFavor)+(st.mesesAdelanto>0?' ('+st.mesesAdelanto+' mes'+(st.mesesAdelanto>1?'es':'')+')'  :''):st.saldo>0?'Debe '+fmt(st.saldo):'âœ“ Al dÃ­a'}</span>
        </div>`;
      }).join('')}
    </div>` : `<div style="font-size:12px;color:var(--text3);margin-bottom:10px">Sin propiedades asignadas</div>`}
    ${(c.inicioContrato||c.finContrato||c.fechaIncremento) ? `
    <div style="font-size:11px;color:var(--text3);margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid var(--border);padding-top:8px">
      ${c.inicioContrato ? `<span>ğŸ“… ${fmtDate(c.inicioContrato)}</span>` : ''}
      ${c.finContrato ? `<span>ğŸ ${fmtDate(c.finContrato)}</span>` : ''}
      ${c.diaCobro ? `<span>ğŸ’° DÃ­a ${c.diaCobro}</span>` : ''}
      ${c.fechaIncremento ? `<span style="color:var(--warning)">ğŸ“ˆ Inc: ${fmtDate(c.fechaIncremento)}</span>` : ''}
    </div>` : ''}
    <div style="display:flex;gap:6px">
      <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px;flex:1" onclick="verDetalleCliente('${c.id}')">ğŸ‘¤ Ver</button>
      <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px;flex:1" onclick="editarCliente('${c.id}')">âœï¸ Editar</button>
      <button class="btn btn-danger" style="font-size:12px;padding:6px 12px" onclick="eliminarCliente('${c.id}')">ğŸ—‘ï¸</button>
    </div>
  </div>`;
}

function renderClienteListCard(c) {
  const rentas = state.rentas.filter(r => r.clienteId === c.id);
  const saldoTotal   = rentas.reduce((s,r) => s + getStatusRenta(r).saldo, 0);
  const saldoFavTotal = rentas.reduce((s,r) => s + (getStatusRenta(r).saldoFavor||0), 0);
  const mesesFavTotal = rentas.reduce((s,r) => s + (getStatusRenta(r).mesesAdelanto||0), 0);
  const totalMensual = rentas.reduce((s,r) => s + Number(r.monto||0), 0);
  const iniciales = c.nombre.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  const estadoColor = saldoTotal > 0 ? 'var(--danger)' : 'var(--success)';
  const estadoLabel = saldoTotal > 0
    ? 'Debe ' + fmt(saldoTotal)
    : saldoFavTotal > 0
      ? 'âœ¨ A favor +' + fmt(saldoFavTotal) + (mesesFavTotal > 0 ? ' (' + mesesFavTotal + ' mes' + (mesesFavTotal > 1 ? 'es' : '') + ')' : '')
      : 'âœ“ Al dÃ­a';
  const propNombres = rentas.map(r => r.nombre).join(', ');
  return `
  <div onclick="verDetalleCliente('${c.id}')" style="
    background:#fff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px 16px;
    margin-bottom:10px;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    gap:10px;
    box-shadow:0 1px 4px rgba(0,0,0,0.04);
  ">
    <!-- Fila superior: avatar + nombre + botÃ³n editar -->
    <div style="display:flex;align-items:center;gap:12px">
      <div style="width:42px;height:42px;border-radius:50%;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;flex-shrink:0">
        ${c.foto ? '<img src="'+c.foto+'" style="width:42px;height:42px;border-radius:50%;object-fit:cover"/>' : iniciales}
      </div>
      <div style="flex:1;min-width:0">
        <div style="font-size:15px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.nombre}</div>
        ${c.tel ? '<div style="font-size:12px;color:var(--text3);margin-top:1px">ğŸ“ '+c.tel+'</div>' : ''}
      </div>
      <button class="btn btn-ghost" style="font-size:13px;padding:6px 10px;flex-shrink:0" onclick="event.stopPropagation();editarCliente('${c.id}')">âœï¸</button>
    </div>
    <!-- Fila inferior: propiedad + monto + estado -->
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding-top:8px;border-top:1px solid var(--border)">
      <div style="flex:1;min-width:0">
        ${rentas.length
          ? '<div style="font-size:12px;color:var(--accent);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + rentas.map(r => '<span onclick="event.stopPropagation();verDetalle(\''+r.id+'\')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px" title="Ver propiedad">ğŸ  '+escHtml(r.nombre)+'</span>').join(', ') + '</div>'
          : '<div style="font-size:12px;color:var(--text3)">Sin propiedad</div>'}
      </div>
      <div style="text-align:right;flex-shrink:0">
        ${totalMensual > 0 ? '<div style="font-size:14px;font-weight:700;font-family:monospace;color:var(--text)">'+fmt(totalMensual)+'</div><div style="font-size:10px;color:var(--text3)">por mes</div>' : ''}
        <div style="font-size:12px;font-weight:600;color:${estadoColor}">${estadoLabel}</div>
      </div>
    </div>
  </div>
  `;
}

function getMesLabel(mesStr) {
  if (!mesStr) return '';
  const meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const [y, m] = mesStr.split('-');
  return meses[parseInt(m)-1] + ' ' + y;
}

function renderAlertas() {
  const _visibles = getRentasVisibles();
  const el = document.getElementById('alertas-list');
  const q = (document.getElementById('alertas-search')?.value||'').toLowerCase();
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  const hoyStr = hoy.toISOString().slice(0,10);
  const _canWriteAlertas = hasPerm('alertas_write');

  // Solo se muestran rentas cuyo plazo ya vencio (dia+6) y no pagaron
  const alertasRojas = [];
  const alertasAmarillas = [];
  _visibles.forEach(r => {
    const st = getStatusRenta(r);
    if (st.estado === 'atrasado' || (st.estado === 'parcial' && st.plazoVencio)) {
      const seg = state.alertaSeguimiento?.[r.id];
      // Tiene seguimiento con fecha futura? â†’ amarilla
      if (seg && seg.fechaAccion && seg.fechaAccion >= hoyStr) {
        alertasAmarillas.push({renta:r, st, seg});
      } else {
        alertasRojas.push({renta:r, st, seg: seg || null});
      }
    }
  });
  alertasRojas.sort((a,b) => b.st.saldo - a.st.saldo);
  alertasAmarillas.sort((a,b) => new Date(a.seg.fechaAccion) - new Date(b.seg.fechaAccion));

  // Rentas con saldo pero dentro del plazo (aviso suave)
  const enPlazo = [];
  _visibles.forEach(r => {
    const st = getStatusRenta(r);
    if (st.estado === 'parcial' && !st.plazoVencio && st.diasRestantes >= 0) {
      enPlazo.push({renta:r, st});
    }
  });

  if (!alertasRojas.length && !alertasAmarillas.length && !enPlazo.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ‰</div><div class="empty-title">Â¡Todo al dÃ­a!</div><p>No hay rentas vencidas.</p></div>`;
    return;
  }

  let html = '';

  // ğŸ”´ ROJAS â€” Requiere acciÃ³n
  if (alertasRojas.length) {
    html += `<div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--danger);font-weight:600;margin-bottom:10px">ğŸ”´ Requiere acciÃ³n â€” pago vencido</div>`;
    html += alertasRojas.map(({renta,st,seg}) => {
      const plazoFinal = st.diaCobro + 6;
      const notaHtml = seg && seg.nota ? `<div class="alert-nota-preview">ğŸ“ ${escHtml(seg.nota)}</div>` : '';
      return `<div class="alert-item danger">
        <div class="alert-dot danger"></div>
        <div class="alert-info" onclick="verDetalle('${renta.id}')" style="cursor:pointer">
          <div class="alert-name">${escHtml(renta.nombre)}</div>
          <div class="alert-detail">${clienteLink(renta.clienteId)} Â· DebÃ­a pagar <strong>${getMesLabel(st.mesDebido)}</strong> antes del dÃ­a ${plazoFinal}</div>
          ${notaHtml}
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div class="alert-amount danger">${fmt(st.saldo)}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">pendiente</div>
        </div>
        <div class="alert-actions" style="width:100%;padding-left:22px">
          ${_canWriteAlertas ? `<button class="alert-action-btn ${seg&&seg.nota?'active':''}" onclick="event.stopPropagation();alertaAgregarNota('${renta.id}')">ğŸ“ Nota</button>
          <button class="alert-action-btn" onclick="event.stopPropagation();alertaReagendar('${renta.id}')">ğŸ“… Reagendar</button>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  // ğŸŸ¡ AMARILLAS â€” En espera (tienen fecha de seguimiento)
  if (alertasAmarillas.length) {
    if (alertasRojas.length) html += `<div style="margin:20px 0 10px;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#d97706;font-weight:600">ğŸŸ¡ En espera â€” compromiso de pago</div>`;
    else html += `<div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#d97706;font-weight:600;margin-bottom:10px">ğŸŸ¡ En espera â€” compromiso de pago</div>`;
    html += alertasAmarillas.map(({renta,st,seg}) => {
      const fechaObj = new Date(seg.fechaAccion + 'T12:00:00');
      const diasFaltan = Math.ceil((fechaObj - hoy) / 86400000);
      const fechaLabel = fechaObj.toLocaleDateString('es-MX', {day:'numeric', month:'short'});
      const diasLabel = diasFaltan === 0 ? 'Hoy' : diasFaltan === 1 ? 'MaÃ±ana' : `en ${diasFaltan} dÃ­as`;
      const notaHtml = seg.nota ? `<div class="alert-nota-preview">ğŸ“ ${escHtml(seg.nota)}</div>` : '';
      return `<div class="alert-item seguimiento">
        <div class="alert-dot seguimiento"></div>
        <div class="alert-info" onclick="verDetalle('${renta.id}')" style="cursor:pointer">
          <div class="alert-name">${escHtml(renta.nombre)} <span class="alert-fecha-badge">ğŸ“… ${fechaLabel} â€” ${diasLabel}</span></div>
          <div class="alert-detail">${clienteLink(renta.clienteId)} Â· Adeudo de <strong>${getMesLabel(st.mesDebido)}</strong></div>
          ${notaHtml}
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div class="alert-amount warning">${fmt(st.saldo)}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">pendiente</div>
        </div>
        <div class="alert-actions" style="width:100%;padding-left:22px">
          ${_canWriteAlertas ? `<button class="alert-action-btn active" onclick="event.stopPropagation();alertaAgregarNota('${renta.id}')">ğŸ“ Nota</button>
          <button class="alert-action-btn active" onclick="event.stopPropagation();alertaReagendar('${renta.id}')">ğŸ“… Cambiar fecha</button>
          <button class="alert-action-btn" onclick="event.stopPropagation();alertaQuitarSeguimiento('${renta.id}')" style="color:var(--danger);border-color:var(--danger)">âœ• Quitar</button>` : ''}
        </div>
      </div>`;
    }).join('');
  }

  // â³ EN PLAZO
  if (enPlazo.length) {
    if (alertasRojas.length || alertasAmarillas.length) html += `<div style="margin:20px 0 10px;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--warning);font-weight:600">â³ Dentro del plazo â€” aÃºn pueden pagar</div>`;
    html += enPlazo.map(({renta,st}) => {
      const plazoFinal = st.diaCobro + 6;
      return `<div class="alert-item warning" onclick="verDetalle('${renta.id}')">
        <div class="alert-dot warning"></div>
        <div class="alert-info">
          <div class="alert-name">${escHtml(renta.nombre)}</div>
          <div class="alert-detail">${clienteLink(renta.clienteId)} &nbsp;Â·&nbsp; Pagar <strong>${getMesLabel(st.mesDebido)}</strong> Â· Vence dÃ­a ${plazoFinal} &nbsp;Â·&nbsp; <span style="color:var(--warning)">quedan ${st.diasRestantes} dÃ­a${st.diasRestantes!==1?'s':''}</span></div>
        </div>
        <div style="text-align:right">
          <div class="alert-amount warning">${fmt(st.saldo)}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px">pendiente</div>
        </div>
      </div>`;
    }).join('');
  }

  // Total adeudado
  const totalItems = alertasRojas.length + alertasAmarillas.length;
  if (totalItems) {
    const totalAdeudo = [...alertasRojas, ...alertasAmarillas].reduce((s,{st}) => s + st.saldo, 0);
    html += `<div style="margin-top:12px;padding:14px 16px;background:var(--surface2);border-radius:10px;display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:12px;font-weight:600;color:var(--text2)">${totalItems} inquilino${totalItems!==1?'s':''} con adeudo vencido</span>
      <span style="font-family:'DM Mono',monospace;font-weight:700;font-size:16px;color:var(--danger)">${fmt(totalAdeudo)}</span>
    </div>`;
  }

  el.innerHTML = html;
}

// â”€â”€â”€ Alertas: Nota de seguimiento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function alertaAgregarNota(rentaId) {
  if (!hasPerm('alertas_write')) return alert('No tienes permiso para modificar alertas.');
  if (!state.alertaSeguimiento) state.alertaSeguimiento = {};
  const seg = state.alertaSeguimiento[rentaId] || {};
  const notaActual = seg.nota || '';
  const nuevaNota = prompt('ğŸ“ Nota de seguimiento:\n(Ej: "Dijo que paga el viernes", "Hablar con fiador")', notaActual);
  if (nuevaNota === null) return; // cancelled
  if (!state.alertaSeguimiento[rentaId]) state.alertaSeguimiento[rentaId] = {};
  state.alertaSeguimiento[rentaId].nota = nuevaNota;
  state.alertaSeguimiento[rentaId].creadoEl = state.alertaSeguimiento[rentaId].creadoEl || new Date().toISOString();
  save();
  renderAlertas();
  if (nuevaNota) showToast('ğŸ“ Nota guardada');
  else showToast('Nota eliminada');
}

// â”€â”€â”€ Alertas: Reagendar fecha de acciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function alertaReagendar(rentaId) {
  if (!hasPerm('alertas_write')) return alert('No tienes permiso para modificar alertas.');
  if (!state.alertaSeguimiento) state.alertaSeguimiento = {};
  const seg = state.alertaSeguimiento[rentaId] || {};
  const fechaActual = seg.fechaAccion || '';
  
  // Create a simple date picker dialog
  const hoy = new Date();
  const minDate = hoy.toISOString().slice(0,10);
  const fecha = prompt('ğŸ“… Fecha compromiso de pago:\n\nIngresa la fecha en formato AAAA-MM-DD\n(Ej: ' + minDate + ')\n\nDespuÃ©s de esta fecha, si no se paga, la alerta volverÃ¡ a rojo.', fechaActual || minDate);
  if (fecha === null) return;
  
  // Validate date
  if (!/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
    alert('Formato de fecha no vÃ¡lido. Usa AAAA-MM-DD (ej: 2026-03-01)');
    return;
  }
  if (fecha < minDate) {
    alert('La fecha debe ser hoy o posterior.');
    return;
  }

  if (!state.alertaSeguimiento[rentaId]) state.alertaSeguimiento[rentaId] = {};
  state.alertaSeguimiento[rentaId].fechaAccion = fecha;
  state.alertaSeguimiento[rentaId].creadoEl = state.alertaSeguimiento[rentaId].creadoEl || new Date().toISOString();
  save();
  renderAlertas();
  
  const fechaObj = new Date(fecha + 'T12:00:00');
  const label = fechaObj.toLocaleDateString('es-MX', {day:'numeric', month:'long', year:'numeric'});
  showToast('ğŸ“… Reagendado para ' + label);
}

// â”€â”€â”€ Alertas: Quitar seguimiento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function alertaQuitarSeguimiento(rentaId) {
  if (!hasPerm('alertas_write')) return alert('No tienes permiso para modificar alertas.');
  if (!confirm('Â¿Quitar el seguimiento? La alerta volverÃ¡ a rojo.')) return;
  delete state.alertaSeguimiento[rentaId];
  save();
  renderAlertas();
  showToast('Seguimiento eliminado');
}
// ============================================================
// DETALLE CLIENTE
// ============================================================
function filtrarRentasPorTipo(tipo) {
  _rentaTipoFiltro = tipo;
  _rentaEstadoFiltro = null;
  currentFilter = 'all';
  nav('rentas');
  setMobileNav('rentas');
  setTimeout(function() {
    // Reset chips to "Todas"
    document.querySelectorAll('.filter-chip').forEach(function(c, i) {
      c.classList.toggle('active', i === 0);
    });
    renderRentas();
    var badge = document.getElementById('rentas-tipo-badge');
    var label = document.getElementById('rentas-tipo-badge-label');
    if (badge && label) {
      var cfg = tipoConfig(tipo);
      label.textContent = cfg.icon + ' ' + tipo;
      badge.style.display = 'inline-flex';
      badge.onclick = function(){ _rentaTipoFiltro = null; this.style.display='none'; renderRentas(); };
    }
  }, 50);
}

function filtrarClientesPorEstado(estado) {
  // 'al-dia' | 'parcial' | 'atrasado'
  _clienteEstadoFiltro = estado;
  nav('clientes');
  setMobileNav('clientes');
  // Small delay to let page render then apply filter label
  setTimeout(() => {
    renderClientes();
    // Update filter badge
    const badge = document.getElementById('clientes-filtro-badge');
    if (badge) {
      const labels = {'al-dia':'âœ… Al dÃ­a','a-favor':'âœ¨ A favor','parcial':'ğŸ”¶ Parcial','atrasado':'âš ï¸ Atrasado'};
      document.getElementById('clientes-filtro-label').textContent = labels[estado] || '';
      badge.style.display = estado ? 'inline-flex' : 'none';
    }
  }, 50);
}

function verDetalleCliente(id) {
  currentClienteId = id;
  nav('detalle-cliente');
  setMobileNav('detalle-cliente');
}

function renderDetalleCliente(id) {
  const c = state.clientes.find(c => c.id === id);
  if (!c) { nav('clientes'); return; }
  const el = document.getElementById('detalle-cliente-content');
  if (!el) return;

  // Rentas vinculadas
  const rentas = state.rentas.filter(r => r.clienteId === id);

  // Todos los abonos de todas sus propiedades
  const todosAbonos = [];
  rentas.forEach(r => {
    (r.abonos || []).forEach(a => {
      todosAbonos.push({ ...a, propNombre: r.nombre, propId: r.id });
    });
  });
  todosAbonos.sort((a,b) => (b.fecha||'').localeCompare(a.fecha||''));

  const totalPagado = todosAbonos.reduce((s,a) => s + Number(a.monto||0), 0);
  const totalMensual = rentas.reduce((s,r) => s + Number(r.monto||0), 0);
  const totalSaldo   = rentas.reduce((s,r) => s + getStatusRenta(r).saldo, 0);

  // Iniciales avatar
  const iniciales = c.nombre.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();

  el.innerHTML = `
    <div style="padding:20px 20px 0;max-width:700px;margin:0 auto">

      <!-- BotÃ³n volver + editar -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <button onclick="nav('clientes')" class="btn btn-ghost" style="font-size:13px">â† Volver</button>
        <button onclick="editarCliente('${c.id}')" class="btn btn-primary" style="font-size:13px">âœï¸ Editar</button>
      </div>

      <!-- Header cliente -->
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px">
        <div style="width:64px;height:64px;border-radius:50%;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:24px;flex-shrink:0">
          ${c.foto ? '<img src="'+c.foto+'" style="width:64px;height:64px;border-radius:50%;object-fit:cover"/>' : iniciales}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-size:20px;font-weight:700;color:var(--text)">${c.nombre}</div>
          ${c.tel ? '<div style="font-size:13px;color:var(--text2);margin-top:2px">ğŸ“ '+escHtml(c.tel)+'</div>' : ''}
          ${c.email ? '<div style="font-size:13px;color:var(--text2);margin-top:2px;word-break:break-all;overflow-wrap:break-word">âœ‰ï¸ '+escHtml(c.email)+'</div>' : ''}
        </div>
      </div>

      <!-- Stats rÃ¡pidos -->
      <div class="g3" style="margin-bottom:20px">
        <div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:18px;font-weight:700;color:var(--accent);font-family:'DM Mono',monospace">${fmt(totalMensual)}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px;text-transform:uppercase">Renta/mes</div>
        </div>
        <div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:18px;font-weight:700;font-family:'DM Mono',monospace;color:var(--success)">${fmt(totalPagado)}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px;text-transform:uppercase">Total pagado</div>
        </div>
        <div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center">
          <div style="font-size:18px;font-weight:700;font-family:'DM Mono',monospace;color:${totalSaldo>0?'var(--danger)':'var(--success)'}">${totalSaldo>0?fmt(totalSaldo):'Al dÃ­a'}</div>
          <div style="font-size:10px;color:var(--text3);margin-top:2px;text-transform:uppercase">Saldo pendiente</div>
        </div>
      </div>

      <!-- Acciones rÃ¡pidas -->
      ${rentas.length ? `
      <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
        ${hasPerm('abono_write') ? '<button class="btn btn-success" style="flex:1;min-width:120px;font-size:13px" onclick="abonoDesdeCliente(\''+c.id+'\')">+ Abono</button>' : ''}
        ${hasPerm('factura_write') && c.factura ? '<button class="btn btn-ghost" style="flex:1;min-width:120px;font-size:13px;background:var(--accent);color:#fff;border-color:var(--accent)" onclick="facturarDesdeCliente(\''+c.id+'\')">ğŸ§¾ Facturar</button>' : ''}
        ${c.tel ? '<button class="btn btn-ghost" style="flex:1;min-width:120px;font-size:13px;background:#25D366;color:#fff;border-color:#25D366" onclick="enviarRecordatorioPagoCliente(\''+c.id+'\')">ğŸ’¬ WhatsApp</button>' : ''}
      </div>` : ''}

      <!-- Propiedades -->
      ${rentas.length ? `
      <div class="section-title" style="margin-bottom:10px">ğŸ  Propiedades rentadas</div>
      ${rentas.map(r => {
        const st = getStatusRenta(r);
        const estadoColor = st.saldoFavor > 0 ? 'var(--success)' : st.estado==='al-dia'?'var(--success)':st.estado==='atrasado'?'var(--danger)':'var(--warning)';
        const estadoLabel = st.saldoFavor > 0 ? 'âœ¨ A favor +'+fmt(st.saldoFavor) : st.estado==='al-dia'?'âœ“ Al dÃ­a':st.estado==='atrasado'?'âš  Atrasado':'â—‘ Parcial';
        return '<div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="verDetalle(this.dataset.id)" data-id="'+r.id+'">' +
          '<div><div style="font-weight:600;font-size:14px">'+r.nombre+'</div>' +
          '<div style="font-size:12px;color:var(--text3);margin-top:2px">'+fmt(r.monto)+'/mes Â· Cobro dÃ­a '+(r.dia||'â€”')+'</div></div>' +
          '<div style="text-align:right"><div style="font-size:12px;font-weight:600;color:'+estadoColor+'">'+estadoLabel+'</div>' +
          (st.saldo>0?'<div style="font-size:11px;color:var(--danger)">Debe '+fmt(st.saldo)+'</div>':'') + '</div></div>';
      }).join('')}` : '<div style="color:var(--text3);font-size:13px;margin-bottom:20px">Sin propiedades asignadas</div>'}

      <!-- Datos personales -->
      <div class="section-title" style="margin-top:20px;margin-bottom:10px">ğŸ‘¤ Datos personales</div>
      <div class="g2" style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;gap:12px;margin-bottom:20px">
        ${c.direccion?'<div style="grid-column:1/-1"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">DirecciÃ³n</div><div style="font-size:13px">'+c.direccion+'</div></div>':''}
        ${c.avalNombre?'<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Aval</div><div style="font-size:13px">'+c.avalNombre+(c.avalTel?' Â· '+c.avalTel:'')+'</div></div>':''}
        ${c.inicioContrato?'<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Inicio contrato</div><div style="font-size:13px">'+fmtDate(c.inicioContrato)+'</div></div>':''}
        ${c.finContrato?'<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Fin contrato</div><div style="font-size:13px">'+fmtDate(c.finContrato)+'</div></div>':''}
        ${c.notas?'<div style="grid-column:1/-1"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Notas</div><div style="font-size:13px;white-space:pre-line">'+c.notas+'</div></div>':''}
      </div>

      <!-- Historial de abonos -->
      <div class="section-title" style="margin-bottom:10px">ğŸ’° Historial de pagos <span style="font-size:11px;color:var(--text3);font-weight:400">${todosAbonos.length} registros</span></div>
      ${todosAbonos.length ? `
      <div style="background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:32px">
        <table class="payments-table" style="margin-bottom:0">
          <thead><tr>
            <th>Fecha</th><th>Mes</th><th>Monto</th><th>Propiedad</th><th>Forma de pago</th><th>CFDI</th>
          </tr></thead>
          <tbody>
            ${todosAbonos.map(a =>
              '<tr' + (a.pendientePago ? ' style="background:var(--warning-light)"' : '') + '>' +
              '<td>'+fmtDate(a.fecha)+'</td>' +
              '<td>'+(a.mes?getMesLabel(a.mes):'â€”')+'</td>' +
              '<td class="mono" style="color:'+(a.pendientePago?'var(--warning)':'var(--success)')+';font-weight:600">'+fmt(Number(a.monto))+(a.pendientePago?' <span style="font-size:9px;background:var(--warning);color:#fff;padding:1px 5px;border-radius:4px">PENDIENTE</span>':'')+'</td>' +
              '<td style="font-size:11px;color:var(--accent)"><span onclick="verDetalle(\''+a.propId+'\')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px">'+a.propNombre+'</span></td>' +
              '<td>'+(a.metodo||'â€”')+'</td>' +
              '<td>' + (a.uuid ? '<span style="color:var(--success);font-size:11px;font-weight:600" title="'+a.uuid+'">âœ… Timbrada</span>' : (hasPerm('factura_write') && c.factura ? '<button onclick="facturarAbono(\''+a.propId+'\',\''+a.id+'\')" style="background:var(--accent);color:#fff;border:none;border-radius:6px;padding:3px 8px;font-size:10px;cursor:pointer;font-weight:600">ğŸ§¾ Facturar</button>' : 'â€”')) + '</td>' +
              '</tr>'
            ).join('')}
          </tbody>
        </table>
        <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:12px;color:var(--text3)">Total pagado</span>
          <span style="font-family:'DM Mono',monospace;font-weight:700;font-size:16px;color:var(--success)">${fmt(totalPagado)}</span>
        </div>
      </div>` : '<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px;background:#fff;border:1px solid var(--border);border-radius:12px;margin-bottom:32px">Sin pagos registrados</div>'}

    </div>

      <!-- â”€â”€ Tabs: Documentos Â· Contrato Â· FacturaciÃ³n â”€â”€â”€â”€â”€â”€ -->
      <div style="margin-top:24px;margin-bottom:8px">
        <div style="display:flex;gap:0;background:var(--surface2);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px">
          ${['docs','contrato','factura'].map((t,i) => {
            const labels = {docs:'ğŸ“ Docs', contrato:'ğŸ“ Contrato', factura:'ğŸ§¾ Factura'};
            return '<button onclick="switchDetalleTab(\''+t+'\',\''+c.id+'\')" id="dtab-btn-'+t+'" style="flex:1;padding:10px 4px;font-size:12px;font-weight:600;border:none;cursor:pointer;background:'+(i===0?'var(--accent)':'transparent')+';color:'+(i===0?'#fff':'var(--text2)')+';transition:all 0.15s">'+labels[t]+'</button>';
          }).join('')}
        </div>

        <!-- TAB DOCS -->
        <div id="dtab-docs" style="display:block">
          ${(c.docs && c.docs.length) ? c.docs.map(doc => {
            const isImg = (doc.type||'').startsWith('image');
            const icon  = (doc.type||'').includes('pdf') ? 'ğŸ“•' : isImg ? 'ğŸ–¼ï¸' : 'ğŸ“„';
            return '<div style="display:flex;align-items:center;gap:10px;background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px">' +
              '<span style="font-size:22px">' + icon + '</span>' +
              '<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + (doc.name||'Documento') + '</div>' +
              '<div style="font-size:11px;color:var(--text3)">' + (doc.size ? (doc.size > 1048576 ? (doc.size/1048576).toFixed(1)+' MB' : Math.round(doc.size/1024)+' KB') : '') + '</div></div>' +
              '<button onclick="verDocumentoCliente(\''+c.id+'\',\''+doc.id+'\')" class="btn btn-ghost" style="font-size:12px;padding:6px 10px">Ver</button>' +
              '</div>';
          }).join('') : '<div style="text-align:center;padding:28px 16px;color:var(--text3);font-size:13px;background:#fff;border:1px solid var(--border);border-radius:10px"><div style="font-size:32px;margin-bottom:8px">ğŸ“</div>Sin documentos adjuntos<br><span style="font-size:11px">Agrega desde Editar cliente</span></div>'}
        </div>

        <!-- TAB CONTRATO -->
        <div id="dtab-contrato" style="display:none">
          ${(() => {
            const b64  = c.contrato || c.contratoData || '';
            const meta = c.contratoMeta ? (typeof c.contratoMeta === 'string' ? JSON.parse(c.contratoMeta) : c.contratoMeta) : {};
            if (!b64) return '<div style="text-align:center;padding:28px 16px;color:var(--text3);font-size:13px;background:#fff;border:1px solid var(--border);border-radius:10px"><div style="font-size:32px;margin-bottom:8px">ğŸ“‚</div>Sin contrato adjunto<br><span style="font-size:11px">Sube desde Editar cliente</span></div>';
            const isPdf = (meta.type||'').includes('pdf');
            const isImg = (meta.type||'').startsWith('image');
            const icon  = isPdf ? 'ğŸ“•' : isImg ? 'ğŸ–¼ï¸' : 'ğŸ“„';
            const sizeStr = meta.size ? (meta.size > 1048576 ? (meta.size/1048576).toFixed(1)+' MB' : Math.round(meta.size/1024)+' KB') : '';
            return '<div style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px">' +
              '<div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">' +
              '<span style="font-size:32px">' + icon + '</span>' +
              '<div><div style="font-weight:600;font-size:14px">' + (meta.name||'contrato') + '</div>' +
              '<div style="font-size:11px;color:var(--text3)">' + sizeStr + '</div></div></div>' +
              (isPdf ? '<iframe src="' + b64 + '" style="width:100%;height:320px;border:none;border-radius:8px;background:#f5f0e8"></iframe>' :
               isImg ? '<img src="' + b64 + '" style="width:100%;border-radius:8px;max-height:400px;object-fit:contain"/>' : '') +
              '<div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">' +
              '<button onclick="descargarContratoCliente(\''+c.id+'\')" class="btn btn-primary" style="font-size:13px;flex:1">â¬‡ï¸ Descargar</button>' +
              '</div></div>';
          })()}
        </div>

        <!-- TAB FACTURA -->
        <div id="dtab-factura" style="display:none">
          ${c.factura && c.facturacion ? (() => {
            var f = c.facturacion;
            return '<div class="g2" style="background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;gap:12px">' +
              '<div style="grid-column:1/-1;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:600;margin-bottom:2px">Datos de FacturaciÃ³n</div>' +
              (f.tipo ? '<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Tipo</div><div style="font-size:13px;font-weight:600">' + (f.tipo==='fisica'?'Persona FÃ­sica':'Persona Moral') + '</div></div>' : '') +
              (f.rfc  ? '<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">RFC</div><div style="font-size:13px;font-family:monospace;font-weight:600">' + escHtml(f.rfc) + '</div></div>' : '') +
              (f.razon ? '<div style="grid-column:1/-1"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">RazÃ³n social</div><div style="font-size:13px;word-break:break-word">' + escHtml(f.razon) + '</div></div>' : '') +
              (f.cp ? '<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">C.P. Fiscal</div><div style="font-size:13px;font-family:monospace">' + escHtml(f.cp) + '</div></div>' : '') +
              (f.regimen ? '<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">RÃ©gimen fiscal</div><div style="font-size:13px">' + escHtml(f.regimen) + '</div></div>' : '') +
              (f.cfdi ? '<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Uso CFDI</div><div style="font-size:13px">' + escHtml(f.cfdi) + '</div></div>' : '') +
              (f.emailFactura ? '<div style="grid-column:1/-1"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Email facturaciÃ³n</div><div style="font-size:13px;word-break:break-all;overflow-wrap:break-word">' + escHtml(f.emailFactura) + '</div></div>' : '') +
              (f.predial ? '<div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:2px">Cuenta predial</div><div style="font-size:13px;font-family:monospace">' + escHtml(f.predial) + '</div></div>' : '') +
              (f.subtotal ? '<div style="grid-column:1/-1;border-top:1px solid var(--border);padding-top:10px;margin-top:4px"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--accent);font-weight:600;margin-bottom:8px">ğŸ’° Desglose fiscal</div>' +
                '<div><div style="font-size:10px;color:var(--text3)">Subtotal</div><div style="font-weight:600;font-family:monospace">$' + Number(f.subtotal).toLocaleString('es-MX') + '</div></div>' +
                '<div><div style="font-size:10px;color:var(--text3)">IVA 16%</div><div style="font-weight:600;font-family:monospace">$' + Number(f.iva||0).toLocaleString('es-MX') + '</div></div>' +
                (f.retIsr ? '<div><div style="font-size:10px;color:var(--text3)">Ret. ISR ' + (f.retIsrPct||10) + '%</div><div style="font-weight:600;font-family:monospace;color:var(--danger)">-$' + Number(f.retIsr).toLocaleString('es-MX') + '</div></div>' : '') +
                (f.retIva ? '<div><div style="font-size:10px;color:var(--text3)">Ret. IVA ' + (f.retIvaPct||'') + '%</div><div style="font-weight:600;font-family:monospace;color:var(--danger)">-$' + Number(f.retIva).toLocaleString('es-MX') + '</div></div>' : '') +
                '<div><div style="font-size:10px;color:var(--text3);font-weight:700">Neto a depositar</div><div style="font-weight:700;font-family:monospace;color:var(--accent);font-size:16px">$' + Number(f.neto||0).toLocaleString('es-MX') + '</div></div>' +
              '</div>' : '') +
              '</div>';
          })() : '<div style="text-align:center;padding:28px 16px;color:var(--text3);font-size:13px;background:#fff;border:1px solid var(--border);border-radius:10px"><div style="font-size:32px;margin-bottom:8px">ğŸ§¾</div>No requiere factura</div>'}
        </div>
      </div>  `;
}

// â”€â”€ Tabs en vista de detalle de cliente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchDetalleTab(tab, clienteId) {
  ['docs','contrato','factura'].forEach(function(t) {
    var panel = document.getElementById('dtab-' + t);
    var btn   = document.getElementById('dtab-btn-' + t);
    if (!panel || !btn) return;
    var active = (t === tab);
    panel.style.display = active ? 'block' : 'none';
    btn.style.background = active ? 'var(--accent)' : 'transparent';
    btn.style.color      = active ? '#fff' : 'var(--text2)';
  });
}

// Ver un documento del cliente (abre en nueva pestaÃ±a o modal)
function verDocumentoCliente(clienteId, docId) {
  var c = state.clientes.find(function(x){ return x.id === clienteId; });
  if (!c) return;
  var doc = (c.documentos||[]).find(function(d){ return d.id === docId; });
  if (!doc || !doc.data) { alert('Documento no disponible.'); return; }
  var w = window.open('');
  if (!w) return;
  if ((doc.type||'').includes('pdf')) {
    w.document.write('<iframe src="' + doc.data + '" style="width:100vw;height:100vh;border:none"></iframe>');
  } else {
    w.document.write('<img src="' + doc.data + '" style="max-width:100%;height:auto"/>');
  }
}

// Descargar contrato del cliente
function descargarContratoCliente(clienteId) {
  var c = state.clientes.find(function(x){ return x.id === clienteId; });
  if (!c || (!c.contrato && !c.contratoData)) { alert('No hay contrato adjunto.'); return; }
  var contratoB64 = c.contrato || c.contratoData;
  var meta = c.contratoMeta ? (typeof c.contratoMeta === 'string' ? JSON.parse(c.contratoMeta) : c.contratoMeta) : {};
  var a = document.createElement('a');
  a.href = contratoB64;
  a.download = meta.name || 'contrato';
  a.click();
}

// ============================================================
// DETALLE
// ============================================================
function verDetalle(id) {
  currentRentaId = id;
  _prevPage = currentPage; // track where we came from
  document.getElementById('a-fecha').value = new Date().toISOString().slice(0,10);
  const hoy = new Date();
  document.getElementById('a-mes').value = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}`;
  nav('detalle');
  setMobileNav('detalle');
}
function renderDetalle(id) {
  const renta = state.rentas.find(r => r.id === id);
  if (!renta) { nav('rentas'); return; }
  const st = getStatusRenta(renta);
  const abonos = [...(renta.abonos||[])].reverse();
  const badgeLabel = st.saldoFavor > 0
    ? 'âœ¨ A favor +' + fmt(st.saldoFavor) + (st.mesesAdelanto > 0 ? ' Â· ' + st.mesesAdelanto + ' mes' + (st.mesesAdelanto > 1 ? 'es' : '') + ' adelantado' + (st.mesesAdelanto > 1 ? 's' : '') : '')
    : {atrasado:'âš ï¸ Atrasado',parcial:'ğŸ”¶ Parcial','al-dia':'âœ… Al dÃ­a'}[st.estado];
  const fp = renta.formaPagoId ? state.formasPago.find(f=>f.id===renta.formaPagoId) : null;
  const servicios = renta.servicios || [];
  const predial = renta.predial || {};
  const archivos = renta.archivos || [];
  const fotos = archivos.filter(a => a.tipo === 'foto');
  const docs = archivos.filter(a => a.tipo === 'doc');
  const currentTab = renta._tab || 'general';
  const clienteObj = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;

  document.getElementById('detalle-content').innerHTML = `
    <div class="detail-header">
      <div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <button class="btn btn-ghost" onclick="nav(_prevPage||'rentas');setMobileNav(_prevPage||'rentas')" style="font-size:12px;padding:6px 12px">â† Volver</button>
          <span class="badge ${st.estado}">${badgeLabel}</span>
          <span class="tag">${renta.tipo||'Propiedad'}</span>
        </div>
        <div class="detail-title">${escHtml(renta.nombre)}</div>
        <div style="color:var(--text3);margin-top:4px">ğŸ‘¤ <span style="cursor:pointer;text-decoration:underline;text-decoration-color:transparent" onmouseenter="this.style.textDecorationColor='currentColor'" onmouseleave="this.style.textDecorationColor='transparent'" onclick="if(renta.clienteId)verDetalleCliente(renta.clienteId)">${getClienteNombre(renta.clienteId)}</span> Â· Cobro dÃ­a <strong>${renta.dia||1}</strong> Â· Plazo hasta dÃ­a <strong>${Number(renta.dia||1)+6}</strong></div>
        ${renta.emisorId ? (() => { var _em = getEmisor(renta.emisorId); return _em ? '<div style="font-size:11px;color:var(--accent);margin-top:4px">ğŸ§¾ Emisor: <strong>' + escHtml(_em.razon) + '</strong> (' + _em.rfc + ')</div>' : ''; })() : ''}
      </div>
      <div class="detail-actions">
        ${hasPerm('abono_write') ? `<button class="btn btn-success" onclick="openModal('modalAbono')">+ Registrar abono</button>` : ''}
        ${hasPerm('prop_write') ? `<button class="btn btn-ghost" onclick="editarRenta('${renta.id}')">âœï¸ Editar</button>` : ''}
        ${clienteObj && clienteObj.tel ? `<button class="btn btn-ghost" style="background:#25D366;color:#fff;border-color:#25D366;font-size:13px" onclick="enviarRecordatorioPago('${renta.id}')">ğŸ’¬ Recordatorio</button>` : ''}
        ${clienteObj && clienteObj.factura && hasPerm('factura_write') ? `<button class="btn btn-ghost" style="background:var(--accent);color:#fff;border-color:var(--accent);font-size:13px" onclick="facturarMes('${renta.id}')">ğŸ§¾ Facturar mes</button>` : ''}
        <button class="btn btn-ghost" onclick="abrirModalFichaPDF('${renta.id}')" style="font-size:13px" title="Ficha PDF">
          ğŸ“ Ficha PDF${renta.fichaPDF ? ' <span style=\"width:7px;height:7px;border-radius:50%;background:var(--success);display:inline-block;margin-left:3px\" title=\"PDF adjunto\"></span>' : ''}
        </button>
        <button class="btn btn-ghost" onclick="verHistorialInquilinos('${renta.id}')" style="font-size:13px">ğŸ‘¥ Historial</button>
        <button class="btn btn-danger" onclick="eliminarRenta('${renta.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>

    <div class="detail-tabs">
      <button class="detail-tab ${currentTab==='general'?'active':''}" onclick="switchTab('general')">ğŸ“‹ General</button>
      <button class="detail-tab ${currentTab==='servicios'?'active':''}" onclick="switchTab('servicios')">ğŸ”Œ Servicios</button>
      <button class="detail-tab ${currentTab==='predial'?'active':''}" onclick="switchTab('predial')">ğŸ›ï¸ Predial</button>
      <button class="detail-tab ${currentTab==='gastos'?'active':''}" onclick="switchTab('gastos')">ğŸ’¸ Gastos</button>
      <button class="detail-tab ${currentTab==='inventario'?'active':''}" onclick="switchTab('inventario')">ğŸ“¦ Inventario</button>
      <button class="detail-tab ${currentTab==='media'?'active':''}" onclick="switchTab('media')">ğŸ“· Fotos y Documentos</button>
    </div>

    <div class="tab-panel ${currentTab==='general'?'active':''}" id="tab-general">
      <div class="info-grid">
        <div class="info-box"><div class="info-val big">${fmt(renta.monto)}</div><div class="info-label">Precio de renta</div></div>
        ${st.saldoFavor > 0 ? `<div class="info-box" style="position:relative"><div class="info-val big success" style="color:var(--success)">+${fmt(st.saldoFavor)}</div><div class="info-label">âœ¨ Saldo a favor</div>${st.mesesAdelanto > 0 ? '<div style="position:absolute;top:8px;right:8px;background:var(--success);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px">' + st.mesesAdelanto + ' mes' + (st.mesesAdelanto > 1 ? "es" : "") + ' adelante</div>' : ''}</div>` : `<div class="info-box"><div class="info-val big ${st.saldo>0?'danger':'success'}">${fmt(st.saldo)}</div><div class="info-label">Saldo pendiente</div></div>`}
        <div class="info-box"><div class="info-val success">${fmt(st.totalPagado)}</div><div class="info-label">Total cobrado</div></div>
        <div class="info-box"><div class="info-val">${fmt(st.pagadoMes)}</div><div class="info-label">Pagado este mes</div></div>
        <div class="info-box"><div class="info-val">${fmtDate(renta.inicio)}</div><div class="info-label">Inicio contrato</div></div>
        <div class="info-box"><div class="info-val">${renta.fin ? (new Date(renta.fin+'T12:00:00') < new Date() ? '<span style="color:var(--success);font-size:13px;font-weight:600">ğŸ”„ Renovado auto</span><div style="font-size:10px;color:var(--text3);margin-top:2px">VenciÃ³: ' + fmtDate(renta.fin) + '</div>' : fmtDate(renta.fin)) : 'â€”'}</div><div class="info-label">Fin contrato</div></div>
      </div>
      ${fp ? `<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:12px;font-size:14px;display:flex;align-items:center;gap:10px"><span style="font-size:22px">${fp.icono||'ğŸ’³'}</span><div><div style="font-weight:600">${escHtml(fp.nombre)}</div>${fp.desc?`<div style="color:var(--text3);font-size:12px;white-space:pre-line;margin-top:2px">${escHtml(fp.desc)}</div>`:''}</div></div>` : ''}
      ${renta.notas ? `<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:24px;font-size:14px;color:var(--text2)">ğŸ“ ${escHtml(renta.notas)}</div>` : ''}

      <!-- DepÃ³sito en garantÃ­a -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="section-title" style="margin:0">ğŸ’° DepÃ³sito en garantÃ­a</div>
          ${hasPerm('prop_write') ? `<button class="btn btn-ghost" style="font-size:11px;padding:4px 10px" onclick="editarDeposito('${renta.id}')">${renta.deposito ? 'âœï¸ Editar' : '+ Registrar'}</button>` : ''}
        </div>
        ${renta.deposito ? `
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px" class="g3">
            <div><div style="font-family:'DM Mono',monospace;font-size:18px;font-weight:700;color:var(--accent)">${fmt(renta.deposito.monto)}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">MONTO</div></div>
            <div><div style="font-size:14px;font-weight:600">${fmtDate(renta.deposito.fecha)}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">FECHA RECIBIDO</div></div>
            <div><div style="font-size:14px;font-weight:600;color:${renta.deposito.devuelto ? 'var(--success)' : 'var(--accent)'}">${renta.deposito.devuelto ? 'âœ… Devuelto' : 'ğŸ”’ Retenido'}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">ESTADO</div></div>
          </div>
          ${renta.deposito.nota ? `<div style="font-size:12px;color:var(--text3);margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">ğŸ“ ${escHtml(renta.deposito.nota)}</div>` : ''}
          ${renta.deposito.devuelto ? `<div style="font-size:12px;color:var(--success);margin-top:6px">Devuelto el ${fmtDate(renta.deposito.fechaDevolucion)}${renta.deposito.montoDevuelto != renta.deposito.monto ? ' â€” Monto devuelto: ' + fmt(renta.deposito.montoDevuelto) + (renta.deposito.descuento ? ' (descuento: ' + fmt(renta.deposito.descuento) + ')' : '') : ''}</div>` : ''}
          ${!renta.deposito.devuelto && hasPerm('prop_write') ? `<div style="margin-top:10px"><button class="btn btn-ghost" style="font-size:12px;border-color:var(--success);color:var(--success)" onclick="devolverDeposito('${renta.id}')">ğŸ’¸ Registrar devoluciÃ³n</button></div>` : ''}
        ` : `<div style="font-size:13px;color:var(--text3)">Sin depÃ³sito registrado</div>`}
      </div>

      <!-- Incremento anual -->
      ${renta.incrementoPct ? `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px">
        <div class="section-title" style="margin-bottom:10px">ğŸ“ˆ Incremento anual programado</div>
        <div class="g3">
          <div><div style="font-family:'DM Mono',monospace;font-size:18px;font-weight:700;color:var(--accent)">${renta.incrementoPct}%</div><div style="font-size:10px;color:var(--text3);margin-top:2px">PORCENTAJE</div></div>
          <div><div style="font-size:14px;font-weight:600">${fmtDate(renta.incrementoFecha)}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">PRÃ“XIMO INCREMENTO</div></div>
          <div><div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:600">${fmt(Math.round(Number(renta.monto) * (1 + Number(renta.incrementoPct)/100)))}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">NUEVA RENTA</div></div>
        </div>
      </div>` : ''}
      ${renta.historialMonto && renta.historialMonto.length ?
        '<div class="section-title" style="margin-top:24px">ğŸ“ˆ Historial de cambios de renta</div>' +
        '<table class="payments-table" style="margin-bottom:20px">' +
        '<thead><tr><th>Fecha cambio</th><th>Monto anterior</th><th>Monto nuevo</th><th>Aplica desde</th></tr></thead>' +
        '<tbody>' + renta.historialMonto.map(h =>
          '<tr><td>'+(h.fecha||'â€”')+'</td>' +
          '<td style="color:var(--danger)">'+fmt(h.montoAnterior)+'</td>' +
          '<td style="color:var(--success)">'+fmt(h.montoNuevo)+'</td>' +
          '<td>'+(h.fechaAplic||'â€”')+'</td></tr>'
        ).join('') + '</tbody></table>'
        : ''}
      <div class="section-title">Historial de abonos <span style="font-size:11px;color:var(--text3);font-weight:400">${renta.abonos?.length||0} registros</span></div>
            ${abonos.length ? `<table class="payments-table">
        <thead><tr><th>Fecha</th><th>Mes</th><th>Monto</th><th>Forma de pago</th><th>Concepto</th><th>Recibo</th><th>Comprobante</th><th>CFDI</th><th></th></tr></thead>
        <tbody>${abonos.map((a,aidx) => `<tr${a.pendientePago ? ' style="background:var(--warning-light)"' : ''}>
          <td>${fmtDate(a.fecha)}</td><td>${a.mes||'â€”'}</td>
          <td class="mono" style="color:${a.pendientePago ? 'var(--warning)' : 'var(--success)'}">${fmt(a.monto)}${a.pendientePago ? ' <span style="font-size:9px;background:var(--warning);color:#fff;padding:1px 5px;border-radius:4px;margin-left:4px">PENDIENTE</span>' : ''}</td>
          <td><span class="tag">${a.metodo||'â€”'}</span>${a.pendientePago && !a.metodo ? '<button onclick="marcarPagado(\\\''+renta.id+'\\\',\\\''+a.id+'\\\')" style="background:var(--success);color:#fff;border:none;border-radius:4px;padding:2px 6px;font-size:9px;cursor:pointer;margin-left:4px">âœ“ Pagado</button>' : ''}</td>
          <td style="color:var(--text2)">${a.nota||'â€”'}</td>
          <td><div style="position:relative;display:inline-block"><button onclick="toggleReciboMenu(this,'${renta.id}','${a.id}')" style="background:var(--accent-light);color:var(--accent);border:1px solid var(--accent);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;font-weight:600;white-space:nowrap">ğŸ“„ Recibo â–¾</button></div></td>
          <td>${a.comprobante ? `<button onclick="verComprobante('${renta.id}','${a.id}')" style="background:var(--accent-light);color:var(--accent);border:1px solid var(--accent);border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;font-weight:600;white-space:nowrap">ğŸ“ Ver</button>` : '<span style="color:var(--text3);font-size:11px">â€”</span>'}</td>
          <td>${a.uuid ? `<div style="display:flex;gap:4px;align-items:center"><span style="color:var(--success);font-size:11px;font-weight:600" title="${a.uuid}">âœ… Timbrada</span><button onclick="descargarXMLFactura('${renta.id}','${a.id}')" style="background:none;border:1px solid var(--accent);color:var(--accent);border-radius:4px;padding:2px 6px;font-size:10px;cursor:pointer" title="Descargar XML">XML</button></div>` : (renta.clienteId && hasPerm('factura_write') ? `<button onclick="facturarAbono('${renta.id}','${a.id}')" style="background:${fiscalReady()?'var(--accent)':'var(--text3)'};color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;font-weight:600;white-space:nowrap">ğŸ§¾ Facturar</button>` : '<span style="color:var(--text3);font-size:10px">â€”</span>')}</td>
          <td>${hasPerm('abono_delete') ? `<button class="del-pay-btn" onclick="eliminarAbono('${renta.id}','${a.id}')">âœ•</button>` : ''}</td>
        </tr>`).join('')}</tbody>
      </table>` : `<div class="empty-state"><div class="empty-icon">ğŸ’°</div><div class="empty-title">Sin abonos registrados</div></div>`}
    </div>

    <div class="tab-panel ${currentTab==='servicios'?'active':''}" id="tab-servicios">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div style="color:var(--text3);font-size:14px">NÃºmeros de cuenta y datos de servicios</div>
        <button class="btn btn-primary" onclick="openModalServicio()">+ Agregar servicio</button>
      </div>
      ${servicios.length ? servicios.map((s,i) => `
        <div class="servicio-row">
          <div class="servicio-icon">${s.icono||'ğŸ”Œ'}</div>
          <div class="servicio-info">
            <div class="servicio-name">${s.nombre}</div>
            ${s.numero ? `<div class="servicio-num">NÂ° cuenta: ${s.numero}</div>` : ''}
            ${s.proveedor ? `<div class="servicio-num">Proveedor: ${s.proveedor}</div>` : ''}
            ${s.notas ? `<div class="servicio-num">${s.notas}</div>` : ''}
          </div>
          <div class="servicio-actions">
            <button class="btn btn-ghost" style="font-size:11px;padding:5px 10px" onclick="openModalServicio(${i})">âœï¸</button>
            <button class="btn btn-danger" style="font-size:11px;padding:5px 10px" onclick="eliminarServicio(${i})">ğŸ—‘ï¸</button>
          </div>
        </div>`).join('') : `<div class="empty-state"><div class="empty-icon">ğŸ”Œ</div><div class="empty-title">Sin servicios registrados</div><p>Agrega agua, luz, gas y mÃ¡s.</p></div>`}
    </div>

    <div class="tab-panel ${currentTab==='predial'?'active':''}" id="tab-predial">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div style="color:var(--text3);font-size:14px">InformaciÃ³n del impuesto predial</div>
        <button class="btn btn-primary" onclick="openModalPredial()">âœï¸ Editar predial</button>
      </div>
      ${predial.cuenta ? `<div class="predial-box">
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px">
          <div><div class="info-label">Cuenta predial</div><div style="font-family:'DM Mono',monospace;font-size:16px;margin-top:4px">${predial.cuenta}</div></div>
          ${predial.valor ? `<div><div class="info-label">Valor catastral</div><div style="font-family:'DM Mono',monospace;font-size:16px;margin-top:4px;color:var(--accent)">${fmt(predial.valor)}</div></div>` : ''}
          ${predial.monto ? `<div><div class="info-label">Monto anual</div><div style="font-family:'DM Mono',monospace;font-size:16px;margin-top:4px">${fmt(predial.monto)}</div></div>` : ''}
          ${predial.vencimiento ? `<div><div class="info-label">Vencimiento</div><div style="font-family:'DM Mono',monospace;font-size:16px;margin-top:4px">${fmtDate(predial.vencimiento)}</div></div>` : ''}
          ${predial.municipio ? `<div><div class="info-label">Municipio</div><div style="font-size:14px;margin-top:4px">${predial.municipio}</div></div>` : ''}
          ${predial.pagado !== undefined ? `<div><div class="info-label">Estado de pago</div><div style="font-size:14px;margin-top:4px;color:${predial.pagado?'var(--success)':'var(--danger)'}">${predial.pagado?'âœ… Pagado':'âš ï¸ Pendiente'}</div></div>` : ''}
        </div>
        ${predial.notas ? `<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);font-size:13px;color:var(--text2)">ğŸ“ ${predial.notas}</div>` : ''}
      </div>` : `<div class="empty-state"><div class="empty-icon">ğŸ›ï¸</div><div class="empty-title">Sin informaciÃ³n de predial</div><p>Agrega la cuenta predial y datos de pago.</p></div>`}
    </div>

    <div class="tab-panel ${currentTab==='gastos'?'active':''}" id="tab-gastos">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <div>
          <div style="font-size:14px;color:var(--text2)">Gastos registrados en esta propiedad</div>
          ${(renta.gastos||[]).length ? `<div style="font-size:12px;color:var(--danger);margin-top:2px">Total: <strong>${fmt((renta.gastos||[]).reduce((s,g)=>s+Number(g.monto||0),0))}</strong></div>` : ''}
        </div>
        <button class="btn btn-danger" style="font-size:13px" onclick="openModalGasto()">+ Registrar gasto</button>
      </div>
      ${(renta.gastos||[]).length === 0
        ? `<div class="empty-state"><div class="empty-icon">ğŸ§¾</div><div class="empty-title">Sin gastos registrados</div></div>`
        : `<table class="payments-table">
            <thead><tr><th>Fecha</th><th>Tipo</th><th>DescripciÃ³n</th><th>Monto</th><th>Pago</th><th></th></tr></thead>
            <tbody>${[...(renta.gastos||[])].sort((a,b)=>(b.fecha||'').localeCompare(a.fecha||'')).map(g=>`
              <tr>
                <td>${fmtDate(g.fecha)}</td>
                <td><span class="tag">${g.tipo||'â€”'}</span></td>
                <td style="color:var(--text2)">${g.desc||'â€”'}</td>
                <td class="mono" style="color:var(--danger);font-weight:600">${fmt(g.monto)}</td>
                <td><span class="tag">${g.formaPago||'â€”'}</span></td>
                <td><button class="del-pay-btn" onclick="eliminarGasto('${renta.id}','${g.id}')">âœ•</button></td>
              </tr>`).join('')}
            </tbody>
          </table>`
      }
    </div>

    <div class="tab-panel ${currentTab==='inventario'?'active':''}" id="tab-inventario">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div>
          <div style="font-size:14px;color:var(--text2)">ArtÃ­culos, muebles y equipos de la propiedad</div>
          ${(renta.inventario||[]).length ? `<div style="font-size:12px;color:var(--text3);margin-top:2px">${(renta.inventario||[]).length} artÃ­culo${(renta.inventario||[]).length!==1?'s':''} Â· Valor total: <strong style="font-family:'DM Mono',monospace">${fmt((renta.inventario||[]).reduce((s,it)=>s+Number(it.valor||0)*Number(it.cantidad||1),0))}</strong></div>` : ''}
        </div>
        <button class="btn btn-primary" style="font-size:13px" onclick="openModalInventario('${renta.id}')">+ Agregar artÃ­culo</button>
      </div>
      ${(renta.inventario||[]).length === 0
        ? `<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><div class="empty-title">Sin inventario registrado</div></div>`
        : `<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden">
            <div class="inv-row header">
              <span>ArtÃ­culo</span><span style="text-align:center">Cant.</span><span class="inv-val" style="text-align:right">Valor unit.</span><span style="text-align:center">Estado</span><span></span>
            </div>
            ${(renta.inventario||[]).map(it => `
              <div class="inv-row">
                <div>
                  <div style="font-weight:600">${it.nombre}</div>
                  ${it.nota?`<div style="font-size:11px;color:var(--text3)">${it.nota}</div>`:''}
                </div>
                <div class="inv-cant" style="text-align:center;font-family:'DM Mono',monospace;font-weight:600">${it.cantidad||1}</div>
                <div class="inv-val" style="text-align:right;font-family:'DM Mono',monospace;color:var(--text2)">${it.valor?fmt(it.valor):'â€”'}</div>
                <div><span class="inv-estado ${it.estado||'bueno'}">${it.estado==='regular'?'ğŸ”¶ Regular':it.estado==='malo'?'ğŸ”´ Malo':'âœ… Bueno'}</span></div>
                <div style="display:flex;gap:6px">
                  <button class="btn btn-ghost" style="font-size:11px;padding:3px 8px" onclick="editarItemInventario('${renta.id}','${it.id}')">âœï¸</button>
                  <button class="del-pay-btn" onclick="eliminarItemInventario('${renta.id}','${it.id}')">âœ•</button>
                </div>
              </div>`).join('')}
          </div>`
      }
    </div>

    <div class="tab-panel ${currentTab==='media'?'active':''}" id="tab-media">
      <div class="section-title" style="margin-bottom:16px">Fotos <span style="font-size:11px;font-weight:400;color:var(--text3)">${fotos.length} archivos</span></div>
      <div class="upload-zone" id="foto-drop" onclick="document.getElementById('foto-input').click()"
        ondragover="event.preventDefault();this.classList.add('drag')"
        ondragleave="this.classList.remove('drag')"
        ondrop="handleDrop(event,'foto')">
        <div class="upload-zone-icon">ğŸ“·</div>
        <div class="upload-zone-text">Subir fotos</div>
        <div class="upload-zone-sub">JPG, PNG, WebP Â· Arrastra o haz clic</div>
      </div>
      <input type="file" id="foto-input" accept="image/*" multiple style="display:none" onchange="handleFiles(this.files,'foto')" />
      ${fotos.length ? '<div class="media-grid" style="margin-top:16px">' + fotos.map(f =>
        '<div class="media-item" onclick="openLightbox(\'' + f.data + '\')">' +
        '<img src="' + f.data + '" alt="' + f.nombre + '" loading="lazy" />' +
        '<div class="media-overlay"><div style="color:#fff;font-size:12px;text-align:center;padding:8px">' + f.nombre + '</div></div>' +
        '<button class="media-del" onclick="event.stopPropagation();eliminarArchivo(\'' + f.id + '\')">âœ•</button>' +
        '</div>'
      ).join('') + '</div>' : ''}

      <div class="section-title" style="margin-top:28px;margin-bottom:16px">Documentos <span style="font-size:11px;font-weight:400;color:var(--text3)">${docs.length} archivos</span></div>
      <div class="upload-zone" id="doc-drop" onclick="document.getElementById('doc-input').click()"
        ondragover="event.preventDefault();this.classList.add('drag')"
        ondragleave="this.classList.remove('drag')"
        ondrop="handleDrop(event,'doc')">
        <div class="upload-zone-icon">ğŸ“„</div>
        <div class="upload-zone-text">Subir documentos</div>
        <div class="upload-zone-sub">PDF, Word, Excel Â· Arrastra o haz clic</div>
      </div>
      <input type="file" id="doc-input" multiple style="display:none" onchange="handleFiles(this.files,'doc')" />
      ${docs.length ? docs.map(f =>
        '<div class="doc-item" style="margin-top:10px">' +
        '<div class="doc-icon">' + getDocIcon(f.nombre) + '</div>' +
        '<div class="doc-info"><div class="doc-name">' + f.nombre + '</div><div class="doc-size">' + (f.size||'') + '</div></div>' +
        '<button class="btn btn-ghost" style="font-size:11px;padding:5px 10px" onclick="descargarArchivo(\'' + f.id + '\')">â¬‡ï¸</button>' +
        '<button class="del-pay-btn" onclick="eliminarArchivo(\'' + f.id + '\')">âœ•</button>' +
        '</div>'
      ).join('') : ''}
    </div>
  `;
}

function switchTab(tab) {
  const renta = state.rentas.find(r => r.id === currentRentaId);
  if (renta) renta._tab = tab;
  renderDetalle(currentRentaId);
}

function getDocIcon(nombre) {
  const ext = (nombre||'').split('.').pop().toLowerCase();
  return {pdf:'ğŸ“„',doc:'ğŸ“',docx:'ğŸ“',xls:'ğŸ“Š',xlsx:'ğŸ“Š',ppt:'ğŸ“‘',pptx:'ğŸ“‘',zip:'ğŸ—œï¸',txt:'ğŸ“ƒ'}[ext] || 'ğŸ“';
}

function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('open');
}
function closeLightbox() { document.getElementById('lightbox').classList.remove('open'); }

function handleDrop(e, tipo) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag');
  handleFiles(e.dataTransfer.files, tipo);
}

function handleFiles(files, tipo) {
  const renta = state.rentas.find(r => r.id === currentRentaId);
  if (!renta) return;
  if (!renta.archivos) renta.archivos = [];
  const MAX_SIZE = 5 * 1024 * 1024;
  let pending = files.length;
  if (!pending) return;
  Array.from(files).forEach(file => {
    if (file.size > MAX_SIZE) {
      alert(`"${file.name}" supera el lÃ­mite de 5MB.`);
      pending--;
      if (!pending) { save(); renderDetalle(currentRentaId); }
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      const esImagen = file.type.startsWith('image/');
      renta.archivos.push({
        id: uid(), nombre: file.name,
        size: formatBytes(file.size),
        tipo: esImagen && tipo === 'foto' ? 'foto' : 'doc',
        data: e.target.result,
        fecha: new Date().toISOString(),
      });
      pending--;
      if (!pending) { save(); renderDetalle(currentRentaId); }
    };
    reader.readAsDataURL(file);
  });
}

function formatBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
  return (b/(1024*1024)).toFixed(1) + ' MB';
}

function eliminarArchivo(archivoId) {
  if (!confirm('Â¿Eliminar este archivo?')) return;
  const renta = state.rentas.find(r => r.id === currentRentaId);
  renta.archivos = renta.archivos.filter(a => a.id !== archivoId);
  save(); renderDetalle(currentRentaId);
}

function descargarArchivo(archivoId) {
  const renta = state.rentas.find(r => r.id === currentRentaId);
  const archivo = renta.archivos.find(a => a.id === archivoId);
  if (!archivo) return;
  const a = document.createElement('a');
  a.href = archivo.data; a.download = archivo.nombre; a.click();
}

let editandoServicioIdx = null;

function openModalServicio(idx) {
  editandoServicioIdx = idx !== undefined ? idx : null;
  const renta = state.rentas.find(r => r.id === currentRentaId);
  const s = idx !== undefined ? (renta.servicios||[])[idx] : null;
  document.getElementById('sv-nombre').value = s ? s.nombre : '';
  document.getElementById('sv-icono').value = s ? (s.icono||'') : '';
  document.getElementById('sv-numero').value = s ? (s.numero||'') : '';
  document.getElementById('sv-proveedor').value = s ? (s.proveedor||'') : '';
  document.getElementById('sv-notas').value = s ? (s.notas||'') : '';
  document.querySelectorAll('#sv-tipos .filter-chip').forEach(b => b.classList.remove('active'));
  document.querySelector('#modalServicio .modal-title').textContent = s ? 'Editar Servicio' : 'Agregar Servicio';
  openModal('modalServicio');
}

function selTipo(icono, nombre, btn) {
  document.getElementById('sv-icono').value = icono;
  document.getElementById('sv-nombre').value = nombre;
  document.querySelectorAll('#sv-tipos .filter-chip').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function guardarServicio() {
  const nombre = document.getElementById('sv-nombre').value.trim();
  if (!nombre) return alert('El nombre del servicio es obligatorio.');
  const renta = state.rentas.find(r => r.id === currentRentaId);
  if (!renta.servicios) renta.servicios = [];
  const sv = {
    nombre,
    icono: document.getElementById('sv-icono').value || 'ğŸ”Œ',
    numero: document.getElementById('sv-numero').value,
    proveedor: document.getElementById('sv-proveedor').value,
    notas: document.getElementById('sv-notas').value,
  };
  if (editandoServicioIdx !== null) {
    renta.servicios[editandoServicioIdx] = sv;
  } else {
    renta.servicios.push(sv);
  }
  save(); closeModal('modalServicio'); renderDetalle(currentRentaId);
}

function eliminarServicio(idx) {
  if (!confirm('Â¿Eliminar este servicio?')) return;
  const renta = state.rentas.find(r => r.id === currentRentaId);
  renta.servicios.splice(idx, 1);
  save(); renderDetalle(currentRentaId);
}

function openModalPredial() {
  const renta = state.rentas.find(r => r.id === currentRentaId);
  const p = renta.predial || {};
  document.getElementById('pd-cuenta').value = p.cuenta||'';
  document.getElementById('pd-municipio').value = p.municipio||'';
  document.getElementById('pd-valor').value = p.valor||'';
  document.getElementById('pd-monto').value = p.monto||'';
  document.getElementById('pd-vencimiento').value = p.vencimiento||'';
  document.getElementById('pd-pagado').checked = p.pagado||false;
  document.getElementById('pd-notas').value = p.notas||'';
  openModal('modalPredial');
}

function guardarPredial() {
  const renta = state.rentas.find(r => r.id === currentRentaId);
  renta.predial = {
    cuenta: document.getElementById('pd-cuenta').value,
    municipio: document.getElementById('pd-municipio').value,
    valor: document.getElementById('pd-valor').value,
    monto: document.getElementById('pd-monto').value,
    vencimiento: document.getElementById('pd-vencimiento').value,
    pagado: document.getElementById('pd-pagado').checked,
    notas: document.getElementById('pd-notas').value,
  };
  save(); closeModal('modalPredial'); renderDetalle(currentRentaId);
}
// ============================================================
// CRUD RENTAS
// ============================================================
function guardarRenta() {
  if (!hasPerm('prop_write')) return alert('No tienes permiso para modificar propiedades.');
  // Check plan property limit for new properties
  const _isNew = !document.getElementById('modalRenta-id')?.value;
  if (_isNew) {
    const _limite = state.planLimites?.propiedades || 10;
    if ((state.rentas || []).length >= _limite) {
      alert(`Tu plan ${state.planLimites?.nombre || 'BÃ¡sico'} permite mÃ¡ximo ${_limite} propiedades.\nActualiza tu plan para agregar mÃ¡s.`);
      cerrarModal('modalRenta');
      return;
    }
  }
  const nombre = document.getElementById('r-nombre').value.trim();
  const monto = document.getElementById('r-monto').value;
  if (!nombre || !monto) return alert('Completa al menos el nombre y el monto.');
  const dupRenta = state.rentas.find(r => r.nombre.toLowerCase() === nombre.toLowerCase() && r.id !== editandoRentaId);
  if (dupRenta) return alert('Ya existe una propiedad con ese nombre.');

  if (editandoRentaId) {
    const r = state.rentas.find(r => r.id === editandoRentaId);
    const nuevoClienteId = document.getElementById('r-cliente').value;
    // â”€â”€ Detect client change â†’ register outgoing tenant in historial â”€â”€
    if (r.clienteId && nuevoClienteId !== r.clienteId) {
      const clienteAnterior = state.clientes.find(c => c.id === r.clienteId);
      const motivo = prompt(`Se cambiarÃ¡ el inquilino de esta propiedad.\n\nInquilino anterior: ${clienteAnterior ? clienteAnterior.nombre : 'â€”'}\n\nÂ¿Motivo de salida? (opcional):`, 'Fin de contrato');
      registrarSalidaInquilino(r, r.clienteId, motivo || '');
      // Reset deposit for new tenant
      if (r.deposito && r.deposito.devuelto) r.deposito = null;
    }
    r.nombre   = nombre;
    r.tipo     = document.getElementById('r-tipo').value;
    r.clienteId = nuevoClienteId;
    r.monto    = monto;
    r.notas    = document.getElementById('r-notas').value;
    // Incremento anual
    const incPct = document.getElementById('r-incremento-pct').value;
    const incFecha = document.getElementById('r-incremento-fecha').value;
    r.incrementoPct = incPct ? Number(incPct) : null;
    r.incrementoFecha = incFecha || null;
    r.emisorId = document.getElementById('r-emisor-id').value || '';
    // DepÃ³sito en garantÃ­a (solo si no existe ya o se estÃ¡ creando por primera vez)
    const depMonto = document.getElementById('r-deposito-monto').value;
    const depFecha = document.getElementById('r-deposito-fecha').value;
    if (depMonto && !r.deposito) {
      r.deposito = { monto: Number(depMonto), fecha: depFecha || new Date().toISOString().slice(0,10), devuelto: false, nota: '' };
    } else if (depMonto && r.deposito) {
      r.deposito.monto = Number(depMonto);
      if (depFecha) r.deposito.fecha = depFecha;
    }
    // dia, inicio, fin come from client record
    const cliForDia = nuevoClienteId ? state.clientes.find(c => c.id === nuevoClienteId) : null;
    if (cliForDia) {
      if (cliForDia.dia)            r.dia    = cliForDia.dia;
      if (cliForDia.inicioContrato) r.inicio = cliForDia.inicioContrato;
      if (cliForDia.finContrato)    r.fin    = cliForDia.finContrato;
    }
  } else {
    const newClienteId = document.getElementById('r-cliente').value;
    const newCli = newClienteId ? state.clientes.find(c => c.id === newClienteId) : null;
    const incPctNew = document.getElementById('r-incremento-pct').value;
    const incFechaNew = document.getElementById('r-incremento-fecha').value;
    const depMontoNew = document.getElementById('r-deposito-monto').value;
    const depFechaNew = document.getElementById('r-deposito-fecha').value;
    state.rentas.push({
      id: uid(),
      nombre,
      tipo:      document.getElementById('r-tipo').value,
      clienteId: newClienteId,
      monto,
      dia:    newCli?.dia            || '5',
      inicio: newCli?.inicioContrato || new Date().toISOString().slice(0,10),
      fin:    newCli?.finContrato    || '',
      notas: document.getElementById('r-notas').value,
      incrementoPct: incPctNew ? Number(incPctNew) : null,
      incrementoFecha: incFechaNew || null,
      deposito: depMontoNew ? { monto: Number(depMontoNew), fecha: depFechaNew || new Date().toISOString().slice(0,10), devuelto: false, nota: '' } : null,
      emisorId: document.getElementById('r-emisor-id').value || '',
      abonos: [],
      createdAt: new Date().toISOString(),
    });
    // Generate historical abonos if client has past start date
    const _newRenta = state.rentas[state.rentas.length - 1];
    const _histSec = document.getElementById('r-historial-section');
    if (_newRenta && _histSec && _histSec.style.display !== 'none' && _newRenta.clienteId) {
      const _cli = state.clientes.find(c => c.id === _newRenta.clienteId);
      const _inicio = _cli && _cli.inicioContrato;
      const _montoNum = Number(_newRenta.monto) || 0;
      if (_inicio && _montoNum > 0) {
        const _inicioDate = new Date(_inicio + 'T12:00:00');
        const _hoy = new Date();
        const _totalMeses = (_hoy.getFullYear() - _inicioDate.getFullYear()) * 12 + (_hoy.getMonth() - _inicioDate.getMonth());
        const _histTipo = document.querySelector('input[name="r-hist-tipo"]:checked')?.value || 'al-dia';
        const _mesesDebe = _histTipo === 'debe' ? (parseInt(document.getElementById('r-hist-meses-debe')?.textContent) || 0) : 0;
        const _mesesPagar = Math.max(0, _totalMeses - _mesesDebe);
        // Generate one abono per month paid
        for (let i = 0; i < _mesesPagar; i++) {
          const _mesDate = new Date(_inicioDate.getFullYear(), _inicioDate.getMonth() + i, 1);
          const _mesStr = _mesDate.getFullYear() + '-' + String(_mesDate.getMonth() + 1).padStart(2, '0');
          const _diaCobro = Number(_newRenta.dia) || 1;
          const _fechaPago = _mesDate.getFullYear() + '-' + String(_mesDate.getMonth() + 1).padStart(2, '0') + '-' + String(Math.min(_diaCobro, 28)).padStart(2, '0');
          _newRenta.abonos.push({
            id: uid(),
            monto: _montoNum,
            fecha: _fechaPago,
            metodo: 'ğŸ“‹ Registro inicial',
            formaPagoId: '',
            mes: _mesStr,
            nota: 'Generado automÃ¡ticamente al dar de alta â€” ' + getMesLabel(_mesStr),
          });
        }
        if (_mesesPagar > 0) {
          showToast('ğŸ“‹ Se generaron ' + _mesesPagar + ' abonos histÃ³ricos');
        }
      }
    }
  }
  save();
  closeModal('modalRenta');
  clearRentaForm();
  render();
  showToast(editandoRentaId ? 'âœ… Propiedad actualizada' : 'âœ… Propiedad guardada');
}

function editarRenta(id) {
  const r = state.rentas.find(r => r.id === id);
  if (!r) return;
  editandoRentaId = id;
  document.getElementById('r-nombre').value = r.nombre || '';
  document.getElementById('r-monto').value  = r.monto  || '';
  document.getElementById('r-notas').value  = r.notas  || '';
  document.getElementById('r-incremento-pct').value = r.incrementoPct || '';
  document.getElementById('r-incremento-fecha').value = r.incrementoFecha || '';
  document.getElementById('r-deposito-monto').value = r.deposito ? r.deposito.monto : '';
  document.getElementById('r-deposito-fecha').value = r.deposito ? r.deposito.fecha : '';
  document.querySelector('#modalRenta .modal-title').textContent = 'Editar Propiedad';
  openModal('modalRenta');
  // Set cliente and tipo AFTER openModal rebuilds the selects
  document.getElementById('r-tipo').value    = r.tipo      || 'Departamento';
  document.getElementById('r-cliente').value = r.clienteId || '';
  // Populate emisor selector
  populateEmisorSelect();
  document.getElementById('r-emisor-id').value = r.emisorId || '';
}

function eliminarRenta(id) {
  if (!confirm('Â¿Eliminar esta propiedad y todos sus abonos?')) return;
  state.rentas = state.rentas.filter(r => r.id !== id);
  // Clean up seguimiento data
  if (state.alertaSeguimiento && state.alertaSeguimiento[id]) delete state.alertaSeguimiento[id];
  save();
  nav('rentas');
}

function clearRentaForm() {
  ['r-nombre','r-monto','r-notas','r-incremento-pct','r-incremento-fecha','r-deposito-monto','r-deposito-fecha'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
  const emisorSel = document.getElementById('r-emisor-id'); if (emisorSel) emisorSel.value = '';
  document.querySelector('#modalRenta .modal-title').textContent = 'Agregar Propiedad';
  // Reset historial section
  const histSec = document.getElementById('r-historial-section');
  if (histSec) histSec.style.display = 'none';
  const alDiaRadio = document.querySelector('input[name="r-hist-tipo"][value="al-dia"]');
  if (alDiaRadio) alDiaRadio.checked = true;
  const deudaDetail = document.getElementById('r-hist-deuda-detail');
  if (deudaDetail) deudaDetail.style.display = 'none';
  const mesesEl = document.getElementById('r-hist-meses-debe');
  if (mesesEl) mesesEl.textContent = '1';
}

// Show/hide historial section based on client selection in modalRenta
function onClienteSelectChange() {
  var clienteId = document.getElementById('r-cliente').value;
  var histSec = document.getElementById('r-historial-section');
  var isNew = !editandoRentaId;
  if (clienteId && isNew) {
    // Check if this client has a start date in the past
    var cli = state.clientes.find(function(c) { return c.id === clienteId; });
    var inicio = cli && cli.inicioContrato;
    if (inicio) {
      var inicioDate = new Date(inicio + 'T12:00:00');
      var hoy = new Date();
      var mesesDiff = (hoy.getFullYear() - inicioDate.getFullYear()) * 12 + (hoy.getMonth() - inicioDate.getMonth());
      if (mesesDiff > 0) {
        histSec.style.display = '';
        updateHistPreview();
        return;
      }
    }
    histSec.style.display = 'none';
  } else {
    histSec.style.display = 'none';
  }
}

function toggleHistDeuda() {
  var val = document.querySelector('input[name="r-hist-tipo"]:checked').value;
  var detail = document.getElementById('r-hist-deuda-detail');
  detail.style.display = val === 'debe' ? '' : 'none';
  updateHistPreview();
}

function ajustarMesesDeuda(delta) {
  var el = document.getElementById('r-hist-meses-debe');
  var v = parseInt(el.textContent) + delta;
  // Calculate max months based on client start date
  var clienteId = document.getElementById('r-cliente').value;
  var cli = clienteId ? state.clientes.find(function(c) { return c.id === clienteId; }) : null;
  var maxMeses = 60;
  if (cli && cli.inicioContrato) {
    var inicioDate = new Date(cli.inicioContrato + 'T12:00:00');
    var hoy = new Date();
    maxMeses = (hoy.getFullYear() - inicioDate.getFullYear()) * 12 + (hoy.getMonth() - inicioDate.getMonth());
  }
  if (v < 1) v = 1;
  if (v > maxMeses) v = maxMeses;
  el.textContent = v;
  updateHistPreview();
}

function updateHistPreview() {
  var clienteId = document.getElementById('r-cliente').value;
  var cli = clienteId ? state.clientes.find(function(c) { return c.id === clienteId; }) : null;
  var monto = Number(document.getElementById('r-monto').value) || 0;
  var inicio = cli && cli.inicioContrato;
  var preview = document.getElementById('r-hist-preview');
  if (!inicio || !monto || !preview) return;

  var tipo = document.querySelector('input[name="r-hist-tipo"]:checked').value;
  var inicioDate = new Date(inicio + 'T12:00:00');
  var hoy = new Date();
  var totalMeses = (hoy.getFullYear() - inicioDate.getFullYear()) * 12 + (hoy.getMonth() - inicioDate.getMonth());

  if (tipo === 'al-dia') {
    preview.innerHTML = 'âœ… Se generarÃ¡n <strong>' + totalMeses + ' abonos</strong> automÃ¡ticos por <strong>' + fmt(monto) + '</strong> cada uno = <strong>' + fmt(totalMeses * monto) + '</strong> total';
  } else {
    var mesesDebe = parseInt(document.getElementById('r-hist-meses-debe').textContent) || 1;
    var mesesPagados = totalMeses - mesesDebe;
    if (mesesPagados < 0) mesesPagados = 0;
    preview.innerHTML = 'ğŸ“ Se generarÃ¡n <strong>' + mesesPagados + ' abonos</strong> automÃ¡ticos por <strong>' + fmt(monto) + '</strong> = <strong>' + fmt(mesesPagados * monto) + '</strong>. QuedarÃ¡ debiendo <strong>' + mesesDebe + ' mes' + (mesesDebe > 1 ? 'es' : '') + '</strong> (<strong style="color:var(--danger)">' + fmt(mesesDebe * monto) + '</strong>)';
  }
}

// ============================================================
// CRUD CLIENTES
// ============================================================
function toggleFactura() {
  const cb = document.getElementById('c-factura');
  cb.checked = !cb.checked;
  const section = document.getElementById('factura-section');
  const track = document.getElementById('toggle-track');
  const thumb = document.getElementById('toggle-thumb');
  if (cb.checked) {
    section.style.display = 'block';
    track.style.background = 'var(--accent)';
    thumb.style.left = '20px';
  } else {
    section.style.display = 'none';
    track.style.background = 'var(--border)';
    thumb.style.left = '2px';
  }
}

function setToggleFactura(val) {
  const cb = document.getElementById('c-factura');
  cb.checked = false; // reset first
  if (val) toggleFactura();
}

function switchClienteTab(tab) {
  ['datos','docs','contrato','factura'].forEach(t => {
    document.getElementById('ctab-'+t)?.classList.toggle('active', t === tab);
    document.getElementById('ctab-btn-'+t)?.classList.toggle('active', t === tab);
  });
}

function cargarContratoArchivo(input) {
  const file = input.files[0];
  if (!file) return;
  const maxMB = 8;
  if (file.size > maxMB * 1024 * 1024) {
    alert('El archivo es demasiado grande. MÃ¡ximo ' + maxMB + ' MB.');
    input.value = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = e => {
    const b64 = e.target.result; // data:type;base64,...
    const meta = JSON.stringify({ name: file.name, size: file.size, type: file.type });
    document.getElementById('c-contrato-data').value = b64;
    document.getElementById('c-contrato-meta').value = meta;
    mostrarContratoPreview(b64, file.name, file.size, file.type);
  };
  reader.readAsDataURL(file);
}

function mostrarContratoPreview(b64, name, size, type) {
  if (!b64) {
    document.getElementById('contrato-empty').style.display = '';
    document.getElementById('contrato-loaded').style.display = 'none';
    return;
  }
  document.getElementById('contrato-empty').style.display = 'none';
  document.getElementById('contrato-loaded').style.display = '';
  document.getElementById('contrato-filename').textContent = name || 'Contrato';
  document.getElementById('contrato-filesize').textContent = size ? (size > 1024*1024 ? (size/1024/1024).toFixed(1)+' MB' : Math.round(size/1024)+' KB') : '';
  const isPdf = (type||'').includes('pdf') || (name||'').toLowerCase().endsWith('.pdf');
  const isImg = (type||'').startsWith('image') || /\.(jpg|jpeg|png|webp)$/i.test(name||'');
  document.getElementById('contrato-file-icon').textContent = isPdf ? 'ğŸ“•' : isImg ? 'ğŸ–¼ï¸' : 'ğŸ“„';
  // Show inline preview
  const imgEl = document.getElementById('contrato-preview-img');
  const pdfEl = document.getElementById('contrato-preview-pdf');
  const placeholder = document.getElementById('contrato-preview-placeholder');
  if (isImg && b64) {
    imgEl.src = b64; imgEl.style.display = ''; pdfEl.style.display = 'none'; placeholder.style.display = 'none';
  } else if (isPdf && b64) {
    pdfEl.src = b64; pdfEl.style.display = ''; imgEl.style.display = 'none'; placeholder.style.display = 'none';
  } else {
    imgEl.style.display = 'none'; pdfEl.style.display = 'none'; placeholder.style.display = '';
  }
}

function verContratoArchivo() {
  const b64 = document.getElementById('c-contrato-data').value;
  if (!b64) return;
  const win = window.open('', '_blank');
  win.document.write('<html><body style="margin:0;background:#222"><iframe src="' + b64 + '" style="width:100%;height:100vh;border:none"></iframe></body></html>');
  win.document.close();
}

function descargarContratoArchivo() {
  const b64 = document.getElementById('c-contrato-data').value;
  const metaStr = document.getElementById('c-contrato-meta').value;
  if (!b64) return;
  let name = 'contrato';
  try { name = JSON.parse(metaStr).name || name; } catch(e) {}
  const a = document.createElement('a');
  a.href = b64; a.download = name;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function clearContrato() {
  if (!confirm('Â¿Eliminar el archivo del contrato?')) return;
  document.getElementById('c-contrato-data').value = '';
  document.getElementById('c-contrato-meta').value = '';
  document.getElementById('contrato-empty').style.display = '';
  document.getElementById('contrato-loaded').style.display = 'none';
  document.getElementById('contrato-preview-img').style.display = 'none';
  document.getElementById('contrato-preview-pdf').style.display = 'none';
  document.getElementById('contrato-preview-placeholder').style.display = '';
}

function clearClienteForm() {
  document.getElementById('c-contrato-data').value = '';
  document.getElementById('c-contrato-meta').value = '';
  document.getElementById('contrato-empty').style.display = '';
  document.getElementById('contrato-loaded').style.display = 'none';
  document.getElementById('c-foto-data').value = '';
  document.getElementById('c-foto-preview').textContent = 'ğŸ‘¤';
  // nacimiento field removed
  document.getElementById('c-direccion').value = '';
  document.getElementById('c-aval-nombre').value = '';
  document.getElementById('c-aval-tel').value = '';
  _clienteDocs = [];
  renderDocsTab();
  switchClienteTab('datos');
  ['c-nombre','c-tel','c-email','c-notas','c-monto-renta','c-monto-fecha','c-dia','c-inicio-contrato','c-fin-contrato','c-fac-rfc','c-fac-razon','c-fac-cp','c-fac-email','c-fac-subtotal','c-fac-iva','c-fac-ret-isr','c-fac-ret-iva','c-fac-concepto','c-fac-predial'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  const netoEl = document.getElementById('c-fac-neto');
  if (netoEl) netoEl.value = '0';
  const netoDisp = document.getElementById('c-fac-neto-display');
  if (netoDisp) netoDisp.textContent = '$0';
  // Reset retention defaults
  const retIsr = document.getElementById('c-fac-ret-isr-pct');
  if (retIsr) retIsr.value = '10';
  const retIva = document.getElementById('c-fac-ret-iva-pct');
  if (retIva) retIva.value = '10.6667';
  setToggleFactura(false);
  // Reset WhatsApp reminders
  resetWaReminders();
  document.querySelector('#modalCliente .modal-title').textContent = 'Nuevo Cliente';
  const propSel = document.getElementById('c-propiedad');
  if (propSel) propSel.value = '';
  const montoWrap = document.getElementById('c-monto-fecha-wrap');
  if (montoWrap) montoWrap.style.display = 'none';
}
function onClientePropiedadChange() {

// â”€â”€ WhatsApp Reminders helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _waEnabled = false, _waMsg2Enabled = false;
function toggleWaReminders() {
  _waEnabled = !_waEnabled;
  var toggle = document.getElementById('c-wa-toggle');
  var thumb = document.getElementById('c-wa-thumb');
  var config = document.getElementById('c-wa-config');
  if (!toggle) return;
  toggle.style.background = _waEnabled ? '#25D366' : 'var(--border)';
  thumb.style.left = _waEnabled ? '22px' : '2px';
  config.style.display = _waEnabled ? 'block' : 'none';
}
function toggleWaMsg2() {
  _waMsg2Enabled = !_waMsg2Enabled;
  var toggle = document.getElementById('c-wa-msg2-toggle');
  var thumb = document.getElementById('c-wa-msg2-thumb');
  var config = document.getElementById('c-wa-msg2-config');
  var off = document.getElementById('c-wa-msg2-off');
  if (!toggle) return;
  toggle.style.background = _waMsg2Enabled ? '#25D366' : 'var(--border)';
  thumb.style.left = _waMsg2Enabled ? '20px' : '2px';
  config.style.display = _waMsg2Enabled ? 'block' : 'none';
  off.style.display = _waMsg2Enabled ? 'none' : 'block';
}
function toggleWaCustomDays(n) {
  var sel = document.getElementById('c-wa-msg'+n+'-when');
  var wrap = document.getElementById('c-wa-msg'+n+'-days-wrap');
  if (!sel || !wrap) return;
  var val = sel.value;
  wrap.style.display = (val === 'antes_vencimiento' || val === 'despues_vencimiento') ? 'block' : 'none';
}
function resetWaReminders() {
  _waEnabled = false; _waMsg2Enabled = false;
  var toggle = document.getElementById('c-wa-toggle');
  var thumb = document.getElementById('c-wa-thumb');
  var config = document.getElementById('c-wa-config');
  if (toggle) { toggle.style.background = 'var(--border)'; }
  if (thumb) { thumb.style.left = '2px'; }
  if (config) { config.style.display = 'none'; }
  var t2 = document.getElementById('c-wa-msg2-toggle');
  var th2 = document.getElementById('c-wa-msg2-thumb');
  var c2 = document.getElementById('c-wa-msg2-config');
  var off2 = document.getElementById('c-wa-msg2-off');
  if (t2) { t2.style.background = 'var(--border)'; }
  if (th2) { th2.style.left = '2px'; }
  if (c2) { c2.style.display = 'none'; }
  if (off2) { off2.style.display = 'block'; }
  var m1w = document.getElementById('c-wa-msg1-when'); if (m1w) m1w.value = 'antes_vencimiento';
  var m1d = document.getElementById('c-wa-msg1-days'); if (m1d) m1d.value = '3';
  var m1t = document.getElementById('c-wa-msg1-text'); if (m1t) m1t.value = 'Hola {nombre}, te recordamos que tu pago de renta por {monto} de la propiedad {propiedad} estÃ¡ prÃ³ximo. La fecha lÃ­mite es el dÃ­a {dia_vencimiento} de este mes. Â¡Gracias por tu puntualidad!';
  var m2w = document.getElementById('c-wa-msg2-when'); if (m2w) m2w.value = 'despues_vencimiento';
  var m2d = document.getElementById('c-wa-msg2-days'); if (m2d) m2d.value = '3';
  var m2t = document.getElementById('c-wa-msg2-text'); if (m2t) m2t.value = 'Hola {nombre}, tu pago de renta por {monto} de la propiedad {propiedad} correspondiente a {mes} se encuentra vencido. Tu saldo pendiente es de {saldo}. Te pedimos realizar tu pago a la brevedad. Quedo al pendiente para cualquier duda.';
  toggleWaCustomDays(1); toggleWaCustomDays(2);
}
function loadWaReminders(wa) {
  resetWaReminders();
  if (!wa || !wa.enabled) return;
  toggleWaReminders(); // turn on
  var m1w = document.getElementById('c-wa-msg1-when'); if (m1w && wa.msg1When) m1w.value = wa.msg1When;
  var m1d = document.getElementById('c-wa-msg1-days'); if (m1d && wa.msg1Days) m1d.value = wa.msg1Days;
  var m1t = document.getElementById('c-wa-msg1-text'); if (m1t && wa.msg1Text) m1t.value = wa.msg1Text;
  toggleWaCustomDays(1);
  if (wa.msg2Enabled) {
    toggleWaMsg2(); // turn on msg2
    var m2w = document.getElementById('c-wa-msg2-when'); if (m2w && wa.msg2When) m2w.value = wa.msg2When;
    var m2d = document.getElementById('c-wa-msg2-days'); if (m2d && wa.msg2Days) m2d.value = wa.msg2Days;
    var m2t = document.getElementById('c-wa-msg2-text'); if (m2t && wa.msg2Text) m2t.value = wa.msg2Text;
    toggleWaCustomDays(2);
  }
}
function getWaRemindersData() {
  if (!_waEnabled) return null;
  return {
    enabled: true,
    msg1When: document.getElementById('c-wa-msg1-when')?.value || 'antes_vencimiento',
    msg1Days: Number(document.getElementById('c-wa-msg1-days')?.value) || 3,
    msg1Text: document.getElementById('c-wa-msg1-text')?.value || '',
    msg2Enabled: _waMsg2Enabled,
    msg2When: document.getElementById('c-wa-msg2-when')?.value || 'despues_vencimiento',
    msg2Days: Number(document.getElementById('c-wa-msg2-days')?.value) || 3,
    msg2Text: document.getElementById('c-wa-msg2-text')?.value || '',
  };
}
// â”€â”€ Global WhatsApp toggle in Config â”€â”€
function toggleGlobalWa() {
  var cfg = state.configuracion || (state.configuracion = {});
  cfg.waGlobalEnabled = !(cfg.waGlobalEnabled !== false);
  var on = cfg.waGlobalEnabled;
  var toggle = document.getElementById('cfg-wa-global-toggle');
  var thumb = document.getElementById('cfg-wa-global-thumb');
  var status = document.getElementById('cfg-wa-global-status');
  if (toggle) toggle.style.background = on ? '#25D366' : 'var(--border)';
  if (thumb) thumb.style.left = on ? '22px' : '2px';
  if (status) {
    status.textContent = on ? 'âœ… Activados â€” Los mensajes se configuran en cada cliente' : 'âŒ Desactivados â€” No se enviarÃ¡n recordatorios';
    status.style.color = on ? 'var(--success)' : 'var(--text3)';
  }
  save();
}
function loadGlobalWaToggle() {
  var cfg = state.configuracion || {};
  var on = cfg.waGlobalEnabled !== false;
  var toggle = document.getElementById('cfg-wa-global-toggle');
  var thumb = document.getElementById('cfg-wa-global-thumb');
  var status = document.getElementById('cfg-wa-global-status');
  if (toggle) toggle.style.background = on ? '#25D366' : 'var(--border)';
  if (thumb) thumb.style.left = on ? '22px' : '2px';
  if (status) {
    status.textContent = on ? 'âœ… Activados â€” Los mensajes se configuran en cada cliente' : 'âŒ Desactivados â€” No se enviarÃ¡n recordatorios';
    status.style.color = on ? 'var(--success)' : 'var(--text3)';
  }
}
function guardarDiasGracia() {
  var cfg = state.configuracion || (state.configuracion = {});
  cfg.diasGracia = Number(document.getElementById('cfg-gracia-dias')?.value) || 6;
  save();
  showToast('âœ… DÃ­as de gracia actualizados');
}
  const propId = document.getElementById('c-propiedad')?.value;
  const montoInput = document.getElementById('c-monto-renta');
  if (!propId) {
    // Deselected â€” clear monto if it was auto-filled
    if (montoInput && montoInput.dataset.autoFilled === '1') {
      montoInput.value = '';
      montoInput.dataset.original = '';
      montoInput.dataset.autoFilled = '0';
    }
    return;
  }
  const renta = state.rentas.find(r => r.id === propId);
  if (!renta) return;
  if (montoInput && !montoInput.value) {
    montoInput.value = renta.monto || '';
    montoInput.dataset.original = renta.monto || '';
    montoInput.dataset.autoFilled = '1';
  }
  const montoInfo = document.getElementById('c-monto-info');
  if (montoInfo) montoInfo.textContent = 'Monto actual en ' + renta.nombre;
}

function checkMontoCambio() {
  const input = document.getElementById('c-monto-renta');
  const wrap  = document.getElementById('c-monto-fecha-wrap');
  if (!input || !wrap) return;
  const nuevo = parseFloat(input.value) || 0;
  const orig  = parseFloat(input.dataset.original || '0');
  // Show date picker only if editing and monto changed
  if (editandoClienteId && orig > 0 && nuevo !== orig) {
    wrap.style.display = '';
    // Default to today
    if (!document.getElementById('c-monto-fecha').value) {
      document.getElementById('c-monto-fecha').value = new Date().toISOString().slice(0,10);
    }
  } else {
    wrap.style.display = 'none';
  }
}

function populatePropiedadSelectCliente() {
  const sel = document.getElementById('c-propiedad');
  if (!sel) return;
  const cur = sel.value;

  if (!state.rentas || state.rentas.length === 0) {
    sel.innerHTML = '<option value="">â€” No hay propiedades registradas â€”</option>';
    return;
  }

  // Separate: available first, then occupied
  const disponibles = state.rentas.filter(r => !r.clienteId || r.clienteId === '' || r.clienteId === editandoClienteId);
  const ocupadas    = state.rentas.filter(r => r.clienteId && r.clienteId !== '' && r.clienteId !== editandoClienteId);

  let opts = '<option value="">â€” Sin propiedad asignada â€”</option>';

  if (disponibles.length) {
    opts += '<optgroup label="âœ… Disponibles">';
    opts += disponibles.map(r =>
      `<option value="${r.id}">${r.nombre}</option>`
    ).join('');
    opts += '</optgroup>';
  }

  if (ocupadas.length) {
    opts += '<optgroup label="ğŸ”’ Ocupadas">';
    opts += ocupadas.map(r => {
      const inq = state.clientes.find(c => c.id === r.clienteId);
      return `<option value="${r.id}" style="color:var(--text3)">${r.nombre} â€” ${inq?.nombre || 'ocupada'}</option>`;
    }).join('');
    opts += '</optgroup>';
  }

  sel.innerHTML = opts;
  if (cur) sel.value = cur;
}

// â”€â”€ Desglose fiscal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleDeudaCliente() {
  var on = document.getElementById('c-tiene-deuda').checked;
  document.getElementById('c-deuda-fields').style.display = on ? '' : 'none';
  if (on) {
    // Auto-calculate monto based on meses Ã— renta
    var monto = parseFloat(document.getElementById('c-monto-renta')?.value) || 0;
    var mesesEl = document.getElementById('c-deuda-meses');
    if (!mesesEl.value) mesesEl.value = 1;
    if (monto > 0) {
      document.getElementById('c-deuda-monto').value = monto * (parseInt(mesesEl.value) || 1);
    }
    mesesEl.oninput = function() {
      var m = parseFloat(document.getElementById('c-monto-renta')?.value) || 0;
      if (m > 0) document.getElementById('c-deuda-monto').value = m * (parseInt(this.value) || 0);
    };
  }
}

// â”€â”€ Concepto de factura â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generarConceptoDefault() {
  var propSel = document.getElementById('c-propiedad');
  var propNombre = '';
  if (propSel && propSel.value) {
    var r = state.rentas.find(function(r2){ return r2.id === propSel.value; });
    if (r) propNombre = r.nombre;
  }
  var periodoTipo = document.getElementById('c-fac-periodo-tipo').value;
  var concepto;
  if (periodoTipo === 'contrato') {
    concepto = 'Renta de ' + (propNombre || '{propiedad}') + ' correspondiente al periodo {periodo} {anio}';
  } else {
    concepto = 'Renta de ' + (propNombre || '{propiedad}') + ' correspondiente al mes de {mes} {anio}';
  }
  document.getElementById('c-fac-concepto').value = concepto;
  generarConceptoPreview();
}

function generarConceptoPreview() {
  var concepto = document.getElementById('c-fac-concepto').value;
  if (!concepto) { document.getElementById('c-fac-concepto-preview').textContent = ''; return; }
  var now = new Date();
  var meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  var propSel = document.getElementById('c-propiedad');
  var propNombre = 'Mi Propiedad';
  var diaCobro = 1;
  if (propSel && propSel.value) {
    var r = state.rentas.find(function(r2){ return r2.id === propSel.value; });
    if (r) { propNombre = r.nombre; diaCobro = parseInt(r.dia) || 1; }
  }
  var periodoTipo = document.getElementById('c-fac-periodo-tipo').value;
  var periodoStr;
  if (periodoTipo === 'contrato') {
    var diaFin = diaCobro - 1; if (diaFin < 1) diaFin = 28;
    var mesSig = now.getMonth() + 1; var anioSig = now.getFullYear();
    if (mesSig > 11) { mesSig = 0; anioSig++; }
    periodoStr = 'del ' + diaCobro + ' de ' + meses[now.getMonth()] + ' al ' + diaFin + ' de ' + meses[mesSig];
  } else {
    periodoStr = meses[now.getMonth()];
  }
  var preview = concepto
    .replace(/\{propiedad\}/g, propNombre)
    .replace(/\{mes\}/g, meses[now.getMonth()])
    .replace(/\{anio\}/g, String(now.getFullYear()))
    .replace(/\{periodo\}/g, periodoStr);
  document.getElementById('c-fac-concepto-preview').textContent = 'ğŸ“„ Preview: ' + preview;
}

function resolverConcepto(plantilla, rentaId, mesKey) {
  if (!plantilla) return '';
  var renta = state.rentas.find(function(r){ return r.id === rentaId; });
  var propNombre = renta ? renta.nombre : 'Propiedad';
  var diaCobro = renta ? (parseInt(renta.dia) || 1) : 1;
  var meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  var parts = (mesKey || '').split('-');
  var mesIdx = parts.length === 2 ? parseInt(parts[1]) - 1 : new Date().getMonth();
  var anio = parts.length === 2 ? parts[0] : String(new Date().getFullYear());
  var mesNom = meses[mesIdx] || '';

  // Periodo por contrato
  var diaFin = diaCobro - 1; if (diaFin < 1) diaFin = 28;
  var mesSigIdx = mesIdx + 1;  var anioSig = parseInt(anio);
  if (mesSigIdx > 11) { mesSigIdx = 0; anioSig++; }
  var periodoStr = 'del ' + diaCobro + ' de ' + mesNom + ' al ' + diaFin + ' de ' + meses[mesSigIdx] + (anioSig !== parseInt(anio) ? ' ' + anioSig : '');

  return plantilla
    .replace(/\{propiedad\}/g, propNombre)
    .replace(/\{mes\}/g, mesNom)
    .replace(/\{anio\}/g, anio)
    .replace(/\{periodo\}/g, periodoStr);
}

function calcDesgloseFromSubtotal() {
  const subtotal = Number(document.getElementById('c-fac-subtotal').value) || 0;
  const ivaPct = 0.16;
  const retIsrPct = Number(document.getElementById('c-fac-ret-isr-pct').value) / 100;
  const retIvaPct = Number(document.getElementById('c-fac-ret-iva-pct').value) / 100;

  const iva = Math.round(subtotal * ivaPct * 100) / 100;
  const retIsr = Math.round(subtotal * retIsrPct * 100) / 100;
  const retIva = Math.round(subtotal * retIvaPct * 100) / 100;
  const neto = Math.round((subtotal + iva - retIsr - retIva) * 100) / 100;

  document.getElementById('c-fac-iva').value = iva.toFixed(2);
  document.getElementById('c-fac-ret-isr').value = retIsr.toFixed(2);
  document.getElementById('c-fac-ret-iva').value = retIva.toFixed(2);
  document.getElementById('c-fac-neto').value = neto;
  document.getElementById('c-fac-neto-display').textContent = fmt(neto);
}

function calcDesglosePreview() {
  // When regimen changes, adjust default retention percentages
  const reg = document.getElementById('c-fac-regimen').value;
  const tipo = document.getElementById('c-fac-tipo')?.value || 'fisica';
  // RESICO â†’ ISR 1.25%, no IVA retention
  if (reg === '625') {
    document.getElementById('c-fac-ret-isr-pct').value = '1.25';
    document.getElementById('c-fac-ret-iva-pct').value = '0';
  } else if (tipo === 'moral') {
    // Moral paying to fisica â†’ standard retentions
    document.getElementById('c-fac-ret-isr-pct').value = '10';
    document.getElementById('c-fac-ret-iva-pct').value = '10.6667';
  } else {
    document.getElementById('c-fac-ret-isr-pct').value = '0';
    document.getElementById('c-fac-ret-iva-pct').value = '0';
  }
  calcDesgloseFromSubtotal();
}

function guardarCliente() {
  if (!hasPerm('cli_write')) return alert('No tienes permiso para modificar clientes.');
  const nombre = document.getElementById('c-nombre').value.trim();
  if (!nombre) return alert('El nombre es obligatorio.');
  // Validar nombre duplicado
  const dupCli = state.clientes.find(c => c.nombre.toLowerCase() === nombre.toLowerCase() && c.id !== editandoClienteId);
  if (dupCli) { if (!confirm('Ya existe un cliente con ese nombre. Â¿Deseas continuar de todas formas?')) return; }
  const factura = document.getElementById('c-factura').checked;
  const clienteData = {
    id: editandoClienteId || uid(),
    nombre,
    tel: document.getElementById('c-tel').value,
    email: document.getElementById('c-email').value,
    foto: document.getElementById('c-foto-data').value || null,
    direccion: document.getElementById('c-direccion').value,
    avalNombre: document.getElementById('c-aval-nombre').value,
    avalTel: document.getElementById('c-aval-tel').value,
    notas:          document.getElementById('c-notas').value,
    whatsapp:       getWaRemindersData(),
    inicioContrato: document.getElementById('c-inicio-contrato')?.value || '',
    finContrato:    document.getElementById('c-fin-contrato')?.value    || '',
    dia:            document.getElementById('c-dia')?.value || '',
    montoRenta:     parseFloat(document.getElementById('c-monto-renta')?.value) || 0,
    docs: _clienteDocs,
    contrato: document.getElementById('c-contrato-data').value || null,
    contratoMeta: (() => { try { return JSON.parse(document.getElementById('c-contrato-meta').value||'null'); } catch(e){ return null; } })(),
    factura,
    facturacion: factura ? {
      tipo: document.getElementById('c-fac-tipo').value,
      rfc: document.getElementById('c-fac-rfc').value,
      razon: document.getElementById('c-fac-razon').value,
      direccion: '',
      cp: document.getElementById('c-fac-cp').value.trim(),
      emailFactura: document.getElementById('c-fac-email').value,
      cfdi: document.getElementById('c-fac-cfdi').value,
      regimen: document.getElementById('c-fac-regimen').value,
      concepto: document.getElementById('c-fac-concepto').value || '',
      periodoTipo: document.getElementById('c-fac-periodo-tipo').value || 'mes',
      predial: (document.getElementById('c-fac-predial').value || '').trim(),
      subtotal: Number(document.getElementById('c-fac-subtotal').value) || 0,
      iva: Number(document.getElementById('c-fac-iva').value) || 0,
      retIsr: Number(document.getElementById('c-fac-ret-isr').value) || 0,
      retIsrPct: Number(document.getElementById('c-fac-ret-isr-pct').value) || 0,
      retIva: Number(document.getElementById('c-fac-ret-iva').value) || 0,
      retIvaPct: Number(document.getElementById('c-fac-ret-iva-pct').value) || 0,
      neto: Number(document.getElementById('c-fac-neto').value) || 0,
    } : null,
    whatsapp: getWaRemindersData(),
  };
  if (editandoClienteId) {
    const idx = state.clientes.findIndex(c => c.id === editandoClienteId);
    if (idx !== -1) state.clientes[idx] = clienteData;
    editandoClienteId = null;
  } else {
    state.clientes.push(clienteData);
  }

  // â”€â”€ Monto del cliente (tiene prioridad sobre el de la propiedad) â”€â”€
  const montoInput  = document.getElementById('c-monto-renta');
  const montoNuevo  = montoInput ? parseFloat(montoInput.value) || 0 : 0;
  const montoOrig   = montoInput ? parseFloat(montoInput.dataset.original || '0') : 0;
  const fechaAplic  = document.getElementById('c-monto-fecha')?.value || new Date().toISOString().slice(0,10);
  clienteData.montoRenta = montoNuevo;

  // â”€â”€ Link client to selected property â”€â”€
  const propSel = document.getElementById('c-propiedad');
  const propId  = propSel ? propSel.value : '';

  // Find property currently linked BEFORE reassignment
  const propAnterior = state.rentas.find(r => r.clienteId === clienteData.id);

  // Remove client from any property previously assigned
  state.rentas.forEach(r => { if (r.clienteId === clienteData.id) r.clienteId = ''; });

  // Determine which property to update
  const rentaTarget = propId
    ? state.rentas.find(r => r.id === propId)   // newly selected property
    : propAnterior;                               // keep current if not changed

  if (rentaTarget) {
    if (propId) rentaTarget.clienteId = clienteData.id;
    // Sync contract dates
    if (clienteData.inicioContrato) rentaTarget.inicio = clienteData.inicioContrato;
    if (clienteData.finContrato)    rentaTarget.fin    = clienteData.finContrato;
    // Sync dia de cobro
    if (clienteData.dia) rentaTarget.dia = clienteData.dia;

    // â”€â”€ Apply monto (client takes priority) â”€â”€
    if (montoNuevo > 0) {
      const montoAnteriorProp = parseFloat(rentaTarget.monto) || 0;
      if (montoNuevo !== montoAnteriorProp) {
        if (!rentaTarget.historialMonto) rentaTarget.historialMonto = [];
        rentaTarget.historialMonto.push({
          montoAnterior: montoAnteriorProp,
          montoNuevo,
          fechaAplic,
          fecha: new Date().toISOString().slice(0,10),
        });
      }
      rentaTarget.monto = montoNuevo;
    }
  } else if (montoNuevo > 0) {
    // Sin propiedad â€” guardar monto solo en cliente para cuando se asigne despuÃ©s
    clienteData.montoRenta = montoNuevo;
  }

  // â”€â”€ Generate auto-abonos for new clients with deuda â”€â”€
  const isNew = !state.clientes.find(c => c.id === clienteData.id && c._altaCompleta);
  const tieneDeuda = document.getElementById('c-tiene-deuda')?.checked;
  if (rentaTarget && tieneDeuda && isNew) {
    const mesesDeuda = parseInt(document.getElementById('c-deuda-meses')?.value) || 0;
    const inicioStr = clienteData.inicioContrato || rentaTarget.inicio;
    const monto = montoNuevo || Number(rentaTarget.monto) || 0;
    if (inicioStr && monto > 0 && mesesDeuda > 0) {
      const inicioD = new Date(inicioStr + 'T12:00:00');
      if (!isNaN(inicioD.getTime())) {
        if (!rentaTarget.abonos) rentaTarget.abonos = [];
        // Calculate how many months from inicio to now
        const hoy = new Date();
        let cursor = new Date(inicioD);
        const mesesTotal = [];
        for (let i = 0; i < 120; i++) {
          const mKey = cursor.getFullYear() + '-' + String(cursor.getMonth()+1).padStart(2,'0');
          const graceDate = new Date(cursor.getFullYear(), cursor.getMonth(), (Number(rentaTarget.dia)||1) + 6);
          if (graceDate > hoy) break;
          mesesTotal.push(mKey);
          cursor.setMonth(cursor.getMonth() + 1);
        }
        // Months to auto-pay = total periods minus deuda months (the unpaid ones)
        const mesesPagados = mesesTotal.slice(0, Math.max(0, mesesTotal.length - mesesDeuda));
        mesesPagados.forEach(function(mesKey) {
          const dia = Number(rentaTarget.dia) || 1;
          const fechaPago = mesKey + '-' + String(Math.min(dia, 28)).padStart(2,'0');
          rentaTarget.abonos.push({
            id: uid(),
            monto: monto,
            fecha: fechaPago,
            metodo: 'Alta automÃ¡tica',
            formaPagoId: '',
            mes: mesKey,
            nota: 'âœ… Generado al dar de alta al cliente',
          });
        });
        clienteData._altaCompleta = true;
        if (mesesPagados.length > 0) {
          showToast('âœ… ' + mesesPagados.length + ' abono' + (mesesPagados.length > 1 ? 's' : '') + ' generado' + (mesesPagados.length > 1 ? 's' : '') + ' automÃ¡ticamente');
        }
      }
    }
  }

  save();
  showToast('âœ… Cliente guardado');
  closeModal('modalCliente');
  clearClienteForm();
  render();
  // Si se editÃ³ desde detalle-cliente, regresar al detalle
  if (clienteData.id && currentClienteId === clienteData.id) {
    nav('detalle-cliente');
    setMobileNav('detalle-cliente');
  }
}

let editandoClienteId = null;
let _skipClearCliente = false;

function editarCliente(id) {
  const c = state.clientes.find(c => c.id === id);
  if (!c) { alert('Cliente no encontrado'); return; }

  
  // Clear form completely first to avoid stale data
  clearClienteForm();
  
  editandoClienteId = id;
  document.getElementById('c-nombre').value = c.nombre;
  document.getElementById('c-tel').value = c.tel||'';
  document.getElementById('c-email').value = c.email||'';
  document.getElementById('c-notas').value = c.notas||'';
  // Load WhatsApp reminder config
  loadWaReminders(c.whatsapp);
  if (document.getElementById('c-dia')) document.getElementById('c-dia').value = c.dia||'';
  if (document.getElementById('c-inicio-contrato')) document.getElementById('c-inicio-contrato').value = c.inicioContrato||'';
  if (document.getElementById('c-fin-contrato'))    document.getElementById('c-fin-contrato').value    = c.finContrato||'';
  // Load current rent from linked property
  const propVinc = state.rentas.find(r => r.clienteId === id);
  const montoActual = propVinc ? (propVinc.monto || '') : (c.montoRenta || '');
  const montoInput = document.getElementById('c-monto-renta');
  if (montoInput) {
    montoInput.value = montoActual;
    montoInput.dataset.original = montoActual;
  }
  const montoInfo = document.getElementById('c-monto-info');
  if (montoInfo && propVinc) montoInfo.textContent = 'Monto actual en ' + propVinc.nombre;
  const fechaWrap = document.getElementById('c-monto-fecha-wrap');
  if (fechaWrap) fechaWrap.style.display = 'none';
  // nacimiento field removed
  document.getElementById('c-direccion').value = c.direccion||'';
  document.getElementById('c-aval-nombre').value = c.avalNombre||'';
  document.getElementById('c-aval-tel').value = c.avalTel||'';
  // Foto
  const fotoData = c.foto||'';
  document.getElementById('c-foto-data').value = fotoData;
  const fotoPreview = document.getElementById('c-foto-preview');
  if (fotoData) {
    fotoPreview.innerHTML = `<img src="${fotoData}" class="foto-avatar" />`;
  } else {
    fotoPreview.textContent = 'ğŸ‘¤';
  }
  // Docs
  _clienteDocs = c.docs ? [...c.docs] : [];
  renderDocsTab();
  setToggleFactura(c.factura || false);
  document.querySelector('#modalCliente .modal-title').textContent = 'Editar Cliente';
  // Restore contrato archivo
  const contratoB64 = c.contrato || '';
  const contratoMeta = c.contratoMeta || {};
  document.getElementById('c-contrato-data').value = contratoB64;
  document.getElementById('c-contrato-meta').value = contratoB64 ? JSON.stringify(contratoMeta) : '';
  mostrarContratoPreview(contratoB64, contratoMeta.name, contratoMeta.size, contratoMeta.type);
  switchClienteTab('datos');
  // Encontrar propiedad vinculada ANTES de abrir el modal
  const propVincId = (state.rentas.find(r => r.clienteId === id) || {}).id || '';
  openModal('modalCliente');
  
  // Populate facturacion AFTER modal is open to ensure DOM elements are accessible
  if (c.factura && c.facturacion) {
  
    setToggleFactura(true);
    document.getElementById('c-fac-tipo').value = c.facturacion.tipo||'fisica';
    document.getElementById('c-fac-rfc').value = c.facturacion.rfc||'';
    document.getElementById('c-fac-razon').value = c.facturacion.razon||'';
    document.getElementById('c-fac-cp').value = c.facturacion.cp || c.facturacion.direccion || '';
    document.getElementById('c-fac-email').value = c.facturacion.emailFactura||'';
    document.getElementById('c-fac-cfdi').value = c.facturacion.cfdi||'G03';
    document.getElementById('c-fac-regimen').value = c.facturacion.regimen||'612';
    if (c.facturacion.subtotal) {
      document.getElementById('c-fac-subtotal').value = c.facturacion.subtotal;
      document.getElementById('c-fac-ret-isr-pct').value = c.facturacion.retIsrPct || 0;
      document.getElementById('c-fac-ret-iva-pct').value = c.facturacion.retIvaPct || 0;
      calcDesgloseFromSubtotal();
    }
    // Concepto â€” only generate default if empty
    document.getElementById('c-fac-periodo-tipo').value = c.facturacion.periodoTipo || 'mes';
    document.getElementById('c-fac-concepto').value = c.facturacion.concepto || '';
    document.getElementById('c-fac-predial').value = c.facturacion.predial || '';
    if (!c.facturacion.concepto) {
      // Delay to allow property select to populate first
      setTimeout(function(){ generarConceptoDefault(); }, 100);
    }
    generarConceptoPreview();
  
  }
  // Poblar y seleccionar propiedad DESPUÃ‰S de que el modal abre
  setTimeout(() => {
    populatePropiedadSelectCliente();
    const sel = document.getElementById('c-propiedad');
    if (sel && propVincId) {
      sel.value = propVincId;
      // Actualizar info del monto
      const rVinc = state.rentas.find(r => r.id === propVincId);
      const montoInfo = document.getElementById('c-monto-info');
      if (montoInfo && rVinc) montoInfo.textContent = 'Monto actual en ' + rVinc.nombre;
    }
  }, 50);
}

function eliminarCliente(id, silent=false) {
  if (!silent && !confirm('Â¿Eliminar este cliente?')) return;
  state.clientes = state.clientes.filter(c => c.id !== id);
  save();
  render();
}

function populateClienteSelect() {
  const sel = document.getElementById('r-cliente');
  sel.innerHTML = '<option value="">â€” Sin asignar â€”</option>' +
    state.clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
  sel.onchange = onClienteSelectChange;
}

function populateFormaPagoSelectRenta(selected) {
  // r-forma-pago was removed from property modal â€” no-op
}

function populateFormaPagoSelectAbono() {
  const sel = document.getElementById('a-metodo');
  if (!sel) return;
  sel.innerHTML = state.formasPago.map(f =>
    `<option value="${f.id}">${f.icono?f.icono+' ':''}${f.nombre}</option>`
  ).join('');
  if (currentRentaId) {
    const renta = state.rentas.find(r => r.id === currentRentaId);
    if (renta && renta.formaPagoId) sel.value = renta.formaPagoId;
  }
}

// ============================================================
// CRUD FORMAS DE PAGO
// ============================================================
let editandoFpId = null;

function guardarFormaPago() {
  const nombre = document.getElementById('fp-nombre').value.trim();
  if (!nombre) return alert('El nombre es obligatorio.');
  const fp = {
    id: editandoFpId || uid(),
    nombre,
    icono: document.getElementById('fp-icono').value.trim(),
    desc: document.getElementById('fp-desc').value.trim(),
    editable: true,
  };
  if (editandoFpId) {
    const idx = state.formasPago.findIndex(f => f.id === editandoFpId);
    if (idx !== -1) state.formasPago[idx] = fp;
    editandoFpId = null;
  } else {
    state.formasPago.push(fp);
  }
  save();
  closeModal('modalFormaPago');
  clearFpForm();
  render();
}

function editarFormaPago(id) {
  if (currentUser && currentUser.role !== 'titular') return alert('Solo el titular puede modificar la configuraciÃ³n.');
  const fp = state.formasPago.find(f => f.id === id);
  editandoFpId = id;
  document.getElementById('fp-nombre').value = fp.nombre;
  document.getElementById('fp-icono').value = fp.icono||'';
  document.getElementById('fp-desc').value = fp.desc||'';
  document.getElementById('fp-modal-title').textContent = 'Editar Forma de Pago';
  openModal('modalFormaPago');
}

function eliminarFormaPago(id) {
  if (currentUser && currentUser.role !== 'titular') return alert('Solo el titular puede modificar la configuraciÃ³n.');
  if (!confirm('Esta forma de pago se eliminarÃ¡. Â¿Continuar?')) return;
  state.formasPago = state.formasPago.filter(f => f.id !== id);
  save();
  render();
}

function clearFpForm() {
  ['fp-nombre','fp-icono','fp-desc'].forEach(i => { const el=document.getElementById(i); if(el) el.value=''; });
  document.getElementById('fp-modal-title').textContent = 'Nueva Forma de Pago';
  editandoFpId = null;
}

function renderPagos() {
  const el = document.getElementById('pagos-list');
  if (!el) return;
  el.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px">` +
    state.formasPago.map(fp => `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:26px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--surface2);border-radius:10px">${fp.icono||'ğŸ’³'}</div>
          <div>
            <div style="font-weight:600;font-size:15px">${fp.nombre}</div>
            ${!fp.editable ? '<div><span class="tag" style="margin-top:4px">Predeterminada</span></div>' : ''}
          </div>
        </div>
        ${fp.desc ? `<div style="font-size:12px;color:var(--text2);background:var(--surface2);border-radius:8px;padding:10px;white-space:pre-line;line-height:1.6">${fp.desc}</div>` : ''}
        <div style="display:flex;gap:8px;margin-top:4px">
          <button class="btn btn-ghost" style="font-size:11px;padding:5px 10px;flex:1" onclick="editarFormaPago('${fp.id}')">âœï¸ Editar</button>
          ${fp.editable ? `<button class="btn btn-danger" style="font-size:11px;padding:5px 10px" onclick="eliminarFormaPago('${fp.id}')">ğŸ—‘ï¸</button>` : ''}
        </div>
      </div>`
    ).join('') + '</div>';
}
// ============================================================
// CONFIGURACIÃ“N â€” CATÃLOGOS
// ============================================================
function renderConfig() {
  const _isTitular = !currentUser || currentUser.role === 'titular';
  renderUsuarios();
  // Load fiscal config if available
  if (typeof cargarFiscalDesdeFirebase === 'function' && state.fiscalConfig) cargarFiscalDesdeFirebase();
  // Tipos de gasto
  const elG = document.getElementById('cfg-tipos-gasto');
  if (elG) elG.innerHTML = (state.tiposGasto||[]).map(t => `
    <div class="config-tag">
      <span>${t}</span>
      <button class="tag-del" onclick="delCfgItem('tiposGasto','${t.replace(/'/g,"\\'")}')">Ã—</button>
    </div>`).join('') || '<span style="font-size:13px;color:var(--text3)">Sin categorÃ­as</span>';

  // Tipos de propiedad
  const elP = document.getElementById('cfg-tipos-prop');
  if (elP) elP.innerHTML = (state.tiposProp||[]).map(t => `
    <div class="config-tag">
      <span>${t}</span>
      <button class="tag-del" onclick="delCfgItem('tiposProp','${t.replace(/'/g,"\\'")}')">Ã—</button>
    </div>`).join('') || '<span style="font-size:13px;color:var(--text3)">Sin tipos</span>';

  renderPagos();

  // Load dias de gracia value
  const cfgData = state.configuracion || {};
  const diasEl = document.getElementById('cfg-gracia-dias');
  if (diasEl && cfgData.diasGracia) diasEl.value = cfgData.diasGracia;
  loadGlobalWaToggle();

  // Hide all edit controls in config for non-titular
  if (!_isTitular) {
    document.querySelectorAll('#page-pagos .config-add-row').forEach(el => el.style.display = 'none');
    document.querySelectorAll('#page-pagos [onclick*="guardarDiasGracia"]').forEach(el => el.style.display = 'none');
    // Disable inputs
    document.querySelectorAll('#page-pagos input[type="number"]').forEach(el => el.disabled = true);
  }
}

function addCfgItem(key, inputId) {
  if (currentUser && currentUser.role !== 'titular') return alert('Solo el titular puede modificar la configuraciÃ³n.');
  const el = document.getElementById(inputId);
  const val = el.value.trim();
  if (!val) return;
  if (!state[key]) state[key] = [];
  if (state[key].includes(val)) { el.value=''; return; }
  state[key].push(val);
  save();
  el.value = '';
  renderConfig();
}

function delCfgItem(key, val) {
  if (currentUser && currentUser.role !== 'titular') return alert('Solo el titular puede modificar la configuraciÃ³n.');
  if (!confirm('Â¿Eliminar "' + val + '"?')) return;
  state[key] = (state[key]||[]).filter(t => t !== val);
  save();
  renderConfig();
}

// ============================================================
// GASTOS DE PROPIEDADES
// ============================================================
function openModalGasto() {
  // Populate tipo select
  const tipoSel = document.getElementById('g-tipo');
  tipoSel.innerHTML = (state.tiposGasto||DEFAULT_TIPOS_GASTO).map(t =>
    `<option value="${t}">${t}</option>`).join('');

  // Populate forma pago select
  const fpSel = document.getElementById('g-fp');
  fpSel.innerHTML = '<option value="">â€” Sin especificar â€”</option>' +
    state.formasPago.map(f => `<option value="${f.nombre}">${f.icono||''} ${f.nombre}</option>`).join('');

  // Default date to today
  document.getElementById('g-fecha').value = new Date().toISOString().slice(0,10);
  document.getElementById('g-monto').value = '';
  document.getElementById('g-desc').value = '';
  openModal('modalGasto');
}

function guardarGasto() {
  const monto = document.getElementById('g-monto').value;
  if (!monto || Number(monto) <= 0) return alert('Ingresa un monto vÃ¡lido.');
  const renta = state.rentas.find(r => r.id === currentRentaId);
  if (!renta) return;
  if (!renta.gastos) renta.gastos = [];
  renta.gastos.push({
    id: uid(),
    tipo:      document.getElementById('g-tipo').value,
    monto:     Number(monto),
    fecha:     document.getElementById('g-fecha').value || new Date().toISOString().slice(0,10),
    formaPago: document.getElementById('g-fp').value,
    desc:      document.getElementById('g-desc').value.trim(),
  });
  save();
  closeModal('modalGasto');
  render();
}

function eliminarGasto(rentaId, gastoId) {
  if (!confirm('Â¿Eliminar este gasto?')) return;
  const renta = state.rentas.find(r => r.id === rentaId);
  if (renta) renta.gastos = (renta.gastos||[]).filter(g => g.id !== gastoId);
  save();
  render();
}

// ============================================================
// ABONOS
// ============================================================
// â”€â”€ Abono quick fill (for clients with factura desglose) â”€â”€
let _abonoQuickMeses = 0;
let _abonoQuickData = null; // {subtotal, iva, retIsr, retIva, neto, monto}

function initAbonoQuickFill() {
  _abonoQuickMeses = 0;
  _abonoQuickData = null;
  const panel = document.getElementById('abono-quick-fill');
  if (!panel) return;

  // Get current renta and linked client
  const renta = state.rentas.find(r => r.id === currentRentaId);
  if (!renta || !renta.clienteId) { panel.style.display = 'none'; return; }
  const cliente = state.clientes.find(c => c.id === renta.clienteId);
  if (!cliente) { panel.style.display = 'none'; return; }

  const monto = Number(renta.monto) || 0;
  if (!monto) { panel.style.display = 'none'; return; }

  // Check if client has factura with desglose
  if (cliente.factura && cliente.facturacion && cliente.facturacion.neto > 0) {
    _abonoQuickData = {
      subtotal: cliente.facturacion.subtotal,
      iva: cliente.facturacion.iva,
      retIsr: cliente.facturacion.retIsr,
      retIva: cliente.facturacion.retIva,
      neto: cliente.facturacion.neto,
      monto: monto,
      hasDesglose: true
    };
  } else {
    // No desglose, just use renta monto
    _abonoQuickData = {
      subtotal: monto, iva: 0, retIsr: 0, retIva: 0, neto: monto, monto: monto,
      hasDesglose: false
    };
  }

  panel.style.display = 'block';
  _abonoQuickMeses = 0;
  abonoQuickMeses(1); // Start at 1 month
}

function abonoQuickMeses(delta) {
  if (!_abonoQuickData) return;
  _abonoQuickMeses = Math.max(1, _abonoQuickMeses + delta);
  const m = _abonoQuickMeses;
  const d = _abonoQuickData;

  const totalNeto = Math.round(d.neto * m * 100) / 100;
  document.getElementById('a-monto').value = totalNeto;
  document.getElementById('abono-quick-meses').textContent = m + ' mes' + (m > 1 ? 'es' : '');

  // Show desglose
  const el = document.getElementById('abono-quick-desglose');
  if (d.hasDesglose) {
    el.innerHTML =
      `<div style="display:grid;grid-template-columns:1fr auto;gap:2px 12px">` +
      `<span>Subtotal:</span><span style="text-align:right;font-family:'DM Mono',monospace">${fmt(d.subtotal * m)}</span>` +
      `<span>+ IVA (16%):</span><span style="text-align:right;font-family:'DM Mono',monospace">${fmt(d.iva * m)}</span>` +
      (d.retIsr > 0 ? `<span>âˆ’ Ret. ISR:</span><span style="text-align:right;font-family:'DM Mono',monospace;color:var(--danger)">-${fmt(d.retIsr * m)}</span>` : '') +
      (d.retIva > 0 ? `<span>âˆ’ Ret. IVA:</span><span style="text-align:right;font-family:'DM Mono',monospace;color:var(--danger)">-${fmt(d.retIva * m)}</span>` : '') +
      `<span style="font-weight:700;border-top:1px solid var(--border);padding-top:4px;margin-top:4px">Neto a depositar:</span>` +
      `<span style="text-align:right;font-family:'DM Mono',monospace;font-weight:800;color:var(--accent);border-top:1px solid var(--border);padding-top:4px;margin-top:4px">${fmt(totalNeto)}</span>` +
      `</div>`;
  } else {
    el.innerHTML = `<span style="font-weight:600">Renta: ${fmt(d.monto)}/mes Ã— ${m} = </span><span style="font-family:'DM Mono',monospace;font-weight:800;color:var(--accent)">${fmt(totalNeto)}</span>`;
  }

  // Auto-fill nota
  document.getElementById('a-nota').value = m > 1 ? `Pago de ${m} meses` : 'Pago de renta mensual';
}

// â”€â”€ Comprobante helpers â”€â”€
let _comprobanteBase64 = null;
const COMPROBANTE_MAX_W = 800;
const COMPROBANTE_QUALITY = 0.5;

function onComprobanteSelected(input) {
  const file = input.files && input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > COMPROBANTE_MAX_W) { h = Math.round(h * COMPROBANTE_MAX_W / w); w = COMPROBANTE_MAX_W; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      _comprobanteBase64 = canvas.toDataURL('image/jpeg', COMPROBANTE_QUALITY);
      document.getElementById('a-comprobante-img').src = _comprobanteBase64;
      document.getElementById('a-comprobante-preview').style.display = 'inline-block';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function clearComprobanteInput() {
  _comprobanteBase64 = null;
  document.getElementById('a-comprobante-preview').style.display = 'none';
  document.getElementById('a-comprobante-file').value = '';
  document.getElementById('a-comprobante-camera').value = '';
}

function verComprobanteTemp() {
  if (!_comprobanteBase64) return;
  document.getElementById('comprobante-viewer-img').src = _comprobanteBase64;
  document.getElementById('comprobante-info').textContent = '';
  openModal('modalComprobante');
}

function verComprobante(rentaId, abonoId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  const abono = (renta.abonos||[]).find(a => a.id === abonoId);
  if (!abono || !abono.comprobante) return alert('Este abono no tiene comprobante adjunto.');
  document.getElementById('comprobante-viewer-img').src = abono.comprobante;
  document.getElementById('comprobante-info').textContent =
    (renta.nombre || 'Propiedad') + ' â€” ' + fmtDate(abono.fecha) + ' â€” ' + fmt(abono.monto);
  window._comprobanteActual = abono.comprobante;
  openModal('modalComprobante');
}

function descargarComprobante() {
  const src = window._comprobanteActual || document.getElementById('comprobante-viewer-img').src;
  if (!src) return;
  const a = document.createElement('a');
  a.href = src;
  a.download = 'comprobante_' + new Date().toISOString().slice(0,10) + '.jpg';
  a.click();
}

function guardarAbono() {
  if (!hasPerm('abono_write')) return alert('No tienes permiso para registrar abonos.');
  const monto = Number(document.getElementById('a-monto').value);
  if (!monto || monto <= 0) return alert('Ingresa un monto vÃ¡lido.');
  const renta = state.rentas.find(r => r.id === currentRentaId);
  if (!renta) return alert('Propiedad no encontrada.');
  if (!renta.abonos) renta.abonos = [];
  const fpId = document.getElementById('a-metodo').value;
  const fp = state.formasPago.find(f => f.id === fpId);
  const abono = {
    id: uid(),
    monto,
    fecha: document.getElementById('a-fecha').value || new Date().toISOString().slice(0,10),
    metodo: fp ? ((fp.icono ? fp.icono + ' ' : '') + fp.nombre) : fpId,
    formaPagoId: fpId,
    mes: document.getElementById('a-mes').value,
    nota: document.getElementById('a-nota').value,
  };
  if (_comprobanteBase64) abono.comprobante = _comprobanteBase64;
  renta.abonos.push(abono);
  save();
  closeModal('modalAbono');
  document.getElementById('a-monto').value = '';
  document.getElementById('a-nota').value = '';
  clearComprobanteInput();
  render();
  showToast('âœ… Abono registrado');
}

function eliminarAbono(rentaId, abonoId) {
  if (!hasPerm('abono_delete')) return alert('No tienes permiso para eliminar abonos.');
  if (!confirm('Â¿Eliminar este abono?')) return;
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  renta.abonos = (renta.abonos||[]).filter(a => a.id !== abonoId);
  save();
  render();
}

let _contratoRapidoClienteId = null;
function verContratoRapido(clienteId) {
  const c = state.clientes.find(x => x.id === clienteId);
  if (!c || !c.contrato) return;
  _contratoRapidoClienteId = clienteId;
  const meta = c.contratoMeta || {};
  const b64 = c.contrato;
  const isPdf = (meta.type||'').includes('pdf') || (meta.name||'').toLowerCase().endsWith('.pdf');
  const isImg = (meta.type||'').startsWith('image') || /\.(jpg|jpeg|png|webp)$/i.test(meta.name||'');
  document.getElementById('modal-contrato-nombre').textContent = 'ğŸ“„ ' + (meta.name || 'Contrato') + ' â€” ' + c.nombre;
  const imgEl = document.getElementById('modal-contrato-img');
  const pdfEl = document.getElementById('modal-contrato-pdf');
  const ph    = document.getElementById('modal-contrato-placeholder');
  imgEl.style.display = 'none'; pdfEl.style.display = 'none'; ph.style.display = 'none';
  if (isImg) { imgEl.src = b64; imgEl.style.display = 'block'; }
  else if (isPdf) { pdfEl.src = b64; pdfEl.style.display = 'block'; }
  else { ph.style.display = ''; }
  openModal('modalContratoRapido');
}
function descargarContratoRapido() {
  const c = state.clientes.find(x => x.id === _contratoRapidoClienteId);
  if (!c || !c.contrato) return;
  const a = document.createElement('a');
  a.href = c.contrato;
  a.download = (c.contratoMeta||{}).name || 'contrato';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function editarClienteDesdeContrato() {
  closeModal('modalContratoRapido');
  if (_contratoRapidoClienteId) {
    editarCliente(_contratoRapidoClienteId);
    setTimeout(() => switchClienteTab('contrato'), 100);
  }
}

// ============================================================
// IMPORTACION DESDE EXCEL
// ============================================================
let importTipo = null; // 'propiedades' | 'clientes'
let importPreviewData = [];

function triggerImport(tipo) {
  importTipo = tipo;
  importPreviewData = [];
  document.getElementById('import-title').textContent =
    tipo === 'propiedades' ? 'ğŸ“¥ Importar Propiedades desde Excel' : 'ğŸ“¥ Importar Clientes desde Excel';
  document.getElementById('dl-template-label').textContent =
    tipo === 'propiedades' ? 'Descargar plantilla de Propiedades' : 'Descargar plantilla de Clientes';
  document.getElementById('import-step-1').style.display = '';
  document.getElementById('import-step-2').style.display = 'none';
  document.getElementById('import-confirm-btn').style.display = 'none';
  document.getElementById('import-file-input').value = '';
  openModal('modalImport');
}

function resetImport() {
  closeModal('modalImport');
  importTipo = null;
  importPreviewData = [];
}

function descargarPlantilla(e) {
  e.preventDefault();
  if (!window.XLSX) {
    loadSheetJS(() => descargarPlantilla(e));
    alert('Cargando librerÃ­a, intenta en 3 segundos...');
    return;
  }
  const wb = XLSX.utils.book_new();
  if (importTipo === 'propiedades') {
    // Instructions sheet
    const instrWs = XLSX.utils.aoa_to_sheet([
      ['ğŸ“‹ Instrucciones para importar propiedades'],
      [''],
      ['1. Ve a la hoja "Propiedades" y llena los datos'],
      ['2. Los campos obligatorios son: Nombre de propiedad y Monto de renta'],
      ['3. Los demÃ¡s campos son opcionales'],
      ['4. No modifiques la fila de encabezados (fila 3)'],
      ['5. Llena los datos a partir de la fila 5'],
      ['6. La fila 4 es un ejemplo, puedes borrarla'],
    ]);
    XLSX.utils.book_append_sheet(wb, instrWs, 'Instrucciones');
    // Data sheet
    const headers = ['Nombre de propiedad', 'Monto de renta', 'Tipo', 'Cliente / Inquilino', 'DÃ­a de cobro', 'Forma de pago', 'Notas'];
    const example = ['Depto 101 - Centro', '8500', 'Departamento', 'Juan PÃ©rez', '5', 'Transferencia', 'Piso 3, interior'];
    const ws = XLSX.utils.aoa_to_sheet([
      ['PLANTILLA DE PROPIEDADES â€” GestorRenta'],
      ['Obligatorios: Nombre y Monto. Los demÃ¡s son opcionales. Llena desde fila 5.'],
      headers,
      example,
    ]);
    ws['!cols'] = headers.map(() => ({wch: 22}));
    XLSX.utils.book_append_sheet(wb, ws, 'Propiedades');
    XLSX.writeFile(wb, 'plantilla_propiedades.xlsx');
  } else {
    const instrWs = XLSX.utils.aoa_to_sheet([
      ['ğŸ“‹ Instrucciones para importar clientes'],
      [''],
      ['1. Ve a la hoja "Clientes" y llena los datos'],
      ['2. El campo obligatorio es: Nombre del cliente'],
      ['3. Los demÃ¡s campos son opcionales'],
      ['4. Llena los datos a partir de la fila 5'],
    ]);
    XLSX.utils.book_append_sheet(wb, instrWs, 'Instrucciones');
    const headers = ['Nombre del cliente', 'TelÃ©fono', 'Email', 'Propiedad', 'Monto renta', 'DÃ­a de cobro', 'Inicio contrato', 'Fin contrato', 'Notas'];
    const example = ['Juan PÃ©rez', '614-555-1234', 'juan@mail.com', 'Depto 101', '8500', '5', '2025-01-01', '2026-01-01', 'Buen inquilino'];
    const ws = XLSX.utils.aoa_to_sheet([
      ['PLANTILLA DE CLIENTES â€” GestorRenta'],
      ['Llena los datos a partir de la fila 5. No borres los encabezados.'],
      headers,
      example,
    ]);
    ws['!cols'] = headers.map(() => ({wch: 20}));
    XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
    XLSX.writeFile(wb, 'plantilla_clientes.xlsx');
  }
}

function handleImportDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (file) handleImportFile(file);
}

function handleImportFile(file) {
  if (!file) return;
  if (!window.XLSX) {
    loadSheetJS(() => handleImportFile(file));
    document.getElementById('import-drop').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3)">â³ Cargando lector de Excel...</div>';
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, {type:'array'});
      // Find the right sheet (first non-Instrucciones sheet)
      const sheetName = wb.SheetNames.find(n => !n.toLowerCase().includes('instruc')) || wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      // Read from row 4 onwards (row 3 = headers, row 4 = example, row 5+ = data)
      // We read headers from row 3, data from row 5
      const raw = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
      const headerRow = raw[2]; // row index 2 = Excel row 3
      // Find example row (row 4, index 3) â€” skip it, use from index 4
      const dataRows = raw.slice(4).filter(r => r.some(c => c !== '' && c !== null && c !== undefined));
      
      if (!headerRow || dataRows.length === 0) {
        showImportError('No se encontraron datos. AsegÃºrate de usar la plantilla oficial y de llenar los datos desde la fila 5.');
        return;
      }

      const parsed = importTipo === 'propiedades'
        ? parsePropiedadesRows(headerRow, dataRows)
        : parseClientesRows(headerRow, dataRows);

      importPreviewData = parsed.rows;
      showImportPreview(file.name, parsed);
    } catch(err) {
      showImportError('Error al leer el archivo: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function colIdx(headers, ...names) {
  for (const n of names) {
    const i = headers.findIndex(h => h && h.toString().toLowerCase().replace(/[^a-z0-9]/g,'').includes(n.replace(/[^a-z0-9]/g,'')));
    if (i >= 0) return i;
  }
  return -1;
}

function parsePropiedadesRows(headers, rows) {
  const iNombre   = colIdx(headers, 'nombre', 'direccion', 'propiedad');
  const iMonto    = colIdx(headers, 'monto', 'mensual', 'renta');
  const iTipo     = colIdx(headers, 'tipo');
  const iCliente  = colIdx(headers, 'cliente', 'inquilino');
  const iDia      = colIdx(headers, 'dia', 'cobro');
  const iFP       = colIdx(headers, 'forma', 'pago', 'metodo');
  const iNotas    = colIdx(headers, 'notas', 'observ');

  const result = [], errors = [], warnings = [];
  rows.forEach((row, ri) => {
    const nombre = (row[iNombre] || '').toString().trim();
    const monto  = parseFloat(row[iMonto]);
    if (!nombre) { errors.push(`Fila ${ri+5}: falta el nombre de la propiedad`); return; }
    if (isNaN(monto) || monto <= 0) { errors.push(`Fila ${ri+5} (${nombre}): monto invÃ¡lido`); return; }
    // Buscar cliente
    const cliente = iCliente >= 0 ? (row[iCliente]||'').toString().trim() : '';
    const clienteEncontrado = cliente ? state.clientes.find(c => c.nombre.toLowerCase() === cliente.toLowerCase()) : null;
    if (cliente && !clienteEncontrado) warnings.push(`Fila ${ri+5}: cliente "${cliente}" no existe â€” se importarÃ¡ sin cliente`);
    // Buscar forma de pago
    const fpText = iFP >= 0 ? (row[iFP]||'').toString().trim() : '';
    const fpMatch = fpText ? state.formasPago.find(f => f.nombre.toLowerCase() === fpText.toLowerCase()) : null;
    if (fpText && !fpMatch) warnings.push(`Fila ${ri+5}: forma de pago "${fpText}" no existe â€” se ignorarÃ¡`);
    // Dia de cobro
    const dia = iDia >= 0 ? (parseInt(row[iDia]) || '') : '';

    result.push({
      nombre,
      tipo: iTipo >= 0 ? ((row[iTipo]||'Otro').toString().trim() || 'Otro') : 'Otro',
      clienteId: clienteEncontrado ? clienteEncontrado.id : '',
      clienteNombre: cliente,
      monto: monto.toString(),
      dia: dia ? dia.toString() : '',
      formaPago: fpText,
      formaPagoId: fpMatch ? fpMatch.id : '',
      notas: iNotas >= 0 ? (row[iNotas]||'').toString().trim() : '',
      servicios: [],
      predialCuenta: '',
    });
  });
  return {rows: result, errors, warnings};
}

function parseClientesRows(headers, rows) {
  const iNombre     = colIdx(headers, 'nombre', 'completo');
  const iPropiedad  = colIdx(headers, 'propiedad', 'renta');
  const iMontoRenta = colIdx(headers, 'monto');
  const iTel        = colIdx(headers, 'tel', 'telefono', 'phone');
  const iEmail      = colIdx(headers, 'correo', 'email');
  const iInicio     = colIdx(headers, 'inicio', 'contrato');
  const iDia        = colIdx(headers, 'dia', 'cobro');
  const iFin        = colIdx(headers, 'fin', 'terminacion');
  const iFormaPago  = colIdx(headers, 'forma', 'pago', 'metodo');
  const iIncremento = colIdx(headers, 'incremento', 'aumento');
  const iNotas      = colIdx(headers, 'notas');
  const iFactura    = colIdx(headers, 'factura', 'requiere');
  const iFTipo      = colIdx(headers, 'tipo', 'persona');
  const iFRFC       = colIdx(headers, 'rfc');
  const iFRazon     = colIdx(headers, 'razon', 'social');
  const iFDir       = colIdx(headers, 'direccion', 'fiscal');
  const iFEmail     = colIdx(headers, 'fac_email', 'facturacion');
  const iFCfdi      = colIdx(headers, 'cfdi');
  const iFReg       = colIdx(headers, 'regimen');

  const result = [], errors = [], warnings = [];
  rows.forEach((row, ri) => {
    const nombre = (row[iNombre]||'').toString().trim();
    if (!nombre) { errors.push(`Fila ${ri+5}: falta el nombre del cliente`); return; }
    const facturaVal = (row[iFactura]||'').toString().trim().toLowerCase();
    const factura = facturaVal === 'si' || facturaVal === 'sÃ­' || facturaVal === 'yes' || facturaVal === '1' || facturaVal === 'true';
    result.push({
      nombre,
      tel: (row[iTel]||'').toString().trim(),
      email: (row[iEmail]||'').toString().trim(),
      propiedadNombre: iPropiedad >= 0 ? (row[iPropiedad]||'').toString().trim() : '',
      montoRenta: iMontoRenta >= 0 ? (row[iMontoRenta]||'').toString().trim() : '',
      inicioContrato: parseExcelDate(row[iInicio]) || '',
      diaCobro: iDia >= 0 ? (row[iDia]||'').toString().trim() || '1' : '1',
      finContrato: parseExcelDate(row[iFin]) || '',
      formaPago: iFormaPago >= 0 ? (row[iFormaPago]||'').toString().trim() : '',
      fechaIncremento: parseExcelDate(row[iIncremento]) || '',
      notas: (row[iNotas]||'').toString().trim(),
      factura,
      facturacion: factura ? {
        tipo: (row[iFTipo]||'fisica').toString().trim().toLowerCase() || 'fisica',
        rfc: (row[iFRFC]||'').toString().trim().toUpperCase(),
        razon: (row[iFRazon]||'').toString().trim(),
        direccion: (row[iFDir]||'').toString().trim(),
        emailFactura: (row[iFEmail]||'').toString().trim(),
        cfdi: (row[iFCfdi]||'G03').toString().trim(),
        regimen: (row[iFReg]||'612').toString().trim(),
      } : null,
    });
  });
  return {rows: result, errors, warnings};
}

function parseExcelDate(val) {
  if (!val) return '';
  // If it's already YYYY-MM-DD
  if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) return val.slice(0,10);
  // If it's a number (Excel serial date)
  if (typeof val === 'number') {
    const d = XLSX.SSF.parse_date_code(val);
    if (d) return `${d.y}-${String(d.m).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`;
  }
  return '';
}

function showImportError(msg) {
  document.getElementById('import-step-2').style.display = '';
  document.getElementById('import-preview').innerHTML = '';
  const el = document.getElementById('import-errors');
  el.style.display = ''; el.textContent = 'â›” ' + msg;
  document.getElementById('import-warnings').style.display = 'none';
  document.getElementById('import-confirm-btn').style.display = 'none';
}

function showImportPreview(filename, parsed) {
  document.getElementById('import-step-1').style.display = 'none';
  document.getElementById('import-step-2').style.display = '';
  document.getElementById('import-filename').textContent = filename;
  document.getElementById('import-rowcount').textContent =
    `${parsed.rows.length} registro${parsed.rows.length!==1?'s':''} listos para importar` +
    (parsed.errors.length ? ` Â· ${parsed.errors.length} con error (se omitirÃ¡n)` : '');

  const errEl = document.getElementById('import-errors');
  if (parsed.errors.length) {
    errEl.style.display = '';
    errEl.innerHTML = '<strong>Errores (filas omitidas):</strong><br>' + parsed.errors.join('<br>');
  } else { errEl.style.display = 'none'; }

  const warnEl = document.getElementById('import-warnings');
  if (parsed.warnings && parsed.warnings.length) {
    warnEl.style.display = '';
    warnEl.innerHTML = '<strong>Advertencias:</strong><br>' + parsed.warnings.join('<br>');
  } else { warnEl.style.display = 'none'; }

  // Build preview table
  const cols = importTipo === 'propiedades'
    ? ['nombre','monto','tipo','clienteNombre','formaPago']
    : ['nombre','propiedadNombre','montoRenta','tel','factura'];
  const labels = importTipo === 'propiedades'
    ? ['Nombre','Monto','Tipo','Cliente','Forma de pago']
    : ['Nombre','Propiedad','Monto','TelÃ©fono','Factura'];

  let html = `<table style="width:100%;border-collapse:collapse;font-size:12px">
    <thead><tr>${labels.map(l=>`<th style="padding:8px;background:var(--surface2);color:var(--text3);text-align:left;border-bottom:1px solid var(--border);font-size:11px;text-transform:uppercase">${l}</th>`).join('')}</tr></thead>
    <tbody>`;
  parsed.rows.slice(0,10).forEach(r => {
    html += `<tr>${cols.map(c => {
      let v = r[c];
      if (c === 'factura') v = v ? 'âœ… SÃ­' : 'No';
      if (c === 'monto') v = '$' + Number(v).toLocaleString('es-MX');
      return `<td style="padding:8px 10px;border-bottom:1px solid var(--border);color:var(--text)">${v||'â€”'}</td>`;
    }).join('')}</tr>`;
  });
  if (parsed.rows.length > 10) html += `<tr><td colspan="${cols.length}" style="padding:8px;color:var(--text3);text-align:center;font-style:italic">...y ${parsed.rows.length-10} mÃ¡s</td></tr>`;
  html += '</tbody></table>';
  document.getElementById('import-preview').innerHTML = html;
  document.getElementById('import-confirm-btn').style.display = parsed.rows.length > 0 ? '' : 'none';
}

function confirmarImport() {
  if (!importPreviewData.length) return;
  let count = 0;
  const warnings = [];
  if (importTipo === 'propiedades') {
    importPreviewData.forEach(p => {
      // Get dia: from Excel, from linked cliente, or default 1
      const clienteLinked = p.clienteId ? state.clientes.find(c => c.id === p.clienteId) : null;
      const dia = p.dia || (clienteLinked && clienteLinked.dia ? clienteLinked.dia : '1');
      const inicio = (clienteLinked && clienteLinked.inicioContrato) || new Date().toISOString().slice(0,10);
      state.rentas.push({
        id: uid(), nombre: p.nombre, tipo: p.tipo,
        clienteId: p.clienteId, monto: p.monto,
        dia: dia,
        inicio: inicio,
        fin: (clienteLinked && clienteLinked.finContrato) || '',
        formaPagoId: p.formaPagoId || '',
        notas: p.notas,
        servicios: p.servicios || [],
        predial: p.predialCuenta ? { cuenta: p.predialCuenta } : {},
        abonos: [], archivos: [],
        createdAt: new Date().toISOString(),
      });
      count++;
    });
  } else {
    importPreviewData.forEach(c => {
      // Avoid duplicates by name
      const existe = state.clientes.find(x => x.nombre.toLowerCase() === c.nombre.toLowerCase());
      if (existe) return;
      // Match forma de pago to existing or leave as text note
      let formaPagoId = '';
      if (c.formaPago) {
        const fp = state.formasPago.find(f => f.nombre.toLowerCase() === c.formaPago.toLowerCase());
        formaPagoId = fp ? fp.id : '';
      }
      const nuevoClienteId = uid();
      state.clientes.push({
        id: nuevoClienteId,
        nombre: c.nombre,
        tel: c.tel,
        email: c.email,
        notas: c.notas,
        factura: c.factura,
        facturacion: c.facturacion,
        inicioContrato: c.inicioContrato || '',
        diaCobro: c.diaCobro || '1',
        finContrato: c.finContrato || '',
        formaPagoId,
        fechaIncremento: c.fechaIncremento || '',
      });

      // Link cliente to propiedad and update monto if provided
      if (c.propiedadNombre) {
        const renta = state.rentas.find(r =>
          r.nombre.toLowerCase().trim() === c.propiedadNombre.toLowerCase().trim()
        );
        if (renta) {
          renta.clienteId = nuevoClienteId;
          // Update dia de cobro on the property too
          if (c.diaCobro) renta.dia = c.diaCobro;
          // Update inicio/fin contrato on property
          if (c.inicioContrato) renta.inicio = c.inicioContrato;
          if (c.finContrato) renta.fin = c.finContrato;
          // Update forma de pago on property
          if (formaPagoId) renta.formaPagoId = formaPagoId;
          // Update monto only if provided AND different
          const nuevoMonto = parseFloat(c.montoRenta);
          if (!isNaN(nuevoMonto) && nuevoMonto > 0) {
            const montoAnterior = parseFloat(renta.monto);
            if (nuevoMonto !== montoAnterior) {
              renta.monto = nuevoMonto.toString();
              warnings.push('Propiedad "' + renta.nombre + '": monto actualizado de $' + montoAnterior.toLocaleString('es-MX') + ' a $' + nuevoMonto.toLocaleString('es-MX'));
            }
          }
        } else {
          warnings.push('Cliente "' + c.nombre + '": no se encontrÃ³ la propiedad "' + c.propiedadNombre + '" (verifica que estÃ© importada)');
        }
      }
      count++;
    });
  }
  save();
  resetImport();
  render();
  const tipo_label = importTipo === 'propiedades' ? 'propiedad' + (count!==1?'es':'') : 'cliente' + (count!==1?'s':'');
  showToast(`âœ… ${count} ${tipo_label} importado${count!==1?'s':''} correctamente`);
  if (warnings.length) {
    setTimeout(() => {
      const msg = warnings.slice(0,5).join('\n') + (warnings.length > 5 ? `\n...y ${warnings.length-5} mÃ¡s` : '');
      alert('Avisos de importaciÃ³n:\n\n' + msg);
    }, 800);
  }
  nav(importTipo === 'propiedades' ? 'rentas' : 'clientes');
}

// ============================================================
// FILTER
// ============================================================
function setFilter(f, btn) {
  currentFilter = f;
  _rentaEstadoFiltro = null; // clear dashboard filter
  _rentaTipoFiltro = null;
  var _eb = document.getElementById('rentas-tipo-badge');
  if (_eb) _eb.style.display = 'none';
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  renderRentas();
}

// Navigate from dashboard KPI to rentas with a specific filter
function dashGoRentas(tipo) {
  _rentaTipoFiltro = null;
  _rentaEstadoFiltro = null;
  // Map: 'all' â†’ show all, 'sin-rentar'/'atrasado'/'parcial'/'al-dia' â†’ use currentFilter chip
  // 'rentadas' â†’ special: use _rentaEstadoFiltro since no chip exists for it
  // 'vencidas' â†’ special: show atrasadas + parciales combined
  if (tipo === 'rentadas') {
    currentFilter = 'all';
    _rentaEstadoFiltro = 'rentadas';
  } else if (tipo === 'vencidas') {
    currentFilter = 'all';
    _rentaEstadoFiltro = 'vencidas';
  } else {
    currentFilter = tipo === 'all' ? 'all' : tipo;
    _rentaEstadoFiltro = null;
  }
  nav('rentas');
  setTimeout(function() {
    // Highlight the correct chip button
    var chipMap = {'all':0, 'atrasado':1, 'parcial':2, 'al-dia':3, 'sin-rentar':4};
    var idx = chipMap[currentFilter];
    document.querySelectorAll('.filter-chip').forEach(function(c, i) {
      c.classList.toggle('active', i === (idx !== undefined ? idx : 0));
    });
    // Show badge for special filters
    if (_rentaEstadoFiltro === 'rentadas' || _rentaEstadoFiltro === 'vencidas') {
      var badge = document.getElementById('rentas-tipo-badge');
      if (badge) {
        var lbl = _rentaEstadoFiltro === 'rentadas' ? 'ğŸ”‘ Rentadas' : 'âš ï¸ Vencidas';
        document.getElementById('rentas-tipo-badge-label').textContent = lbl;
        badge.style.display = 'inline-flex';
        badge.onclick = function(){ _rentaEstadoFiltro = null; this.style.display='none'; renderRentas(); };
      }
    }
    renderRentas();
  }, 100);
}

// Navigate to propiedades filtered by forma de pago
function dashGoFP(fpId) {
  _rentaTipoFiltro = null;
  _rentaEstadoFiltro = fpId === 'sin-fp' ? 'sin-fp' : 'fp:' + fpId;
  currentFilter = 'all';
  nav('rentas');
  setTimeout(function() {
    document.querySelectorAll('.filter-chip').forEach(function(c, i) {
      c.classList.toggle('active', i === 0);
    });
    var fp = state.formasPago.find(function(f) { return f.id === fpId; });
    var badge = document.getElementById('rentas-tipo-badge');
    if (badge) {
      var lbl = fp ? (fp.icono || 'ğŸ’³') + ' ' + fp.nombre : 'â“ Sin asignar';
      document.getElementById('rentas-tipo-badge-label').textContent = lbl;
      badge.style.display = 'inline-flex';
      badge.onclick = function(){ _rentaEstadoFiltro = null; this.style.display='none'; renderRentas(); };
    }
    renderRentas();
  }, 100);
}

// Show modal with abonos for a specific forma de pago this month
function verAbonosFP(fpId) {
  var data = window._dashFPData && window._dashFPData[fpId];
  if (!data) return;
  var abonos = data.abonos.sort(function(a,b) { return (b.fecha || '').localeCompare(a.fecha || ''); });

  var title = data.icono + ' ' + escHtml(data.nombre) + ' â€” Cobros del mes';
  document.getElementById('fpAbonos-title').innerHTML = title;

  var html = '';
  if (!abonos.length) {
    html = '<div style="text-align:center;padding:24px;color:var(--text3)">Sin cobros este mes para esta forma de pago.</div>';
  } else {
    var totalAbonos = abonos.reduce(function(s,a){ return s + a.monto; }, 0);
    html += '<div style="background:var(--success-light);border:1px solid rgba(22,163,74,0.2);border-radius:10px;padding:14px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">';
    html += '<div><div style="font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--success);font-weight:600">Total cobrado</div>';
    html += '<div style="font-size:10px;color:var(--text3);margin-top:1px">' + abonos.length + ' pago' + (abonos.length !== 1 ? 's' : '') + ' recibidos</div></div>';
    html += '<div style="font-family:\'DM Mono\',monospace;font-size:22px;font-weight:800;color:var(--success)">' + fmt(totalAbonos) + '</div></div>';

    html += '<div style="max-height:55vh;overflow-y:auto">';
    abonos.forEach(function(a) {
      var fechaLabel = a.fecha ? fmtDate(a.fecha) : 'â€”';
      html += '<div onclick="verDetalle(\'' + a.propiedadId + '\');closeModal(\'modalFPAbonos\')" style="display:flex;align-items:center;gap:12px;padding:10px 8px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s" onmouseenter="this.style.background=\'var(--surface2)\'" onmouseleave="this.style.background=\'\'">';
      html += '<div style="flex:1;min-width:0">';
      html += '<div style="font-weight:600;font-size:13px;color:var(--text)">' + escHtml(a.propiedad) + '</div>';
      html += '<div style="font-size:11px;color:var(--text3);margin-top:1px">ğŸ‘¤ ' + escHtml(a.cliente) + '</div>';
      if (a.nota) html += '<div style="font-size:10px;color:var(--text3);margin-top:2px;font-style:italic">ğŸ“ ' + escHtml(a.nota) + '</div>';
      html += '</div>';
      html += '<div style="text-align:right;flex-shrink:0">';
      html += '<div style="font-family:\'DM Mono\',monospace;font-size:15px;font-weight:700;color:var(--success)">' + fmt(a.monto) + '</div>';
      html += '<div style="font-size:10px;color:var(--text3);margin-top:1px">' + fechaLabel + '</div>';
      if (a.comprobante) html += '<div onclick="event.stopPropagation();verComprobante(\'' + a.propiedadId + '\',\'' + a.id + '\')" style="font-size:10px;color:var(--accent);font-weight:600;margin-top:2px;cursor:pointer;text-decoration:underline">ğŸ“ Ver comprobante</div>';
      html += '</div>';
      html += '<div style="color:var(--text3);font-size:12px;flex-shrink:0">â€º</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  document.getElementById('fpAbonos-content').innerHTML = html;
  openModal('modalFPAbonos');
}
// ============================================================
// REPORTE DE PAGOS â€” EXCEL
// ============================================================
function descargarReportePagos() {
  if (!window.XLSX) {
    loadSheetJS(() => descargarReportePagos());
    alert('Cargando librerÃ­a Excel, intenta en 3 segundos...');
    return;
  }

  const wb = XLSX.utils.book_new();
  const hoy = new Date();
  const mesActual = hoy.getFullYear() + '-' + String(hoy.getMonth()+1).padStart(2,'0');

  // â”€â”€ Hoja 1: Detalle de pagos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const detalle = [];
  const _reportVisibles = getRentasVisibles();
  _reportVisibles.forEach(renta => {
    const st = getStatusRenta(renta);
    const cliente = getClienteNombre(renta.clienteId);
    const fp = renta.formaPagoId ? state.formasPago.find(f => f.id === renta.formaPagoId) : null;
    const fpNombre = fp ? fp.nombre : 'â€”';

    if ((renta.abonos || []).length === 0) {
      // Property with no payments at all
      detalle.push({
        'Propiedad':      renta.nombre,
        'Tipo':           renta.tipo || 'Otro',
        'Cliente':        cliente,
        'Renta Mensual':  Number(renta.monto) || 0,
        'Fecha de Pago':  'â€”',
        'Mes Aplicado':   'â€”',
        'Monto Pagado':   0,
        'Forma de Pago':  fpNombre,
        'Nota':           '',
        'Estado':         st.estado === 'sin-rentar' ? 'Sin rentar' :
                          st.estado === 'atrasado'   ? 'Atrasado'   :
                          st.estado === 'parcial'    ? 'Parcial'    : 'Al dÃ­a',
        'Saldo Pendiente': st.saldo,
      });
    } else {
      [...(renta.abonos || [])].sort((a,b) => (b.fecha||'').localeCompare(a.fecha||'')).forEach(abono => {
        detalle.push({
          'Propiedad':      renta.nombre,
          'Tipo':           renta.tipo || 'Otro',
          'Cliente':        cliente,
          'Renta Mensual':  Number(renta.monto) || 0,
          'Fecha de Pago':  abono.fecha || 'â€”',
          'Mes Aplicado':   abono.mes   || 'â€”',
          'Monto Pagado':   Number(abono.monto) || 0,
          'Forma de Pago':  abono.metodo ? abono.metodo.replace(/^[\S]+\s/,'') : fpNombre,
          'Nota':           abono.nota   || '',
          'Estado':         st.estado === 'sin-rentar' ? 'Sin rentar' :
                            st.estado === 'atrasado'   ? 'Atrasado'   :
                            st.estado === 'parcial'    ? 'Parcial'    : 'Al dÃ­a',
          'Saldo Pendiente': st.saldo,
        });
      });
    }
  });

  // Sort by Propiedad then Fecha desc
  detalle.sort((a,b) => a['Propiedad'].localeCompare(b['Propiedad']) || (b['Fecha de Pago']||'').localeCompare(a['Fecha de Pago']||''));

  const ws1 = XLSX.utils.json_to_sheet(detalle);

  // Column widths for sheet 1
  ws1['!cols'] = [
    {wch:32}, {wch:14}, {wch:22}, {wch:14},
    {wch:14}, {wch:12}, {wch:14}, {wch:18},
    {wch:20}, {wch:12}, {wch:14},
  ];

  // â”€â”€ Hoja 2: Resumen por forma de pago â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const fpMap = {};
  _reportVisibles.forEach(renta => {
    (renta.abonos || []).forEach(abono => {
      const fpRaw = abono.metodo ? abono.metodo.replace(/^[\uD800-\uDFFF\u2600-\u27BF]\s*/u,'').trim() : 'â€”';
      const key = fpRaw || 'â€”';
      if (!fpMap[key]) fpMap[key] = { total: 0, count: 0, propiedades: new Set() };
      fpMap[key].total += Number(abono.monto) || 0;
      fpMap[key].count++;
      fpMap[key].propiedades.add(renta.nombre);
    });
  });

  const resumen = Object.entries(fpMap)
    .sort((a,b) => b[1].total - a[1].total)
    .map(([fp, d]) => ({
      'Forma de Pago':        fp,
      'Total Cobrado':        d.total,
      'No. de Pagos':         d.count,
      'Propiedades Distintas': d.propiedades.size,
    }));

  // Totals row
  const totalCobrado = resumen.reduce((s,r) => s + r['Total Cobrado'], 0);
  const totalPagos   = resumen.reduce((s,r) => s + r['No. de Pagos'], 0);
  resumen.push({
    'Forma de Pago':        'TOTAL',
    'Total Cobrado':        totalCobrado,
    'No. de Pagos':         totalPagos,
    'Propiedades Distintas': '',
  });

  const ws2 = XLSX.utils.json_to_sheet(resumen);
  ws2['!cols'] = [{wch:22},{wch:16},{wch:12},{wch:22}];

  // â”€â”€ Hoja 3: Estado actual por propiedad â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const estado = state.rentas.map(renta => {
    const st = getStatusRenta(renta);
    const fp = renta.formaPagoId ? state.formasPago.find(f => f.id === renta.formaPagoId) : null;
    return {
      'Propiedad':        renta.nombre,
      'Tipo':             renta.tipo || 'Otro',
      'Cliente':          getClienteNombre(renta.clienteId),
      'Renta Mensual':    Number(renta.monto) || 0,
      'Total Pagado':     st.totalPagado,
      'Saldo Pendiente':  st.saldo,
      'Estado':           st.estado === 'sin-rentar' ? 'Sin rentar' :
                          st.estado === 'atrasado'   ? 'Atrasado'   :
                          st.estado === 'parcial'    ? 'Parcial'    : 'Al dÃ­a',
      'Forma de Pago':    fp ? fp.nombre : 'â€”',
      'DÃ­a de Cobro':     renta.dia || 1,
      'Inicio Contrato':  renta.inicio || 'â€”',
      'Fin Contrato':     renta.fin    || 'â€”',
    };
  }).sort((a,b) => a['Propiedad'].localeCompare(b['Propiedad']));

  const ws3 = XLSX.utils.json_to_sheet(estado);
  ws3['!cols'] = [
    {wch:32},{wch:14},{wch:22},{wch:14},{wch:13},{wch:15},{wch:10},{wch:18},{wch:11},{wch:14},{wch:14}
  ];

  XLSX.utils.book_append_sheet(wb, ws1, 'Detalle de Pagos');
  XLSX.utils.book_append_sheet(wb, ws2, 'Por Forma de Pago');
  XLSX.utils.book_append_sheet(wb, ws3, 'Estado Actual');

  const fecha = hoy.toISOString().slice(0,10);
  XLSX.writeFile(wb, `Reporte_Rentas_${fecha}.xlsx`);
}
// ============================================================
// FOTO + DOCUMENTOS CLIENTE
// ============================================================
let _clienteDocs = [];

function cargarFotoCliente(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 4 * 1024 * 1024) return alert('Foto muy grande. MÃ¡x 4 MB.');
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('c-foto-data').value = e.target.result;
    document.getElementById('c-foto-preview').innerHTML = `<img src="${e.target.result}" class="foto-avatar" />`;
  };
  reader.readAsDataURL(file);
}

function agregarDocumentoCliente(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    if (file.size > 8 * 1024 * 1024) { alert(`${file.name} es muy grande (mÃ¡x 8 MB)`); return; }
    const reader = new FileReader();
    reader.onload = e => {
      _clienteDocs.push({ id: uid(), name: file.name, size: file.size, type: file.type, data: e.target.result });
      renderDocsTab();
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function renderDocsTab() {
  const el = document.getElementById('docs-list');
  if (!el) return;
  if (!_clienteDocs.length) { el.innerHTML = '<div style="color:var(--text3);font-size:13px;padding:12px 0">Sin documentos adjuntos</div>'; return; }
  el.innerHTML = _clienteDocs.map(doc => {
    const isImg = (doc.type||'').startsWith('image');
    const icon = doc.type?.includes('pdf') ? 'ğŸ“•' : isImg ? 'ğŸ–¼ï¸' : 'ğŸ“„';
    const size = doc.size > 1024*1024 ? (doc.size/1024/1024).toFixed(1)+' MB' : Math.round(doc.size/1024)+' KB';
    return `<div style="display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 12px">
      <span style="font-size:22px">${icon}</span>
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${doc.name}</div>
        <div style="font-size:11px;color:var(--text3)">${size}</div>
      </div>
      <button class="btn btn-ghost" style="font-size:11px;padding:4px 8px" onclick="verDocCliente('${doc.id}')">ğŸ‘ï¸</button>
      <button class="del-pay-btn" onclick="eliminarDocCliente('${doc.id}')">âœ•</button>
    </div>`;
  }).join('');
}

function verDocCliente(docId) {
  const doc = _clienteDocs.find(d => d.id === docId);
  if (!doc) return;
  const win = window.open('','_blank');
  win.document.write(`<html><body style="margin:0;background:#222"><iframe src="${doc.data}" style="width:100%;height:100vh;border:none"></iframe>
</body></html>`);
  win.document.close();
}

function eliminarDocCliente(docId) {
  if (!confirm('Â¿Eliminar este documento?')) return;
  _clienteDocs = _clienteDocs.filter(d => d.id !== docId);
  renderDocsTab();
}

// ============================================================
// INCREMENTOS DE RENTA
// ============================================================
function checkIncrementos() {
  const hoy = new Date();
  const hoyStr = hoy.toISOString().slice(0,10);
  const proximos = [];
  state.rentas.forEach(r => {
    if (!r.incrementoFecha || !r.incrementoPct) return;
    const diffDays = Math.round((new Date(r.incrementoFecha) - hoy) / 86400000);
    if (diffDays <= 30 && diffDays >= -7) {
      proximos.push({ renta: r, diffDays });
    }
  });
  return proximos;
}

function aplicarIncremento(rentaId) {
  const r = state.rentas.find(x => x.id === rentaId);
  if (!r || !r.incrementoPct) return;
  const pct = Number(r.incrementoPct);
  const montoActual = Number(r.monto);
  const nuevoMonto = Math.round(montoActual * (1 + pct/100));
  if (!confirm(`Â¿Aplicar incremento del ${pct}% a "${r.nombre}"?\n\n${fmt(montoActual)} â†’ ${fmt(nuevoMonto)}/mes`)) return;
  // Log in historial
  if (!r.historialIncrementos) r.historialIncrementos = [];
  r.historialIncrementos.push({ fecha: new Date().toISOString().slice(0,10), montoAnterior: montoActual, montoNuevo: nuevoMonto, pct });
  r.monto = nuevoMonto;
  // Advance next increment date by 1 year
  if (r.incrementoFecha) {
    const d = new Date(r.incrementoFecha);
    d.setFullYear(d.getFullYear() + 1);
    r.incrementoFecha = d.toISOString().slice(0,10);
  }
  save(); render();
  buildNotifPanel();
  alert(`âœ… Incremento aplicado. Nueva renta: ${fmt(nuevoMonto)}/mes\nPrÃ³ximo incremento: ${fmtDate(r.incrementoFecha)}`);
}

// Auto-apply increments that are past due (called on app load)
function autoAplicarIncrementos() {
  const hoy = new Date();
  const hoyStr = hoy.toISOString().slice(0,10);
  let aplicados = 0;
  state.rentas.forEach(r => {
    if (!r.incrementoFecha || !r.incrementoPct) return;
    if (!r.clienteId) return; // Solo propiedades rentadas
    // Apply if the increment date has passed
    while (r.incrementoFecha && r.incrementoFecha <= hoyStr) {
      const pct = Number(r.incrementoPct);
      const montoActual = Number(r.monto);
      const nuevoMonto = Math.round(montoActual * (1 + pct/100));
      // Log in historial
      if (!r.historialMonto) r.historialMonto = [];
      r.historialMonto.push({ fecha: r.incrementoFecha, montoAnterior: montoActual, montoNuevo: nuevoMonto, fechaAplic: r.incrementoFecha });
      if (!r.historialIncrementos) r.historialIncrementos = [];
      r.historialIncrementos.push({ fecha: r.incrementoFecha, montoAnterior: montoActual, montoNuevo: nuevoMonto, pct });
      r.monto = nuevoMonto;
      // Advance to next year
      const d = new Date(r.incrementoFecha);
      d.setFullYear(d.getFullYear() + 1);
      r.incrementoFecha = d.toISOString().slice(0,10);
      aplicados++;
    }
  });
  if (aplicados > 0) {
    save();
    showToast(`ğŸ“ˆ Se aplicaron ${aplicados} incremento${aplicados > 1 ? 's' : ''} de renta automÃ¡ticamente`);
  }
}

// â”€â”€ Recordatorio de pago por WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Acciones desde detalle de cliente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function abonoDesdeCliente(clienteId) {
  var rentas = state.rentas.filter(function(r){ return r.clienteId === clienteId; });
  if (rentas.length === 0) { alert('Este cliente no tiene propiedad asignada.'); return; }
  var renta;
  if (rentas.length === 1) {
    renta = rentas[0];
  } else {
    var lista = rentas.map(function(r, i){ return (i+1) + '. ' + r.nombre; }).join('\n');
    var sel = prompt('Â¿A cuÃ¡l propiedad quieres registrar el abono?\n\n' + lista, '1');
    if (!sel) return;
    var idx = parseInt(sel) - 1;
    if (idx < 0 || idx >= rentas.length) { alert('OpciÃ³n no vÃ¡lida'); return; }
    renta = rentas[idx];
  }
  // Navigate to property detail and open abono modal
  currentRentaId = renta.id;
  currentTab = 'general';
  nav('detalle');
  setTimeout(function() { openModal('modalAbono'); }, 200);
}

function facturarDesdeCliente(clienteId) {
  var rentas = state.rentas.filter(function(r){ return r.clienteId === clienteId; });
  if (rentas.length === 0) { alert('Este cliente no tiene propiedad asignada.'); return; }
  var renta;
  if (rentas.length === 1) {
    renta = rentas[0];
  } else {
    var lista = rentas.map(function(r, i){ return (i+1) + '. ' + r.nombre; }).join('\n');
    var sel = prompt('Â¿De cuÃ¡l propiedad quieres facturar?\n\n' + lista, '1');
    if (!sel) return;
    var idx = parseInt(sel) - 1;
    if (idx < 0 || idx >= rentas.length) { alert('OpciÃ³n no vÃ¡lida'); return; }
    renta = rentas[idx];
  }
  facturarMes(renta.id);
}

function enviarRecordatorioPagoCliente(clienteId) {
  var rentas = state.rentas.filter(function(r){ return r.clienteId === clienteId; });
  if (rentas.length === 0) { alert('Este cliente no tiene propiedad asignada.'); return; }
  var renta;
  if (rentas.length === 1) {
    renta = rentas[0];
  } else {
    var lista = rentas.map(function(r, i){ return (i+1) + '. ' + r.nombre; }).join('\n');
    var sel = prompt('Â¿De cuÃ¡l propiedad?\n\n' + lista, '1');
    if (!sel) return;
    var idx = parseInt(sel) - 1;
    if (idx < 0 || idx >= rentas.length) { alert('OpciÃ³n no vÃ¡lida'); return; }
    renta = rentas[idx];
  }
  enviarRecordatorioPago(renta.id);
}

function enviarRecordatorioPago(rentaId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  const cliente = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  if (!cliente || !cliente.tel) return alert('El cliente no tiene nÃºmero de telÃ©fono registrado.');

  // Check global WA toggle
  const cfg = state.configuracion || {};
  if (cfg.waGlobalEnabled === false) return alert('Los recordatorios por WhatsApp estÃ¡n desactivados en ConfiguraciÃ³n.');

  const st = getStatusRenta(renta);
  const tel = cliente.tel.replace(/[^0-9]/g, '');
  const telFull = tel.length >= 10 ? (tel.startsWith('52') ? tel : '52' + tel) : tel;
  const mesesNombres = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const mesParts = (st.mesDebido || '').split('-');
  const mesNombre = mesParts.length === 2 ? mesesNombres[parseInt(mesParts[1])] + ' ' + mesParts[0] : '';
  const diaCobro = Number(renta.dia || 1);
  const diasGracia = Number((state.configuracion||{}).diasGracia) || 6;
  const diaVenc = diaCobro + diasGracia;

  let msg = '';
  const wa = cliente.whatsapp;

  // Use client-specific message if configured
  if (wa && wa.enabled) {
    // Pick the right message based on status
    let template = '';
    if (st.estado === 'atrasado' || st.estado === 'parcial') {
      // Use msg2 if available, otherwise msg1
      template = (wa.msg2Enabled && wa.msg2Text) ? wa.msg2Text : wa.msg1Text;
    } else {
      template = wa.msg1Text || '';
    }
    if (template) {
      msg = template
        .replace(/\{nombre\}/g, cliente.nombre)
        .replace(/\{monto\}/g, fmt(renta.monto))
        .replace(/\{propiedad\}/g, renta.nombre)
        .replace(/\{mes\}/g, mesNombre)
        .replace(/\{dia_pago\}/g, diaCobro)
        .replace(/\{dia_vencimiento\}/g, diaVenc)
        .replace(/\{saldo\}/g, fmt(st.saldo));
      msg = encodeURIComponent(msg);
    }
  }

  // Fallback to default messages
  if (!msg) {
    if (st.estado === 'atrasado' || st.estado === 'parcial') {
      msg = `Hola ${cliente.nombre}, te enviamos un recordatorio amable sobre tu pago de renta.%0A%0A`
        + `ğŸ  Propiedad: ${renta.nombre}%0A`
        + `ğŸ’° Renta mensual: ${fmt(renta.monto)}%0A`
        + `ğŸ“… Mes pendiente: ${mesNombre}%0A`
        + `âš ï¸ Saldo pendiente: ${fmt(st.saldo)}%0A`
        + `ğŸ“† DÃ­a de cobro: ${diaCobro} de cada mes%0A%0A`
        + `Te pedimos realizar tu pago a la brevedad. Quedo al pendiente para cualquier duda. Â¡Gracias!`;
    } else {
      msg = `Hola ${cliente.nombre}, este es un recordatorio de que tu pago de renta estÃ¡ prÃ³ximo.%0A%0A`
        + `ğŸ  Propiedad: ${renta.nombre}%0A`
        + `ğŸ’° Renta mensual: ${fmt(renta.monto)}%0A`
        + `ğŸ“… Mes: ${mesNombre}%0A`
        + `ğŸ“† Fecha lÃ­mite: dÃ­a ${diaVenc} del mes%0A%0A`
        + `Â¡Gracias por tu puntualidad!`;
    }
  }
  window.open(`https://wa.me/${telFull}?text=${msg}`, '_blank');
}

// â”€â”€ DepÃ³sito en garantÃ­a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editarDeposito(rentaId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  const dep = renta.deposito || {};
  const monto = prompt('Monto del depÃ³sito ($):', dep.monto || Number(renta.monto) * 2);
  if (monto === null) return;
  const montoNum = Number(monto);
  if (!montoNum || montoNum <= 0) return alert('Ingresa un monto vÃ¡lido.');
  const fecha = prompt('Fecha de recepciÃ³n (AAAA-MM-DD):', dep.fecha || new Date().toISOString().slice(0,10));
  if (fecha === null) return;
  const nota = prompt('Nota (opcional):', dep.nota || '');
  renta.deposito = {
    monto: montoNum,
    fecha: fecha || new Date().toISOString().slice(0,10),
    nota: nota || '',
    devuelto: dep.devuelto || false,
    fechaDevolucion: dep.fechaDevolucion || null,
    montoDevuelto: dep.montoDevuelto || null,
    descuento: dep.descuento || null,
  };
  save(); render();
  showToast('âœ… DepÃ³sito actualizado');
}

function devolverDeposito(rentaId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta || !renta.deposito) return;
  const dep = renta.deposito;
  const descuento = prompt(`DepÃ³sito original: ${fmt(dep.monto)}\n\nÂ¿Hay algÃºn descuento por daÃ±os o adeudos? Ingresa el monto a descontar (0 si se devuelve completo):`, '0');
  if (descuento === null) return;
  const descNum = Number(descuento) || 0;
  const montoDevolver = dep.monto - descNum;
  if (montoDevolver < 0) return alert('El descuento no puede ser mayor al depÃ³sito.');
  if (!confirm(`Â¿Confirmar devoluciÃ³n?\n\nDepÃ³sito: ${fmt(dep.monto)}\nDescuento: ${fmt(descNum)}\nMonto a devolver: ${fmt(montoDevolver)}`)) return;
  dep.devuelto = true;
  dep.fechaDevolucion = new Date().toISOString().slice(0,10);
  dep.montoDevuelto = montoDevolver;
  dep.descuento = descNum;
  save(); render();
  showToast('âœ… DevoluciÃ³n de depÃ³sito registrada');
}

// ============================================================
// NOTIFICACIONES
// ============================================================
function buildNotifPanel() {
  const items = [];
  const hoy = new Date();

  // Incrementos prÃ³ximos
  checkIncrementos().forEach(({ renta, diffDays }) => {
    items.push({
      type: diffDays < 0 ? 'danger' : diffDays <= 7 ? 'danger' : 'warning',
      icon: 'ğŸ“ˆ',
      title: `Incremento: ${renta.nombre}`,
      sub: diffDays < 0
        ? `VenciÃ³ hace ${Math.abs(diffDays)} dÃ­a${Math.abs(diffDays)!==1?'s':''} Â· ${renta.incrementoPct}%`
        : diffDays === 0 ? `Â¡Hoy! Â· ${renta.incrementoPct}%`
        : `En ${diffDays} dÃ­a${diffDays!==1?'s':''} Â· ${renta.incrementoPct}%`,
      action: `aplicarIncremento('${renta.id}')`,
      actionLabel: 'Aplicar'
    });
  });

  // Contratos por vencer (30 dÃ­as)
  state.rentas.forEach(r => {
    if (!r.fin || !r.clienteId) return;
    const diffDays = Math.round((new Date(r.fin) - hoy) / 86400000);
    if (diffDays >= -7 && diffDays <= 60) {
      items.push({
        type: diffDays <= 7 ? 'danger' : 'warning',
        icon: 'ğŸ“‹',
        title: `Contrato vence: ${r.nombre}`,
        sub: diffDays < 0 ? `VenciÃ³ hace ${Math.abs(diffDays)} dÃ­as`
          : diffDays === 0 ? 'Â¡Vence hoy!'
          : `Vence en ${diffDays} dÃ­a${diffDays!==1?'s':''}  Â· ${fmtDate(r.fin)}`
      });
    }
  });

  // Cobros del dÃ­a
  state.rentas.forEach(r => {
    if (!r.clienteId || !r.dia) return;
    const st = getStatusRenta(r);
    if (st.estado === 'sin-rentar') return;
    const diaHoy = hoy.getDate();
    const diaCobro = Number(r.dia);
    if (diaHoy === diaCobro && st.saldo > 0) {
      items.push({
        type: 'info',
        icon: 'ğŸ’°',
        title: `Cobro hoy: ${r.nombre}`,
        sub: `${getClienteNombre(r.clienteId)} Â· ${fmt(r.monto)}/mes`
      });
    }
  });

  // Rentas atrasadas
  state.rentas.forEach(r => {
    if (!r.clienteId) return;
    const st = getStatusRenta(r);
    if (st.estado === 'atrasado') {
      items.push({
        type: 'danger',
        icon: 'âš ï¸',
        title: `Renta atrasada: ${r.nombre}`,
        sub: `${getClienteNombre(r.clienteId)} Â· Debe ${fmt(st.saldo)}`
      });
    }
  });

  const el = document.getElementById('notif-panel-body');
  const dot = document.getElementById('notif-dot');
  if (!el) return;

  if (!items.length) {
    el.innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:30px 10px">âœ… Sin avisos pendientes</div>';
    dot.classList.remove('show');
    return;
  }
  dot.classList.add('show');
  el.innerHTML = items.map(item => `
    <div class="notif-item ${item.type}">
      <div class="notif-item-title">${item.icon} ${item.title}</div>
      <div class="notif-item-sub">${item.sub}</div>
      ${item.action ? `<button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;margin-top:8px" onclick="${item.action};closeNotifPanel()">${item.actionLabel}</button>` : ''}
    </div>`).join('');
}

function toggleNotifPanel() {
  buildNotifPanel();
  document.getElementById('notif-panel').classList.toggle('open');
  document.getElementById('notif-overlay').classList.toggle('open');
}
function closeNotifPanel() {
  document.getElementById('notif-panel').classList.remove('open');
  document.getElementById('notif-overlay').classList.remove('open');
}

// ============================================================
// ESTADO DE RESULTADOS
// ============================================================
let _erMesIdx = 0;
const _erMeses = (() => {
  const meses = [];
  const hoy = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
    meses.push(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'));
  }
  return meses;
})();

function mostrarEstadoResultados() {
  const sel = document.getElementById('er-mes-sel');
  sel.innerHTML = _erMeses.map((m,i) => `<option value="${i}">${getMesLabel(m)}</option>`).join('');
  _erMesIdx = _erMeses.length - 1;
  sel.value = _erMesIdx;
  renderER();
  openModal('modalER');
}

function erNavMes(dir) {
  _erMesIdx = Math.max(0, Math.min(_erMeses.length-1, _erMesIdx + dir));
  document.getElementById('er-mes-sel').value = _erMesIdx;
  renderER();
}

function renderER() {
  _erMesIdx = parseInt(document.getElementById('er-mes-sel').value);
  const mes = _erMeses[_erMesIdx];
  const el = document.getElementById('er-content');

  // Ingresos del mes
  let totalIngresos = 0;
  const _erVisibles = getRentasVisibles();
  const ingRows = [];
  _erVisibles.forEach(r => {
    const pagos = (r.abonos||[]).filter(a => a.mes === mes || a.fecha?.startsWith(mes));
    const monto = pagos.reduce((s,a) => s + Number(a.monto||0), 0);
    if (monto > 0) {
      ingRows.push({ nombre: r.nombre, cliente: getClienteNombre(r.clienteId), monto });
      totalIngresos += monto;
    }
  });

  // Gastos del mes
  let totalGastos = 0;
  const gasRows = [];
  _erVisibles.forEach(r => {
    const gastos = (r.gastos||[]).filter(g => g.fecha?.startsWith(mes));
    gastos.forEach(g => {
      gasRows.push({ nombre: r.nombre, tipo: g.tipo, desc: g.desc, monto: Number(g.monto||0) });
      totalGastos += Number(g.monto||0);
    });
  });

  const utilidad = totalIngresos - totalGastos;
  const color = utilidad >= 0 ? 'var(--success)' : 'var(--danger)';

  el.innerHTML = `
  <!-- Ingresos -->
  <div style="margin-bottom:20px">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px">ğŸ’° Ingresos</div>
    ${ingRows.length ? `
    <table class="er-table">
      <thead><tr><th>Propiedad</th><th>Inquilino</th><th style="text-align:right">Monto</th></tr></thead>
      <tbody>
        ${ingRows.map(r=>`<tr><td>${escHtml(r.nombre)}</td><td style="color:var(--text3)">${escHtml(r.cliente)}</td><td class="mono" style="text-align:right;color:var(--success)">${fmt(r.monto)}</td></tr>`).join('')}
        <tr class="total-row"><td colspan="2"><strong>Total ingresos</strong></td><td class="mono" style="text-align:right;color:var(--success)"><strong>${fmt(totalIngresos)}</strong></td></tr>
      </tbody>
    </table>` : '<div style="color:var(--text3);font-size:13px;padding:8px 0">Sin ingresos registrados este mes</div>'}
  </div>

  <!-- Gastos -->
  <div style="margin-bottom:20px">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px">ğŸ”§ Gastos</div>
    ${gasRows.length ? `
    <table class="er-table">
      <thead><tr><th>Propiedad</th><th>Tipo</th><th>DescripciÃ³n</th><th style="text-align:right">Monto</th></tr></thead>
      <tbody>
        ${gasRows.map(r=>`<tr><td>${escHtml(r.nombre)}</td><td><span class="tag">${escHtml(r.tipo)}</span></td><td style="color:var(--text3)">${escHtml(r.desc||'â€”')}</td><td class="mono" style="text-align:right;color:var(--danger)">${fmt(r.monto)}</td></tr>`).join('')}
        <tr class="total-row"><td colspan="3"><strong>Total gastos</strong></td><td class="mono" style="text-align:right;color:var(--danger)"><strong>${fmt(totalGastos)}</strong></td></tr>
      </tbody>
    </table>` : '<div style="color:var(--text3);font-size:13px;padding:8px 0">Sin gastos registrados este mes</div>'}
  </div>

  <!-- Utilidad -->
  <div style="background:${utilidad>=0?'var(--success-light)':'#fef2f2'};border:1px solid ${utilidad>=0?'rgba(22,163,74,.2)':'rgba(192,57,43,.2)'};border-radius:12px;padding:18px 20px;display:flex;justify-content:space-between;align-items:center">
    <div>
      <div style="font-size:11px;text-transform:uppercase;letter-spacing:.8px;font-weight:700;color:${color};opacity:.7">Utilidad neta ${getMesLabel(mes)}</div>
      <div style="font-size:28px;font-family:'DM Mono',monospace;font-weight:700;color:${color};margin-top:4px">${fmt(utilidad)}</div>
    </div>
    <div style="font-size:36px">${utilidad>=0?'ğŸ“ˆ':'ğŸ“‰'}</div>
  </div>`;
}

function descargarERExcel() {
  if (!window.XLSX) { loadSheetJS(() => descargarERExcel()); alert('Cargando librerÃ­a, intenta en 3 seg...'); return; }
  const mes = _erMeses[_erMesIdx];
  const wb = XLSX.utils.book_new();
  const rows = [['Propiedad','Concepto','Tipo','Monto']];
  let totalIng = 0, totalGas = 0;
  state.rentas.forEach(r => {
    (r.abonos||[]).filter(a => a.mes===mes||a.fecha?.startsWith(mes)).forEach(a => {
      rows.push([r.nombre, getClienteNombre(r.clienteId), 'Ingreso', Number(a.monto||0)]);
      totalIng += Number(a.monto||0);
    });
  });
  state.rentas.forEach(r => {
    (r.gastos||[]).filter(g => g.fecha?.startsWith(mes)).forEach(g => {
      rows.push([r.nombre, g.tipo+(g.desc?' - '+g.desc:''), 'Gasto', -Number(g.monto||0)]);
      totalGas += Number(g.monto||0);
    });
  });
  rows.push(['','','Utilidad neta', totalIng - totalGas]);
  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:30},{wch:28},{wch:12},{wch:14}];
  XLSX.utils.book_append_sheet(wb, ws, getMesLabel(mes));
  XLSX.writeFile(wb, `EstadoResultados_${mes}.xlsx`);
}

// ============================================================
// REPORTE DE GASTOS
// ============================================================
function descargarReporteGastos() {
  if (!window.XLSX) { loadSheetJS(() => descargarReporteGastos()); alert('Cargando librerÃ­a, intenta en 3 seg...'); return; }
  const wb = XLSX.utils.book_new();
  const detalle = [];
  const resumen = {};
  getRentasVisibles().forEach(r => {
    (r.gastos||[]).forEach(g => {
      detalle.push({
        'Propiedad': r.nombre, 'Tipo': r.tipo||'Otro',
        'CategorÃ­a': g.tipo, 'DescripciÃ³n': g.desc||'',
        'Fecha': g.fecha||'', 'Monto': Number(g.monto||0),
        'Forma de pago': g.formaPago||'â€”'
      });
      if (!resumen[g.tipo]) resumen[g.tipo] = 0;
      resumen[g.tipo] += Number(g.monto||0);
    });
  });
  detalle.sort((a,b) => (b.Fecha).localeCompare(a.Fecha));
  const ws1 = XLSX.utils.json_to_sheet(detalle);
  ws1['!cols'] = [{wch:30},{wch:14},{wch:18},{wch:24},{wch:12},{wch:12},{wch:16}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Detalle de Gastos');
  const resRows = Object.entries(resumen).sort((a,b)=>b[1]-a[1])
    .map(([cat,tot]) => ({'CategorÃ­a':cat,'Total':tot}));
  resRows.push({'CategorÃ­a':'TOTAL','Total': resRows.reduce((s,r)=>s+r['Total'],0)});
  const ws2 = XLSX.utils.json_to_sheet(resRows);
  ws2['!cols'] = [{wch:22},{wch:14}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Por CategorÃ­a');
  XLSX.writeFile(wb, `ReporteGastos_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ============================================================
// HISTORIAL DE INQUILINOS
// ============================================================
function verHistorialInquilinos(rentaId) {
  const r = state.rentas.find(x => x.id === rentaId);
  if (!r) return;
  const historial = r.historialInquilinos || [];
  const clienteActual = r.clienteId ? state.clientes.find(c => c.id === r.clienteId) : null;
  document.getElementById('historial-title').textContent = `ğŸ  Historial â€” ${r.nombre}`;

  // Helper: calculate duration between two dates
  function calcDuracion(inicio, fin) {
    if (!inicio) return 'â€”';
    const d1 = new Date(inicio + 'T12:00:00');
    const d2 = fin ? new Date(fin + 'T12:00:00') : new Date();
    if (isNaN(d1.getTime())) return 'â€”';
    const totalMeses = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
    const anios = Math.floor(totalMeses / 12);
    const meses = totalMeses % 12;
    if (anios > 0 && meses > 0) return `${anios} aÃ±o${anios>1?'s':''} y ${meses} mes${meses>1?'es':''}`;
    if (anios > 0) return `${anios} aÃ±o${anios>1?'s':''}`;
    if (meses > 0) return `${meses} mes${meses>1?'es':''}`;
    return 'Menos de 1 mes';
  }

  // Helper: count payments and total for a period
  function calcPagos(abonos, inicio, fin) {
    const abs = (abonos || []).filter(a => {
      if (!a.fecha) return false;
      if (inicio && a.fecha < inicio) return false;
      if (fin && a.fecha > fin) return false;
      return true;
    });
    const total = abs.reduce((s, a) => s + Number(a.monto || 0), 0);
    return { count: abs.length, total };
  }

  let html = '';

  // â”€â”€ Inquilino actual â”€â”€
  if (clienteActual) {
    const durActual = calcDuracion(r.inicio, null);
    const pagosActual = calcPagos(r.abonos, r.inicio, null);
    html += `<div style="background:var(--success-light);border:1px solid rgba(22,163,74,.2);border-radius:12px;padding:16px;margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--success);font-weight:700;margin-bottom:4px">ğŸŸ¢ Inquilino actual</div>
          <div style="font-weight:700;font-size:16px">${escHtml(clienteActual.nombre)}</div>
        </div>
        <div style="background:var(--success);color:#fff;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700">${durActual}</div>
      </div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:8px">${clienteActual.tel||''} ${clienteActual.email?'Â· '+clienteActual.email:''}</div>
      <div class="g3" style="gap:8px;background:rgba(22,163,74,.06);border-radius:8px;padding:10px">
        <div><div style="font-family:'DM Mono',monospace;font-size:15px;font-weight:700;color:var(--success)">${fmt(r.monto)}</div><div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px">Renta/mes</div></div>
        <div><div style="font-family:'DM Mono',monospace;font-size:15px;font-weight:700;color:var(--text)">${fmt(pagosActual.total)}</div><div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px">Total cobrado</div></div>
        <div><div style="font-size:15px;font-weight:700;color:var(--text)">${pagosActual.count}</div><div style="font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px">Pagos</div></div>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-top:8px">ğŸ“… Desde: ${fmtDate(r.inicio)} ${r.fin ? 'Â· Hasta: '+fmtDate(r.fin) : 'Â· Vigente'}</div>
    </div>`;
  }

  // â”€â”€ Historial anterior â”€â”€
  if (historial.length) {
    html += `<div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin:16px 0 10px">ğŸ“‹ Inquilinos anteriores (${historial.length})</div>`;
    html += historial.slice().reverse().map((h, idx) => {
      const durH = calcDuracion(h.inicio, h.fin);
      const pagosH = { count: h.numPagos || 0, total: h.totalCobrado || 0 };
      return `
      <div style="border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:10px;${idx===0?'border-left:3px solid var(--accent)':''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
          <div>
            <div style="font-weight:700;font-size:14px">${escHtml(h.nombre||'â€”')}</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px">${h.tel||''} ${h.email?'Â· '+h.email:''}</div>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:10px;font-weight:600;color:var(--text2);white-space:nowrap">${durH}</div>
        </div>
        <div class="g3" style="gap:8px;background:var(--surface);border-radius:8px;padding:10px;margin-top:8px">
          <div><div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:700">${h.monto ? fmt(h.monto) : 'â€”'}</div><div style="font-size:9px;color:var(--text3);text-transform:uppercase">Renta/mes</div></div>
          <div><div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:700">${pagosH.total ? fmt(pagosH.total) : 'â€”'}</div><div style="font-size:9px;color:var(--text3);text-transform:uppercase">Total cobrado</div></div>
          <div><div style="font-size:14px;font-weight:700">${pagosH.count || 'â€”'}</div><div style="font-size:9px;color:var(--text3);text-transform:uppercase">Pagos</div></div>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:8px">ğŸ“… ${h.inicio?fmtDate(h.inicio):''} â†’ ${h.fin?fmtDate(h.fin):'â€”'}${h.motivo ? ' Â· <span style=\"color:var(--text2)\">Motivo: '+escHtml(h.motivo)+'</span>' : ''}</div>
        ${h.depositoDevuelto !== undefined ? `<div style="font-size:11px;margin-top:4px;color:${h.depositoDevuelto?'var(--success)':'var(--danger)'}">ğŸ’° DepÃ³sito: ${h.depositoDevuelto ? 'Devuelto' + (h.depositoMonto ? ' â€” '+fmt(h.depositoMonto) : '') : 'No devuelto'}</div>` : ''}
      </div>`;
    }).join('');
  } else if (!clienteActual) {
    html = '<div style="color:var(--text3);text-align:center;padding:40px;font-size:13px">ğŸ  Sin historial de inquilinos registrado.<br><span style="font-size:11px">El historial se crea automÃ¡ticamente cuando cambias de inquilino en una propiedad.</span></div>';
  }

  // Resumen de la propiedad
  const totalInquilinos = historial.length + (clienteActual ? 1 : 0);
  const totalCobradoHistorico = historial.reduce((s, h) => s + (h.totalCobrado || 0), 0) + (r.abonos || []).reduce((s, a) => s + Number(a.monto || 0), 0);
  if (totalInquilinos > 1) {
    html += `<div style="background:var(--surface);border-radius:10px;padding:14px;margin-top:14px;text-align:center">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:8px">ğŸ“Š Resumen de la propiedad</div>
      <div style="display:flex;justify-content:center;gap:24px">
        <div><div style="font-size:20px;font-weight:700;color:var(--accent)">${totalInquilinos}</div><div style="font-size:10px;color:var(--text3)">Inquilinos</div></div>
        <div><div style="font-size:20px;font-weight:700;font-family:'DM Mono',monospace;color:var(--success)">${fmt(totalCobradoHistorico)}</div><div style="font-size:10px;color:var(--text3)">Total cobrado histÃ³rico</div></div>
      </div>
    </div>`;
  }

  document.getElementById('historial-content').innerHTML = html;
  openModal('modalHistorial');
}

// Cuando se desasigna un cliente de una propiedad, guardar en historial
function registrarSalidaInquilino(renta, clienteIdAnterior, motivo) {
  const c = state.clientes.find(x => x.id === clienteIdAnterior);
  if (!c) return;
  if (!renta.historialInquilinos) renta.historialInquilinos = [];

  // Calculate payments during this tenant's period
  const inicio = renta.inicio || '';
  const fin = new Date().toISOString().slice(0,10);
  const abonos = (renta.abonos || []).filter(a => {
    if (!a.fecha) return false;
    if (inicio && a.fecha < inicio) return false;
    return true;
  });
  const totalCobrado = abonos.reduce((s, a) => s + Number(a.monto || 0), 0);
  const numPagos = abonos.length;

  // Deposit info
  const dep = renta.deposito || null;

  renta.historialInquilinos.push({
    nombre: c.nombre,
    tel: c.tel || '',
    email: c.email || '',
    inicio: inicio,
    fin: fin,
    monto: renta.monto,
    totalCobrado: totalCobrado,
    numPagos: numPagos,
    motivo: motivo || '',
    depositoDevuelto: dep ? dep.devuelto : undefined,
    depositoMonto: dep && dep.devuelto ? dep.montoDevuelto : undefined,
    clienteId: clienteIdAnterior,
  });
}
// Manual entry of past tenant to historial
function agregarInquilinoHistorial() {
  if (!currentRentaId) return;
  const renta = state.rentas.find(r => r.id === currentRentaId);
  if (!renta) return;

  const nombre = prompt('Nombre del inquilino anterior:');
  if (!nombre) return;
  const tel = prompt('TelÃ©fono (opcional):', '') || '';
  const email = prompt('Email (opcional):', '') || '';
  const inicio = prompt('Fecha de inicio (AAAA-MM-DD):', '') || '';
  const fin = prompt('Fecha de salida (AAAA-MM-DD):', '') || '';
  const montoStr = prompt('Renta mensual que pagaba ($):', '') || '0';
  const totalStr = prompt('Total cobrado durante su estancia ($, aprox):', '') || '0';
  const numPagosStr = prompt('NÃºmero de pagos registrados:', '') || '0';
  const motivo = prompt('Motivo de salida (opcional):', '') || '';

  if (!renta.historialInquilinos) renta.historialInquilinos = [];
  renta.historialInquilinos.push({
    nombre, tel, email,
    inicio, fin,
    monto: Number(montoStr) || 0,
    totalCobrado: Number(totalStr) || 0,
    numPagos: Number(numPagosStr) || 0,
    motivo,
    manual: true,
  });
  save();
  showToast('âœ… Inquilino anterior agregado al historial');
  verHistorialInquilinos(currentRentaId);
}
// ============================================================
// INVENTARIO DE PROPIEDAD
// ============================================================
let _invRentaId = null, _invEditId = null;

function openModalInventario(rentaId, itemId) {
  _invRentaId = rentaId;
  _invEditId = itemId || null;
  if (itemId) {
    const renta = state.rentas.find(r => r.id === rentaId);
    const item = (renta?.inventario||[]).find(it => it.id === itemId);
    if (!item) return;
    document.getElementById('inv-modal-title').textContent = 'âœï¸ Editar artÃ­culo';
    document.getElementById('inv-nombre').value = item.nombre||'';
    document.getElementById('inv-cantidad').value = item.cantidad||1;
    document.getElementById('inv-valor').value = item.valor||'';
    document.getElementById('inv-estado').value = item.estado||'bueno';
    document.getElementById('inv-serie').value = item.serie||'';
    document.getElementById('inv-nota').value = item.nota||'';
  } else {
    document.getElementById('inv-modal-title').textContent = 'ğŸ“¦ Agregar artÃ­culo';
    ['inv-nombre','inv-serie','inv-nota'].forEach(id => document.getElementById(id).value='');
    document.getElementById('inv-cantidad').value = 1;
    document.getElementById('inv-valor').value = '';
    document.getElementById('inv-estado').value = 'bueno';
  }
  openModal('modalInventario');
}

function guardarItemInventario() {
  const nombre = document.getElementById('inv-nombre').value.trim();
  if (!nombre) return alert('El nombre del artÃ­culo es obligatorio.');
  const renta = state.rentas.find(r => r.id === _invRentaId);
  if (!renta) return;
  if (!renta.inventario) renta.inventario = [];
  const item = {
    id: _invEditId || uid(),
    nombre,
    cantidad: Number(document.getElementById('inv-cantidad').value)||1,
    valor: Number(document.getElementById('inv-valor').value)||0,
    estado: document.getElementById('inv-estado').value,
    serie: document.getElementById('inv-serie').value.trim(),
    nota: document.getElementById('inv-nota').value.trim(),
    fechaAlta: _invEditId ? (renta.inventario.find(i=>i.id===_invEditId)?.fechaAlta||new Date().toISOString().slice(0,10)) : new Date().toISOString().slice(0,10),
  };
  if (_invEditId) {
    const idx = renta.inventario.findIndex(i => i.id === _invEditId);
    if (idx !== -1) renta.inventario[idx] = item;
  } else {
    renta.inventario.push(item);
  }
  save(); closeModal('modalInventario'); render();
}

function editarItemInventario(rentaId, itemId) {
  openModalInventario(rentaId, itemId);
}

function eliminarItemInventario(rentaId, itemId) {
  if (!confirm('Â¿Eliminar este artÃ­culo del inventario?')) return;
  const renta = state.rentas.find(r => r.id === rentaId);
  if (renta) renta.inventario = (renta.inventario||[]).filter(i => i.id !== itemId);
  save(); render();
}
// ============================================================
// COMPARTIR FICHA POR WHATSAPP
// ============================================================
let _fichaTexto = '';

function compartirFicha(rentaId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  const st = getStatusRenta(renta);
  const cliente = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  const fp = renta.formaPagoId ? state.formasPago.find(f => f.id === renta.formaPagoId) : null;
  const hoy = new Date().toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric' });

  // Build ficha text
  const lineas = [];
  lineas.push('ğŸ  *FICHA DE PROPIEDAD*');
  lineas.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  lineas.push(`ğŸ“ *${renta.nombre}*`);
  if (renta.tipo) lineas.push(`ğŸ·ï¸ Tipo: ${renta.tipo}`);
  lineas.push('');
  lineas.push('ğŸ’° *DATOS DE RENTA*');
  lineas.push(`â€¢ Monto mensual: *${fmt(renta.monto)}*`);
  if (renta.dia) lineas.push(`â€¢ DÃ­a lÃ­mite de pago: *dÃ­a ${renta.dia}*`);
  if (renta.inicio) lineas.push(`â€¢ Inicio de contrato: ${fmtDate(renta.inicio)}`);
  if (renta.fin) lineas.push(`â€¢ Fin de contrato: ${fmtDate(renta.fin)}`);
  if (fp) lineas.push(`â€¢ Forma de pago: ${fp.nombre}`);
  if (renta.incrementoPct && renta.incrementoFecha)
    lineas.push(`â€¢ Incremento anual: ${renta.incrementoPct}% (prÃ³ximo: ${fmtDate(renta.incrementoFecha)})`);
  lineas.push('');

  // Estado actual
  lineas.push('ğŸ“Š *ESTADO ACTUAL*');
  const estadoLabel = st.estado === 'al-dia' ? 'âœ… Al dÃ­a' : st.estado === 'atrasado' ? 'ğŸ”´ Atrasado' : st.estado === 'parcial' ? 'ğŸ”¶ Pago parcial' : 'ğŸ”“ Sin inquilino';
  lineas.push(`â€¢ Estado: ${estadoLabel}`);
  lineas.push(`â€¢ Total cobrado: ${fmt(st.totalPagado)}`);
  if (st.saldo > 0) lineas.push(`â€¢ Saldo pendiente: *${fmt(st.saldo)}*`);

  // Inquilino
  if (cliente) {
    lineas.push('');
    lineas.push('ğŸ‘¤ *INQUILINO*');
    lineas.push(`â€¢ Nombre: ${cliente.nombre}`);
    if (cliente.tel) lineas.push(`â€¢ Tel: ${cliente.tel}`);
    if (cliente.email) lineas.push(`â€¢ Email: ${cliente.email}`);
  }

  // Servicios
  const servicios = renta.servicios || [];
  if (servicios.length) {
    lineas.push('');
    lineas.push('ğŸ”Œ *SERVICIOS*');
    servicios.forEach(s => {
      lineas.push(`â€¢ ${s.nombre}${s.cuenta ? ': ' + s.cuenta : ''}`);
    });
  }

  // Notas
  if (renta.notas) {
    lineas.push('');
    lineas.push('ğŸ“ *NOTAS*');
    lineas.push(renta.notas);
  }

  lineas.push('');
  lineas.push('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  lineas.push(`_Generado por GestorRenta Â· ${hoy}_`);

  _fichaTexto = lineas.join('\n');

  // Populate modal
  document.getElementById('ficha-preview').textContent = _fichaTexto;

  // Show inquilino direct-send row if has phone
  const inquilinoRow = document.getElementById('wa-inquilino-row');
  if (cliente && cliente.tel) {
    document.getElementById('wa-inquilino-nombre').textContent = cliente.nombre;
    document.getElementById('wa-inquilino-tel').textContent = cliente.tel;
    inquilinoRow.style.display = '';
  } else {
    inquilinoRow.style.display = 'none';
  }

  // Pre-fill phone with inquilino's if available
  document.getElementById('wa-numero').value = cliente?.tel?.replace(/\D/g,'') || '';

  _fichaRentaId = rentaId;
  switchShareTab('pdf');
  openModal('modalCompartir');
  setTimeout(() => mostrarPDFPreview(renta), 150);
}

function enviarWhatsApp() {
  let num = document.getElementById('wa-numero').value.replace(/\D/g,'').trim();
  if (!num) return alert('Ingresa un nÃºmero de WhatsApp');
  // If doesn't start with country code, assume Mexico (+52)
  if (num.length === 10) num = '52' + num;
  const msg = encodeURIComponent(_fichaTexto);
  window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
}

function enviarWhatsAppInquilino() {
  const telEl = document.getElementById('wa-inquilino-tel');
  let num = (telEl.textContent || '').replace(/\D/g,'').trim();
  if (!num) return alert('El inquilino no tiene telÃ©fono registrado');
  if (num.length === 10) num = '52' + num;
  const msg = encodeURIComponent(_fichaTexto);
  window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
}

function copiarFicha() {
  if (!_fichaTexto) return;
  navigator.clipboard.writeText(_fichaTexto).then(() => {
    const btn = event.currentTarget;
    const orig = btn.innerHTML;
    btn.innerHTML = 'âœ… Â¡Copiado!';
    btn.style.color = 'var(--success)';
    setTimeout(() => { btn.innerHTML = orig; btn.style.color = ''; }, 2000);
  }).catch(() => {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = _fichaTexto;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('Â¡Texto copiado al portapapeles!');
  });
}
// ============================================================
// FICHA PDF â€” generada en el navegador con HTMLâ†’Print
// ============================================================
let _fichaPDFBlob = null;
let _fichaRentaId = null;

function switchShareTab(tab) {
  ['pdf','wa'].forEach(t => {
    document.getElementById('stab-'+t)?.classList.toggle('active', t===tab);
    document.getElementById('stab-btn-'+t)?.classList.toggle('active', t===tab);
  });
}

function generarFichaPDFHtml(renta) {
  const st = getStatusRenta(renta);
  const cliente = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  const fp = renta.formaPagoId ? state.formasPago.find(f => f.id === renta.formaPagoId) : null;
  const cfg = tipoConfig(renta.tipo || 'Otro');
  const hoy = new Date().toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric' });
  const estadoColor = st.estado==='al-dia'?'#2d6a4f': st.estado==='atrasado'?'#8b0000': st.estado==='parcial'?'#b7791f':'#6b7280';
  const estadoLabel = st.estado==='al-dia'?'Al dÃ­a': st.estado==='atrasado'?'Atrasado': st.estado==='parcial'?'Parcial':'Sin inquilino';
  const servicios = renta.servicios || [];
  const inventario = renta.inventario || [];
  const gastos = renta.gastos || [];
  const totalGastos = gastos.reduce((s,g)=>s+Number(g.monto||0),0);
  const utilidad = st.totalPagado - totalGastos;

  // Foto del inquilino
  const fotoHtml = cliente?.foto
    ? `<img src="${cliente.foto}" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid #d9cfb8;flex-shrink:0" />`
    : `<div style="width:64px;height:64px;border-radius:50%;background:#f0ead8;border:2px solid #d9cfb8;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0">ğŸ‘¤</div>`;

  return `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ficha â€” ${renta.nombre}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:'DM Sans',Arial,sans-serif; background:#f5f0e8; color:#1a1a1a; font-size:13px; }
  .page { max-width:720px; margin:0 auto; background:#fff; min-height:100vh; }
  @media print {
    body { background:#fff; }
    .page { max-width:100%; box-shadow:none; }
    .no-print { display:none !important; }
  }

  /* Header */
  .header { background:#1b3a2d; color:#fff; padding:28px 32px; display:flex; align-items:flex-start; justify-content:space-between; gap:20px; }
  .header-left { flex:1; }
  .header-tipo { display:inline-flex; align-items:center; gap:6px; background:rgba(255,255,255,.15); border-radius:20px; padding:4px 12px; font-size:11px; font-weight:600; margin-bottom:10px; }
  .header-nombre { font-size:22px; font-weight:700; line-height:1.2; margin-bottom:6px; }
  .header-sub { font-size:13px; opacity:.75; }
  .header-badge { background:${estadoColor}; color:#fff; border-radius:8px; padding:8px 16px; font-weight:700; font-size:14px; white-space:nowrap; align-self:flex-start; }

  /* Sections */
  .section { padding:20px 32px; border-bottom:1px solid #f0ead8; }
  .section:last-child { border-bottom:none; }
  .section-title { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:#6b7280; margin-bottom:12px; }

  /* Grid */
  .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
  .info-box { background:#f9f6f0; border-radius:8px; padding:12px; }
  .info-val { font-size:18px; font-weight:700; font-family:'DM Mono',monospace; color:#1b3a2d; }
  .info-val.danger { color:#8b0000; }
  .info-val.success { color:#2d6a4f; }
  .info-label { font-size:10px; color:#6b7280; margin-top:3px; text-transform:uppercase; letter-spacing:.5px; }

  /* Cliente */
  .cliente-row { display:flex; align-items:center; gap:14px; }
  .cliente-info { flex:1; }
  .cliente-nombre { font-weight:700; font-size:16px; margin-bottom:4px; }
  .cliente-meta { font-size:12px; color:#6b7280; display:flex; flex-direction:column; gap:2px; }

  /* Table */
  table { width:100%; border-collapse:collapse; font-size:12px; }
  th { text-align:left; padding:6px 8px; font-size:10px; text-transform:uppercase; letter-spacing:.5px; color:#6b7280; border-bottom:2px solid #f0ead8; }
  td { padding:8px; border-bottom:1px solid #f0ead8; }
  tr:last-child td { border-bottom:none; }
  .mono { font-family:'DM Mono',monospace; }

  /* Footer */
  .footer { background:#f9f6f0; padding:16px 32px; text-align:center; font-size:11px; color:#9ca3af; }
  .highlight-box { background:#f0fdf4; border:1px solid rgba(45,106,79,.2); border-radius:10px; padding:14px 16px; }
</style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <div class="header-tipo">${cfg.icon} ${renta.tipo||'Propiedad'}</div>
      <div class="header-nombre">${renta.nombre}</div>
      <div class="header-sub">Ficha generada el ${hoy}</div>
    </div>
    <div class="header-badge">${estadoLabel}</div>
  </div>

  <!-- DATOS FINANCIEROS -->
  <div class="section">
    <div class="section-title">ğŸ’° Datos de renta</div>
    <div class="grid-3" style="margin-bottom:12px">
      <div class="info-box">
        <div class="info-val">${fmt(renta.monto)}</div>
        <div class="info-label">Precio de renta</div>
      </div>
      <div class="info-box">
        <div class="info-val success">${fmt(st.totalPagado)}</div>
        <div class="info-label">Total cobrado</div>
      </div>
      <div class="info-box">
        <div class="info-val ${st.saldo>0?'danger':''}">${fmt(st.saldo)}</div>
        <div class="info-label">Saldo pendiente</div>
      </div>
    </div>
    <div class="grid-2">
      ${renta.inicio ? `<div><span style="color:#6b7280;font-size:11px">Inicio contrato</span><br><strong>${fmtDate(renta.inicio)}</strong></div>` : ''}
      ${renta.fin ? `<div><span style="color:#6b7280;font-size:11px">Fin contrato</span><br><strong>${fmtDate(renta.fin)}</strong></div>` : ''}
      ${renta.dia ? `<div><span style="color:#6b7280;font-size:11px">DÃ­a lÃ­mite de pago</span><br><strong>DÃ­a ${renta.dia}</strong></div>` : ''}
      ${fp ? `<div><span style="color:#6b7280;font-size:11px">Forma de pago</span><br><strong>${fp.icono||''} ${fp.nombre}</strong></div>` : ''}
      ${renta.incrementoPct ? `<div><span style="color:#6b7280;font-size:11px">Incremento anual</span><br><strong>${renta.incrementoPct}% Â· ${fmtDate(renta.incrementoFecha)}</strong></div>` : ''}
    </div>
  </div>

  ${cliente ? `
  <!-- INQUILINO -->
  <div class="section">
    <div class="section-title">ğŸ‘¤ Inquilino</div>
    <div class="cliente-row">
      ${fotoHtml}
      <div class="cliente-info">
        <div class="cliente-nombre">${cliente.nombre}</div>
        <div class="cliente-meta">
          ${cliente.tel ? `<span>ğŸ“ ${cliente.tel}</span>` : ''}
          ${cliente.email ? `<span>âœ‰ï¸ ${cliente.email}</span>` : ''}
          ${cliente.direccion ? `<span>ğŸ“ ${cliente.direccion}</span>` : ''}
          ${cliente.avalNombre ? `<span>ğŸ›¡ï¸ Aval: ${cliente.avalNombre}${cliente.avalTel?' Â· '+cliente.avalTel:''}</span>` : ''}
        </div>
      </div>
    </div>
  </div>` : ''}

  ${gastos.length || st.totalPagado ? `
  <!-- RESUMEN FINANCIERO -->
  <div class="section">
    <div class="section-title">ğŸ“Š Resumen financiero</div>
    <div class="grid-3">
      <div class="info-box">
        <div class="info-val success">${fmt(st.totalPagado)}</div>
        <div class="info-label">Total ingresos</div>
      </div>
      <div class="info-box">
        <div class="info-val danger">${fmt(totalGastos)}</div>
        <div class="info-label">Total gastos</div>
      </div>
      <div class="info-box">
        <div class="info-val ${utilidad>=0?'success':'danger'}">${fmt(utilidad)}</div>
        <div class="info-label">Utilidad neta</div>
      </div>
    </div>
  </div>` : ''}

  ${servicios.length ? `
  <!-- SERVICIOS -->
  <div class="section">
    <div class="section-title">ğŸ”Œ Servicios</div>
    <table>
      <thead><tr><th>Servicio</th><th>Cuenta / NÃºmero</th><th>Notas</th></tr></thead>
      <tbody>
        ${servicios.map(s=>`<tr><td><strong>${s.nombre}</strong></td><td class="mono">${s.cuenta||'â€”'}</td><td style="color:#6b7280">${s.notas||'â€”'}</td></tr>`).join('')}
      </tbody>
    </table>
  </div>` : ''}

  ${inventario.length ? `
  <!-- INVENTARIO -->
  <div class="section">
    <div class="section-title">ğŸ“¦ Inventario (${inventario.length} artÃ­culos)</div>
    <table>
      <thead><tr><th>ArtÃ­culo</th><th style="text-align:center">Cant.</th><th style="text-align:right">Valor unit.</th><th>Estado</th></tr></thead>
      <tbody>
        ${inventario.map(it=>`<tr>
          <td><strong>${it.nombre}</strong>${it.nota?`<br><span style="color:#6b7280;font-size:11px">${it.nota}</span>`:''}</td>
          <td class="mono" style="text-align:center">${it.cantidad||1}</td>
          <td class="mono" style="text-align:right">${it.valor?fmt(it.valor):'â€”'}</td>
          <td><span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:10px;background:${it.estado==='malo'?'#fef2f2':it.estado==='regular'?'#fff8e1':'#e8f5e9'};color:${it.estado==='malo'?'#8b0000':it.estado==='regular'?'#b7791f':'#2d6a4f'}">${it.estado==='malo'?'Malo':it.estado==='regular'?'Regular':'Bueno'}</span></td>
        </tr>`).join('')}
        <tr style="border-top:2px solid #f0ead8">
          <td colspan="2" style="font-weight:700">Valor total inventario</td>
          <td class="mono" style="text-align:right;font-weight:700">${fmt(inventario.reduce((s,it)=>s+Number(it.valor||0)*Number(it.cantidad||1),0))}</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>` : ''}

  ${renta.notas ? `
  <!-- NOTAS -->
  <div class="section">
    <div class="section-title">ğŸ“ Notas</div>
    <div style="color:#374151;line-height:1.6">${renta.notas}</div>
  </div>` : ''}

  <!-- FOOTER -->
  <div class="footer">
    GestorRenta &nbsp;Â·&nbsp; ${hoy} &nbsp;Â·&nbsp; Documento generado automÃ¡ticamente
  </div>

</div>
</body>
</html>`;
}

// Open live preview in iframe + generate blob
function mostrarPDFPreview(renta) {
  const html = generarFichaPDFHtml(renta);
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  // Create frame dynamically if it doesn't exist in DOM
  let frame = document.getElementById('pdf-preview-frame');
  if (!frame) {
    frame = document.createElement('iframe');
    frame.id = 'pdf-preview-frame';
    frame.style.cssText = 'width:100%;height:600px;border:none;border-radius:8px';
    const container = document.getElementById('pdf-preview-container') || document.body;
    container.appendChild(frame);
  }
  let placeholder = document.getElementById('pdf-preview-placeholder');
  if (!placeholder) { placeholder = { style: { display: 'none' } }; } // dummy
  frame.src = url;
  frame.style.display = 'block';
  if (placeholder) placeholder.style.display = 'none';
  // Store for download
  _fichaPDFBlob = blob;
  _fichaPDFUrl = url;
}

let _fichaPDFUrl = null;

// ============================================================
// RECIBO DE PAGO PDF
// ============================================================
// â”€â”€ Recibo dropdown menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleReciboMenu(btn, rentaId, abonoId) {
  // Close any existing menu
  document.querySelectorAll('.recibo-dropdown').forEach(el => el.remove());

  const renta = state.rentas.find(r => r.id === rentaId);
  const cliente = renta && renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  const tieneTel = cliente && cliente.tel;

  const menu = document.createElement('div');
  menu.className = 'recibo-dropdown';
  menu.style.cssText = 'position:absolute;top:100%;right:0;z-index:9999;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);padding:6px;min-width:180px;margin-top:4px';
  menu.innerHTML = `
    <button onclick="generarReciboPDF('${rentaId}','${abonoId}');closeReciboMenus()" style="display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:12px;font-weight:500;color:var(--text);border-radius:6px;text-align:left" onmouseenter="this.style.background='var(--accent-light)'" onmouseleave="this.style.background='none'">ğŸ–¨ï¸ Imprimir / PDF</button>
    <button onclick="descargarReciboHTML('${rentaId}','${abonoId}');closeReciboMenus()" style="display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:12px;font-weight:500;color:var(--text);border-radius:6px;text-align:left" onmouseenter="this.style.background='var(--accent-light)'" onmouseleave="this.style.background='none'">ğŸ’¾ Guardar recibo</button>
    ${tieneTel ? `<button onclick="enviarReciboWhatsApp('${rentaId}','${abonoId}');closeReciboMenus()" style="display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;border:none;background:none;cursor:pointer;font-size:12px;font-weight:500;color:#25D366;border-radius:6px;text-align:left" onmouseenter="this.style.background='rgba(37,211,102,.08)'" onmouseleave="this.style.background='none'">ğŸ’¬ Enviar por WhatsApp</button>` : ''}
  `;
  btn.parentElement.appendChild(menu);

  // Close on click outside
  setTimeout(() => {
    document.addEventListener('click', function _closeMenu(e) {
      if (!menu.contains(e.target) && e.target !== btn) {
        menu.remove();
        document.removeEventListener('click', _closeMenu);
      }
    });
  }, 10);
}

function closeReciboMenus() {
  document.querySelectorAll('.recibo-dropdown').forEach(el => el.remove());
}

// Download receipt as HTML file (save)
function descargarReciboHTML(rentaId, abonoId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  const abono = (renta.abonos||[]).find(a => a.id === abonoId);
  if (!abono) return;
  // Build the same HTML as generarReciboPDF but download it
  const html = _buildReciboHTML(rentaId, abonoId);
  if (!html) return;
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Recibo_' + renta.nombre.replace(/[^a-zA-Z0-9]/g,'_') + '_' + (abono.mes||'') + '.html';
  a.click();
  URL.revokeObjectURL(url);
}

function generarReciboPDF(rentaId, abonoId) {
  const html = _buildReciboHTML(rentaId, abonoId);
  if (!html) return;
  const win = window.open('', '_blank');
  if (win) {
    win.document.write(html);
    win.document.close();
  } else {
    const renta = state.rentas.find(r => r.id === rentaId);
    const abono = (renta.abonos || []).find(a => a.id === abonoId);
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'Recibo_' + (renta?renta.nombre:'') + '_' + (abono?abono.mes:'') + '.html';
    a.click();
    URL.revokeObjectURL(url);
  }
}

function _buildReciboHTML(rentaId, abonoId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) { alert('Propiedad no encontrada.'); return null; }
  const abono = (renta.abonos || []).find(a => a.id === abonoId);
  if (!abono) { alert('Abono no encontrado.'); return null; }

  const cliente = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  const clienteNombre = cliente ? cliente.nombre : 'Sin asignar';
  const clienteTel = cliente && cliente.tel ? cliente.tel : '';
  const clienteEmail = cliente && cliente.email ? cliente.email : '';

  // Tenant/arrendador info
  const users = loadUsers();
  const titular = users.find(u => u.role === 'titular');
  const arrendadorNombre = titular ? titular.nombre : (currentUser ? currentUser.nombre : 'Arrendador');

  // Fiscal info â€” use property-specific emisor if available
  const fc = state.fiscalConfig || {};
  const propertyEmisor = typeof getEmisorForRenta === 'function' ? getEmisorForRenta(rentaId) : null;
  const emisor = propertyEmisor || (typeof getEmisores === 'function' && getEmisores().length > 0 ? getEmisores()[0] : null) || fc.emisor || {};
  const razonSocial = emisor.razon || arrendadorNombre;
  const rfcEmisor = emisor.rfc || '';

  const cfg = tipoConfig(renta.tipo || 'Otro');
  const hoy = new Date();
  const fechaEmision = hoy.toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric' });
  const horaEmision = hoy.toLocaleTimeString('es-MX', { hour:'2-digit', minute:'2-digit' });

  // Folio: based on abono id
  const folio = (abonoId || '').slice(-8).toUpperCase();

  // Mes formateado
  const mesParts = (abono.mes || '').split('-');
  const mesesNombres = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const mesFormateado = mesParts.length === 2 ? (mesesNombres[parseInt(mesParts[1])] || mesParts[1]) + ' ' + mesParts[0] : (abono.mes || 'â€”');

  // Monto en letras (simplificado)
  const montoNum = Number(abono.monto);

  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Recibo de Pago â€” ${renta.nombre}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:'DM Sans',Arial,sans-serif; background:#f5f0e8; color:#1a1a1a; font-size:13px; }
  .page { max-width:600px; margin:20px auto; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 24px rgba(0,0,0,.08); }
  @media print {
    body { background:#fff; }
    .page { max-width:100%; box-shadow:none; margin:0; border-radius:0; }
    .no-print { display:none !important; }
  }

  .header { background:#1b3a2d; color:#fff; padding:24px 28px; display:flex; align-items:center; justify-content:space-between; }
  .header-left { }
  .header-logo { font-family:'DM Sans',serif; font-size:20px; font-weight:700; color:#c8a85a; }
  .header-sub { font-size:11px; opacity:.7; margin-top:2px; }
  .header-right { text-align:right; }
  .header-folio { font-size:11px; opacity:.7; }
  .header-folio b { color:#c8a85a; font-size:13px; }

  .badge { display:inline-block; background:#c8a85a; color:#1b3a2d; font-size:16px; font-weight:700; padding:6px 18px; border-radius:8px; text-align:center; letter-spacing:.5px; }

  .section { padding:18px 28px; border-bottom:1px solid #f0ead8; }
  .section:last-child { border-bottom:none; }
  .section-title { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:#9ca3af; margin-bottom:10px; }

  .row { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
  .row .label { color:#6b7280; font-size:12px; }
  .row .value { font-weight:600; font-size:13px; text-align:right; }
  .row .value.big { font-size:22px; font-family:'DM Mono',monospace; color:#1b3a2d; }
  .row .value.accent { color:#c8a85a; }

  .divider { border:none; border-top:1px dashed #e5e0d4; margin:14px 0; }

  .monto-box { background:#f0fdf4; border:1.5px solid rgba(45,106,79,.2); border-radius:10px; padding:16px 20px; text-align:center; margin:8px 0; }
  .monto-box .amount { font-size:28px; font-weight:700; font-family:'DM Mono',monospace; color:#2d6a4f; }
  .monto-box .label { font-size:10px; color:#6b7280; margin-top:4px; text-transform:uppercase; letter-spacing:.8px; }

  .footer { background:#f9f6f0; padding:16px 28px; text-align:center; font-size:10px; color:#9ca3af; }
  .footer .firma { margin-top:24px; padding-top:12px; border-top:1px solid #d9cfb8; display:inline-block; min-width:200px; font-size:11px; color:#6b7280; }

  .actions { padding:16px 28px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
  .actions button { padding:10px 20px; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; border:none; }
  .btn-print { background:#1b3a2d; color:#fff; }
  .btn-wa { background:#25D366; color:#fff; }
  .btn-download { background:#c8a85a; color:#1b3a2d; }
</style>
</head>
<body>
<div class="page">

  <div class="header">
    <div class="header-left">
      <div class="header-logo">GestorRenta</div>
      <div class="header-sub">Recibo de Pago</div>
    </div>
    <div class="header-right">
      <div class="header-folio">Folio: <b>${folio}</b></div>
      <div class="header-folio">${fechaEmision} â€” ${horaEmision}</div>
    </div>
  </div>

  <div class="section" style="text-align:center;padding:20px 28px">
    <div class="monto-box">
      <div class="amount">${fmt(montoNum)}</div>
      <div class="label">Monto recibido</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ“‹ Datos del pago</div>
    <div class="row"><span class="label">Mes que aplica</span><span class="value accent">${mesFormateado}</span></div>
    <div class="row"><span class="label">Fecha de pago</span><span class="value">${fmtDate(abono.fecha)}</span></div>
    <div class="row"><span class="label">Forma de pago</span><span class="value">${abono.metodo || 'â€”'}</span></div>
    ${abono.nota ? `<div class="row"><span class="label">Concepto / Nota</span><span class="value" style="max-width:60%;text-align:right">${abono.nota}</span></div>` : ''}
  </div>

  <div class="section">
    <div class="section-title">ğŸ  Propiedad</div>
    <div class="row"><span class="label">Nombre</span><span class="value">${renta.nombre}</span></div>
    <div class="row"><span class="label">Tipo</span><span class="value">${cfg.icon} ${renta.tipo || 'Otro'}</span></div>
    <div class="row"><span class="label">Renta mensual</span><span class="value">${fmt(renta.monto)}</span></div>
    <div class="row"><span class="label">DÃ­a de cobro</span><span class="value">${renta.dia || 1} de cada mes</span></div>
  </div>

  <div class="section">
    <div class="section-title">ğŸ‘¤ Inquilino</div>
    <div class="row"><span class="label">Nombre</span><span class="value">${clienteNombre}</span></div>
    ${clienteTel ? `<div class="row"><span class="label">TelÃ©fono</span><span class="value">${clienteTel}</span></div>` : ''}
    ${clienteEmail ? `<div class="row"><span class="label">Email</span><span class="value">${clienteEmail}</span></div>` : ''}
  </div>

  <div class="section">
    <div class="section-title">ğŸ¢ Arrendador</div>
    <div class="row"><span class="label">Nombre</span><span class="value">${razonSocial}</span></div>
    ${rfcEmisor ? `<div class="row"><span class="label">RFC</span><span class="value">${rfcEmisor}</span></div>` : ''}
  </div>

  <div class="footer">
    <div>Este recibo confirma la recepciÃ³n del pago indicado.</div>
    <div style="margin-top:4px">Generado por GestorRenta el ${fechaEmision} a las ${horaEmision}</div>
    <div class="firma">Firma del arrendador</div>
  </div>

  <div class="actions no-print">
    <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Imprimir / PDF</button>
    <button class="btn-wa" onclick="
      var tel='${clienteTel}'.replace(/[^0-9]/g,'');
      var msg='ğŸ  *Recibo de Pago*%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AğŸ“‹ *Folio:* ${folio}%0AğŸ’° *Monto:* ${fmt(montoNum)}%0AğŸ“… *Mes:* ${mesFormateado}%0AğŸ—“ï¸ *Fecha:* ${fmtDate(abono.fecha)}%0AğŸ’³ *Forma de pago:* ${(abono.metodo||'â€”').replace(/'/g,'')}%0AğŸ  *Propiedad:* ${renta.nombre.replace(/'/g,'')}%0AğŸ‘¤ *Inquilino:* ${clienteNombre.replace(/'/g,'')}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0Aâœ… Pago recibido. Gracias.';
      var url='https://wa.me/'+(tel.length>=10?(tel.startsWith('52')?tel:'52'+tel):'')+'?text='+msg;
      window.open(url,'_blank');
    ">ğŸ’¬ WhatsApp</button>
  </div>
</body>
</html>`;

  return html;
}

// Send receipt directly via WhatsApp (without opening PDF first)
function enviarReciboWhatsApp(rentaId, abonoId) {
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  const abono = (renta.abonos||[]).find(a => a.id === abonoId);
  if (!abono) return;
  const cliente = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  if (!cliente || !cliente.tel) return alert('El cliente no tiene telÃ©fono registrado.');
  const tel = cliente.tel.replace(/[^0-9]/g, '');
  const telFull = tel.length >= 10 ? (tel.startsWith('52') ? tel : '52' + tel) : tel;
  const folio = abonoId.slice(-8).toUpperCase();
  const montoNum = Number(abono.monto) || 0;
  const mesParts = (abono.mes || '').split('-');
  const mesesNombres = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const mesFormateado = mesParts.length === 2 ? mesesNombres[parseInt(mesParts[1])] + ' ' + mesParts[0] : abono.mes || '';
  const msg = `ğŸ  *Recibo de Pago*%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AğŸ“‹ *Folio:* ${folio}%0AğŸ’° *Monto:* ${fmt(montoNum)}%0AğŸ“… *Mes:* ${mesFormateado}%0AğŸ—“ï¸ *Fecha:* ${fmtDate(abono.fecha)}%0AğŸ’³ *Forma de pago:* ${(abono.metodo||'â€”').replace(/'/g,'')}%0AğŸ  *Propiedad:* ${renta.nombre.replace(/'/g,'')}%0AğŸ‘¤ *Inquilino:* ${cliente.nombre.replace(/'/g,'')}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0Aâœ… Pago recibido. Gracias.`;
  window.open(`https://wa.me/${telFull}?text=${msg}`, '_blank');
}

function descargarFichaPDF() {
  const renta = state.rentas.find(r => r.id === _fichaRentaId);
  if (!renta) return;
  const html = generarFichaPDFHtml(renta);
  // Use print dialog to save as PDF
  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 600);
}

function abrirFichaPDF() {
  const renta = state.rentas.find(r => r.id === _fichaRentaId);
  if (!renta) return;
  const html = generarFichaPDFHtml(renta);
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
}
// ============================================================
// FICHA PDF POR PROPIEDAD
// ============================================================
let _fichaPDFRentaId = null;

function abrirModalFichaPDF(rentaId) {
  _fichaPDFRentaId = rentaId;
  const renta = state.rentas.find(r => r.id === rentaId);
  if (!renta) return;
  if (renta.fichaPDF) {
    mostrarFichaPDFCargada(renta.fichaPDF, renta.fichaPDFMeta || {});
  } else {
    document.getElementById('ficha-pdf-empty').style.display = '';
    document.getElementById('ficha-pdf-loaded').style.display = 'none';
  }
  openModal('modalFichaPDF');
}

function cargarFichaPDF(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 10 * 1024 * 1024) { alert('El archivo es muy grande. MÃ¡ximo 10 MB.'); input.value=''; return; }
  const reader = new FileReader();
  reader.onload = e => {
    const b64 = e.target.result;
    const meta = { name: file.name, size: file.size, type: file.type };
    // Save to renta
    const renta = state.rentas.find(r => r.id === _fichaPDFRentaId);
    if (!renta) return;
    renta.fichaPDF = b64;
    renta.fichaPDFMeta = meta;
    save();
    mostrarFichaPDFCargada(b64, meta);
    render(); // refresh card badge
  };
  reader.readAsDataURL(file);
  input.value = '';
}

function mostrarFichaPDFCargada(b64, meta) {
  document.getElementById('ficha-pdf-empty').style.display = 'none';
  document.getElementById('ficha-pdf-loaded').style.display = '';
  const isPdf = (meta.type||'').includes('pdf') || (meta.name||'').toLowerCase().endsWith('.pdf');
  const isImg = (meta.type||'').startsWith('image');
  document.getElementById('ficha-pdf-icon').textContent = isPdf ? 'ğŸ“•' : isImg ? 'ğŸ–¼ï¸' : 'ğŸ“„';
  document.getElementById('ficha-pdf-nombre').textContent = meta.name || 'Ficha';
  const size = meta.size > 1024*1024 ? (meta.size/1024/1024).toFixed(1)+' MB' : Math.round((meta.size||0)/1024)+' KB';
  document.getElementById('ficha-pdf-size').textContent = size;
  // Preview
  const frame = document.getElementById('ficha-pdf-frame');
  const img   = document.getElementById('ficha-pdf-img');
  const ph    = document.getElementById('ficha-pdf-placeholder');
  frame.style.display = 'none'; img.style.display = 'none'; ph.style.display = '';
  if (isPdf) { frame.src = b64; frame.style.display = 'block'; ph.style.display = 'none'; }
  else if (isImg) { img.src = b64; img.style.display = 'block'; ph.style.display = 'none'; }
}

function eliminarFichaPDF() {
  if (!confirm('Â¿Eliminar la ficha PDF de esta propiedad?')) return;
  const renta = state.rentas.find(r => r.id === _fichaPDFRentaId);
  if (renta) { renta.fichaPDF = null; renta.fichaPDFMeta = null; save(); render(); }
  document.getElementById('ficha-pdf-empty').style.display = '';
  document.getElementById('ficha-pdf-loaded').style.display = 'none';
}

function abrirFichaPDFNuevaPestana() {
  const renta = state.rentas.find(r => r.id === _fichaPDFRentaId);
  if (!renta?.fichaPDF) return;
  const win = window.open('', '_blank');
  win.document.write(`<html><body style="margin:0;background:#222"><iframe src="${renta.fichaPDF}" style="width:100%;height:100vh;border:none"></iframe></body></html>`);
  win.document.close();
}

function descargarFichaPDFArchivo() {
  const renta = state.rentas.find(r => r.id === _fichaPDFRentaId);
  if (!renta?.fichaPDF) return;
  const a = document.createElement('a');
  a.href = renta.fichaPDF;
  a.download = renta.fichaPDFMeta?.name || `Ficha_${renta.nombre}.pdf`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

function compartirTextoWhatsApp() {
  closeModal('modalFichaPDF');
  const renta = state.rentas.find(r => r.id === _fichaPDFRentaId);
  if (renta) compartirFicha(renta.id);
}
// ============================================================
// RESPALDO â€” EXPORTAR / IMPORTAR
// ============================================================
function exportarDatos() {
  const datos = {
    version: 'gestorrenta_v2',
    exportado: new Date().toISOString(),
    state: state,
    users: JSON.parse(localStorage.getItem('gestorrenta_users') || '[]'),
  };
  const json = JSON.stringify(datos, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `GestorRenta_respaldo_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importarDatos(input) {
  const file = input.files[0];
  if (!file) return;
  if (!confirm('âš ï¸ Esto reemplazarÃ¡ TODOS los datos actuales con los del archivo.\n\nÂ¿Continuar?')) {
    input.value = ''; return;
  }
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const datos = JSON.parse(e.target.result);
      // Validate structure
      if (!datos.state || !datos.state.rentas) {
        alert('El archivo no es un respaldo vÃ¡lido de GestorRenta.');
        return;
      }
      // Restore state â€” save locally AND push to Firebase
      localStorage.setItem('gestorrenta_v2', JSON.stringify(datos.state));
      if (datos.users && datos.users.length) {
        localStorage.setItem('gestorrenta_users', JSON.stringify(datos.users));
        fbSaveUsers(datos.users);
      }
      const nProp = datos.state.rentas?.length || 0;
      const nCli  = datos.state.clientes?.length || 0;
      const nPagos = datos.state.rentas?.reduce((s,r)=>s+(r.abonos?.length||0),0) || 0;
      // Reload everything
      load();
      _saveCore(); // Push imported data to Firebase
      applyPermissions();
      nav('dashboard');
      render();
      // Show success toast
      mostrarToastExito(`âœ… Datos recuperados: ${nProp} propiedades Â· ${nCli} clientes Â· ${nPagos} pagos`);
    } catch(err) {
      alert('Error al leer el archivo: ' + err.message);
    }
    input.value = '';
  };
  reader.readAsText(file);
}
// ============================================================
// TOAST + AUTOSAVE INDICATOR
// ============================================================
function mostrarToastExito(msg) {
  // Simple overlay toast
  const div = document.createElement('div');
  div.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1b3a2d;color:#fff;padding:20px 28px;border-radius:14px;font-size:15px;font-weight:600;z-index:9999;text-align:center;max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,.3);line-height:1.5';
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 3500);
}

// save() â€” persists state + flashes autosave indicator
function save() {
  // Animate header icon while saving
  const icon = document.getElementById('hstat-sync-icon');
  if (icon) { icon.textContent = 'ğŸ”„'; icon.className = 'hstat-val sync-saving'; }
  _saveCore();
  // After save, show synced
  setTimeout(() => fbShowStatus(true), 800);
  // Bottom indicator
  const ind = document.getElementById('autosave-indicator');
  const txt = document.getElementById('autosave-text');
  if (!ind) return;
  txt.textContent = 'â˜ï¸ Guardando...';
  ind.classList.add('show');
  clearTimeout(ind._t);
  ind._t = setTimeout(() => ind.classList.remove('show'), 3000);
}
// ============================================================
// EXTRA â€” DOCUMENTOS LEGALES
// ============================================================

const DOCS_EXTRA = [
  { id:'contrato',  icon:'ğŸ“', title:'Contrato de arrendamiento', desc:'Contrato completo listo para firmar, con todos los datos del inquilino, monto, fechas y clÃ¡usulas estÃ¡ndar.' },
  { id:'ficha',     icon:'ğŸ ', title:'Ficha de presentaciÃ³n',     desc:'Ficha comercial para publicar o presentar la propiedad: foto, caracterÃ­sticas, precio y contacto.' },
  { id:'entrega',   icon:'ğŸ”‘', title:'Acta de entrega / recepciÃ³n', desc:'Documento para firmar al inicio o al final del contrato registrando el estado de la propiedad.' },
  { id:'deposito',  icon:'ğŸ’°', title:'Recibo de depÃ³sito',         desc:'Recibo formal del depÃ³sito en garantÃ­a recibido del inquilino.' },
  { id:'salida',    icon:'ğŸšª', title:'Acta de devoluciÃ³n / salida', desc:'Documento que firmarÃ¡ el inquilino al dejar la propiedad, con estado final y devoluciÃ³n del depÃ³sito.' },
  { id:'rescision', icon:'âš–ï¸', title:'RescisiÃ³n de contrato',         desc:'Documento formal para rescindir el contrato por incumplimiento de clÃ¡usulas o salida anticipada. Detalla motivos, penalidades y plazos de desocupaciÃ³n.' },
];

let _extraRentaId = null;
let _docTextoActual = '';
let _docTituloActual = '';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIGRACIÃ“N MULTI-TENANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMigracion() {
  const el = document.getElementById('migracion-content');
  if (!el) return;
  el.innerHTML = `
    <div style="background:#fff;border-radius:14px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
      <div style="font-size:22px;font-weight:700;color:var(--accent);margin-bottom:4px">ğŸ”„ MigraciÃ³n de Datos</div>
      <div style="font-size:13px;color:var(--text3);margin-bottom:20px">Mueve tus datos a la nueva estructura multi-tenant</div>
      <div style="background:#f0f8f0;border:2px solid var(--success);border-radius:8px;padding:12px;font-family:monospace;font-size:12px;margin-bottom:16px">
        <strong>UID destino:</strong><br>tSKcnxaw6tRJXWlcZKhiXCERKwp2
      </div>
      <button onclick="ejecutarMigracion()" id="btn-migrar-app"
        style="width:100%;background:var(--accent);color:#fff;border:none;padding:14px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:12px">
        ğŸš€ Iniciar MigraciÃ³n
      </button>
      <div id="mig-log" style="background:#1a1a2e;color:#00ff88;padding:16px;border-radius:8px;font-family:monospace;font-size:12px;min-height:180px;max-height:350px;overflow-y:auto;white-space:pre-wrap"></div>
    </div>
  `;
  // Auto check
  const uid = _fbAuth ? _fbAuth.uid : null;
  const logEl = document.getElementById('mig-log');
  if (uid) {
    logEl.innerHTML += '<span style="color:#00ff88">âœ… SesiÃ³n activa: ' + (_fbAuth.email||uid) + '</span>\n';
    logEl.innerHTML += '<span style="color:#88aaff">Listo para migrar. Presiona el botÃ³n.</span>\n';
  } else {
    logEl.innerHTML += '<span style="color:#ffaa00">âš ï¸ No hay sesiÃ³n de Firebase Auth activa.</span>\n';
  }
}

async function ejecutarMigracion() {
  const btn = document.getElementById('btn-migrar-app');
  const logEl = document.getElementById('mig-log');
  if (!btn || !logEl) return;
  btn.disabled = true; btn.textContent = 'Migrando...';
  logEl.innerHTML = '';

  function mlog(msg, color) {
    logEl.innerHTML += '<span style="color:' + (color||'#88aaff') + '">' + msg + '</span>\n';
    logEl.scrollTop = logEl.scrollHeight;
  }

  const TARGET_UID = 'tSKcnxaw6tRJXWlcZKhiXCERKwp2';

  try {
    // Verify auth
    mlog('Paso 1: Verificando sesiÃ³n...', '#88aaff');
    if (!_fbAuth) { mlog('âŒ No hay sesiÃ³n de Firebase Auth.', '#ff4444'); btn.disabled=false; btn.textContent='ğŸš€ Iniciar MigraciÃ³n'; return; }
    if (_fbAuth.uid !== TARGET_UID) { mlog('âŒ UID no coincide: ' + _fbAuth.uid, '#ff4444'); btn.disabled=false; btn.textContent='ğŸš€ Iniciar MigraciÃ³n'; return; }
    mlog('âœ… SesiÃ³n verificada: ' + _fbAuth.email, '#00ff88');

    // Read source
    mlog('\nPaso 2: Leyendo gestorrenta/main...', '#88aaff');
    const mainSnap = await db.collection('gestorrenta').doc('main').get();
    if (!mainSnap.exists) { mlog('âŒ No existe gestorrenta/main', '#ff4444'); btn.disabled=false; btn.textContent='ğŸš€ Iniciar MigraciÃ³n'; return; }
    const mainData = mainSnap.data();
    mlog('âœ… ' + (mainData.rentas||[]).length + ' propiedades, ' + (mainData.clientes||[]).length + ' clientes', '#00ff88');

    // Read users
    mlog('\nPaso 3: Leyendo usuarios...', '#88aaff');
    const usersSnap = await db.collection('gestorrenta').doc('users').get();
    const usersData = usersSnap.exists ? usersSnap.data() : { list: [] };
    mlog('âœ… ' + (usersData.list||[]).length + ' usuarios', '#00ff88');

    // Write to new path
    mlog('\nPaso 4: Escribiendo en tenants/' + TARGET_UID + '/data/main...', '#88aaff');
    await db.collection('tenants').doc(TARGET_UID).collection('data').doc('main').set({
      ...mainData,
      migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
    mlog('âœ… Datos migrados', '#00ff88');

    // Write users
    mlog('\nPaso 5: Migrando usuarios...', '#88aaff');
    await db.collection('tenants').doc(TARGET_UID).collection('data').doc('users').set(usersData);
    mlog('âœ… Usuarios migrados', '#00ff88');

    // Create plan doc
    mlog('\nPaso 6: Configurando plan admin...', '#88aaff');
    await db.collection('tenants').doc(TARGET_UID).set({
      plan: 'admin', nombre: 'Franco', empresa: 'GestorRentas',
      email: _fbAuth.email, createdAt: new Date().toISOString(), stripeStatus: 'active',
    }, { merge: true });
    mlog('âœ… Plan admin configurado', '#00ff88');

    // Verify
    mlog('\nPaso 7: Verificando...', '#88aaff');
    const verSnap = await db.collection('tenants').doc(TARGET_UID).collection('data').doc('main').get();
    mlog('âœ… ' + (verSnap.data().rentas||[]).length + ' propiedades en nuevo path', '#00ff88');

    mlog('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', '#ffffff');
    mlog('ğŸ‰ MIGRACIÃ“N COMPLETADA', '#00ff88');
    mlog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', '#ffffff');
    mlog('Tus datos ahora estÃ¡n en tenants/' + TARGET_UID, '#00ff88');
    mlog('Los datos originales NO fueron eliminados.', '#88aaff');
    btn.textContent = 'âœ… Completado';

    // Reload data from new path
    setTimeout(() => { fbStopSync(); fbStartSync(); }, 1000);

  } catch(e) {
    mlog('\nâŒ Error: ' + e.message, '#ff4444');
    btn.disabled = false; btn.textContent = 'ğŸ”„ Reintentar';
  }
}

// â”€â”€ AYUDA (HELP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAyuda(headerEl) {
  const body = headerEl.nextElementSibling;
  const chevron = headerEl.querySelector('.ayuda-chevron');
  const isOpen = body.style.display !== 'none';
  body.style.display = isOpen ? 'none' : 'block';
  if (chevron) chevron.style.transform = isOpen ? '' : 'rotate(90deg)';
}

function renderExtra() {
  // Populate property selector
  const sel = document.getElementById('extra-prop-sel');
  if (!sel) return;
  const curVal = sel.value;
  sel.innerHTML = '<option value="">â€” Seleccionar propiedad â€”</option>' +
    state.rentas.map(r => {
      const cli = r.clienteId ? state.clientes.find(c => c.id === r.clienteId) : null;
      return `<option value="${r.id}">${r.nombre}${cli ? ' Â· ' + cli.nombre : ' Â· (sin inquilino)'}</option>`;
    }).join('');
  if (curVal) sel.value = curVal;

  const cards = document.getElementById('extra-doc-cards');
  if (!_extraRentaId) {
    cards.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--text3)">
      <div style="font-size:48px;margin-bottom:12px">ğŸ“„</div>
      <div style="font-size:15px;font-weight:600;margin-bottom:6px">Selecciona una propiedad</div>
      <div style="font-size:13px">Elige arriba la propiedad para generar sus documentos legales</div>
    </div>`;
    return;
  }

  const renta = state.rentas.find(r => r.id === _extraRentaId);
  if (!renta) return;
  const cli = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;

  // Info bar
  const info = document.getElementById('extra-prop-inquilino');
  if (info) info.innerHTML = cli
    ? `ğŸ‘¤ ${cli.nombre} Â· ğŸ’° ${fmt(renta.monto)}/mes`
    : `<span style="color:var(--warning)">Sin inquilino asignado</span>`;

  // Cards
  cards.innerHTML = DOCS_EXTRA.map(doc => `
    <div class="doc-card" onclick="generarDocExtra('${doc.id}')">
      <div class="doc-card-icon">${doc.icon}</div>
      <div class="doc-card-title">${doc.title}</div>
      <div class="doc-card-desc">${doc.desc}</div>
      <button class="btn btn-primary doc-card-btn" onclick="event.stopPropagation();generarDocExtra('${doc.id}')">
        Generar documento â†—
      </button>
    </div>`).join('');
}

function extraCambiarPropiedad() {
  _extraRentaId = document.getElementById('extra-prop-sel').value || null;
  renderExtra();
}

function generarDocExtra(tipo) {
  const renta = state.rentas.find(r => r.id === _extraRentaId);
  if (!renta) return;
  const cli = renta.clienteId ? state.clientes.find(c => c.id === renta.clienteId) : null;
  const fp = renta.formaPagoId ? state.formasPago.find(f => f.id === renta.formaPagoId) : null;
  const hoy = new Date().toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric' });
  const ciudad = 'Chihuahua, Chihuahua'; // Can be made configurable

  // Helpers
  const prop = renta.nombre || '____________________';
  const inquilino = cli?.nombre || '____________________';
  const arrendador = '____________________'; // Owner name â€” configurable in future
  const monto = fmt(renta.monto || 0);
  const montoLetras = '(' + (renta.monto || 0).toLocaleString('es-MX') + '/100 M.N.)';
  const dia = renta.dia || '____';
  const inicio = renta.inicio ? fmtDate(renta.inicio) : '____________________';
  const fin = renta.fin ? fmtDate(renta.fin) : '____________________';
  const deposito = fmt((renta.monto || 0) * 2); // Standard 2 months deposit

  let titulo = '';
  let texto = '';

  if (tipo === 'contrato') {
    titulo = 'Contrato de Arrendamiento';
    texto = `CONTRATO DE ARRENDAMIENTO

En la ciudad de ${ciudad}, siendo el dÃ­a ${hoy}, comparecen:

EL ARRENDADOR: ${arrendador}, en adelante "el Arrendador".
EL ARRENDATARIO: ${inquilino}, en adelante "el Arrendatario".
${cli?.tel ? 'TelÃ©fono: ' + cli.tel : ''}
${cli?.email ? 'Correo: ' + cli.email : ''}

Ambas partes, con plena capacidad legal, convienen en celebrar el presente Contrato de Arrendamiento al tenor de las siguientes:

CLÃUSULAS

PRIMERA. OBJETO DEL CONTRATO.
El Arrendador da en arrendamiento al Arrendatario el inmueble ubicado en: ${prop}, en adelante "el Inmueble", el cual el Arrendatario declara conocer y recibir a su entera satisfacciÃ³n.

SEGUNDA. DESTINO DEL INMUEBLE.
El Arrendatario se obliga a destinar el Inmueble exclusivamente a uso habitacional, sin poder subarrendarlo ni cederlo sin autorizaciÃ³n escrita del Arrendador.

TERCERA. VIGENCIA.
El presente contrato tendrÃ¡ vigencia del ${inicio} al ${fin}. Al tÃ©rmino del plazo, si ninguna de las partes da aviso de terminaciÃ³n con al menos 30 dÃ­as de anticipaciÃ³n, se considerarÃ¡ prorrogado por perÃ­odos iguales.

CUARTA. RENTA MENSUAL.
Las partes acuerdan una renta mensual de ${monto} ${montoLetras}, que el Arrendatario se obliga a pagar puntualmente a mÃ¡s tardar el dÃ­a ${dia} de cada mes.${fp ? '\nForma de pago acordada: ' + fp.nombre + '.' : ''}

QUINTA. DEPÃ“SITO EN GARANTÃA.
Al momento de la firma, el Arrendatario entrega al Arrendador la cantidad de ${deposito} en concepto de depÃ³sito en garantÃ­a, el cual serÃ¡ devuelto al tÃ©rmino del contrato previa verificaciÃ³n del estado del Inmueble.

SEXTA. SERVICIOS.
Los servicios de agua, luz, gas y demÃ¡s que se generen durante la vigencia del contrato correrÃ¡n por cuenta del Arrendatario, quien se obliga a mantenerlos al corriente.

SÃ‰PTIMA. CONSERVACIÃ“N Y REPARACIONES.
El Arrendatario se obliga a conservar el Inmueble en buen estado y a realizar las reparaciones menores derivadas del uso ordinario. Las reparaciones mayores serÃ¡n responsabilidad del Arrendador.

OCTAVA. MASCOTAS Y MODIFICACIONES.
Queda prohibido tener mascotas y realizar modificaciones al Inmueble sin autorizaciÃ³n escrita del Arrendador.

NOVENA. TERMINACIÃ“N ANTICIPADA.
En caso de que el Arrendatario desee terminar el contrato anticipadamente, deberÃ¡ dar aviso por escrito con 30 dÃ­as de anticipaciÃ³n y estarÃ¡ obligado a cubrir los meses restantes del perÃ­odo acordado.

DÃ‰CIMA. AVAL.
${cli?.avalNombre ? `El C. ${cli.avalNombre}${cli.avalTel ? ', Tel: ' + cli.avalTel : ''}, se constituye como aval solidario de todas las obligaciones del Arrendatario derivadas del presente contrato.` : 'C. ____________________, se constituye como aval solidario de todas las obligaciones del Arrendatario derivadas del presente contrato.'}

DÃ‰CIMA PRIMERA. JURISDICCIÃ“N.
Para la interpretaciÃ³n y cumplimiento del presente contrato, las partes se someten expresamente a las leyes aplicables y a la jurisdicciÃ³n de los Tribunales competentes de ${ciudad}, renunciando al fuero que pudiera corresponderles por razÃ³n de su domicilio presente o futuro.

LeÃ­do el presente contrato y enterados de su contenido y alcance legal, las partes lo firman de conformidad en la ciudad y fecha seÃ±aladas.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EL ARRENDADOR                     EL ARRENDATARIO
${arrendador}                      ${inquilino}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EL AVAL
${cli?.avalNombre || '____________________'}
`;
  }

  else if (tipo === 'ficha') {
    titulo = 'Ficha de PresentaciÃ³n';
    texto = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PROPIEDAD EN RENTA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ  ${prop}
ğŸ·ï¸ Tipo: ${renta.tipo || 'Propiedad'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATOS DE LA RENTA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’° Renta mensual:    ${monto}
ğŸ“… Disponible desde: ${inicio || '____________________'}
ğŸ”‘ DepÃ³sito:         ${deposito} (2 meses)
ğŸ“† DÃ­a de pago:      DÃ­a ${dia} de cada mes
${fp ? 'ğŸ’³ Forma de pago: ' + fp.nombre : ''}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CARACTERÃSTICAS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${renta.notas || 'â€¢ Escribe aquÃ­ las caracterÃ­sticas de la propiedad:\n  habitaciones, baÃ±os, estacionamiento, etc.'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SERVICIOS INCLUIDOS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${(renta.servicios||[]).length
  ? (renta.servicios||[]).map(s => `â€¢ ${s.nombre}${s.cuenta ? ' (No. ' + s.cuenta + ')' : ''}`).join('\n')
  : 'â€¢ ____________________\nâ€¢ ____________________'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CONTACTO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ Tel: ____________________
ğŸ“§ Email: ____________________

Generado el ${hoy}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
  }

  else if (tipo === 'entrega') {
    titulo = 'Acta de Entrega / RecepciÃ³n';
    const inventario = renta.inventario || [];
    texto = `ACTA DE ENTREGA DEL INMUEBLE

Lugar y fecha: ${ciudad}, ${hoy}

DATOS DE LAS PARTES:
Arrendador: ${arrendador}
Arrendatario: ${inquilino}
Inmueble: ${prop}

Por medio del presente documento, el Arrendador hace entrega formal del Inmueble antes descrito al Arrendatario, quien lo recibe en las condiciones siguientes:

ESTADO GENERAL DEL INMUEBLE:
â–¡ Bueno    â–¡ Regular    â–¡ Con observaciones (ver abajo)

LLAVES ENTREGADAS:
â€¢ Llave principal:      ____ juego(s)
â€¢ Llave de garage:      ____ juego(s)
â€¢ Control remoto:       ____ pieza(s)
â€¢ Otros: ____________________

${inventario.length ? `INVENTARIO DE BIENES INCLUIDOS:
${inventario.map(it => `â€¢ ${it.nombre} (${it.cantidad||1} pieza${(it.cantidad||1)>1?'s':''}) â€” Estado: ${it.estado==='malo'?'Malo':it.estado==='regular'?'Regular':'Bueno'}`).join('\n')}` : `INVENTARIO DE BIENES INCLUIDOS:
â€¢ ____________________
â€¢ ____________________
â€¢ ____________________`}

OBSERVACIONES Y CONDICIONES ESPECIALES:
________________________________________________________
________________________________________________________
________________________________________________________

Con la firma del presente documento, el Arrendatario declara haber recibido el Inmueble y todos los bienes descritos a su entera satisfacciÃ³n, comprometiÃ©ndose a devolverlos en las mismas condiciones al tÃ©rmino del contrato.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ENTREGA: EL ARRENDADOR            RECIBE: EL ARRENDATARIO
${arrendador}                      ${inquilino}

Fecha: ______________________     Fecha: ______________________
`;
  }

  else if (tipo === 'deposito') {
    titulo = 'Recibo de DepÃ³sito en GarantÃ­a';
    texto = `RECIBO DE DEPÃ“SITO EN GARANTÃA

Folio: ____________

Lugar y fecha: ${ciudad}, ${hoy}

Por medio del presente recibo, yo ${arrendador}, en calidad de Arrendador del inmueble ubicado en:

${prop}

DECLARO HABER RECIBIDO:

Del C. ${inquilino}, en calidad de Arrendatario, la cantidad de:

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
${deposito}
(Equivalente a dos meses de renta)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

Concepto: DepÃ³sito en garantÃ­a correspondiente al contrato de arrendamiento con vigencia del ${inicio} al ${fin}.

CONDICIONES DE DEVOLUCIÃ“N:
El depÃ³sito serÃ¡ devuelto Ã­ntegramente al Arrendatario al tÃ©rmino del contrato siempre que:
1. El inmueble sea entregado en las condiciones en que fue recibido.
2. No existan adeudos de renta, servicios o reparaciones pendientes.
3. Se haya dado aviso previo de desocupaciÃ³n conforme al contrato.

En caso de daÃ±os o adeudos, el Arrendador podrÃ¡ descontar del depÃ³sito las cantidades correspondientes.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
QUIEN RECIBE: ARRENDADOR          QUIEN ENTREGA: ARRENDATARIO
${arrendador}                      ${inquilino}
${cli?.tel ? 'Tel: ' + cli.tel : ''}

Fecha: ______________________     Fecha: ______________________
`;
  }

  else if (tipo === 'salida') {
    titulo = 'Acta de DevoluciÃ³n / Salida';
    const inventario = renta.inventario || [];
    texto = `ACTA DE DEVOLUCIÃ“N Y SALIDA DEL INMUEBLE

Lugar y fecha: ${ciudad}, ${hoy}

DATOS:
Arrendador: ${arrendador}
Arrendatario: ${inquilino}
Inmueble: ${prop}
Contrato vigente: ${inicio} al ${fin}

Por medio del presente documento, el Arrendatario hace devoluciÃ³n formal del Inmueble al Arrendador, quien lo recibe en las siguientes condiciones:

ESTADO GENERAL AL MOMENTO DE LA ENTREGA:
â–¡ Bueno    â–¡ Regular    â–¡ Con observaciones (ver abajo)

LLAVES DEVUELTAS:
â€¢ Llave principal:      ____ juego(s)
â€¢ Llave de garage:      ____ juego(s)
â€¢ Control remoto:       ____ pieza(s)
â€¢ Otros: ____________________

${inventario.length ? `VERIFICACIÃ“N DE INVENTARIO:
${inventario.map(it => `â€¢ ${it.nombre} (${it.cantidad||1} pza) â€” Estado al entrar: ${it.estado==='malo'?'Malo':it.estado==='regular'?'Regular':'Bueno'} â€” Estado al salir: ____________`).join('\n')}` : `VERIFICACIÃ“N DE INVENTARIO:
â€¢ ____________________  Estado al salir: ____________
â€¢ ____________________  Estado al salir: ____________`}

SERVICIOS AL CORRIENTE:
â–¡ Luz        â–¡ Agua       â–¡ Gas       â–¡ Internet
â–¡ Otros: ____________________

ADEUDOS PENDIENTES:
â–¡ Sin adeudos
â–¡ Con adeudos por: $____________________ concepto: ____________________

RESOLUCIÃ“N DEL DEPÃ“SITO (${deposito}):
â–¡ Se devuelve Ã­ntegramente al Arrendatario
â–¡ Se devuelve parcialmente: $______________ (descontando $___________ por: ____________)
â–¡ Se retiene por adeudos o daÃ±os (ver detalle en observaciones)

OBSERVACIONES:
________________________________________________________
________________________________________________________

Con la firma del presente documento, ambas partes dan por terminado el contrato de arrendamiento sin ulterior reclamaciÃ³n, salvo lo expresamente indicado.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EL ARRENDADOR                     EL ARRENDATARIO
${arrendador}                      ${inquilino}

Fecha: ______________________     Fecha: ______________________
TESTIGO 1: ____________________   TESTIGO 2: ____________________
`;
  }

  else if (tipo === 'rescision') {
    titulo = 'RescisiÃ³n de Contrato de Arrendamiento';
    // Detect clauses violated â€” build list from renta data
    const saldoPend = (() => {
      try { return getStatusRenta(renta).saldo; } catch(e) { return 0; }
    })();
    const mesesAdeudo = saldoPend > 0 ? Math.ceil(saldoPend / (renta.monto||1)) : 0;

    texto = `RESCISIÃ“N DE CONTRATO DE ARRENDAMIENTO

En la ciudad de ${ciudad}, siendo el dÃ­a ${hoy}, comparecen:

EL ARRENDADOR: ${arrendador}, en adelante "el Arrendador".
EL ARRENDATARIO: ${inquilino}, en adelante "el Arrendatario".
${cli?.tel ? 'TelÃ©fono del Arrendatario: ' + cli.tel : ''}
${cli?.email ? 'Correo del Arrendatario: ' + cli.email : ''}

ANTECEDENTES:
Con fecha ${inicio}, las partes celebraron un Contrato de Arrendamiento sobre el inmueble
ubicado en: ${prop}, con vigencia hasta el ${fin} y una renta mensual de ${monto}.

CAUSAS DE RESCISIÃ“N:
El Arrendador manifiesta que el Arrendatario ha incurrido en los siguientes incumplimientos,
que constituyen causal de rescisiÃ³n conforme al contrato celebrado y la legislaciÃ³n vigente:

${saldoPend > 0
  ? `â–¡ [X] FALTA DE PAGO. El Arrendatario presenta un saldo vencido de ${fmt(saldoPend)},
         equivalente a aproximadamente ${mesesAdeudo} mes(es) de renta sin cubrir,
         incumpliendo la ClÃ¡usula Cuarta del contrato.`
  : `â–¡ [ ] FALTA DE PAGO. Monto adeudado: $____________________`}

â–¡ [ ] USO INDEBIDO DEL INMUEBLE. El Arrendatario ha destinado el inmueble a un uso
       distinto al pactado, en contravenciÃ³n a la ClÃ¡usula Segunda del contrato.

â–¡ [ ] SUBARRENDAMIENTO NO AUTORIZADO. El Arrendatario ha subarrendado o cedido el
       uso del inmueble sin consentimiento escrito del Arrendador, violando la ClÃ¡usula Segunda.

â–¡ [ ] DAÃ‘OS AL INMUEBLE. El Arrendatario ha causado daÃ±os al inmueble que exceden el
       desgaste natural por uso ordinario, en contravenciÃ³n a la ClÃ¡usula SÃ©ptima.

â–¡ [ ] ALTERACIONES NO AUTORIZADAS. El Arrendatario realizÃ³ modificaciones o
       remodelaciones al inmueble sin autorizaciÃ³n escrita, violando la ClÃ¡usula Octava.

â–¡ [ ] SERVICIOS IMPAGOS. El Arrendatario no ha cubierto los servicios a su cargo
       (luz, agua, gas u otros), poniendo en riesgo el inmueble.

â–¡ [ ] OTRO INCUMPLIMIENTO: _________________________________________________
       ______________________________________________________________________

EFECTOS DE LA RESCISIÃ“N:
En virtud de lo anterior, el Arrendador declara rescindido el presente contrato, con los
siguientes efectos:

1. DESOCUPACIÃ“N. El Arrendatario deberÃ¡ desocupar y entregar el inmueble libre de
   personas y bienes, en perfectas condiciones de limpieza y conservaciÃ³n, a mÃ¡s tardar
   el dÃ­a: __________________ (plazo mÃ¡ximo de 15 dÃ­as naturales a partir de este aviso).

2. ADEUDOS. El Arrendatario queda obligado a cubrir los adeudos pendientes de renta y
   servicios hasta la fecha de desocupaciÃ³n efectiva:
   Saldo pendiente de renta:  ${saldoPend > 0 ? fmt(saldoPend) : '$____________________'}
   Servicios pendientes:       $____________________
   DaÃ±os al inmueble:          $____________________
   TOTAL A CUBRIR:             $____________________

3. DEPÃ“SITO EN GARANTÃA. El depÃ³sito en garantÃ­a de ${deposito} quedarÃ¡ retenido por
   el Arrendador y se aplicarÃ¡ al pago de los adeudos y daÃ±os detallados. En caso de que
   el depÃ³sito sea insuficiente, el Arrendatario se obliga a cubrir la diferencia.

4. PENALIDAD POR RESCISIÃ“N. Conforme a lo pactado en la ClÃ¡usula Novena, el
   Arrendatario deberÃ¡ cubrir adicionalmente la penalidad de: $____________________

5. ACCIONES LEGALES. El incumplimiento de los tÃ©rminos de este documento faculta al
   Arrendador para ejercer las acciones legales correspondientes ante los tribunales
   competentes de ${ciudad}, incluyendo el proceso de desahucio y cobro de adeudos.

ACUSE DE RECIBO:
El Arrendatario declara haber recibido el presente aviso de rescisiÃ³n y estar enterado
de su contenido, plazos y consecuencias legales.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EL ARRENDADOR                     EL ARRENDATARIO
${arrendador}                      ${inquilino}

Firma: ______________________     Firma: ______________________
Fecha: ${hoy}                      Fecha: ______________________
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TESTIGO
Nombre: ____________________
Firma:  ____________________
Fecha:  ____________________

Documento generado por GestorRenta â€” ${hoy}
`;
  }

  _docTextoActual = texto;
  _docTituloActual = titulo;
  document.getElementById('doc-extra-title').textContent = titulo;
  document.getElementById('doc-extra-body').textContent = texto;
  openModal('modalDocExtra');
}

function imprimirDocExtra() {
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>${_docTituloActual}</title>
  <style>
    body { font-family: Georgia, serif; max-width: 720px; margin: 30px auto; font-size: 13px; line-height: 1.9; color: #111; }
    pre { white-space: pre-wrap; font-family: Georgia, serif; }
    @media print { body { margin: 15mm 20mm; } }
  </style></head>
  <body><pre>${_docTextoActual.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
  <script>window.onload = () => { setTimeout(() => window.print(), 300); }<\/script>
  </body></html>`);
  win.document.close();
}

function copiarDocExtra() {
  navigator.clipboard.writeText(_docTextoActual).then(() => {
    const btn = event.currentTarget;
    const orig = btn.innerHTML;
    btn.innerHTML = 'âœ… Â¡Copiado!';
    setTimeout(() => btn.innerHTML = orig, 2000);
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = _docTextoActual;
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('Â¡Copiado!');
  });
}
// ============================================================
// BIOMETRIC LOGIN â€” WebAuthn (Face ID / Touch ID / Huella)
// ============================================================

// Keys for localStorage
const BIO_CRED_KEY = 'gestorrenta_bio_cred';   // {userId, credId (base64), username}
const BIO_AVAILABLE = typeof PublicKeyCredential !== 'undefined';

// Helpers: ArrayBuffer <-> base64url
function ab2b64(buf) {
  return btoa(String.fromCharCode(...new Uint8Array(buf)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}
function b642ab(str) {
  str = str.replace(/-/g,'+').replace(/_/g,'/');
  while (str.length % 4) str += '=';
  return Uint8Array.from(atob(str), c => c.charCodeAt(0)).buffer;
}

// Detect biometric icon based on platform
function bioIcon() {
  const ua = navigator.userAgent;
  if (/iPhone|iPad/.test(ua)) return 'ğŸ”’'; // Face ID / Touch ID
  if (/Android/.test(ua)) return 'ğŸ‘†';      // Fingerprint
  if (/Mac/.test(ua)) return 'ğŸ”’';          // Touch ID macOS
  return 'ğŸ”’';
}

// Init: check if biometric credential is registered, show button
function bioInit() {
  if (!BIO_AVAILABLE) return;
  const cred = getBioCred();
  const wrap = document.getElementById('bio-login-wrap');
  if (!wrap) return;
  if (cred) {
    const icon = bioIcon();
    document.getElementById('bio-icon').textContent = icon;
    document.getElementById('bio-btn-label').textContent =
      /iPhone|iPad|Mac/.test(navigator.userAgent) ? 'Entrar con Face ID / Touch ID' : 'Entrar con huella digital';
    document.getElementById('bio-btn-user').textContent = cred.username;
    wrap.style.display = '';
    document.getElementById('login-user').value = cred.username;
  } else {
    wrap.style.display = 'none';
  }
  // Update dropdown label
  updateBioDropdownLabel();
}

function getBioCred() {
  try { return JSON.parse(localStorage.getItem(BIO_CRED_KEY) || 'null'); } catch(e){ return null; }
}

function updateBioDropdownLabel() {
  const el = document.getElementById('dd-bio-label');
  if (!el) return;
  const cred = getBioCred();
  if (cred) {
    el.textContent = 'ğŸ”’ Face ID / Huella: Activado âœ…';
  } else {
    el.textContent = 'ğŸ”’ Activar Face ID / Huella';
  }
}

// â”€â”€ REGISTER biometric for current user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bioRegister(user) {
  if (!BIO_AVAILABLE) {
    alert('Tu dispositivo o navegador no soporta autenticaciÃ³n biomÃ©trica.\n\niOS: usa Safari. Android: Chrome. Mac: Safari o Chrome.');
    return false;
  }
  // Check if platform authenticator is available
  try {
    const avail = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    if (!avail) {
      alert('No se detectÃ³ Face ID, Touch ID ni huella digital en este dispositivo.');
      return false;
    }
  } catch(e) {}

  const challenge = crypto.getRandomValues(new Uint8Array(32));
  const userId = crypto.getRandomValues(new Uint8Array(16));

  try {
    const cred = await navigator.credentials.create({
      publicKey: {
        challenge,
        rp: { name: 'GestorRenta', id: location.hostname || 'localhost' },
        user: {
          id: userId,
          name: user.username,
          displayName: user.nombre || user.username,
        },
        pubKeyCredParams: [
          { type: 'public-key', alg: -7  },  // ES256
          { type: 'public-key', alg: -257 }, // RS256
        ],
        authenticatorSelection: {
          authenticatorAttachment: 'platform',
          userVerification: 'required',
          requireResidentKey: false,
        },
        timeout: 60000,
      }
    });

    // Save credential id (we only need it to identify the credential)
    const credData = {
      userId: user.id,
      username: user.username,
      credId: ab2b64(cred.rawId),
    };
    localStorage.setItem(BIO_CRED_KEY, JSON.stringify(credData));
    updateBioDropdownLabel();
    bioInit();
    return true;
  } catch(e) {
    if (e.name !== 'NotAllowedError') {
      console.error('WebAuthn register error:', e);
    }
    return false;
  }
}

// â”€â”€ AUTHENTICATE with biometric â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bioLogin() {
  const cred = getBioCred();
  if (!cred) return;

  const btn = document.getElementById('bio-login-btn');
  btn.classList.add('loading');
  document.getElementById('login-error').textContent = '';

  const challenge = crypto.getRandomValues(new Uint8Array(32));

  try {
    const assertion = await navigator.credentials.get({
      publicKey: {
        challenge,
        allowCredentials: [{
          type: 'public-key',
          id: b642ab(cred.credId),
          transports: ['internal'],
        }],
        userVerification: 'required',
        timeout: 60000,
      }
    });

    // Auth passed â€” find user and log in
    const users = loadUsers();
    const user = users.find(u => u.id === cred.userId);
    if (!user) {
      document.getElementById('login-error').textContent = 'Usuario no encontrado. Reactiva Face ID.';
      localStorage.removeItem(BIO_CRED_KEY);
      bioInit();
      btn.classList.remove('loading');
      return;
    }
    // Log in directly
    currentUser = user;
    sessionStorage.setItem('gestorrenta_session', JSON.stringify({id: user.id, ts: Date.now()}));
    document.getElementById('loginScreen').style.display = 'none';
    applyPermissions();
    render();
  } catch(e) {
    if (e.name === 'NotAllowedError') {
      document.getElementById('login-error').textContent = 'AutenticaciÃ³n cancelada.';
    } else {
      document.getElementById('login-error').textContent = 'Error biomÃ©trico. Usa usuario y contraseÃ±a.';
      console.error('WebAuthn auth error:', e);
    }
  }
  btn.classList.remove('loading');
}

// â”€â”€ SETUP from user dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bioSetupFromDropdown() {
  if (!BIO_AVAILABLE) {
    alert('Tu dispositivo no soporta autenticaciÃ³n biomÃ©trica.\n\niOS: usa Safari\nAndroid: usa Chrome\nMac: Safari o Chrome');
    return;
  }
  const existingCred = getBioCred();
  if (existingCred) {
    // Ask if they want to remove or re-register
    const action = confirm(
      `Face ID / Huella estÃ¡ activado para: ${existingCred.username}\n\n` +
      `Â¿Deseas DESACTIVARLO?\n\n(Cancela para mantenerlo activo)`
    );
    if (action) {
      localStorage.removeItem(BIO_CRED_KEY);
      bioInit();
      mostrarToastExito('ğŸ”“ Face ID / Huella desactivado');
    }
    return;
  }
  // Register for current user
  if (!currentUser) { alert('Inicia sesiÃ³n primero.'); return; }
  const ok = await bioRegister(currentUser);
  if (ok) {
    mostrarToastExito('âœ… Face ID / Huella activado para ' + currentUser.username);
  } else {
    alert('No se pudo activar. AsegÃºrate de usar Safari en iPhone o Chrome en Android.');
  }
}

// â”€â”€ Offer biometric registration after first successful login â”€â”€
async function ofrecerBioRegistro(user) {
  if (!BIO_AVAILABLE) return;
  // Don't offer if already registered
  if (getBioCred()) return;
  // Don't offer more than once per session
  if (sessionStorage.getItem('bio_offer_shown')) return;
  sessionStorage.setItem('bio_offer_shown', '1');

  try {
    const avail = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
    if (!avail) return;
  } catch(e) { return; }

  // Small delay so login screen has hidden
  setTimeout(() => {
    const icon = /iPhone|iPad/.test(navigator.userAgent) ? 'Face ID / Touch ID' :
                 /Android/.test(navigator.userAgent) ? 'huella digital' : 'Face ID / Touch ID';
    const ok = confirm(
      `Â¿Activar ${icon} para entrar mÃ¡s rÃ¡pido?\n\n` +
      `La prÃ³xima vez solo necesitarÃ¡s tu ${icon} para acceder a GestorRenta.`
    );
    if (ok) bioRegister(user);
  }, 800);
}
// ============================================================
// IMPORTAR ABONOS MASIVOS DESDE EXCEL
// ============================================================

function descargarPlantillaAbonos() {
  if (!window.XLSX) {
    loadSheetJS(() => descargarPlantillaAbonos());
    alert('Cargando librerÃ­a, intenta en 3 segundos...');
    return;
  }

  const wb = XLSX.utils.book_new();

  // â”€â”€ Hoja de abonos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const headers = [
    'Propiedad (nombre exacto)',
    'Cliente que pagÃ³',
    'Monto',
    'Fecha (YYYY-MM-DD)',
    'Concepto / Nota',
    'Forma de pago'
  ];

  // Example row (commented out â€” data rows start directly)
  const ejemplo = [
    '(Ejemplo) ' + (state.rentas[0]?.nombre || 'Nombre de propiedad'),
    state.rentas[0]?.clienteId
      ? (state.clientes.find(c => c.id === state.rentas[0].clienteId)?.nombre || 'Nombre del inquilino')
      : 'Nombre del inquilino',
    state.rentas[0]?.monto || 5000,
    new Date().toISOString().slice(0,10),
    'Saldo al corriente',
    'Transferencia'
  ];

  // Data rows â€” one per property with client info pre-filled
  const dataRows = state.rentas.map(r => {
    const cli = r.clienteId ? state.clientes.find(c => c.id === r.clienteId) : null;
    return [
      r.nombre,
      cli ? cli.nombre : '',
      r.monto || '',
      new Date().toISOString().slice(0,10),
      'Saldo al corriente',
      ''
    ];
  });

  const wsData = [
    ['PLANTILLA DE ABONOS â€” GestorRentas'],
    ['Instrucciones: Llena el Monto, Fecha y Concepto para cada propiedad. No cambies los nombres de propiedades.'],
    [''],
    headers,
    ejemplo,
    ...dataRows
  ];

  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Styles/widths
  ws['!cols'] = [
    {wch: 40}, {wch: 30}, {wch: 12}, {wch: 16}, {wch: 30}, {wch: 20}
  ];
  ws['!merges'] = [{s:{r:0,c:0}, e:{r:0,c:5}}];

  XLSX.utils.book_append_sheet(wb, ws, 'Abonos');

  // â”€â”€ Hoja de referencia de propiedades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const refHeaders = ['Propiedad', 'Cliente actual', 'Precio de renta', 'Abonos existentes'];
  const refRows = state.rentas.map(r => {
    const cli = r.clienteId ? state.clientes.find(c => c.id === r.clienteId) : null;
    const totalAbonos = (r.abonos||[]).reduce((s,a) => s+Number(a.monto||0), 0);
    return [r.nombre, cli?.nombre||'Sin inquilino', r.monto||0, totalAbonos];
  });
  const wsRef = XLSX.utils.aoa_to_sheet([refHeaders, ...refRows]);
  wsRef['!cols'] = [{wch:40},{wch:30},{wch:16},{wch:18}];
  XLSX.utils.book_append_sheet(wb, wsRef, 'Referencia');

  XLSX.writeFile(wb, 'plantilla_abonos.xlsx');
}

function importarAbonos(input) {
  const file = input.files[0];
  if (!file) return;
  if (!window.XLSX) {
    loadSheetJS(() => importarAbonos(input));
    alert('Cargando librerÃ­a, intenta en 3 segundos...');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const wb = XLSX.read(e.target.result, {type:'array'});

      // Search all sheets for the Abonos sheet first, then any sheet
      let raw = null, headerIdx = -1;
      const sheetOrder = ['Abonos', ...wb.SheetNames.filter(n => n !== 'Abonos')];
      for (const sheetName of sheetOrder) {
        if (!wb.Sheets[sheetName]) continue;
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
        // Look for a row that has 'propiedad' and 'monto' in SEPARATE cells
        // and at least 3 non-empty cells (to avoid matching instruction rows)
        const idx = rows.findIndex(r => {
          const cells = r.map(c => String(c).toLowerCase().trim());
          const nonEmpty = cells.filter(c => c).length;
          if (nonEmpty < 3) return false;
          const hasProp  = cells.some(c => c.startsWith('propiedad'));
          const hasMonto = cells.some(c => c === 'monto' || c.startsWith('monto ('));
          return hasProp && hasMonto;
        });
        if (idx !== -1) { raw = rows; headerIdx = idx; break; }
      }

      if (!raw || headerIdx === -1) {
        alert('No se encontrÃ³ la fila de encabezados. Usa la plantilla oficial descargada desde GestorRentas.');
        return;
      }

      const headers = raw[headerIdx].map(h => String(h).toLowerCase().trim());
      const iPropiedad = headers.findIndex(h => h.startsWith('propiedad'));
      const iCliente   = headers.findIndex(h => h.startsWith('cliente'));
      const iMonto     = headers.findIndex(h => h === 'monto' || h.startsWith('monto ('));
      const iFecha     = headers.findIndex(h => h.startsWith('fecha'));
      const iNota      = headers.findIndex(h => h.startsWith('concepto') || h.startsWith('nota'));
      const iForma     = headers.findIndex(h => h.startsWith('forma'));

      // Skip the example row (first row after header if it matches example text)
      let dataStart = headerIdx + 1;
      if (raw[dataStart] && String(raw[dataStart][iPropiedad]||'').toLowerCase().includes('ejemplo')) {
        dataStart++;
      }

      // Include ALL rows after header that have a property name and valid monto > 0
      const dataRows = raw.slice(dataStart)
        .filter(r => {
          const prop = String(r[iPropiedad] || '').trim();
          if (!prop || prop === headers[iPropiedad]) return false; // skip if same as header
          const raw_monto = r[iMonto];
          const m = typeof raw_monto === 'number' ? raw_monto
            : parseFloat(String(raw_monto || '').replace(/[^0-9.-]/g, ''));
          return !isNaN(m) && m > 0;
        });

      if (dataRows.length === 0) {
        alert('No se encontraron abonos con monto mayor a 0. AsegÃºrate de llenar la columna Monto.');
        return;
      }

      let aplicados = 0;
      let noEncontradas = [];

      dataRows.forEach(row => {
        const nombreProp = String(row[iPropiedad]).trim();
        const monto      = parseFloat(String(row[iMonto]).replace(/[^0-9.]/g, '')) || 0;
        const fecha      = row[iFecha]
          ? (typeof row[iFecha] === 'number'
              ? new Date(Math.round((row[iFecha] - 25569) * 86400 * 1000)).toISOString().slice(0,10)
              : String(row[iFecha]).trim())
          : new Date().toISOString().slice(0,10);
        const nota       = iNota   !== -1 ? String(row[iNota]||'').trim()  : 'Saldo al corriente';
        const forma      = iForma  !== -1 ? String(row[iForma]||'').trim() : '';
        const clienteNom = iCliente !== -1 ? String(row[iCliente]||'').trim() : '';

        // Find property by name (case-insensitive, partial match)
        const renta = state.rentas.find(r =>
          r.nombre.toLowerCase().trim() === nombreProp.toLowerCase() ||
          r.nombre.toLowerCase().includes(nombreProp.toLowerCase())
        );

        if (!renta) { noEncontradas.push(nombreProp); return; }

        if (!renta.abonos) renta.abonos = [];
        renta.abonos.push({
          id:          uid(),
          monto:       monto,
          fecha:       fecha,
          metodo:      forma || 'Importado',
          formaPagoId: '',
          mes:         fecha.slice(0,7),
          nota:        nota + (clienteNom ? ` â€” ${clienteNom}` : ''),
        });
        aplicados++;
      });

      save();
      render();
      input.value = '';

      let msg = `âœ… ${aplicados} abono${aplicados!==1?'s':''} importado${aplicados!==1?'s':''} correctamente.`;
      if (noEncontradas.length) {
        msg += `\n\nâš ï¸ No se encontraron estas propiedades:\nâ€¢ ${noEncontradas.join('\nâ€¢ ')}`;
      }
      alert(msg);

    } catch(err) {
      console.error('importarAbonos error:', err);
      alert('Error al leer el archivo. AsegÃºrate de usar la plantilla oficial (.xlsx).');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ============================================================
// INIT
// ============================================================

// â”€â”€ Fixed header offset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adjustHeaderOffset() {
  const h = document.querySelector('.header');
  const main = document.querySelector('.main');
  const layout = document.querySelector('.layout');
  if (!h || !main) return;
  const hh = h.offsetHeight;
  if (window.innerWidth <= 768) {
    main.style.paddingTop = (hh + 10) + 'px';
    if (layout) layout.style.paddingTop = '0';
  } else {
    if (layout) layout.style.paddingTop = hh + 'px';
    main.style.paddingTop = '';
  }
}
window.addEventListener('resize', adjustHeaderOffset);
// Global error handler to help debug
window.onerror = function(msg, url, line, col, error) {
  console.error('Global error:', msg, 'Line:', line);
  const errEl = document.getElementById('login-error');
  if (errEl && document.getElementById('loginScreen').style.display !== 'none') {
    errEl.textContent = 'âš ï¸ Error en lÃ­nea ' + line + ': ' + msg;
  }
};

async function initApp() {
  // Set up modal overlay close-on-backdrop
  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
  });

  // Show loading while connecting to Firebase
  fbShowLoading('Conectando a la nube...');

  // Load users from Firebase (needed for login)
  try {
    const fbUsers = await fbLoadUsers();
    if (fbUsers && fbUsers.length) {
      localStorage.setItem('gestorrenta_users', JSON.stringify(fbUsers));
    }
  } catch(e) {
    console.warn('Could not load users from Firebase:', e);
  }

  fbHideLoading();
  bioInit();

  if (checkSession()) {
    document.getElementById('loginScreen').style.display = 'none';
    applyPermissions();
    // Start real-time sync
    fbStartSync();
    render();
    updateBioDropdownLabel();
    fbShowStatus(true);
  }

  // Pre-load SheetJS in background
  setTimeout(() => loadSheetJS(), 3000);

  // Online/offline detection
  window.addEventListener('online',  () => { fbShowStatus(true);  fbStartSync(); });
  window.addEventListener('offline', () => { fbShowStatus(false); });
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}

// ============================================================
// PWA â€” MANIFEST + SERVICE WORKER + INSTALL PROMPT
// ============================================================
(function() {
  // â”€â”€ SVG icon as base64 data URI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
    <defs>
      <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#1b4332"/>
        <stop offset="100%" stop-color="#2d6a4f"/>
      </linearGradient>
      <linearGradient id="gold" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="#e2c97e"/>
        <stop offset="100%" stop-color="#c8a85a"/>
      </linearGradient>
    </defs>
    <rect width="512" height="512" rx="108" fill="url(#bg)"/>
    <!-- House roof -->
    <path d="M256 100 L400 210 L380 210 L380 370 L310 370 L310 280 L202 280 L202 370 L132 370 L132 210 L112 210 Z" fill="none" stroke="url(#gold)" stroke-width="18" stroke-linejoin="round" stroke-linecap="round"/>
    <!-- Door -->
    <rect x="222" y="290" width="68" height="80" rx="6" fill="url(#gold)" opacity="0.35"/>
    <!-- Key symbol inside door -->
    <circle cx="256" cy="325" r="14" fill="none" stroke="url(#gold)" stroke-width="5"/>
    <line x1="256" y1="339" x2="256" y2="358" stroke="url(#gold)" stroke-width="5" stroke-linecap="round"/>
    <line x1="256" y1="350" x2="264" y2="350" stroke="url(#gold)" stroke-width="4" stroke-linecap="round"/>
    <!-- Dollar sign accent on roof -->
    <text x="256" y="195" text-anchor="middle" font-size="52" fill="#c8a85a" font-family="Arial,sans-serif" font-weight="bold" opacity="0.9">$</text>
    <!-- Brand name -->
    <text x="256" y="440" text-anchor="middle" font-size="62" fill="#e2c97e" font-family="Georgia,serif" font-weight="bold" letter-spacing="2">GestorRenta</text>
  </svg>`;
  const iconB64 = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(iconSvg)));

  // â”€â”€ Apple touch icon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('pwa-apple-icon').href = iconB64;

  // â”€â”€ Inline manifest via Blob URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const manifest = {
    name: 'GestorRenta',
    short_name: 'GestorRenta',
    description: 'GestiÃ³n de rentas e inquilinos',
    start_url: window.location.href,
    display: 'standalone',
    orientation: 'portrait-primary',
    background_color: '#f5f0e8',
    theme_color: '#1b3a2d',
    lang: 'es',
    icons: [
      { src: iconB64, sizes: '192x192', type: 'image/svg+xml', purpose: 'any maskable' },
      { src: iconB64, sizes: '512x512', type: 'image/svg+xml', purpose: 'any maskable' },
    ]
  };
  const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const manifestURL = URL.createObjectURL(manifestBlob);
  document.getElementById('pwa-manifest').href = manifestURL;

  // â”€â”€ Inline Service Worker via Blob â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const swCode = `
const CACHE = 'gestorrenta-v1';
self.addEventListener('install', e => {
  self.skipWaiting();
});
self.addEventListener('activate', e => {
  e.waitUntil(clients.claim());
});
self.addEventListener('fetch', e => {
  // Only cache same-origin requests (the app file itself)
  if (e.request.url === location.origin + location.pathname || e.request.url === location.href) {
    e.respondWith(
      caches.open(CACHE).then(cache =>
        fetch(e.request).then(res => {
          cache.put(e.request, res.clone());
          return res;
        }).catch(() => caches.match(e.request))
      )
    );
  }
});`;
  const swBlob = new Blob([swCode], {type:'application/javascript'});
  const swURL = URL.createObjectURL(swBlob);
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register(swURL, {type:'classic'}).catch(() => {});
  }

  // â”€â”€ Install prompt logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isAndroid = /android/i.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone === true ||
    window.matchMedia('(display-mode: standalone)').matches;
  const dismissed = localStorage.getItem('pwa_banner_dismissed');

  let deferredPrompt = null;

  // Android: capture beforeinstallprompt
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    if (!isStandalone && !dismissed) {
      document.getElementById('pwa-banner').classList.add('show');
    }
  });

  // iOS: show instructions banner
  if (isIOS && !isStandalone && !dismissed) {
    setTimeout(() => {
      document.getElementById('pwa-banner').classList.add('show');
    }, 2500);
  }

  window.pwaInstall = function() {
    if (deferredPrompt) {
      // Android native prompt
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(choice => {
        if (choice.outcome === 'accepted') pwaDismiss();
        deferredPrompt = null;
      });
    } else if (isIOS) {
      // iOS instructions
      document.getElementById('pwa-banner').classList.remove('show');
      document.getElementById('ios-install-modal').classList.add('show');
    }
  };

  window.pwaDismiss = function() {
    document.getElementById('pwa-banner').classList.remove('show');
    localStorage.setItem('pwa_banner_dismissed', '1');
  };

  // Reset dismiss if re-opened after 7 days
  const dismissedAt = parseInt(localStorage.getItem('pwa_banner_dismissed_at') || '0');
  if (Date.now() - dismissedAt > 7 * 86400000) {
    localStorage.removeItem('pwa_banner_dismissed');
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESCÃNER DE CÃMARA â†’ PDF  (usa jsPDF)
// iOS: input[capture] nativo | Desktop: getUserMedia modal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _scanStream     = null;
let _scanPaginas    = [];
let _scanCamara     = 'environment';

/* â”€â”€ DetecciÃ³n de iOS / mÃ³vil â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _esIOS() {
  return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}
function _esMobile() {
  return _esIOS() || /Android/i.test(navigator.userAgent);
}

/* â”€â”€ Entrada principal â€” elige estrategia â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function abrirEscanerAdaptivo() {
  if (_esMobile()) {
    // iOS/Android: usar cÃ¡mara nativa (siempre funciona, sin permisos)
    _scanPaginas = [];
    document.getElementById('scan-native-input').value = '';
    document.getElementById('scan-native-input').click();
  } else {
    // Desktop: abrir modal con webcam
    abrirEscaner();
  }
}

/* â”€â”€ Handler para fotos tomadas con cÃ¡mara nativa â”€â”€â”€â”€â”€ */
async function scanNativoHandler(input) {
  if (!input.files || !input.files.length) return;

  // Mostrar progreso
  var btn = document.querySelector('button[onclick="abrirEscanerAdaptivo()"]');
  if (btn) { btn.textContent = 'â³ Procesandoâ€¦'; btn.disabled = true; }

  try {
    // Cargar y comprimir cada imagen
    for (var i = 0; i < input.files.length; i++) {
      var file = input.files[i];
      var compressed = await _scanComprimirArchivo(file, 1600, 0.82);
      _scanPaginas.push(compressed);
    }

    if (!_scanPaginas.length) throw new Error('No se procesaron imÃ¡genes');

    var pdfBlob = await _scanBuildPDF(_scanPaginas, 0.82);

    // Si supera 5MB, recomprimir
    if (pdfBlob.size > 5 * 1024 * 1024) {
      showToast('ğŸ“¦ Comprimiendoâ€¦');
      var recomp = await _scanRecomprimir(_scanPaginas, 0.55, 1200);
      pdfBlob = await _scanBuildPDF(recomp, 0.55);
    }
    if (pdfBlob.size > 5 * 1024 * 1024) {
      var recomp2 = await _scanRecomprimir(_scanPaginas, 0.35, 900);
      pdfBlob = await _scanBuildPDF(recomp2, 0.35);
    }

    // Guardar en el campo de contrato
    var reader = new FileReader();
    reader.onload = function(ev) {
      var b64 = ev.target.result;
      var sizeKB = Math.round(pdfBlob.size / 1024);
      var sizeStr = sizeKB < 1024 ? sizeKB + ' KB' : (sizeKB/1024).toFixed(1) + ' MB';
      var fileName = 'contrato_' + new Date().toISOString().slice(0,10) + '.pdf';
      var meta = JSON.stringify({ name: fileName, size: pdfBlob.size, type: 'application/pdf' });
      document.getElementById('c-contrato-data').value = b64;
      document.getElementById('c-contrato-meta').value = meta;
      mostrarContratoPreview(b64, fileName, pdfBlob.size, 'application/pdf');
      showToast('âœ… PDF listo â€” ' + _scanPaginas.length + ' pÃ¡g Â· ' + sizeStr);
    };
    reader.readAsDataURL(pdfBlob);

  } catch(e) {
    console.error(e);
    alert('Error al procesar: ' + e.message);
  } finally {
    if (btn) { btn.innerHTML = 'ğŸ“· Escanear con cÃ¡mara'; btn.disabled = false; }
    _scanPaginas = [];
    input.value = '';
  }
}

/* â”€â”€ Comprimir un File/Blob de imagen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _scanComprimirArchivo(file, maxDim, quality) {
  return new Promise(function(resolve, reject) {
    var reader = new FileReader();
    reader.onload = function(ev) {
      var img = new Image();
      img.onload = function() {
        var w = img.width, h = img.height;
        if (w > maxDim || h > maxDim) {
          var r = Math.min(maxDim/w, maxDim/h);
          w = Math.round(w*r); h = Math.round(h*r);
        }
        var c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve({ dataUrl: c.toDataURL('image/jpeg', quality), w: w, h: h });
      };
      img.onerror = reject;
      img.src = ev.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* â”€â”€ Modal WebRTC (solo desktop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function abrirEscaner() {
  _scanPaginas = [];
  const ids = ['escaner-pages','escaner-page-count'];
  document.getElementById('escaner-pages').innerHTML = '';
  document.getElementById('escaner-page-count').textContent = '0';
  document.getElementById('escaner-pages-wrap').style.display  = 'none';
  document.getElementById('btn-generar-pdf').style.display     = 'none';
  document.getElementById('btn-limpiar-scan').style.display    = 'none';
  document.getElementById('escaner-status').textContent        = 'Iniciando cÃ¡maraâ€¦';
  document.getElementById('modalEscaner').style.display        = 'flex';
  document.body.style.overflow = 'hidden';
  _scanIniciarCamara();
}

async function _scanIniciarCamara() {
  if (_scanStream) { _scanStream.getTracks().forEach(t => t.stop()); _scanStream = null; }
  try {
    _scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: _scanCamara }, width: { ideal: 1920 }, height: { ideal: 2560 } },
      audio: false
    });
    const vid = document.getElementById('escaner-video');
    vid.srcObject = _scanStream;
    await vid.play();
    document.getElementById('escaner-status').textContent = 'CÃ¡mara lista âœ“';
  } catch(e) {
    document.getElementById('escaner-status').textContent = 'âš ï¸ Sin acceso a cÃ¡mara';
    alert('No se pudo acceder a la cÃ¡mara.\nVerifica los permisos en ConfiguraciÃ³n > Safari/Chrome.');
  }
}

function flipCamara() {
  _scanCamara = _scanCamara === 'environment' ? 'user' : 'environment';
  _scanIniciarCamara();
}

/* â”€â”€ Capturar pÃ¡gina â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function capturarPagina() {
  const vid = document.getElementById('escaner-video');
  if (!vid.videoWidth) { alert('La cÃ¡mara aÃºn no estÃ¡ lista.'); return; }

  // Flash visual
  const visor = document.getElementById('escaner-visor');
  visor.style.filter = 'brightness(2.5)';
  setTimeout(function() { visor.style.filter = ''; }, 120);

  // Capturar en canvas original
  const cv = document.getElementById('escaner-canvas');
  cv.width  = vid.videoWidth;
  cv.height = vid.videoHeight;
  cv.getContext('2d').drawImage(vid, 0, 0);

  // Reescalar a mÃ¡x 1600px
  var MAX = 1600;
  var w = cv.width, h = cv.height;
  if (w > MAX || h > MAX) {
    var r = Math.min(MAX / w, MAX / h);
    w = Math.round(w * r);
    h = Math.round(h * r);
  }
  var tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  tmp.getContext('2d').drawImage(cv, 0, 0, w, h);
  var dataUrl = tmp.toDataURL('image/jpeg', 0.80);

  _scanPaginas.push({ dataUrl: dataUrl, w: w, h: h });
  _scanActualizarMiniaturas();

  var n = _scanPaginas.length;
  document.getElementById('escaner-status').textContent = n + ' pÃ¡gina' + (n > 1 ? 's' : '') + ' capturada' + (n > 1 ? 's' : '');
  document.getElementById('btn-generar-pdf').style.display  = 'block';
  document.getElementById('btn-limpiar-scan').style.display = 'block';
}

function _scanActualizarMiniaturas() {
  document.getElementById('escaner-pages-wrap').style.display = 'block';
  document.getElementById('escaner-page-count').textContent   = _scanPaginas.length;
  document.getElementById('escaner-pages').innerHTML = _scanPaginas.map(function(p, i) {
    return '<div style="position:relative;flex-shrink:0">' +
      '<img src="' + p.dataUrl + '" style="height:80px;border-radius:6px;border:2px solid var(--border)" />' +
      '<div style="position:absolute;top:2px;left:4px;background:rgba(0,0,0,0.6);color:#fff;font-size:10px;font-weight:700;padding:1px 5px;border-radius:8px">' + (i+1) + '</div>' +
      '<button onclick="_scanEliminar(' + i + ')" style="position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:11px;cursor:pointer;line-height:20px;text-align:center">âœ•</button>' +
      '</div>';
  }).join('');
}

function _scanEliminar(idx) {
  _scanPaginas.splice(idx, 1);
  if (!_scanPaginas.length) {
    document.getElementById('escaner-pages-wrap').style.display = 'none';
    document.getElementById('btn-generar-pdf').style.display    = 'none';
    document.getElementById('btn-limpiar-scan').style.display   = 'none';
    document.getElementById('escaner-status').textContent       = 'CÃ¡mara lista âœ“';
  } else {
    _scanActualizarMiniaturas();
  }
}

function limpiarEscaneo() {
  if (!confirm('Descartar todas las pÃ¡ginas?')) return;
  _scanPaginas = [];
  document.getElementById('escaner-pages').innerHTML         = '';
  document.getElementById('escaner-pages-wrap').style.display = 'none';
  document.getElementById('btn-generar-pdf').style.display    = 'none';
  document.getElementById('btn-limpiar-scan').style.display   = 'none';
  document.getElementById('escaner-page-count').textContent   = '0';
  document.getElementById('escaner-status').textContent       = 'CÃ¡mara lista âœ“';
}

/* â”€â”€ Cerrar modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function cerrarEscaner() {
  if (_scanStream) { _scanStream.getTracks().forEach(function(t){ t.stop(); }); _scanStream = null; }
  var vid = document.getElementById('escaner-video');
  if (vid) vid.srcObject = null;
  document.getElementById('modalEscaner').style.display = 'none';
  document.body.style.overflow = '';
}

/* â”€â”€ Generar PDF con jsPDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function generarPDFEscaneado() {
  if (!_scanPaginas.length) return;

  var btn = document.getElementById('btn-generar-pdf');
  btn.textContent = 'â³ Generando PDFâ€¦';
  btn.disabled = true;

  try {
    // Comprimir si es necesario para < 5 MB
    var paginas = _scanPaginas;
    var quality = 0.80;

    var pdfBlob = await _scanBuildPDF(paginas, quality);

    // Si supera 5 MB, recomprimir con menor calidad
    if (pdfBlob.size > 5 * 1024 * 1024) {
      showToast('ğŸ“¦ Comprimiendo mÃ¡sâ€¦');
      quality = 0.55;
      paginas = await _scanRecomprimir(paginas, quality, 1200);
      pdfBlob = await _scanBuildPDF(paginas, quality);
    }

    // Si aÃºn supera 5 MB, segunda pasada muy agresiva
    if (pdfBlob.size > 5 * 1024 * 1024) {
      quality = 0.35;
      paginas = await _scanRecomprimir(paginas, quality, 900);
      pdfBlob = await _scanBuildPDF(paginas, quality);
    }

    // Convertir Blob a base64
    var reader = new FileReader();
    reader.onload = function(ev) {
      var b64 = ev.target.result;
      var sizeKB = Math.round(pdfBlob.size / 1024);
      var sizeStr = sizeKB < 1024 ? sizeKB + ' KB' : (sizeKB/1024).toFixed(1) + ' MB';
      var fileName = 'contrato_escaneado_' + new Date().toISOString().slice(0,10) + '.pdf';
      var meta = JSON.stringify({ name: fileName, size: pdfBlob.size, type: 'application/pdf' });

      document.getElementById('c-contrato-data').value = b64;
      document.getElementById('c-contrato-meta').value = meta;
      mostrarContratoPreview(b64, fileName, pdfBlob.size, 'application/pdf');

      cerrarEscaner();
      showToast('âœ… PDF guardado â€” ' + _scanPaginas.length + ' pÃ¡g Â· ' + sizeStr);
    };
    reader.readAsDataURL(pdfBlob);

  } catch(e) {
    console.error('PDF error:', e);
    alert('Error al generar PDF: ' + e.message);
    btn.textContent = 'âœ… Generar PDF y guardar';
    btn.disabled = false;
  }
}

async function _scanBuildPDF(paginas, quality) {
  var jsPDF = window.jspdf ? window.jspdf.jsPDF : (window.jsPDF || (typeof jspdf !== 'undefined' ? jspdf.jsPDF : null));
  if (!jsPDF) throw new Error('jsPDF no disponible');

  var doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  var A4W = 210, A4H = 297;

  for (var i = 0; i < paginas.length; i++) {
    if (i > 0) doc.addPage();
    var pg = paginas[i];

    // Escalar imagen para que quepa en A4 con margen de 5mm
    var maxW = A4W - 10, maxH = A4H - 10;
    var imgAspect = pg.w / pg.h;
    var drawW = maxW, drawH = maxW / imgAspect;
    if (drawH > maxH) { drawH = maxH; drawW = maxH * imgAspect; }
    var x = (A4W - drawW) / 2;
    var y = (A4H - drawH) / 2;

    doc.addImage(pg.dataUrl, 'JPEG', x, y, drawW, drawH, '', 'FAST');
  }

  var pdfOutput = doc.output('blob');
  return pdfOutput;
}

async function _scanRecomprimir(paginas, quality, maxDim) {
  var result = [];
  for (var i = 0; i < paginas.length; i++) {
    var pg = paginas[i];
    var canvas = document.createElement('canvas');
    var w = pg.w, h = pg.h;
    if (w > maxDim || h > maxDim) {
      var r = Math.min(maxDim/w, maxDim/h);
      w = Math.round(w*r); h = Math.round(h*r);
    }
    canvas.width = w; canvas.height = h;
    await new Promise(function(resolve) {
      var img = new Image();
      img.onload = function() {
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve();
      };
      img.src = pg.dataUrl;
    });
    result.push({ dataUrl: canvas.toDataURL('image/jpeg', quality), w: w, h: h });
  }
  return result;
}
// end scanner

</script>
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">âœ•</button>
  <img id="lightbox-img" src="" alt="" />
</div>

<!-- MODAL: Usuario -->
<div class="modal-overlay" id="modalUsuario">
  <div class="modal" style="width:500px;max-width:98vw">
    <div class="modal-title" id="modal-usuario-title">Nuevo Usuario</div>
    <div class="form-grid">
      <div class="form-group full">
        <label>Nombre completo</label>
        <input id="u-nombre" placeholder="Nombre del usuario" />
      </div>
      <div class="form-group">
        <label>Usuario (login)</label>
        <input id="u-user" placeholder="Ej: juan123" autocomplete="off" />
      </div>
      <div class="form-group">
        <label>ContraseÃ±a</label>
        <input id="u-pass" type="password" placeholder="MÃ­nimo 4 caracteres" autocomplete="new-password" />
      </div>
    </div>
    <!-- Email para sub-usuarios -->
    <div id="u-subemail-section" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:12px">ğŸ“§ Correo y recuperaciÃ³n</div>
      <div class="form-group" style="margin-bottom:12px">
        <label>Correo electrÃ³nico</label>
        <input id="u-subemail" type="email" placeholder="correo@ejemplo.com" autocomplete="off" />
        <div style="font-size:11px;color:var(--text3);margin-top:4px">Sirve como usuario alterno para acceder y para recuperar contraseÃ±a</div>
      </div>
      <div id="u-sub-recovery-code-wrap" style="display:none">
        <div style="font-size:13px;color:var(--text2);margin-bottom:6px">CÃ³digo de recuperaciÃ³n:</div>
        <div class="recovery-code-box" id="u-sub-recovery-code-display" onclick="copySubRecoveryCode()" title="Toca para copiar">â€”â€”</div>
        <div class="recovery-warning">âš ï¸ <strong>Comparte este cÃ³digo con el usuario.</strong> Lo necesitarÃ¡ para recuperar su contraseÃ±a si la olvida.</div>
        <button class="btn btn-ghost" style="width:100%;margin-top:10px;font-size:13px" onclick="regenerateSubRecoveryCode()">ğŸ”„ Generar nuevo cÃ³digo</button>
      </div>
      <div id="u-sub-recovery-no-code" style="">
        <button class="btn btn-ghost" style="width:100%;font-size:13px" onclick="generateSubRecoveryCode()">ğŸ”‘ Generar cÃ³digo de recuperaciÃ³n</button>
        <div style="font-size:11px;color:var(--text3);margin-top:6px;text-align:center">Genera un cÃ³digo de 8 dÃ­gitos para que el usuario pueda recuperar su contraseÃ±a.</div>
      </div>
    </div>
    <!-- Recovery section â€” solo visible para el titular -->
    <div id="u-recovery-section" style="display:none;margin-top:18px;padding-top:18px;border-top:1px solid var(--border)">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:12px">ğŸ“§ RecuperaciÃ³n de contraseÃ±a</div>
      <div class="form-group" style="margin-bottom:12px">
        <label>Correo electrÃ³nico (referencia)</label>
        <input id="u-email" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="off" />
        <div style="font-size:11px;color:var(--text3);margin-top:4px">Solo se guarda localmente como referencia. No se envÃ­an correos automÃ¡ticos.</div>
      </div>
      <div id="u-recovery-code-wrap" style="display:none">
        <div style="font-size:13px;color:var(--text2);margin-bottom:6px">Tu cÃ³digo de recuperaciÃ³n:</div>
        <div class="recovery-code-box" id="u-recovery-code-display" onclick="copyRecoveryCode()" title="Toca para copiar">â€”â€”</div>
        <div class="recovery-warning">âš ï¸ <strong>Guarda este cÃ³digo en un lugar seguro.</strong> Es la Ãºnica forma de recuperar tu contraseÃ±a si la olvidas. Toca el cÃ³digo para copiarlo.</div>
        <button class="btn btn-ghost" style="width:100%;margin-top:10px;font-size:13px" onclick="regenerateCode()">ğŸ”„ Generar nuevo cÃ³digo</button>
      </div>
      <div id="u-recovery-no-code" style="">
        <button class="btn btn-ghost" style="width:100%;font-size:13px" onclick="generateRecoveryCode()">ğŸ”‘ Generar cÃ³digo de recuperaciÃ³n</button>
        <div style="font-size:11px;color:var(--text3);margin-top:6px;text-align:center">Genera un cÃ³digo de 8 dÃ­gitos para poder recuperar tu contraseÃ±a en caso de olvidarla.</div>
      </div>
    </div>
    <div id="modal-perms-section" style="margin-top:20px">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:12px">ğŸ”‘ Facultades</div>

      <!-- Acceso completo toggle -->
      <div style="background:linear-gradient(135deg,#1b3a2d,#2d6a4f);border-radius:12px;padding:14px 16px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div>
          <div style="font-size:14px;font-weight:700;color:#fff">ğŸ‘‘ Acceso completo (igual que Titular)</div>
          <div style="font-size:11px;color:rgba(255,255,255,.7);margin-top:2px">Activa todas las facultades de un solo toque</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="perm-all" onchange="toggleAccesoCompleto(this.checked)" />
          <span class="toggle-track"></span>
        </label>
      </div>

          <div class="perm-toggle">
            <div>
              <div class="perm-name">Ver Propiedades</div>
              <div class="perm-desc">Acceso a la lista de propiedades (solo lectura)</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-prop_read" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Alta y modificaciÃ³n de Propiedades</div>
              <div class="perm-desc">Crear, editar y eliminar propiedades</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-prop_write" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Ver Clientes</div>
              <div class="perm-desc">Acceso a la lista de clientes (solo lectura)</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-cli_read" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Alta y modificaciÃ³n de Clientes</div>
              <div class="perm-desc">Crear, editar y eliminar clientes</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-cli_write" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Registrar Abonos</div>
              <div class="perm-desc">Agregar pagos a propiedades</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-abono_write" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Eliminar Abonos registrados</div>
              <div class="perm-desc">Borrar pagos ya registrados (peligroso)</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-abono_delete" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Ver Resumen / Resultados (Dashboard)</div>
              <div class="perm-desc">Acceso a la pantalla de Inicio con KPIs e ingresos</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-dash_read" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Ver Alertas</div>
              <div class="perm-desc">Acceso a la secciÃ³n de Alertas de cobro</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-alertas_read" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Modificar Alertas (reagendar, notas)</div>
              <div class="perm-desc">Cambiar fecha de seguimiento, agregar notas, quitar seguimiento</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-alertas_write" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Ver Propiedades sin Rentar</div>
              <div class="perm-desc">Acceso a la secciÃ³n de propiedades disponibles en el Inicio</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-vacant_read" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
          <div class="perm-toggle">
            <div>
              <div class="perm-name">Ver ConfiguraciÃ³n (solo lectura)</div>
              <div class="perm-desc">Puede ver ajustes pero no modificarlos</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="perm-config_read" onchange="syncAccesoCompletoToggle()" />
              <span class="toggle-track"></span>
            </label>
          </div>
    </div>

    <!-- Tipos de propiedad visibles -->
    <div id="modal-tipos-section" style="margin-top:20px">
      <div style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:10px">ğŸ¢ Tipos de propiedad que puede ver</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:10px">Si no seleccionas ninguno, verÃ¡ todos los tipos.</div>
      <div id="tipos-prop-checks" style="display:flex;flex-direction:column;gap:6px">
        <!-- Se llena dinÃ¡micamente -->
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalUsuario')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarUsuario()">Guardar</button>
    </div>
  </div>
</div>
<!-- MODAL: Gasto -->
<div class="modal-overlay" id="modalGasto">
  <div class="modal" style="width:480px;max-width:98vw">
    <div class="modal-title">ğŸ’¸ Registrar Gasto</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Tipo de gasto *</label>
        <select id="g-tipo"></select>
      </div>
      <div class="form-group">
        <label>Monto *</label>
        <input id="g-monto" type="number" placeholder="0.00" min="0" />
      </div>
      <div class="form-group">
        <label>Fecha</label>
        <input id="g-fecha" type="date" />
      </div>
      <div class="form-group">
        <label>Forma de pago</label>
        <select id="g-fp"></select>
      </div>
      <div class="form-group full">
        <label>DescripciÃ³n / Nota</label>
        <input id="g-desc" placeholder="Detalle del gasto..." />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalGasto')">Cancelar</button>
      <button class="btn btn-danger" onclick="guardarGasto()">Registrar gasto</button>
    </div>
  </div>
</div>
<!-- MODAL: Ver Contrato rÃ¡pido -->
<div class="modal-overlay" id="modalContratoRapido">
  <div class="modal" style="width:680px;max-width:98vw">
    <div class="modal-title" id="modal-contrato-nombre">Contrato</div>
    <div id="modal-contrato-body" style="border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#f5f5f5;min-height:300px;display:flex;align-items:center;justify-content:center">
      <img id="modal-contrato-img" style="max-width:100%;max-height:70vh;display:none" />
      <iframe id="modal-contrato-pdf" style="width:100%;height:70vh;min-height:400px;border:none;display:none"></iframe>
      <div id="modal-contrato-placeholder" style="text-align:center;padding:40px;color:var(--text3);display:none">
        <div style="font-size:40px">ğŸ“„</div>
        <div style="font-size:13px;margin-top:8px">No se puede previsualizar este tipo de archivo</div>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="btn btn-ghost" onclick="closeModal('modalContratoRapido')">Cerrar</button>
      <button class="btn btn-ghost" onclick="descargarContratoRapido()">â¬‡ï¸ Descargar</button>
      <button class="btn btn-primary" onclick="editarClienteDesdeContrato()">âœï¸ Editar cliente</button>
    </div>
  </div>
</div>
<!-- PWA Install Banner (Android/Chrome) -->
<div id="pwa-banner">
  <div id="pwa-banner-icon">ğŸ </div>
  <div id="pwa-banner-text">
    <strong>Instalar GestorRenta</strong>
    <span>AgrÃ©gala a tu pantalla de inicio</span>
  </div>
  <button id="pwa-banner-install" onclick="pwaInstall()">Instalar</button>
  <button id="pwa-banner-close" onclick="pwaDismiss()">âœ•</button>
</div>

<!-- iOS Install Instructions Modal -->
<div id="ios-install-modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div id="ios-install-box">
    <button id="ios-install-close" onclick="document.getElementById('ios-install-modal').classList.remove('show')">âœ•</button>
    <h3>ğŸ“± Instalar en iPhone</h3>
    <p>Para agregar GestorRenta a tu pantalla de inicio:</p>
    <div class="ios-step">
      <div class="ios-step-num">1</div>
      <div class="ios-step-text">Toca el botÃ³n <strong>Compartir</strong> <span style="font-size:16px">â¬†ï¸</span> en la barra de Safari (parte inferior de la pantalla)</div>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">2</div>
      <div class="ios-step-text">DesplÃ¡zate y elige <strong>"Agregar a pantalla de inicio"</strong> <span style="font-size:16px">â•</span></div>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">3</div>
      <div class="ios-step-text">Toca <strong>"Agregar"</strong> en la esquina superior derecha</div>
    </div>
    <div class="ios-arrow">ğŸ‘†</div>
  </div>
</div>
<div class="notif-overlay" id="notif-overlay" onclick="closeNotifPanel()"></div>
<div class="notif-panel" id="notif-panel">
  <div class="notif-panel-header">
    <div class="notif-panel-title">ğŸ”” Avisos</div>
    <button onclick="closeNotifPanel()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text3)">âœ•</button>
  </div>
  <div class="notif-panel-body" id="notif-panel-body">
    <div style="color:var(--text3);font-size:13px;text-align:center;padding:30px">Sin avisos pendientes</div>
  </div>
</div>
<!-- MODAL: Estado de Resultados -->
<div class="modal-overlay" id="modalER">
  <div class="modal" style="width:700px;max-width:98vw">
    <div class="modal-title">ğŸ“ˆ Estado de Resultados</div>
    <div class="er-month-selector">
      <button class="btn btn-ghost" style="padding:6px 10px" onclick="erNavMes(-1)">â€¹</button>
      <select id="er-mes-sel" onchange="renderER()" style="flex:1"></select>
      <button class="btn btn-ghost" style="padding:6px 10px" onclick="erNavMes(1)">â€º</button>
      <button class="btn btn-ghost" style="font-size:12px" onclick="descargarERExcel()">â¬‡ï¸ Excel</button>
    </div>
    <div id="er-content"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalER')">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL: Historial de Inquilinos -->
<div class="modal-overlay" id="modalHistorial">
  <div class="modal" style="width:640px;max-width:98vw">
    <div class="modal-title" id="historial-title">Historial de inquilinos</div>
    <div id="historial-content" style="max-height:60vh;overflow-y:auto"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" style="font-size:12px" onclick="agregarInquilinoHistorial()">+ Agregar manualmente</button>
      <button class="btn btn-ghost" onclick="closeModal('modalHistorial')">Cerrar</button>
    </div>
  </div>
</div>
<!-- MODAL: Inventario -->
<div class="modal-overlay" id="modalInventario">
  <div class="modal" style="width:500px;max-width:98vw">
    <div class="modal-title" id="inv-modal-title">ğŸ“¦ Agregar artÃ­culo</div>
    <div class="form-grid">
      <div class="form-group full">
        <label>ArtÃ­culo / DescripciÃ³n *</label>
        <input id="inv-nombre" placeholder="Ej: Refrigerador Samsung, Escritorio, AC 1 ton..." />
      </div>
      <div class="form-group">
        <label>Cantidad</label>
        <input id="inv-cantidad" type="number" min="1" value="1" />
      </div>
      <div class="form-group">
        <label>Valor unitario ($)</label>
        <input id="inv-valor" type="number" min="0" placeholder="0" />
      </div>
      <div class="form-group">
        <label>Estado</label>
        <select id="inv-estado">
          <option value="bueno">âœ… Bueno</option>
          <option value="regular">ğŸ”¶ Regular</option>
          <option value="malo">ğŸ”´ Malo / DaÃ±ado</option>
        </select>
      </div>
      <div class="form-group">
        <label>NÃºmero de serie (opcional)</label>
        <input id="inv-serie" placeholder="SN-XXXX" />
      </div>
      <div class="form-group full">
        <label>Nota</label>
        <input id="inv-nota" placeholder="Color, marca, ubicaciÃ³n en el inmueble..." />
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalInventario')">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarItemInventario()">Guardar</button>
    </div>
  </div>
</div>
<!-- MODAL: Compartir ficha -->
<div class="modal-overlay" id="modalFichaPDF">
  <div class="modal" style="width:520px;max-width:98vw">
    <div class="modal-title">ğŸ“ Ficha PDF de la propiedad</div>

    <!-- Sin PDF -->
    <div id="ficha-pdf-empty" style="text-align:center;padding:36px 20px">
      <div style="font-size:52px;margin-bottom:12px">ğŸ“‚</div>
      <div style="font-size:15px;font-weight:600;color:var(--text);margin-bottom:6px">Sin ficha adjunta</div>
      <div style="font-size:13px;color:var(--text3);margin-bottom:22px">Sube el PDF de la ficha tÃ©cnica de esta propiedad<br>(mÃ¡x. 10 MB)</div>
      <label class="btn btn-primary" style="cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-size:14px">
        ğŸ“ Seleccionar PDF
        <input type="file" id="ficha-pdf-input" accept=".pdf,.jpg,.jpeg,.png"
          style="display:none" onchange="cargarFichaPDF(this)" />
      </label>
    </div>

    <!-- Con PDF -->
    <div id="ficha-pdf-loaded" style="display:none">

      <!-- Info archivo -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:30px" id="ficha-pdf-icon">ğŸ“•</span>
          <div>
            <div style="font-weight:600;font-size:14px" id="ficha-pdf-nombre">ficha.pdf</div>
            <div style="font-size:11px;color:var(--text3)" id="ficha-pdf-size">â€”</div>
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <label class="btn btn-ghost" style="font-size:12px;padding:5px 12px;cursor:pointer">
            ğŸ”„ Reemplazar
            <input type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="cargarFichaPDF(this)" />
          </label>
          <button class="btn btn-danger" style="font-size:12px;padding:5px 12px" onclick="eliminarFichaPDF()">ğŸ—‘ï¸</button>
        </div>
      </div>

      <!-- Preview -->
      <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#f5f5f5;height:320px;display:flex;align-items:center;justify-content:center;margin-bottom:14px">
        <iframe id="ficha-pdf-frame" style="width:100%;height:100%;border:none;display:none"></iframe>
        <img id="ficha-pdf-img" style="max-width:100%;max-height:100%;display:none" />
        <div id="ficha-pdf-placeholder" style="text-align:center;color:var(--text3)">
          <div style="font-size:40px">ğŸ“•</div>
          <div style="font-size:12px;margin-top:6px">Vista previa del PDF</div>
        </div>
      </div>

      <!-- Acciones principales -->
      <div style="display:flex;flex-direction:column;gap:8px">

        <!-- Abrir/descargar -->
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="flex:1;padding:11px" onclick="abrirFichaPDFNuevaPestana()">
            ğŸ‘ï¸ Ver PDF
          </button>
          <button class="btn btn-ghost" style="flex:1;padding:11px" onclick="descargarFichaPDFArchivo()">
            â¬‡ï¸ Descargar
          </button>
        </div>

        <!-- WhatsApp -->
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px">
          <div style="font-size:11px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.6px">ğŸ“± Compartir por WhatsApp</div>
          <div style="font-size:12px;color:var(--text3);margin-bottom:10px;line-height:1.5">
            WhatsApp no permite adjuntar archivos directamente desde el navegador.<br>
            Descarga el PDF y luego adjÃºntalo manualmente en WhatsApp.
          </div>
          <div style="display:flex;gap:8px">
            <input id="ficha-wa-numero" placeholder="52 614 123 4567" style="flex:1;font-size:13px" />
            <button class="btn" style="background:#25D366;color:#fff;border:none;font-weight:600;white-space:nowrap;padding:8px 14px" onclick="compartirTextoWhatsApp()">
              Texto â†—
            </button>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:6px">EnvÃ­a un mensaje de texto con los datos de la propiedad (sin el PDF adjunto)</div>
        </div>

      </div>
    </div>

    <div class="modal-actions" style="margin-top:12px">
      <button class="btn btn-ghost" onclick="closeModal('modalFichaPDF')">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL: Compartir WhatsApp texto -->
<div class="modal-overlay" id="modalCompartir" style="z-index:1101">
  <div class="modal" style="width:480px;max-width:98vw">
    <div class="modal-title">ğŸ’¬ Compartir por WhatsApp</div>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:14px;font-size:12px;white-space:pre-wrap;font-family:'DM Mono',monospace;max-height:240px;overflow-y:auto;line-height:1.7;color:var(--text2)" id="ficha-preview"></div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div id="wa-inquilino-row" style="display:none;background:#f0fdf4;border:1px solid rgba(37,211,102,.3);border-radius:10px;padding:12px 14px">
        <div style="font-size:11px;font-weight:700;color:#166534;margin-bottom:6px;text-transform:uppercase;letter-spacing:.6px">ğŸ‘¤ Inquilino actual</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div>
            <div style="font-weight:600" id="wa-inquilino-nombre">â€”</div>
            <div style="font-size:12px;color:var(--text3)" id="wa-inquilino-tel">â€”</div>
          </div>
          <button class="btn" style="background:#25D366;color:#fff;border:none;font-weight:600" onclick="enviarWhatsAppInquilino()">Enviar â†—</button>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <input id="wa-numero" placeholder="52 614 123 4567" style="flex:1;font-size:13px" />
        <button class="btn" style="background:#25D366;color:#fff;border:none;font-weight:600;white-space:nowrap;padding:8px 14px" onclick="enviarWhatsApp()">Enviar â†—</button>
      </div>
      <button class="btn btn-ghost" onclick="copiarFicha()" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:10px">ğŸ“‹ Copiar texto</button>
    </div>
    <div class="modal-actions" style="margin-top:10px">
      <button class="btn btn-ghost" onclick="closeModal('modalCompartir')">Cerrar</button>
    </div>
  </div>
</div>

<div id="autosave-indicator">ğŸ’¾ <span id="autosave-text">Guardado</span></div>

<!-- MODAL: Documento Extra -->
<div class="modal-overlay" id="modalDocExtra">
  <div class="modal" style="width:750px;max-width:98vw">
    <div class="modal-title" id="doc-extra-title">Documento</div>
    <div class="doc-preview-wrap" id="doc-extra-body"></div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="btn btn-ghost" onclick="closeModal('modalDocExtra')">Cerrar</button>
      <button class="btn btn-ghost" onclick="imprimirDocExtra()">ğŸ–¨ï¸ Imprimir / PDF</button>
      <button class="btn btn-primary" onclick="copiarDocExtra()">ğŸ“‹ Copiar texto</button>
    </div>
  </div>
</div>

<div class="toast" id="app-toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL ABONOS POR FORMA DE PAGO â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modalFPAbonos">
  <div class="modal" style="max-width:520px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
      <div class="modal-title" style="margin-bottom:0" id="fpAbonos-title">Abonos</div>
      <button class="btn btn-ghost" onclick="closeModal('modalFPAbonos')" style="padding:6px 12px">âœ•</button>
    </div>
    <div id="fpAbonos-content"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL VER COMPROBANTE â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modalComprobante" onclick="closeModal('modalComprobante')">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:540px;text-align:center;padding:20px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="modal-title" style="margin-bottom:0">ğŸ“ Comprobante de pago</div>
      <button class="btn btn-ghost" onclick="closeModal('modalComprobante')" style="padding:6px 12px">âœ•</button>
    </div>
    <div id="comprobante-info" style="font-size:12px;color:var(--text3);margin-bottom:12px"></div>
    <img id="comprobante-viewer-img" style="max-width:100%;max-height:65vh;border-radius:10px;border:1px solid var(--border)" />
    <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
      <button class="btn btn-primary" onclick="descargarComprobante()" style="font-size:13px">â¬‡ Descargar</button>
      <button class="btn btn-ghost" onclick="closeModal('modalComprobante')">Cerrar</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL ESCÃNER DE CÃMARA â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modalEscaner" onclick="cerrarEscaner()" style="display:none;z-index:1100">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:480px;width:95%;padding:0;overflow:hidden;border-radius:16px">

    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)">
      <div style="font-weight:700;font-size:16px">ğŸ“· Escanear documento</div>
      <button onclick="cerrarEscaner()" class="btn btn-ghost" style="padding:4px 10px;font-size:18px">âœ•</button>
    </div>

    <!-- Visor de cÃ¡mara -->
    <div style="position:relative;background:#000;width:100%;aspect-ratio:3/4;overflow:hidden" id="escaner-visor">
      <video id="escaner-video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover"></video>
      <!-- GuÃ­a de encuadre -->
      <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
        <div style="width:80%;height:75%;border:2px solid rgba(255,255,255,0.7);border-radius:8px;box-shadow:0 0 0 2000px rgba(0,0,0,0.3)"></div>
      </div>
      <!-- InstrucciÃ³n -->
      <div style="position:absolute;bottom:16px;left:0;right:0;text-align:center">
        <span style="background:rgba(0,0,0,0.6);color:#fff;font-size:12px;padding:5px 12px;border-radius:20px">Encuadra el documento y toca el botÃ³n</span>
      </div>
    </div>

    <!-- Canvas oculto para captura -->
    <canvas id="escaner-canvas" style="display:none"></canvas>

    <!-- PrevisualizaciÃ³n de pÃ¡ginas escaneadas -->
    <div id="escaner-pages-wrap" style="display:none;padding:12px 16px;border-bottom:1px solid var(--border)">
      <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px">PÃ¡ginas escaneadas <span id="escaner-page-count" style="color:var(--accent)">0</span></div>
      <div id="escaner-pages" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:4px"></div>
    </div>

    <!-- Controles -->
    <div style="padding:16px 20px;display:flex;flex-direction:column;gap:10px">
      <!-- Cambiar cÃ¡mara -->
      <div style="display:flex;justify-content:space-between;align-items:center">
        <button id="btn-flip-cam" class="btn btn-ghost" style="font-size:12px;padding:6px 12px" onclick="flipCamara()">ğŸ”„ Voltear cÃ¡mara</button>
        <span id="escaner-status" style="font-size:12px;color:var(--text3)">CÃ¡mara lista</span>
      </div>
      <!-- Capturar / Agregar pÃ¡gina -->
      <button id="btn-capturar" class="btn btn-primary" style="font-size:15px;padding:14px" onclick="capturarPagina()">
        ğŸ“¸ Capturar pÃ¡gina
      </button>
      <!-- Generar PDF (aparece cuando hay â‰¥1 pÃ¡gina) -->
      <button id="btn-generar-pdf" class="btn" style="display:none;background:var(--success);color:#fff;font-size:14px;padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:600" onclick="generarPDFEscaneado()">
        âœ… Generar PDF y guardar
      </button>
      <!-- Limpiar -->
      <button id="btn-limpiar-scan" class="btn btn-ghost" style="display:none;font-size:12px;padding:6px" onclick="limpiarEscaneo()">
        ğŸ—‘ï¸ Descartar pÃ¡ginas
      </button>
    </div>
  </div>
</div>

<!-- MODAL: Comprar Timbres -->
<div class="modal-overlay" id="modalComprarTimbres">
  <div class="modal" style="width:520px;max-width:98vw">
    <div class="modal-title">ğŸ›’ Comprar Timbres CFDI</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:16px">Cada timbre te permite emitir una factura CFDI 4.0. Selecciona un paquete:</div>
    <div id="timbres-paquetes" style="display:grid;gap:10px"></div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:16px">
      <div style="font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);font-weight:700;margin-bottom:8px">Paquete personalizado</div>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="timbres-custom-qty" type="number" min="1" max="500" placeholder="Cantidad" style="width:100px;font-size:14px;text-align:center" />
        <span style="font-size:13px;color:var(--text2)">timbres Ã—</span>
        <span id="timbres-custom-price" style="font-family:'DM Mono',monospace;font-size:14px;font-weight:700;color:var(--accent)">$15</span>
        <span style="font-size:13px;color:var(--text2)">=</span>
        <span id="timbres-custom-total" style="font-family:'DM Mono',monospace;font-size:16px;font-weight:800;color:var(--accent)">$0</span>
      </div>
      <button class="btn btn-primary" style="width:100%;margin-top:10px" onclick="comprarTimbresCustom()">Comprar</button>
    </div>
    <div style="font-size:11px;color:var(--text3);margin-top:12px;text-align:center">Los timbres no expiran y se acumulan en tu cuenta.</div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalComprarTimbres')">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL: Historial de Timbres -->
<div class="modal-overlay" id="modalHistorialTimbres">
  <div class="modal" style="width:600px;max-width:98vw">
    <div class="modal-title">ğŸ“‹ Historial de Timbres</div>
    <div id="historial-timbres-content" style="max-height:60vh;overflow-y:auto"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalHistorialTimbres')">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL: Revisar y Confirmar Factura -->
<div class="modal-overlay" id="modalFacturar">
  <div class="modal" style="width:640px;max-width:98vw">
    <div class="modal-title">ğŸ§¾ Emitir Factura CFDI 4.0</div>
    <div style="max-height:70vh;overflow-y:auto;padding-right:4px">

      <!-- Ambiente y timbres -->
      <div style="display:flex;justify-content:space-between;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:14px">
        <div>Ambiente: <strong id="fac-ambiente">ğŸ§ª PRUEBAS</strong></div>
        <div>ğŸŸï¸ Timbres: <strong id="fac-timbres-disp">0</strong> <span style="font-size:11px;color:var(--text3)">(se usarÃ¡ 1)</span></div>
      </div>

      <!-- Emisor / Receptor -->
      <div class="g2" style="gap:10px;margin-bottom:14px">
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px">
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--accent);font-weight:700;margin-bottom:6px">Emisor</div>
          <div style="font-weight:700;font-size:13px" id="fac-emisor-rfc"></div>
          <div style="font-size:11px;color:var(--text2)" id="fac-emisor-razon"></div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px">
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--success);font-weight:700;margin-bottom:6px">Receptor</div>
          <div style="font-weight:700;font-size:13px" id="fac-receptor-rfc"></div>
          <div style="font-size:11px;color:var(--text2)" id="fac-receptor-razon"></div>
        </div>
      </div>

      <!-- PerÃ­odo -->
      <div style="background:var(--accent-light);border-radius:8px;padding:8px 12px;margin-bottom:14px;font-size:13px">
        ğŸ“… PerÃ­odo: <strong id="fac-periodo"></strong>
        <span id="fac-predial-badge" style="display:none;margin-left:12px;font-size:11px;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:2px 8px">ğŸ›ï¸ Predial: <strong id="fac-predial-num"></strong></span>
      </div>

      <!-- Datos editables -->
      <div class="g2" style="margin-bottom:10px">
        <div>
          <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Forma de pago</label>
          <select id="fac-forma-pago" style="width:100%;font-size:12px;padding:8px">
            <option value="01">01 - Efectivo</option>
            <option value="02">02 - Cheque nominativo</option>
            <option value="03">03 - Transferencia electrÃ³nica</option>
            <option value="04">04 - Tarjeta de crÃ©dito</option>
            <option value="28">28 - Tarjeta de dÃ©bito</option>
            <option value="99">99 - Por definir</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">MÃ©todo de pago</label>
          <select id="fac-metodo-pago" style="width:100%;font-size:12px;padding:8px">
            <option value="PUE">PUE - Pago en una sola exhibiciÃ³n</option>
            <option value="PPD">PPD - Pago en parcialidades o diferido</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Moneda</label>
          <select id="fac-moneda" style="width:100%;font-size:12px;padding:8px">
            <option value="MXN">MXN - Peso mexicano</option>
            <option value="USD">USD - DÃ³lar americano</option>
          </select>
        </div>
        <div>
          <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Uso de CFDI</label>
          <select id="fac-uso-cfdi" style="width:100%;font-size:12px;padding:8px">
            <option value="G03">G03 - Gastos en general</option>
            <option value="P01">P01 - Por definir</option>
            <option value="D10">D10 - Pagos por servicios educativos</option>
            <option value="S01">S01 - Sin efectos fiscales</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:10px">
        <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">DescripciÃ³n / Concepto</label>
        <input id="fac-descripcion" style="width:100%;font-size:13px;padding:8px" placeholder="Pago de renta mensual correspondiente a..." />
      </div>

      <div style="display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:10px">
        <div>
          <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Serie</label>
          <input id="fac-serie" style="width:100%;font-size:12px;padding:8px;text-transform:uppercase" maxlength="25" />
        </div>
        <div></div>
      </div>

      <!-- Desglose fiscal -->
      <div style="background:var(--surface);border:2px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:10px">
        <div style="font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--accent);font-weight:700;margin-bottom:12px">ğŸ’° Desglose fiscal</div>
        <div class="g2" style="margin-bottom:10px">
          <div>
            <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Subtotal</label>
            <input id="fac-subtotal" type="number" style="width:100%;font-size:14px;padding:8px;font-weight:700" oninput="calcFacturaPreview()" />
          </div>
          <div>
            <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">IVA 16%</label>
            <div id="fac-iva-preview" style="font-family:'DM Mono',monospace;font-size:14px;padding:8px;color:var(--text2)">$0.00</div>
          </div>
          <div>
            <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Ret. ISR
              <select id="fac-ret-isr-pct" onchange="calcFacturaPreview()" style="display:inline;width:auto;padding:2px;font-size:10px;margin-left:4px">
                <option value="0">Sin ret.</option>
                <option value="10">10%</option>
                <option value="1.25">1.25% RESICO</option>
              </select>
            </label>
            <div id="fac-ret-isr-preview" style="font-family:'DM Mono',monospace;font-size:14px;padding:8px;color:var(--danger)">$0.00</div>
          </div>
          <div>
            <label style="font-size:11px;display:block;margin-bottom:4px;color:var(--text2)">Ret. IVA
              <select id="fac-ret-iva-pct" onchange="calcFacturaPreview()" style="display:inline;width:auto;padding:2px;font-size:10px;margin-left:4px">
                <option value="0">Sin ret.</option>
                <option value="10.6667">2/3 IVA</option>
              </select>
            </label>
            <div id="fac-ret-iva-preview" style="font-family:'DM Mono',monospace;font-size:14px;padding:8px;color:var(--danger)">$0.00</div>
          </div>
        </div>
        <div style="padding:12px;background:var(--accent-light);border:2px solid var(--accent);border-radius:10px;display:flex;justify-content:space-between;align-items:center">
          <span style="font-weight:700;color:var(--accent);font-size:14px">TOTAL</span>
          <span id="fac-total-preview" style="font-family:'DM Mono',monospace;font-size:22px;font-weight:800;color:var(--accent)">$0.00</span>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalFacturar');_facPendiente=null;">Cancelar</button>
      <button class="btn btn-primary" id="btn-confirmar-factura" onclick="confirmarFactura()" style="background:#22c55e;border-color:#22c55e">ğŸ§¾ Timbrar factura</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACTURACIÃ“N ELECTRÃ“NICA â€” INTEGRACIÃ“N FISCALAPI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderFacturacion() {
  actualizarFiscalStatus();
  actualizarTimbresUI();
  renderPaquetesTimbres();
  // Render historial of emitted invoices
  const el = document.getElementById('facturacion-historial');
  if (!el) return;
  const facturas = [];
  (state.rentas||[]).forEach(r => {
    (r.abonos||[]).forEach(a => {
      if (a.uuid) {
        var _em = typeof getEmisor==='function' && r.emisorId ? getEmisor(r.emisorId) : null;
        facturas.push({
          uuid: a.uuid,
          fecha: a.fechaFactura || a.fecha,
          monto: a.monto,
          propiedad: r.nombre,
          cliente: r.clienteId ? (state.clientes.find(c=>c.id===r.clienteId)||{}).nombre||'â€”' : 'â€”',
          emisorNombre: _em ? _em.razon : 'â€”',
          mes: a.mes || 'â€”',
          rentaId: r.id,
          abonoId: a.id
        });
      }
    });
  });
  if (facturas.length === 0) {
    el.innerHTML = '<div class="empty-state" style="padding:30px"><div class="empty-icon">ğŸ§¾</div><div class="empty-title">Sin facturas emitidas</div><div class="empty-sub">Las facturas aparecerÃ¡n aquÃ­ cuando timbres abonos desde el detalle de cada propiedad</div></div>';
    return;
  }
  facturas.sort((a,b) => (b.fecha||'').localeCompare(a.fecha||''));
  el.innerHTML = '<table class="payments-table"><thead><tr><th>Fecha</th><th>Propiedad</th><th>Cliente</th><th>Emisor</th><th>Mes</th><th>Monto</th><th>UUID</th><th></th></tr></thead><tbody>' +
    facturas.map(f => `<tr>
      <td>${f.fecha||'â€”'}</td>
      <td>${f.propiedad}</td>
      <td>${f.cliente}</td>
      <td style="font-size:10px;color:var(--accent)">${f.emisorNombre}</td>
      <td>${f.mes}</td>
      <td class="mono" style="color:var(--success)">${fmt(f.monto)}</td>
      <td style="font-size:10px;color:var(--text3);max-width:180px;overflow:hidden;text-overflow:ellipsis" title="${f.uuid}">${f.uuid.slice(0,8)}...</td>
      <td><button onclick="descargarXMLFactura('${f.rentaId}','${f.abonoId}')" style="background:none;border:1px solid var(--accent);color:var(--accent);border-radius:4px;padding:2px 8px;font-size:10px;cursor:pointer">XML</button></td>
    </tr>`).join('') + '</tbody></table>';
}

var fiscalConfig = { apiKey:'', tenant:'', env:'test', emisores:[], emisor:{} };

function getFiscalBaseUrl() { return fiscalConfig.env === 'live' ? 'https://live.fiscalapi.com' : 'https://test.fiscalapi.com'; }

function guardarCredencialesFiscal() {
  fiscalConfig.apiKey = document.getElementById('cfg-fiscal-apikey').value.trim();
  fiscalConfig.tenant = document.getElementById('cfg-fiscal-tenant').value.trim();
  fiscalConfig.env = document.getElementById('cfg-fiscal-env').value;
  if (!fiscalConfig.apiKey || !fiscalConfig.tenant) { alert('Ingresa ambas credenciales'); return; }
  guardarFiscalEnFirebase(); actualizarFiscalStatus(); alert('âœ… Credenciales guardadas');
}

// â”€â”€ Multi-Emisor System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var _edEmisorCer = '';
var _edEmisorKey = '';

function getEmisores() { return fiscalConfig.emisores || []; }

function getEmisor(id) { return getEmisores().find(function(e){ return e.id === id; }); }

function getEmisorForRenta(rentaId) {
  var renta = state.rentas.find(function(r){ return r.id === rentaId; });
  if (!renta || !renta.emisorId) return null;
  return getEmisor(renta.emisorId);
}

function populateEmisorSelect() {
  var sel = document.getElementById('r-emisor-id');
  if (!sel) return;
  var emisores = getEmisores();
  sel.innerHTML = '<option value="">â€” Sin facturaciÃ³n â€”</option>' +
    emisores.map(function(e) {
      return '<option value="'+e.id+'">'+escHtml(e.razon)+' ('+e.rfc+')</option>';
    }).join('');
}

function renderEmisoresList() {
  var el = document.getElementById('emisores-list');
  if (!el) return;
  var emisores = getEmisores();
  if (emisores.length === 0) {
    el.innerHTML = '<div style="color:var(--text3);font-size:12px;text-align:center;padding:16px">Sin entidades. Agrega tu primera entidad emisora.</div>';
    return;
  }
  el.innerHTML = emisores.map(function(e) {
    var hasCsd = e.csdCer && e.csdKey;
    var propCount = state.rentas.filter(function(r){ return r.emisorId === e.id; }).length;
    return '<div style="background:#fff;border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px">' +
      '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<div>' +
          '<div style="font-weight:700;font-size:14px;color:var(--text)">' + escHtml(e.razon) + '</div>' +
          '<div style="font-size:12px;color:var(--text2);margin-top:2px;font-family:monospace">' + e.rfc + ' Â· ' + (e.regimen||'â€”') + '</div>' +
          '<div style="font-size:11px;color:var(--text3);margin-top:4px">' +
            (hasCsd ? 'âœ… CSD cargado' : 'âŒ Sin CSD') + ' Â· ' +
            propCount + ' propiedad' + (propCount!==1?'es':'') + ' vinculada' + (propCount!==1?'s':'') +
          '</div>' +
        '</div>' +
        '<div style="display:flex;gap:6px">' +
          '<button onclick="abrirEditorEmisor(\''+e.id+'\')" class="btn btn-ghost" style="font-size:12px;padding:6px 10px">âœï¸</button>' +
          '<button onclick="eliminarEmisor(\''+e.id+'\')" class="btn btn-ghost" style="font-size:12px;padding:6px 10px;color:var(--danger);border-color:var(--danger)">ğŸ—‘ï¸</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

function abrirEditorEmisor(id) {
  var editor = document.getElementById('emisor-editor');
  editor.style.display = 'block';
  _edEmisorCer = '';
  _edEmisorKey = '';
  document.getElementById('ed-csd-cer-label').textContent = 'ğŸ“‚ Seleccionar .cer';
  document.getElementById('ed-csd-key-label').textContent = 'ğŸ“‚ Seleccionar .key';
  document.getElementById('ed-csd-status').innerHTML = '';

  if (id) {
    var e = getEmisor(id);
    if (!e) return;
    document.getElementById('emisor-editor-title').textContent = 'Editar: ' + e.razon;
    document.getElementById('edit-emisor-id').value = id;
    document.getElementById('ed-emisor-rfc').value = e.rfc || '';
    document.getElementById('ed-emisor-cp').value = e.cp || '';
    document.getElementById('ed-emisor-razon').value = e.razon || '';
    document.getElementById('ed-emisor-regimen').value = e.regimen || '';
    document.getElementById('ed-emisor-serie').value = e.serie || 'RENTA';
    document.getElementById('ed-csd-password').value = e.csdPassword || '';
    _edEmisorCer = e.csdCer || '';
    _edEmisorKey = e.csdKey || '';
    if (_edEmisorCer) document.getElementById('ed-csd-cer-label').textContent = 'âœ… .cer cargado';
    if (_edEmisorKey) document.getElementById('ed-csd-key-label').textContent = 'âœ… .key cargado';
    document.getElementById('ed-csd-status').innerHTML = (_edEmisorCer?'âœ… .cer':'âŒ .cer') + ' &nbsp;|&nbsp; ' + (_edEmisorKey?'âœ… .key':'âŒ .key');
  } else {
    document.getElementById('emisor-editor-title').textContent = 'Nueva entidad emisora';
    document.getElementById('edit-emisor-id').value = '';
    ['ed-emisor-rfc','ed-emisor-cp','ed-emisor-razon','ed-csd-password'].forEach(function(fid){ document.getElementById(fid).value = ''; });
    document.getElementById('ed-emisor-regimen').value = '';
    document.getElementById('ed-emisor-serie').value = 'RENTA';
  }
  editor.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function cerrarEditorEmisor() {
  document.getElementById('emisor-editor').style.display = 'none';
  _edEmisorCer = '';
  _edEmisorKey = '';
}

function cargarCSDEmisor(input, tipo) {
  var file = input.files[0]; if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var bytes = new Uint8Array(e.target.result);
    var binary = ''; for (var i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
    var b64 = btoa(binary);
    if (tipo==='cer') { _edEmisorCer = b64; document.getElementById('ed-csd-cer-label').textContent = 'âœ… ' + file.name; }
    else { _edEmisorKey = b64; document.getElementById('ed-csd-key-label').textContent = 'âœ… ' + file.name; }
    document.getElementById('ed-csd-status').innerHTML = (_edEmisorCer?'âœ… .cer':'âŒ .cer') + ' &nbsp;|&nbsp; ' + (_edEmisorKey?'âœ… .key':'âŒ .key');
  };
  reader.readAsArrayBuffer(file);
}

function guardarEmisor() {
  var rfc = (document.getElementById('ed-emisor-rfc').value||'').trim().toUpperCase();
  var razon = (document.getElementById('ed-emisor-razon').value||'').trim().toUpperCase();
  var regimen = document.getElementById('ed-emisor-regimen').value;
  var cp = (document.getElementById('ed-emisor-cp').value||'').trim();
  var serie = (document.getElementById('ed-emisor-serie').value||'RENTA').trim().toUpperCase();
  var password = document.getElementById('ed-csd-password').value;

  if (!rfc || !razon || !regimen) { alert('Llena RFC, razÃ³n social y rÃ©gimen fiscal'); return; }
  if (rfc.length < 12) { alert('El RFC debe tener al menos 12 caracteres'); return; }

  if (!fiscalConfig.emisores) fiscalConfig.emisores = [];
  var editId = document.getElementById('edit-emisor-id').value;

  if (editId) {
    var idx = fiscalConfig.emisores.findIndex(function(e){ return e.id === editId; });
    if (idx !== -1) {
      fiscalConfig.emisores[idx].rfc = rfc;
      fiscalConfig.emisores[idx].razon = razon;
      fiscalConfig.emisores[idx].regimen = regimen;
      fiscalConfig.emisores[idx].cp = cp;
      fiscalConfig.emisores[idx].serie = serie;
      fiscalConfig.emisores[idx].csdPassword = password;
      if (_edEmisorCer) fiscalConfig.emisores[idx].csdCer = _edEmisorCer;
      if (_edEmisorKey) fiscalConfig.emisores[idx].csdKey = _edEmisorKey;
    }
  } else {
    fiscalConfig.emisores.push({
      id: uid(),
      rfc: rfc,
      razon: razon,
      regimen: regimen,
      cp: cp,
      serie: serie,
      csdCer: _edEmisorCer || '',
      csdKey: _edEmisorKey || '',
      csdPassword: password
    });
  }

  // Backward compat: keep first emisor as default emisor
  if (fiscalConfig.emisores.length > 0) {
    var first = fiscalConfig.emisores[0];
    fiscalConfig.emisor = { rfc: first.rfc, cp: first.cp, razon: first.razon, regimen: first.regimen, serie: first.serie };
    fiscalConfig.csdCer = first.csdCer;
    fiscalConfig.csdKey = first.csdKey;
    fiscalConfig.csdPassword = first.csdPassword;
  }

  cerrarEditorEmisor();
  guardarFiscalEnFirebase();
  actualizarFiscalStatus();
  renderEmisoresList();
  showToast('âœ… Entidad emisora guardada');
}

function eliminarEmisor(id) {
  var e = getEmisor(id);
  if (!e) return;
  var props = state.rentas.filter(function(r){ return r.emisorId === id; });
  var msg = 'Â¿Eliminar entidad "' + e.razon + '"?';
  if (props.length > 0) msg += '\n\nâš ï¸ Tiene ' + props.length + ' propiedad(es) vinculada(s). Se desvincularÃ¡n.';
  if (!confirm(msg)) return;
  fiscalConfig.emisores = fiscalConfig.emisores.filter(function(em){ return em.id !== id; });
  // Unlink properties
  props.forEach(function(r){ r.emisorId = ''; });
  // Update backward compat
  if (fiscalConfig.emisores.length > 0) {
    var first = fiscalConfig.emisores[0];
    fiscalConfig.emisor = { rfc: first.rfc, cp: first.cp, razon: first.razon, regimen: first.regimen, serie: first.serie };
    fiscalConfig.csdCer = first.csdCer;
    fiscalConfig.csdKey = first.csdKey;
  } else {
    fiscalConfig.emisor = {};
    fiscalConfig.csdCer = '';
    fiscalConfig.csdKey = '';
  }
  guardarFiscalEnFirebase();
  actualizarFiscalStatus();
  renderEmisoresList();
  save();
  showToast('Entidad eliminada');
}

// Legacy compatibility
function guardarDatosEmisor() { /* replaced by multi-emisor */ }
function cargarCSD(input, tipo) { /* replaced by cargarCSDEmisor */ }

function actualizarFiscalStatus() {
  var dot=document.getElementById('fiscal-dot'), txt=document.getElementById('fiscal-status-text'), sub=document.getElementById('fiscal-status-sub');
  if (!dot||!txt) return;
  var hasApi = fiscalConfig.apiKey && fiscalConfig.tenant;
  var emisores = getEmisores();
  var emisoresReady = emisores.filter(function(e){ return e.rfc && e.razon && e.csdCer && e.csdKey; });
  var timbres = state.timbresBalance || 0;

  if (hasApi && emisoresReady.length > 0 && timbres > 0) {
    dot.style.background = '#22c55e';
    txt.textContent = 'âœ… Listo para facturar';
    txt.style.color = '#22c55e';
    sub.textContent = (fiscalConfig.env==='live'?'ProducciÃ³n':'Pruebas') + ' â€” ' + emisoresReady.length + ' entidad(es) â€” ' + timbres + ' timbres';
  } else if (hasApi && emisoresReady.length > 0 && timbres <= 0) {
    dot.style.background = '#f59e0b'; txt.textContent = 'âš ï¸ Sin timbres'; txt.style.color = '#f59e0b';
    sub.textContent = emisoresReady.length + ' entidad(es) configurada(s) pero sin timbres';
  } else {
    dot.style.background = 'var(--text3)'; txt.textContent = 'No configurado'; txt.style.color = 'var(--text)';
    var f = [];
    if (!hasApi) f.push('credenciales API');
    if (emisores.length === 0) f.push('entidad emisora');
    else if (emisoresReady.length === 0) f.push('CSD en entidades');
    sub.textContent = 'Falta: ' + f.join(', ');
  }
  // Render emisores list on facturacion page
  renderEmisoresList();
}

var _fiscalConfigDirty = false; // Flag to prevent onSnapshot from overwriting unsaved local changes

function guardarFiscalEnFirebase() {
  if (typeof state!=='undefined') {
    state.fiscalConfig = {
      apiKey: fiscalConfig.apiKey,
      tenant: fiscalConfig.tenant,
      env: fiscalConfig.env,
      emisores: (fiscalConfig.emisores||[]).map(function(e) {
        return { id:e.id, rfc:e.rfc, razon:e.razon, regimen:e.regimen, cp:e.cp, serie:e.serie, csdCer:e.csdCer, csdKey:e.csdKey, csdPassword:e.csdPassword };
      }),
      // Backward compat: keep first emisor as default
      emisor: fiscalConfig.emisor ? JSON.parse(JSON.stringify(fiscalConfig.emisor)) : {},
      csdCer: fiscalConfig.csdCer || '',
      csdKey: fiscalConfig.csdKey || '',
      csdPassword: fiscalConfig.csdPassword || '',
      producto: { clave:(document.getElementById('cfg-prod-clave')?document.getElementById('cfg-prod-clave').value:'80131502'), unidad:(document.getElementById('cfg-prod-unidad')?document.getElementById('cfg-prod-unidad').value:'E48') }
    };
    _fiscalConfigDirty = true;
    if (typeof save==='function') save();
    setTimeout(function(){ _fiscalConfigDirty = false; }, 5000);
  }
}

function cargarFiscalDesdeFirebase() {
  if (!state.fiscalConfig) return;
  if (_fiscalConfigDirty) { console.log('[Fiscal] Skipping load â€” local changes pending'); return; }
  var fc = state.fiscalConfig;
  if (fc.apiKey) fiscalConfig.apiKey = fc.apiKey;
  if (fc.tenant) fiscalConfig.tenant = fc.tenant;
  if (fc.env) fiscalConfig.env = fc.env;
  // Load multi-emisor array
  if (fc.emisores && fc.emisores.length > 0) {
    fiscalConfig.emisores = fc.emisores;
  }
  // Backward compat: if old single-emisor exists but no emisores array, migrate
  if ((!fiscalConfig.emisores || fiscalConfig.emisores.length === 0) && fc.emisor && fc.emisor.rfc) {
    fiscalConfig.emisores = [{
      id: uid(),
      rfc: fc.emisor.rfc,
      razon: fc.emisor.razon || '',
      regimen: fc.emisor.regimen || '',
      cp: fc.emisor.cp || '',
      serie: fc.emisor.serie || 'RENTA',
      csdCer: fc.csdCer || '',
      csdKey: fc.csdKey || '',
      csdPassword: fc.csdPassword || ''
    }];
    console.log('[Fiscal] Migrated single emisor to multi-emisor array');
  }
  // Keep backward compat
  if (fc.emisor && fc.emisor.rfc) fiscalConfig.emisor = fc.emisor;
  if (fc.csdCer) fiscalConfig.csdCer = fc.csdCer;
  if (fc.csdKey) fiscalConfig.csdKey = fc.csdKey;
  if (fc.csdPassword) fiscalConfig.csdPassword = fc.csdPassword;

  // Populate API fields
  var apiFields = {'cfg-fiscal-apikey':fiscalConfig.apiKey||'','cfg-fiscal-tenant':fiscalConfig.tenant||'','cfg-fiscal-env':fiscalConfig.env||'test'};
  for (var k in apiFields) { var el=document.getElementById(k); if(el) el.value=apiFields[k]; }
  if (fc.producto) { var el2=document.getElementById('cfg-prod-clave'); if(el2) el2.value=fc.producto.clave||'80131502'; el2=document.getElementById('cfg-prod-unidad'); if(el2) el2.value=fc.producto.unidad||'E48'; }
  renderEmisoresList();
  actualizarFiscalStatus();
}

// â”€â”€ TIMBRES MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function actualizarTimbresUI() {
  var el = document.getElementById('timbres-count');
  if (el) el.textContent = state.timbresBalance || 0;
  var infoEl = document.getElementById('timbres-plan-info');
  if (infoEl) {
    var plan = state.planLimites || getPlanLimites('basico');
    if (plan.timbres > 0) {
      infoEl.innerHTML = 'Tu plan <b>' + plan.nombre + '</b> incluye ' + plan.timbres + ' timbres/mes';
    } else {
      infoEl.innerHTML = 'Tu plan <b>' + plan.nombre + '</b> no incluye timbres. Compra un paquete para facturar.';
    }
  }
  // Show/hide API creds section (only admin)
  var credsSection = document.getElementById('fiscal-api-creds-section');
  if (credsSection) {
    credsSection.style.display = (state.plan === 'admin') ? '' : 'none';
  }
  // Update custom qty price
  calcTimbresCustom();
}

function getPrecioTimbre(qty) {
  var p = state.timbresPrecio || { precio1:15, precio10:12, precio50:9, precio100:7 };
  if (qty >= 100) return p.precio100 || 7;
  if (qty >= 50) return p.precio50 || 9;
  if (qty >= 10) return p.precio10 || 12;
  return p.precio1 || 15;
}

function renderPaquetesTimbres() {
  var el = document.getElementById('timbres-paquetes');
  if (!el) return;
  var p = state.timbresPrecio || { precio1:15, precio10:12, precio50:9, precio100:7 };
  var paquetes = [
    { qty: 10, precio: p.precio10, label: '10 timbres', popular: false },
    { qty: 50, precio: p.precio50, label: '50 timbres', popular: true },
    { qty: 100, precio: p.precio100, label: '100 timbres', popular: false },
  ];
  el.innerHTML = paquetes.map(function(pkg) {
    var total = pkg.qty * pkg.precio;
    var ahorro = pkg.qty * p.precio1 - total;
    return '<div style="border:' + (pkg.popular ? '2px solid var(--accent)' : '1px solid var(--border)') + ';border-radius:12px;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;' + (pkg.popular ? 'background:var(--accent-light)' : '') + '">' +
      '<div>' +
        '<div style="font-weight:700;font-size:15px">' + pkg.label + (pkg.popular ? ' <span style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:20px;font-size:10px;vertical-align:middle">Popular</span>' : '') + '</div>' +
        '<div style="font-size:12px;color:var(--text3);margin-top:2px">$' + pkg.precio + '/timbre' + (ahorro > 0 ? ' Â· <span style="color:var(--success)">Ahorra $' + ahorro + '</span>' : '') + '</div>' +
      '</div>' +
      '<div style="text-align:right">' +
        '<div style="font-family:\'DM Mono\',monospace;font-size:18px;font-weight:800;color:var(--accent)">$' + total.toLocaleString('es-MX') + '</div>' +
        '<button onclick="comprarTimbres(' + pkg.qty + ')" class="btn btn-primary" style="font-size:11px;padding:4px 14px;margin-top:4px">Comprar</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function calcTimbresCustom() {
  var qtyEl = document.getElementById('timbres-custom-qty');
  var priceEl = document.getElementById('timbres-custom-price');
  var totalEl = document.getElementById('timbres-custom-total');
  if (!qtyEl || !priceEl || !totalEl) return;
  var qty = parseInt(qtyEl.value) || 0;
  var precio = getPrecioTimbre(qty);
  priceEl.textContent = '$' + precio;
  totalEl.textContent = '$' + (qty * precio).toLocaleString('es-MX');
}

// Attach input listener
(function() {
  var _intv = setInterval(function() {
    var el = document.getElementById('timbres-custom-qty');
    if (el) { el.addEventListener('input', calcTimbresCustom); clearInterval(_intv); }
  }, 1000);
  setTimeout(function() { clearInterval(_intv); }, 10000);
})();

function comprarTimbres(qty) {
  var precio = getPrecioTimbre(qty);
  var total = qty * precio;
  if (!confirm('Â¿Comprar ' + qty + ' timbres CFDI?\n\nPrecio: $' + precio + '/timbre\nTotal: $' + total.toLocaleString('es-MX') + ' MXN\n\n(En producciÃ³n se procesarÃ¡ el pago. Por ahora se acreditarÃ¡n inmediatamente.)')) return;
  // Acreditar timbres
  state.timbresBalance = (state.timbresBalance || 0) + qty;
  if (!state.timbresHistorial) state.timbresHistorial = [];
  state.timbresHistorial.push({
    fecha: new Date().toISOString(),
    tipo: 'compra',
    cantidad: qty,
    saldo: state.timbresBalance,
    detalle: 'Paquete de ' + qty + ' timbres Ã— $' + precio + ' = $' + total.toLocaleString('es-MX'),
    monto: total,
  });
  if (typeof save === 'function') save();
  actualizarTimbresUI();
  closeModal('modalComprarTimbres');
  showToast('âœ… ' + qty + ' timbres acreditados. Saldo: ' + state.timbresBalance);
}

function comprarTimbresCustom() {
  var qty = parseInt(document.getElementById('timbres-custom-qty').value);
  if (!qty || qty < 1) return alert('Ingresa una cantidad vÃ¡lida');
  comprarTimbres(qty);
}

function descontarTimbre(detalle) {
  state.timbresBalance = Math.max(0, (state.timbresBalance || 0) - 1);
  if (!state.timbresHistorial) state.timbresHistorial = [];
  state.timbresHistorial.push({
    fecha: new Date().toISOString(),
    tipo: 'uso',
    cantidad: -1,
    saldo: state.timbresBalance,
    detalle: detalle || 'Factura emitida',
  });
}

function marcarPagado(rentaId, abonoId) {
  var renta = state.rentas.find(function(r){return r.id===rentaId;});
  if (!renta) return;
  var abono = (renta.abonos||[]).find(function(a){return a.id===abonoId;});
  if (!abono) return;
  var formas = state.formasPago || ['Efectivo','Transferencia','Cheque','Tarjeta de crÃ©dito','Tarjeta de dÃ©bito','DepÃ³sito'];
  var lista = formas.map(function(f,i){ return (i+1)+'. '+f; }).join('\n');
  var sel = prompt('Â¿CÃ³mo pagÃ³ el inquilino?\n\n' + lista + '\n\nEscribe el nÃºmero:', '2');
  if (!sel) return;
  var idx = parseInt(sel) - 1;
  var metodo = (idx >= 0 && idx < formas.length) ? formas[idx] : sel;
  abono.metodo = metodo;
  abono.pendientePago = false;
  abono.nota = (abono.nota||'').replace('pendiente de pago','pagado âœ…');
  abono.fechaPago = new Date().toISOString().slice(0,10);
  save();
  if (typeof render === 'function') render();
  showToast('âœ… Pago registrado para ' + (abono.mes||''));
}

function acreditarTimbresmensuales() {
  var plan = state.planLimites || getPlanLimites(state.plan || 'basico');
  if (!plan.timbres || plan.timbres <= 0) return;
  var now = new Date();
  var mesActual = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
  // Check if already credited this month
  var yaCreditado = (state.timbresHistorial || []).some(function(h) {
    return h.tipo === 'bonus' && h.detalle && h.detalle.indexOf(mesActual) >= 0;
  });
  if (yaCreditado) return;
  // Credit monthly timbres
  state.timbresBalance = (state.timbresBalance || 0) + plan.timbres;
  if (!state.timbresHistorial) state.timbresHistorial = [];
  state.timbresHistorial.push({
    fecha: now.toISOString(),
    tipo: 'bonus',
    cantidad: plan.timbres,
    saldo: state.timbresBalance,
    detalle: 'Timbres mensuales plan ' + plan.nombre + ' â€” ' + mesActual,
  });
  save();
  showToast('ğŸ ' + plan.timbres + ' timbres acreditados (plan ' + plan.nombre + ')');
}

function verHistorialTimbres() {
  var el = document.getElementById('historial-timbres-content');
  if (!el) return;
  var hist = (state.timbresHistorial || []).slice().reverse();
  if (!hist.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--text3);padding:30px;font-size:13px">Sin movimientos registrados</div>';
  } else {
    var html = '<table class="payments-table"><thead><tr><th>Fecha</th><th>Tipo</th><th>Cant.</th><th>Saldo</th><th>Detalle</th></tr></thead><tbody>';
    html += hist.map(function(h) {
      var color = h.tipo === 'compra' ? 'var(--success)' : h.tipo === 'bonus' ? 'var(--accent)' : 'var(--danger)';
      var icon = h.tipo === 'compra' ? 'ğŸ›’' : h.tipo === 'bonus' ? 'ğŸ' : 'ğŸ§¾';
      return '<tr><td style="font-size:11px">' + (h.fecha ? h.fecha.slice(0,10) : '') + '</td>' +
        '<td><span style="color:' + color + ';font-weight:600;font-size:12px">' + icon + ' ' + (h.tipo||'') + '</span></td>' +
        '<td style="font-family:\'DM Mono\',monospace;font-weight:700;color:' + color + '">' + (h.cantidad > 0 ? '+' : '') + h.cantidad + '</td>' +
        '<td style="font-family:\'DM Mono\',monospace;font-weight:600">' + h.saldo + '</td>' +
        '<td style="font-size:11px;color:var(--text2)">' + (h.detalle||'') + '</td></tr>';
    }).join('');
    html += '</tbody></table>';
    el.innerHTML = html;
  }
  openModal('modalHistorialTimbres');
}

function fiscalReady(rentaId) {
  if (!fiscalConfig.apiKey || !fiscalConfig.tenant) return false;
  if (rentaId) {
    var emisor = getEmisorForRenta(rentaId);
    if (emisor && emisor.rfc && emisor.csdCer && emisor.csdKey) return true;
  }
  // Fallback: any emisor is ready
  var emisores = getEmisores();
  if (emisores.length > 0) {
    return emisores.some(function(e){ return e.rfc && e.csdCer && e.csdKey; });
  }
  // Legacy compat
  return fiscalConfig.csdCer && fiscalConfig.csdKey && fiscalConfig.emisor && fiscalConfig.emisor.rfc;
}

var _facPendiente = null;

// Facturar mes â€” emit invoice WITHOUT prior payment
function facturarMes(rentaId) {
  if (!fiscalReady(rentaId)) {
    // Check if property has emisor
    var _r = state.rentas.find(function(r){return r.id===rentaId;});
    if (_r && !_r.emisorId) {
      alert('âš ï¸ Esta propiedad no tiene entidad emisora asignada.\n\nVe a Editar propiedad y selecciona con quÃ© entidad se factura.');
    } else {
      alert('âš ï¸ Configura la facturaciÃ³n en la secciÃ³n de FacturaciÃ³n ElectrÃ³nica');
      nav('facturacion');
    }
    return;
  }
  if ((state.timbresBalance || 0) <= 0) {
    alert('âš ï¸ No tienes timbres disponibles.\n\nCompra un paquete de timbres en FacturaciÃ³n â†’ ğŸ›’ Comprar timbres');
    nav('facturacion'); return;
  }
  var renta = state.rentas.find(function(r){return r.id===rentaId;}); if(!renta){alert('Propiedad no encontrada');return;}
  var cliente = state.clientes.find(function(c){return c.id===renta.clienteId;}); if(!cliente){alert('No hay inquilino asignado');return;}
  if (!cliente.factura||!cliente.facturacion) { alert('El cliente no tiene datos de facturaciÃ³n. EdÃ­talo y activa "Requiere factura".'); return; }
  var fac = cliente.facturacion; if(!fac.rfc){alert('El cliente no tiene RFC');return;}

  // Determine which month to invoice
  var now = new Date();
  var mesActual = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
  var mesesNombres = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

  // Check if this month is already invoiced (in abonos with uuid)
  var yaFacturado = (renta.abonos||[]).some(function(a){ return a.uuid && a.mes === mesActual; });

  // Build list of months to choose from (current + next 2)
  var opciones = [];
  for (var i = 0; i < 3; i++) {
    var d = new Date(now.getFullYear(), now.getMonth() + i, 1);
    var mesKey = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
    var mesNom = mesesNombres[d.getMonth()+1] + ' ' + d.getFullYear();
    var yaFact = (renta.abonos||[]).some(function(a){ return a.uuid && a.mes === mesKey; });
    if (!yaFact) opciones.push({ key: mesKey, nombre: mesNom });
  }

  if (opciones.length === 0) { alert('Todos los meses prÃ³ximos ya estÃ¡n facturados.'); return; }

  // If only one option, use it; otherwise ask
  var mesSeleccionado, mesNombre;
  if (opciones.length === 1) {
    mesSeleccionado = opciones[0].key;
    mesNombre = opciones[0].nombre;
  } else {
    var lista = opciones.map(function(o, idx){ return (idx+1) + '. ' + o.nombre; }).join('\n');
    var sel = prompt('Â¿QuÃ© mes deseas facturar?\n\n' + lista + '\n\nEscribe el nÃºmero:', '1');
    if (!sel) return;
    var idx = parseInt(sel) - 1;
    if (idx < 0 || idx >= opciones.length) { alert('OpciÃ³n no vÃ¡lida'); return; }
    mesSeleccionado = opciones[idx].key;
    mesNombre = opciones[idx].nombre;
  }

  var subtotal = fac.subtotal ? parseFloat(fac.subtotal) : (renta.monto || 0);
  var descDefault = fac.concepto
    ? resolverConcepto(fac.concepto, rentaId, mesSeleccionado)
    : 'Pago de renta mensual correspondiente a ' + mesNombre + ' â€” ' + (renta.nombre||'Propiedad');

  // Create a temporary abono ID for this pre-invoice
  var tempAbonoId = 'fac-' + Date.now().toString(36);

  _facPendiente = { rentaId: rentaId, abonoId: null, mesFactura: mesSeleccionado, tempAbonoId: tempAbonoId, subtotal: subtotal, preInvoice: true };

  // Get emisor for this property
  var emisorFacMes = getEmisorForRenta(rentaId) || getEmisores()[0] || fiscalConfig.emisor || {};

  // Populate modal
  document.getElementById('fac-emisor-rfc').textContent = emisorFacMes.rfc || 'â€”';
  document.getElementById('fac-emisor-razon').textContent = emisorFacMes.razon || 'â€”';
  document.getElementById('fac-receptor-rfc').textContent = fac.rfc || 'â€”';
  document.getElementById('fac-receptor-razon').textContent = (fac.razon||cliente.nombre||'').toUpperCase();
  document.getElementById('fac-subtotal').value = subtotal;
  document.getElementById('fac-descripcion').value = descDefault;
  document.getElementById('fac-forma-pago').value = '99'; // Por definir (aÃºn no pagan)
  document.getElementById('fac-metodo-pago').value = 'PUE';
  document.getElementById('fac-moneda').value = 'MXN';
  document.getElementById('fac-uso-cfdi').value = fac.cfdi || 'G03';
  document.getElementById('fac-serie').value = emisorFacMes.serie || 'RENTA';
  document.getElementById('fac-periodo').textContent = mesNombre;
  document.getElementById('fac-ambiente').textContent = fiscalConfig.env === 'live' ? 'ğŸŸ¢ PRODUCCIÃ“N' : 'ğŸ§ª PRUEBAS';
  document.getElementById('fac-timbres-disp').textContent = state.timbresBalance || 0;
  // Predial badge
  var predBadge = document.getElementById('fac-predial-badge');
  if (predBadge) { if (fac.predial) { predBadge.style.display = 'inline'; document.getElementById('fac-predial-num').textContent = fac.predial; } else { predBadge.style.display = 'none'; } }
  // Set retention defaults from client facturacion
  var retIsrSel = document.getElementById('fac-ret-isr-pct');
  var retIvaSel = document.getElementById('fac-ret-iva-pct');
  if (retIsrSel) retIsrSel.value = fac.retIsrPct || '0';
  if (retIvaSel) retIvaSel.value = fac.retIvaPct || '0';

  calcFacturaPreview();
  openModal('modalFacturar');
}

function facturarAbono(rentaId, abonoId) {
  if (!fiscalReady(rentaId)) {
    var _r2 = state.rentas.find(function(r){return r.id===rentaId;});
    if (_r2 && !_r2.emisorId) {
      alert('âš ï¸ Esta propiedad no tiene entidad emisora asignada.\n\nVe a Editar propiedad y selecciona con quÃ© entidad se factura.');
    } else {
      alert('âš ï¸ Configura la facturaciÃ³n en la secciÃ³n de FacturaciÃ³n ElectrÃ³nica');
      nav('facturacion');
    }
    return;
  }
  if ((state.timbresBalance || 0) <= 0) {
    alert('âš ï¸ No tienes timbres disponibles.\n\nCompra un paquete de timbres en FacturaciÃ³n â†’ ğŸ›’ Comprar timbres');
    nav('facturacion'); return;
  }
  var renta=state.rentas.find(function(r){return r.id===rentaId;}); if(!renta){alert('Propiedad no encontrada');return;}
  var cliente=state.clientes.find(function(c){return c.id===renta.clienteId;}); if(!cliente){alert('No hay inquilino asignado');return;}
  if (!cliente.factura||!cliente.facturacion) { alert('El cliente no tiene datos de facturaciÃ³n. EdÃ­talo y activa "Requiere factura".'); return; }
  var fac=cliente.facturacion; if(!fac.rfc){alert('El cliente no tiene RFC');return;}
  var abonoIdx = (renta.abonos||[]).findIndex(function(a){return a.id===abonoId;});
  var abono = abonoIdx >= 0 ? renta.abonos[abonoIdx] : null;
  if(!abono){alert('Abono no encontrado');return;}
  if (abono.uuid){alert('Ya facturado.\nUUID: '+abono.uuid);return;}

  var subtotal=fac.subtotal?parseFloat(fac.subtotal):(abono.monto||0);
  var mesesNombres=['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  var mesParts=(abono.mes||'').split('-');
  var mesNombre=mesParts.length===2?mesesNombres[parseInt(mesParts[1])]+' '+mesParts[0]:'';
  var descDefault = fac.concepto
    ? resolverConcepto(fac.concepto, rentaId, abono.mes)
    : 'Pago de renta mensual correspondiente a '+mesNombre+' â€” '+(renta.nombre||'Propiedad');

  // Map metodo to forma de pago code
  var metodoText=(abono.metodo||'').toLowerCase();
  var fpCodeDefault='99';
  if(metodoText.indexOf('efectivo')>=0) fpCodeDefault='01';
  else if(metodoText.indexOf('cheque')>=0) fpCodeDefault='02';
  else if(metodoText.indexOf('transferencia')>=0) fpCodeDefault='03';
  else if(metodoText.indexOf('tarjeta')>=0&&metodoText.indexOf('crÃ©d')>=0) fpCodeDefault='04';
  else if(metodoText.indexOf('tarjeta')>=0&&metodoText.indexOf('dÃ©b')>=0) fpCodeDefault='28';
  else if(metodoText.indexOf('depÃ³sito')>=0) fpCodeDefault='03';

  _facPendiente = { rentaId: rentaId, abonoId: abonoId, subtotal: subtotal };

  // Get emisor for this property
  var emisorFac = getEmisorForRenta(rentaId) || getEmisores()[0] || fiscalConfig.emisor || {};

  // Populate modal fields
  document.getElementById('fac-emisor-rfc').textContent = emisorFac.rfc || 'â€”';
  document.getElementById('fac-emisor-razon').textContent = emisorFac.razon || 'â€”';
  document.getElementById('fac-receptor-rfc').textContent = fac.rfc || 'â€”';
  document.getElementById('fac-receptor-razon').textContent = (fac.razon||cliente.nombre||'').toUpperCase();
  document.getElementById('fac-subtotal').value = subtotal;
  document.getElementById('fac-descripcion').value = descDefault;
  document.getElementById('fac-forma-pago').value = fpCodeDefault;
  document.getElementById('fac-metodo-pago').value = 'PUE';
  document.getElementById('fac-moneda').value = 'MXN';
  document.getElementById('fac-uso-cfdi').value = fac.cfdi || 'G03';
  document.getElementById('fac-serie').value = emisorFac.serie || 'RENTA';
  document.getElementById('fac-periodo').textContent = mesNombre;
  document.getElementById('fac-ambiente').textContent = fiscalConfig.env === 'live' ? 'ğŸŸ¢ PRODUCCIÃ“N' : 'ğŸ§ª PRUEBAS';
  document.getElementById('fac-timbres-disp').textContent = state.timbresBalance || 0;
  // Predial badge
  var predBadge2 = document.getElementById('fac-predial-badge');
  if (predBadge2) { if (fac.predial) { predBadge2.style.display = 'inline'; document.getElementById('fac-predial-num').textContent = fac.predial; } else { predBadge2.style.display = 'none'; } }

  // Calc taxes preview
  calcFacturaPreview();
  openModal('modalFacturar');
}

function calcFacturaPreview() {
  var subtotal = parseFloat(document.getElementById('fac-subtotal').value) || 0;
  var iva = subtotal * 0.16;
  var retIsrPct = parseFloat(document.getElementById('fac-ret-isr-pct').value) || 0;
  var retIvaPct = parseFloat(document.getElementById('fac-ret-iva-pct').value) || 0;
  var retIsr = subtotal * (retIsrPct / 100);
  var retIva = subtotal * (retIvaPct / 100);
  var total = subtotal + iva - retIsr - retIva;
  document.getElementById('fac-iva-preview').textContent = '$' + iva.toLocaleString('es-MX',{minimumFractionDigits:2});
  document.getElementById('fac-ret-isr-preview').textContent = retIsr > 0 ? '-$' + retIsr.toLocaleString('es-MX',{minimumFractionDigits:2}) : '$0.00';
  document.getElementById('fac-ret-iva-preview').textContent = retIva > 0 ? '-$' + retIva.toLocaleString('es-MX',{minimumFractionDigits:2}) : '$0.00';
  document.getElementById('fac-total-preview').textContent = '$' + total.toLocaleString('es-MX',{minimumFractionDigits:2});
}

function confirmarFactura() {
  if (!_facPendiente) return;
  var rentaId = _facPendiente.rentaId, abonoId = _facPendiente.abonoId;
  var isPreInvoice = _facPendiente.preInvoice === true;
  var renta=state.rentas.find(function(r){return r.id===rentaId;});
  var cliente=state.clientes.find(function(c){return c.id===renta.clienteId;});
  var fac=cliente.facturacion;

  var abonoIdx = -1, abono = null;
  if (!isPreInvoice) {
    abonoIdx = (renta.abonos||[]).findIndex(function(a){return a.id===abonoId;});
    abono = renta.abonos[abonoIdx];
  }

  var subtotal = parseFloat(document.getElementById('fac-subtotal').value) || 0;
  var desc = document.getElementById('fac-descripcion').value || 'Renta mensual';
  var fpCode = document.getElementById('fac-forma-pago').value;
  var mpCode = document.getElementById('fac-metodo-pago').value;
  var moneda = document.getElementById('fac-moneda').value;
  var usoCfdi = document.getElementById('fac-uso-cfdi').value;
  var serie = document.getElementById('fac-serie').value;
  var retIsrPct = parseFloat(document.getElementById('fac-ret-isr-pct').value) || 0;
  var retIvaPct = parseFloat(document.getElementById('fac-ret-iva-pct').value) || 0;

  var taxes=[];
  var ivaAmount = Math.round(subtotal * 0.16 * 100) / 100;
  taxes.push({taxCode:'002',taxTypeCode:'Tasa',taxRate:'0.160000',taxFlagCode:'T',taxBase:subtotal,taxAmount:ivaAmount});
  if(retIsrPct>0) {
    var retIsrAmt = Math.round(subtotal * (retIsrPct/100) * 100) / 100;
    taxes.push({taxCode:'001',taxTypeCode:'Tasa',taxRate:(retIsrPct/100).toFixed(6),taxFlagCode:'R',taxBase:subtotal,taxAmount:retIsrAmt});
  }
  if(retIvaPct>0) {
    var retIvaAmt = Math.round(subtotal * (retIvaPct/100) * 100) / 100;
    taxes.push({taxCode:'002',taxTypeCode:'Tasa',taxRate:(retIvaPct/100).toFixed(6),taxFlagCode:'R',taxBase:subtotal,taxAmount:retIvaAmt});
  }

  var now=new Date();
  var fechaStr=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+'T'+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');

  // Get the emisor for this property
  var emisor = getEmisorForRenta(rentaId);
  if (!emisor) {
    // Fallback to first emisor or legacy
    emisor = (getEmisores()[0]) || {
      rfc: fiscalConfig.emisor?.rfc || '',
      cp: fiscalConfig.emisor?.cp || '',
      razon: fiscalConfig.emisor?.razon || '',
      regimen: fiscalConfig.emisor?.regimen || '',
      serie: fiscalConfig.emisor?.serie || 'RENTA',
      csdCer: fiscalConfig.csdCer || '',
      csdKey: fiscalConfig.csdKey || '',
      csdPassword: fiscalConfig.csdPassword || ''
    };
  }
  var csdPass = emisor.csdPassword || (state.fiscalConfig && state.fiscalConfig.csdPassword) || '';

  // Pre-flight validation
  var validationErrors = [];
  if (!emisor.cp || emisor.cp.length !== 5) validationErrors.push('C.P. del emisor invÃ¡lido (debe ser 5 dÃ­gitos)');
  if (!fac.cp || fac.cp.length !== 5) validationErrors.push('C.P. fiscal del receptor invÃ¡lido (debe ser 5 dÃ­gitos)');
  if (!fac.rfc || fac.rfc.length < 12) validationErrors.push('RFC del receptor invÃ¡lido');
  if (!emisor.rfc || emisor.rfc.length < 12) validationErrors.push('RFC del emisor invÃ¡lido');
  if (!desc.trim()) validationErrors.push('La descripciÃ³n/concepto no puede estar vacÃ­a');
  if (subtotal <= 0) validationErrors.push('El subtotal debe ser mayor a 0');
  if (!emisor.csdCer || !emisor.csdKey) validationErrors.push('Faltan archivos CSD (.cer y .key) para ' + (emisor.razon||'esta entidad'));
  if (validationErrors.length > 0) {
    var btn1 = document.getElementById('btn-confirmar-factura'); if(btn1){btn1.disabled=false;btn1.textContent='ğŸ§¾ Timbrar factura';}
    alert('âš ï¸ Errores de validaciÃ³n:\n\nâ€¢ ' + validationErrors.join('\nâ€¢ '));
    return;
  }

  // Take only the first email if multiple are comma-separated
  var recipientEmail = (fac.emailFactura||fac.email||cliente.email||'').split(',')[0].split(';')[0].trim();

  var payload={versionCode:'4.0',series:serie,date:fechaStr,paymentFormCode:fpCode,paymentMethodCode:mpCode,currencyCode:moneda,typeCode:'I',
    expeditionZipCode:emisor.cp||'',exchangeRate:1,exportCode:'01',
    issuer:{tin:emisor.rfc,legalName:emisor.razon,taxRegimeCode:emisor.regimen,
      taxCredentials:[{base64File:emisor.csdCer,fileType:0,password:csdPass},{base64File:emisor.csdKey,fileType:1,password:csdPass}]},
    recipient:{tin:fac.rfc.toUpperCase(),legalName:(fac.razon||cliente.nombre||'').toUpperCase(),zipCode:fac.cp||'',taxRegimeCode:fac.regimen||'612',cfdiUseCode:usoCfdi,email:recipientEmail},
    items:[{itemCode:(state.fiscalConfig&&state.fiscalConfig.producto&&state.fiscalConfig.producto.clave)||'80131502',
      itemSku: serie + '-' + ((abono ? abono.mes : _facPendiente.mesFactura) || '').replace(/-/g,''),
      quantity:1,
      unitOfMeasurementCode:(state.fiscalConfig&&state.fiscalConfig.producto&&state.fiscalConfig.producto.unidad)||'E48',
      description:desc,unitPrice:subtotal,taxObjectCode:'02',itemTaxes:taxes,
      propertyTaxAccountNumber: fac.predial || undefined}]
  };

  // Disable button while processing
  var btn = document.getElementById('btn-confirmar-factura');
  if(btn){btn.disabled=true;btn.textContent='â³ Timbrando...';}

  // Custom stringify to preserve 6-decimal taxRate (JSON.stringify drops trailing zeros from numbers)
  var payloadStr = JSON.stringify(payload);
  // Convert string taxRates back to numeric with 6 decimals: "taxRate":"0.160000" â†’ "taxRate":0.160000
  payloadStr = payloadStr.replace(/"taxRate":"(\d+\.\d+)"/g, '"taxRate":$1');

  if (fiscalConfig.env !== 'live') console.log('ğŸ“‹ FiscalAPI Payload:', payloadStr);

  var baseUrl=getFiscalBaseUrl();
  fetch(baseUrl+'/api/v4/invoices',{method:'POST',headers:{'Content-Type':'application/json','X-API-KEY':fiscalConfig.apiKey,'X-TENANT-KEY':fiscalConfig.tenant,'X-TIME-ZONE':'America/Mexico_City'},body:payloadStr})
  .then(function(r){
    return r.text().then(function(text) {
      console.log('ğŸ“‹ FiscalAPI Raw Response (' + r.status + '):', text);
      try { return JSON.parse(text); }
      catch(e) { return { succeeded: false, message: 'HTTP ' + r.status + ': ' + text.substring(0, 500) }; }
    });
  })
  .then(function(data){
    console.log('ğŸ“‹ FiscalAPI Response:', JSON.stringify(data, null, 2));
    if(data.succeeded&&data.data){
      var uuid=data.data.uuid||'',folio=data.data.number||'',total=data.data.total||0;
      var xmlB64='',qrB64='',invoiceId='';
      if(data.data.responses&&data.data.responses[0]){xmlB64=data.data.responses[0].invoiceBase64||'';qrB64=data.data.responses[0].invoiceBase64QrCode||'';invoiceId=data.data.id||'';}

      if (isPreInvoice) {
        // Pre-invoice: create a new abono record with factura data, marked as pending payment
        if (!renta.abonos) renta.abonos = [];
        var mesFactura = _facPendiente.mesFactura || '';
        renta.abonos.push({
          id: _facPendiente.tempAbonoId || ('fac-' + Date.now().toString(36)),
          fecha: new Date().toISOString().slice(0,10),
          mes: mesFactura,
          monto: parseFloat(document.getElementById('fac-subtotal').value) || 0,
          metodo: '',
          nota: 'ğŸ§¾ Facturado â€” pendiente de pago',
          uuid: uuid,
          folioFiscal: folio,
          facturadoEn: new Date().toISOString(),
          xmlBase64: xmlB64,
          qrBase64: qrB64,
          invoiceId: invoiceId,
          pendientePago: true
        });
      } else {
        // Post-payment: update existing abono
        renta.abonos[abonoIdx].uuid=uuid; renta.abonos[abonoIdx].folioFiscal=folio; renta.abonos[abonoIdx].facturadoEn=new Date().toISOString();
        renta.abonos[abonoIdx].xmlBase64=xmlB64; renta.abonos[abonoIdx].qrBase64=qrB64; renta.abonos[abonoIdx].invoiceId=invoiceId;
      }

      descontarTimbre('CFDI ' + uuid.slice(0,8) + ' â€” ' + (renta.nombre||'') + ' ' + (isPreInvoice ? _facPendiente.mesFactura : (renta.abonos[abonoIdx].mes||'')));
      actualizarTimbresUI();
      save();
      closeModal('modalFacturar');
      _facPendiente = null;
      alert('âœ… Â¡Factura timbrada!\n\nUUID: '+uuid+'\nFolio: '+folio+'\nTotal: $'+total.toLocaleString('es-MX',{minimumFractionDigits:2}) + (isPreInvoice ? '\n\nğŸ“Œ Se registrÃ³ como pendiente de pago' : ''));
      if(typeof render==='function') render();
    } else {
      // Build detailed error message
      var errMsg = data.message || 'Error desconocido';
      if (data.details) errMsg += '\n\nğŸ“ Detalles: ' + data.details;
      // FiscalAPI sometimes returns errors in different formats
      if (data.errors) {
        errMsg += '\n\nâš ï¸ Errores de validaciÃ³n:';
        if (Array.isArray(data.errors)) {
          data.errors.forEach(function(e, i) {
            errMsg += '\n' + (i+1) + '. ' + (e.message || e.description || e.errorMessage || JSON.stringify(e));
          });
        } else if (typeof data.errors === 'object') {
          for (var key in data.errors) {
            var val = data.errors[key];
            errMsg += '\nâ€¢ ' + key + ': ' + (Array.isArray(val) ? val.join(', ') : val);
          }
        }
      }
      if (data.data && data.data.errors) {
        errMsg += '\n\nâš ï¸ Errores en data:';
        if (Array.isArray(data.data.errors)) {
          data.data.errors.forEach(function(e) { errMsg += '\nâ€¢ ' + (e.message || e.description || JSON.stringify(e)); });
        }
      }
      if (data.data && data.data.responses) {
        data.data.responses.forEach(function(r) {
          if (r.errors && r.errors.length) {
            errMsg += '\n\nâš ï¸ Errores del PAC:';
            r.errors.forEach(function(e) { errMsg += '\nâ€¢ ' + (e.message || e.description || JSON.stringify(e)); });
          }
        });
      }
      // Also show the full response in console for debugging
      console.error('âŒ FiscalAPI Error:', JSON.stringify(data, null, 2));
      var btn2=document.getElementById('btn-confirmar-factura'); if(btn2){btn2.disabled=false;btn2.textContent='ğŸ§¾ Timbrar factura';}
      alert('âŒ Error al timbrar:\n\n' + errMsg + '\n\n(Revisa la consola del navegador para mÃ¡s detalle: F12 â†’ Console)');
    }
  })
  .catch(function(err){
    var btn3=document.getElementById('btn-confirmar-factura'); if(btn3){btn3.disabled=false;btn3.textContent='ğŸ§¾ Timbrar factura';}
    alert('âŒ Error de conexiÃ³n:\n\n'+err.message);
  });
}

function descargarXMLFactura(rentaId, abonoId) {
  var renta=state.rentas.find(function(r){return r.id===rentaId;}); if(!renta)return;
  var abono=(renta.abonos||[]).find(function(a){return a.id===abonoId;}); if(!abono){alert('Abono no encontrado');return;}
  if(!abono.xmlBase64){alert('No se tiene el XML almacenado');return;}
  try{var xml=atob(abono.xmlBase64);var blob=new Blob([xml],{type:'application/xml'});var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='CFDI_'+(abono.uuid||'factura')+'.xml';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}catch(e){alert('Error: '+e.message);}
}

// Hook: cargar config fiscal despuÃ©s del state load
(function(){
  var origInterval = setInterval(function(){
    if(typeof state!=='undefined'&&state.fiscalConfig){
      cargarFiscalDesdeFirebase();
      actualizarTimbresUI();
      renderPaquetesTimbres();
      clearInterval(origInterval);
    }
  }, 1500);
  // Also init timbres UI once state is available even without fiscal config
  var timbresInterval = setInterval(function(){
    if(typeof state!=='undefined'){
      actualizarTimbresUI();
      renderPaquetesTimbres();
      clearInterval(timbresInterval);
    }
  }, 2000);
  setTimeout(function(){ clearInterval(origInterval); clearInterval(timbresInterval); }, 15000);
})();
</script>
</body>
</html>