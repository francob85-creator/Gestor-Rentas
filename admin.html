<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GestorRenta ‚Äî Panel Admin</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f0e8;
    --surface: #fdfaf4;
    --surface2: #f0ead8;
    --border: #d9cfb8;
    --accent: #2d6a4f;
    --accent2: #1b4332;
    --accent-light: #e8f5e9;
    --danger: #c0392b;
    --danger-light: #fdf0ee;
    --success: #2d6a4f;
    --success-light: #e8f5e9;
    --warning: #b7791f;
    --warning-light: #fef9ec;
    --text: #2c2416;
    --text2: #5c4d3a;
    --text3: #9e8e76;
    --sidebar-bg: #1b3a2d;
    --gold: #c8a85a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* ‚ïê‚ïê‚ïê LOGIN GATE ‚ïê‚ïê‚ïê */
  .login-gate {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1b3a2d 0%, #2d6a4f 50%, #1b4332 100%);
  }
  .login-card {
    background: var(--surface);
    border-radius: 20px;
    padding: 48px 40px;
    width: 420px;
    max-width: 92vw;
    box-shadow: 0 24px 80px rgba(0,0,0,0.3);
    text-align: center;
  }
  .login-card .logo {
    font-family: 'DM Serif Display', Georgia, serif;
    font-size: 32px;
    color: var(--gold);
    margin-bottom: 4px;
  }
  .login-card .logo span { color: var(--text3); font-style: italic; }
  .login-card .subtitle {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text3);
    margin-bottom: 32px;
    font-weight: 600;
  }
  .login-card input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    font-family: inherit;
    background: var(--surface);
    color: var(--text);
    margin-bottom: 12px;
    transition: border-color 0.2s;
  }
  .login-card input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(45,106,79,0.1);
  }
  .login-btn {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: background 0.2s;
    margin-top: 4px;
  }
  .login-btn:hover { background: var(--accent2); }
  .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .login-error {
    color: var(--danger);
    font-size: 13px;
    margin-top: 12px;
    min-height: 20px;
  }

  /* ‚ïê‚ïê‚ïê ADMIN SHELL ‚ïê‚ïê‚ïê */
  .admin-shell { display: none; }
  .admin-shell.active { display: block; }

  /* Top bar */
  .topbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 14px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 6px rgba(0,0,0,0.06);
  }
  .topbar-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .topbar .logo {
    font-family: 'DM Serif Display', Georgia, serif;
    font-size: 22px;
    color: var(--gold);
  }
  .topbar .logo span { color: var(--text3); font-style: italic; }
  .admin-badge {
    background: linear-gradient(135deg, #1b3a2d, #2d6a4f);
    color: #e8f5e9;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 4px 12px;
    border-radius: 20px;
  }
  .topbar-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .topbar-stat {
    text-align: right;
  }
  .topbar-stat-val {
    font-family: 'DM Mono', monospace;
    font-size: 16px;
    font-weight: 600;
  }
  .topbar-stat-label {
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .logout-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 13px;
    cursor: pointer;
    font-family: inherit;
    color: var(--text2);
    transition: all 0.15s;
  }
  .logout-btn:hover {
    border-color: var(--danger);
    color: var(--danger);
    background: var(--danger-light);
  }

  /* ‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê */
  .admin-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px;
  }

  /* KPI Row */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }
  .kpi {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px 22px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    border-top: 3px solid transparent;
    transition: transform 0.2s;
  }
  .kpi:hover { transform: translateY(-2px); }
  .kpi.green { border-top-color: var(--success); }
  .kpi.amber { border-top-color: var(--warning); }
  .kpi.red   { border-top-color: var(--danger); }
  .kpi.blue  { border-top-color: #2563eb; }
  .kpi.gold  { border-top-color: var(--gold); }
  .kpi-val {
    font-family: 'DM Mono', monospace;
    font-size: 28px;
    font-weight: 600;
    line-height: 1.1;
    margin: 6px 0 4px;
  }
  .kpi-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text3);
  }
  .kpi-sub {
    font-size: 12px;
    color: var(--text3);
    margin-top: 4px;
  }

  /* Section Headers */
  .section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .section-title {
    font-family: 'DM Serif Display', Georgia, serif;
    font-size: 24px;
    color: var(--text);
  }

  /* Search & Filters */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  .search-input {
    padding: 9px 14px 9px 36px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    font-family: inherit;
    background: var(--surface);
    color: var(--text);
    width: 280px;
    max-width: 100%;
    transition: border-color 0.2s;
  }
  .search-input:focus {
    outline: none;
    border-color: var(--accent);
  }
  .search-wrap {
    position: relative;
  }
  .search-wrap::before {
    content: 'üîç';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 13px;
    pointer-events: none;
  }
  .filter-chip {
    padding: 7px 16px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    font-family: inherit;
    font-weight: 500;
    transition: all 0.15s;
  }
  .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
  .filter-chip.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }

  /* ‚ïê‚ïê‚ïê TENANT TABLE ‚ïê‚ïê‚ïê */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 1px 6px rgba(0,0,0,0.04);
  }
  .tenant-table {
    width: 100%;
    border-collapse: collapse;
  }
  .tenant-table th {
    text-align: left;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--text3);
    padding: 14px 16px;
    border-bottom: 2px solid var(--border);
    background: var(--surface2);
    font-weight: 700;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
  }
  .tenant-table th:hover { color: var(--accent); }
  .tenant-table th .sort-arrow { font-size: 9px; margin-left: 4px; opacity: 0.4; }
  .tenant-table th.sorted .sort-arrow { opacity: 1; color: var(--accent); }
  .tenant-table td {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    vertical-align: middle;
  }
  .tenant-table tr:last-child td { border-bottom: none; }
  .tenant-table tbody tr {
    transition: background 0.1s;
    cursor: pointer;
  }
  .tenant-table tbody tr:hover td { background: var(--accent-light); }

  /* Cell styles */
  .cell-name {
    font-weight: 600;
    color: var(--text);
  }
  .cell-empresa {
    font-size: 12px;
    color: var(--text3);
    margin-top: 2px;
  }
  .cell-email {
    font-size: 13px;
    color: var(--text2);
  }
  .cell-tel {
    font-size: 12px;
    color: var(--text3);
    margin-top: 1px;
  }
  .mono {
    font-family: 'DM Mono', monospace;
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 3px 10px;
    border-radius: 20px;
    white-space: nowrap;
  }
  .badge.plan-basico   { background: #f0f0f0; color: #555; border: 1px solid #ccc; }
  .badge.plan-pro      { background: #e8f4fd; color: #1d6fa4; border: 1px solid rgba(29,111,164,0.2); }
  .badge.plan-enterprise { background: linear-gradient(135deg,#fef3c7,#fef9ec); color: #92400e; border: 1px solid #f6c84b; }

  .badge.status-active   { background: var(--success-light); color: var(--success); border: 1px solid rgba(45,106,79,0.2); }
  .badge.status-trialing { background: #e8f4fd; color: #1d6fa4; border: 1px solid rgba(29,111,164,0.2); }
  .badge.status-pastdue  { background: var(--warning-light); color: var(--warning); border: 1px solid rgba(183,121,31,0.2); }
  .badge.status-canceled { background: var(--danger-light); color: var(--danger); border: 1px solid rgba(192,57,43,0.2); }
  .badge.status-suspended { background: #f5f5f5; color: #666; border: 1px solid #ccc; }

  /* ‚ïê‚ïê‚ïê DETAIL DRAWER ‚ïê‚ïê‚ïê */
  .drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
    z-index: 500;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }
  .drawer-overlay.open { opacity: 1; pointer-events: all; }

  .drawer {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 640px;
    max-width: 100vw;
    background: var(--surface);
    border-left: 1px solid var(--border);
    z-index: 501;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    box-shadow: -8px 0 40px rgba(0,0,0,0.15);
  }
  .drawer.open { transform: translateX(0); }

  .drawer-header {
    padding: 24px 28px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    flex-shrink: 0;
  }
  .drawer-title {
    font-family: 'DM Serif Display', Georgia, serif;
    font-size: 22px;
    line-height: 1.2;
  }
  .drawer-subtitle {
    font-size: 13px;
    color: var(--text3);
    margin-top: 4px;
  }
  .drawer-close {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .drawer-close:hover { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }

  .drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
  }

  .drawer-section {
    margin-bottom: 24px;
  }
  .drawer-section-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text3);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .drawer-section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .info-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
  }
  .info-box.full { grid-column: 1 / -1; }
  .info-val {
    font-family: 'DM Mono', monospace;
    font-size: 18px;
    font-weight: 500;
    color: var(--text);
  }
  .info-val.sm { font-size: 14px; }
  .info-val.danger { color: var(--danger); }
  .info-val.success { color: var(--success); }
  .info-val.warning { color: var(--warning); }
  .info-label {
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 3px;
  }

  /* Action buttons in drawer */
  .drawer-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
  }
  .btn {
    padding: 9px 18px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: var(--accent2); }
  .btn-ghost { background: var(--surface); color: var(--text2); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: var(--danger-light); color: var(--danger); border: 1px solid rgba(192,57,43,0.2); }
  .btn-danger:hover { background: #fee2e2; }
  .btn-success { background: var(--success-light); color: var(--success); border: 1px solid rgba(45,106,79,0.2); }
  .btn-success:hover { background: #dcfce7; }
  .btn-warning { background: var(--warning-light); color: var(--warning); border: 1px solid rgba(183,121,31,0.2); }
  .btn-warning:hover { background: #fef3c7; }

  /* Status change select */
  .status-select {
    padding: 8px 12px;
    border: 1.5px solid var(--border);
    border-radius: 8px;
    font-size: 13px;
    font-family: inherit;
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
  }
  .status-select:focus { outline: none; border-color: var(--accent); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #1b3a2d;
    color: #fff;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 500;
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Loading spinner */
  .loading-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    color: var(--text3);
    gap: 16px;
  }
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Revenue bar */
  .revenue-bar {
    display: flex;
    align-items: flex-end;
    gap: 3px;
    height: 60px;
    margin-top: 8px;
  }
  .rev-col {
    flex: 1;
    border-radius: 3px 3px 0 0;
    min-height: 2px;
    transition: height 0.4s ease;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
    background: var(--surface2);
    border-radius: 14px;
    border: 1px dashed var(--border);
  }

  /* Notes textarea */
  .notes-area {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-size: 13px;
    font-family: inherit;
    background: var(--surface);
    color: var(--text);
    resize: vertical;
    transition: border-color 0.2s;
  }
  .notes-area:focus { outline: none; border-color: var(--accent); }

  /* Responsive */
  @media (max-width: 900px) {
    .admin-content { padding: 16px; }
    .topbar { padding: 12px 16px; }
    .kpi-row { grid-template-columns: 1fr 1fr; }
    .tenant-table { font-size: 13px; }
    .tenant-table th, .tenant-table td { padding: 10px 10px; }
    .hide-mobile { display: none !important; }
    .drawer { width: 100vw; }
  }
  @media (max-width: 600px) {
    .kpi-row { grid-template-columns: 1fr; }
    .search-input { width: 100%; }
    .toolbar { width: 100%; }
  }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOGIN GATE ‚ïê‚ïê‚ïê -->
<div class="login-gate" id="loginGate">
  <div class="login-card">
    <div class="logo">Gestor<span>Renta</span></div>
    <div class="subtitle">Panel de Administraci√≥n</div>
    <input type="email" id="login-email" placeholder="Correo electr√≥nico" autocomplete="email" />
    <input type="password" id="login-pass" placeholder="Contrase√±a" autocomplete="current-password"
      onkeydown="if(event.key==='Enter') doAdminLogin()" />
    <button class="login-btn" onclick="doAdminLogin()" id="login-btn">Acceder</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ADMIN SHELL ‚ïê‚ïê‚ïê -->
<div class="admin-shell" id="adminShell">

  <!-- Top bar -->
  <header class="topbar">
    <div class="topbar-left">
      <div class="logo">Gestor<span>Renta</span></div>
      <div class="admin-badge">üîë Admin</div>
    </div>
    <div class="topbar-right">
      <div class="topbar-stat">
        <div class="topbar-stat-val" id="stat-total-tenants">‚Äî</div>
        <div class="topbar-stat-label">Clientes</div>
      </div>
      <div class="topbar-stat hide-mobile">
        <div class="topbar-stat-val" style="color:var(--success)" id="stat-active">‚Äî</div>
        <div class="topbar-stat-label">Activos</div>
      </div>
      <div class="topbar-stat hide-mobile">
        <div class="topbar-stat-val" style="color:var(--gold)" id="stat-mrr">‚Äî</div>
        <div class="topbar-stat-label">MRR est.</div>
      </div>
      <button class="logout-btn" onclick="doLogout()">üö™ Salir</button>
    </div>
  </header>

  <!-- Main content -->
  <div class="admin-content">

    <!-- KPI Cards -->
    <div class="kpi-row" id="kpi-row"></div>

    <!-- Tenant List -->
    <div class="section-head">
      <div class="section-title">Clientes</div>
      <div class="toolbar">
        <div class="search-wrap">
          <input class="search-input" placeholder="Buscar por nombre, email..." id="search-input" oninput="renderTenants()" />
        </div>
        <button class="filter-chip active" onclick="setFilter('all')" data-filter="all">Todos</button>
        <button class="filter-chip" onclick="setFilter('trialing')" data-filter="trialing">Trial</button>
        <button class="filter-chip" onclick="setFilter('active')" data-filter="active">Activos</button>
        <button class="filter-chip" onclick="setFilter('past_due')" data-filter="past_due">Vencidos</button>
        <button class="filter-chip" onclick="setFilter('suspended')" data-filter="suspended">Suspendidos</button>
      </div>
    </div>

    <div id="tenant-list-area">
      <div class="loading-wrap">
        <div class="spinner"></div>
        <div>Cargando clientes...</div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê DETAIL DRAWER ‚ïê‚ïê‚ïê -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div>
      <div class="drawer-title" id="drawer-title">‚Äî</div>
      <div class="drawer-subtitle" id="drawer-subtitle">‚Äî</div>
    </div>
    <button class="drawer-close" onclick="closeDrawer()">‚úï</button>
  </div>
  <div class="drawer-body" id="drawer-body"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyAzaBAZDjTPSocVdjulehwONu0cTtJVpLo",
  authDomain: "gestor-rentas.firebaseapp.com",
  projectId: "gestor-rentas",
  storageBucket: "gestor-rentas.firebasestorage.app",
  messagingSenderId: "228651565464",
  appId: "1:228651565464:web:22eb96c51104575c93abed"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMIN_UID = 'tSKcnxaw6tRJXWlcZKhiXCERKwp2';
let tenants = [];
let currentFilter = 'all';
let sortCol = 'createdAt';
let sortDir = 'desc';

// Auto-login check
auth.onAuthStateChanged(async (user) => {
  if (user && user.uid === ADMIN_UID) {
    showAdmin();
    await loadAllTenants();
  }
});

async function doAdminLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  const btn   = document.getElementById('login-btn');
  errEl.textContent = '';

  if (!email || !pass) { errEl.textContent = 'Ingresa correo y contrase√±a.'; return; }

  btn.disabled = true;
  btn.textContent = 'Verificando...';

  try {
    const cred = await auth.signInWithEmailAndPassword(email, pass);

    if (cred.user.uid !== ADMIN_UID) {
      errEl.textContent = '‚õî No tienes permisos de administrador.';
      await auth.signOut();
      btn.disabled = false;
      btn.textContent = 'Acceder';
      return;
    }

    showAdmin();
    await loadAllTenants();
  } catch(e) {
    console.error(e);
    errEl.textContent = e.code === 'auth/invalid-credential'
      ? 'Credenciales incorrectas.'
      : 'Error: ' + e.message;
    btn.disabled = false;
    btn.textContent = 'Acceder';
  }
}

function showAdmin() {
  document.getElementById('loginGate').style.display = 'none';
  document.getElementById('adminShell').classList.add('active');
}

function doLogout() {
  auth.signOut();
  document.getElementById('loginGate').style.display = '';
  document.getElementById('adminShell').classList.remove('active');
  document.getElementById('login-email').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-btn').disabled = false;
  document.getElementById('login-btn').textContent = 'Acceder';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD ALL TENANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAllTenants() {
  try {
    const snap = await db.collection('tenants').get();
    tenants = [];

    for (const doc of snap.docs) {
      const plan = doc.data();
      let data = null;
      let users = null;

      try {
        const dataSnap = await doc.ref.collection('data').doc('main').get();
        if (dataSnap.exists) data = dataSnap.data();
      } catch(e) { /* no data yet */ }

      try {
        const usersSnap = await doc.ref.collection('data').doc('users').get();
        if (usersSnap.exists) users = usersSnap.data();
      } catch(e) { /* no users */ }

      tenants.push({
        uid: doc.id,
        ...plan,
        _data: data,
        _users: users,
      });
    }

    renderKPIs();
    renderTenants();
    toast(`‚úÖ ${tenants.length} clientes cargados`);
  } catch(e) {
    console.error('Error loading tenants:', e);
    document.getElementById('tenant-list-area').innerHTML =
      `<div class="empty-state">
        <div style="font-size:48px;margin-bottom:12px">‚ö†Ô∏è</div>
        <div style="font-size:16px;font-weight:600;margin-bottom:6px">Error al cargar</div>
        <p>${e.message}</p>
        <p style="margin-top:12px;font-size:12px">Verifica que las reglas de Firestore permitan lectura de la colecci√≥n <code>tenants</code> para tu UID.</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="loadAllTenants()">üîÑ Reintentar</button>
      </div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAN PRICING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLAN_PRICES = { basico: 199, pro: 399, enterprise: 799 };
const PLAN_LABELS = { basico: 'B√°sico', pro: 'Pro', enterprise: 'Enterprise' };
const STATUS_LABELS = {
  active: 'Activo', trialing: 'Trial', past_due: 'Vencido',
  canceled: 'Cancelado', suspended: 'Suspendido'
};

function getPlanPrice(plan) { return PLAN_PRICES[plan] || 0; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER KPIs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderKPIs() {
  const total     = tenants.length;
  const active    = tenants.filter(t => t.stripeStatus === 'active').length;
  const trialing  = tenants.filter(t => t.stripeStatus === 'trialing').length;
  const pastDue   = tenants.filter(t => t.stripeStatus === 'past_due').length;
  const suspended = tenants.filter(t => ['suspended','canceled'].includes(t.stripeStatus)).length;

  const mrr = tenants
    .filter(t => ['active','trialing'].includes(t.stripeStatus))
    .reduce((s, t) => s + getPlanPrice(t.plan), 0);

  const totalProps = tenants.reduce((s, t) => {
    return s + ((t._data && t._data.rentas) ? t._data.rentas.length : 0);
  }, 0);

  const totalClients = tenants.reduce((s, t) => {
    return s + ((t._data && t._data.clientes) ? t._data.clientes.length : 0);
  }, 0);

  // Plan distribution
  const planDist = {};
  tenants.forEach(t => {
    const p = t.plan || 'sin plan';
    planDist[p] = (planDist[p] || 0) + 1;
  });

  // Trials expiring soon (next 5 days)
  const now = new Date();
  const trialExpiring = tenants.filter(t => {
    if (t.stripeStatus !== 'trialing' || !t.trialEnds) return false;
    const ends = new Date(t.trialEnds);
    const diff = (ends - now) / (1000*60*60*24);
    return diff >= 0 && diff <= 5;
  }).length;

  document.getElementById('stat-total-tenants').textContent = total;
  document.getElementById('stat-active').textContent = active + trialing;
  document.getElementById('stat-mrr').textContent = '$' + mrr.toLocaleString();

  document.getElementById('kpi-row').innerHTML = `
    <div class="kpi gold">
      <div class="kpi-label">MRR Estimado</div>
      <div class="kpi-val">$${mrr.toLocaleString()}</div>
      <div class="kpi-sub">${active} pagando ¬∑ ${trialing} en trial</div>
    </div>
    <div class="kpi green">
      <div class="kpi-label">Clientes Activos</div>
      <div class="kpi-val">${active}</div>
      <div class="kpi-sub">${Object.entries(planDist).map(([k,v]) => `${PLAN_LABELS[k]||k}: ${v}`).join(' ¬∑ ')}</div>
    </div>
    <div class="kpi blue">
      <div class="kpi-label">En Trial</div>
      <div class="kpi-val">${trialing}</div>
      <div class="kpi-sub">${trialExpiring > 0 ? `‚ö†Ô∏è ${trialExpiring} por vencer` : 'Ninguno por vencer'}</div>
    </div>
    <div class="kpi ${pastDue > 0 ? 'red' : 'amber'}">
      <div class="kpi-label">Vencidos / Suspendidos</div>
      <div class="kpi-val" style="color:${pastDue + suspended > 0 ? 'var(--danger)' : 'var(--text)'}">${pastDue + suspended}</div>
      <div class="kpi-sub">${pastDue} vencidos ¬∑ ${suspended} suspendidos</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Propiedades Totales</div>
      <div class="kpi-val">${totalProps.toLocaleString()}</div>
      <div class="kpi-sub">En ${total} cuentas</div>
    </div>
    <div class="kpi">
      <div class="kpi-label">Inquilinos Totales</div>
      <div class="kpi-val">${totalClients.toLocaleString()}</div>
      <div class="kpi-sub">Registrados en plataforma</div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER TENANT TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTenants() {
  const search = (document.getElementById('search-input').value || '').toLowerCase();
  let list = [...tenants];

  // Filter
  if (currentFilter !== 'all') {
    if (currentFilter === 'suspended') {
      list = list.filter(t => ['suspended','canceled'].includes(t.stripeStatus));
    } else {
      list = list.filter(t => t.stripeStatus === currentFilter);
    }
  }

  // Search
  if (search) {
    list = list.filter(t =>
      (t.nombre || '').toLowerCase().includes(search) ||
      (t.empresa || '').toLowerCase().includes(search) ||
      (t.email || '').toLowerCase().includes(search) ||
      (t.tel || '').includes(search) ||
      (t.uid || '').toLowerCase().includes(search)
    );
  }

  // Sort
  list.sort((a, b) => {
    let va, vb;
    switch(sortCol) {
      case 'nombre':    va = (a.nombre||'').toLowerCase(); vb = (b.nombre||'').toLowerCase(); break;
      case 'plan':      va = a.plan||''; vb = b.plan||''; break;
      case 'status':    va = a.stripeStatus||''; vb = b.stripeStatus||''; break;
      case 'props':
        va = (a._data?.rentas?.length)||0;
        vb = (b._data?.rentas?.length)||0;
        break;
      case 'createdAt':
      default:
        va = a.createdAt||''; vb = b.createdAt||''; break;
    }
    if (va < vb) return sortDir === 'asc' ? -1 : 1;
    if (va > vb) return sortDir === 'asc' ? 1 : -1;
    return 0;
  });

  if (list.length === 0) {
    document.getElementById('tenant-list-area').innerHTML =
      `<div class="empty-state">
        <div style="font-size:40px;margin-bottom:8px">üîç</div>
        <div>No se encontraron clientes</div>
      </div>`;
    return;
  }

  const rows = list.map(t => {
    const props   = t._data?.rentas?.length || 0;
    const clients = t._data?.clientes?.length || 0;
    const created = t.createdAt ? new Date(t.createdAt).toLocaleDateString('es-MX', {day:'numeric', month:'short', year:'numeric'}) : '‚Äî';

    // Trial remaining
    let trialInfo = '';
    if (t.stripeStatus === 'trialing' && t.trialEnds) {
      const days = Math.ceil((new Date(t.trialEnds) - new Date()) / (1000*60*60*24));
      trialInfo = days > 0 ? `${days}d restantes` : 'Expirado';
    }

    return `<tr onclick="openDrawer('${t.uid}')">
      <td>
        <div class="cell-name">${esc(t.nombre || 'Sin nombre')}</div>
        <div class="cell-empresa">${esc(t.empresa || '')}</div>
      </td>
      <td>
        <div class="cell-email">${esc(t.email || '‚Äî')}</div>
        <div class="cell-tel">${esc(t.tel || '')}</div>
      </td>
      <td><span class="badge plan-${t.plan || 'basico'}">${PLAN_LABELS[t.plan] || t.plan || '‚Äî'}</span></td>
      <td>
        <span class="badge status-${(t.stripeStatus||'').replace('_','')}">${STATUS_LABELS[t.stripeStatus] || t.stripeStatus || '‚Äî'}</span>
        ${trialInfo ? `<div style="font-size:11px;color:var(--text3);margin-top:3px">${trialInfo}</div>` : ''}
      </td>
      <td class="mono" style="text-align:center">${props}</td>
      <td class="mono hide-mobile" style="text-align:center">${clients}</td>
      <td class="mono hide-mobile" style="font-size:12px;color:var(--text3)">${created}</td>
      <td class="mono" style="text-align:right;color:var(--success);font-weight:600">$${getPlanPrice(t.plan).toLocaleString()}</td>
    </tr>`;
  }).join('');

  function sortHeader(col, label) {
    const isActive = sortCol === col;
    const arrow = isActive ? (sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚ñΩ';
    return `<th class="${isActive ? 'sorted' : ''}" onclick="toggleSort('${col}')">${label} <span class="sort-arrow">${arrow}</span></th>`;
  }

  document.getElementById('tenant-list-area').innerHTML = `
    <div class="table-wrap">
      <div style="overflow-x:auto">
        <table class="tenant-table">
          <thead>
            <tr>
              ${sortHeader('nombre', 'Cliente')}
              <th>Contacto</th>
              ${sortHeader('plan', 'Plan')}
              ${sortHeader('status', 'Estado')}
              ${sortHeader('props', 'Props')}
              <th class="hide-mobile">Inquilinos</th>
              ${sortHeader('createdAt', 'Registro')}
              <th style="text-align:right">$/mes</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>
    <div style="margin-top:12px;font-size:12px;color:var(--text3);text-align:right">
      Mostrando ${list.length} de ${tenants.length} clientes
    </div>`;
}

function toggleSort(col) {
  if (sortCol === col) {
    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    sortCol = col;
    sortDir = col === 'createdAt' ? 'desc' : 'asc';
  }
  renderTenants();
}

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-chip').forEach(el => {
    el.classList.toggle('active', el.dataset.filter === f);
  });
  renderTenants();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL DRAWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDrawer(uid) {
  const t = tenants.find(x => x.uid === uid);
  if (!t) return;

  document.getElementById('drawer-title').textContent = t.nombre || 'Sin nombre';
  document.getElementById('drawer-subtitle').innerHTML =
    `${esc(t.email || '')} ${t.tel ? '¬∑ ' + esc(t.tel) : ''}<br>
     <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text3)">UID: ${t.uid}</span>`;

  const props    = t._data?.rentas || [];
  const clientes = t._data?.clientes || [];
  const users    = t._users?.list || [];

  // Calculate tenant-level metrics
  const totalRenta = props.reduce((s, r) => s + Number(r.monto || 0), 0);
  const rentadas   = props.filter(r => r.clienteId && r.clienteId !== '').length;
  const vacias     = props.length - rentadas;
  const ocupacion  = props.length > 0 ? Math.round(rentadas / props.length * 100) : 0;

  // Payment stats
  const hoy = new Date();
  const mesActual = hoy.getFullYear() + '-' + String(hoy.getMonth()+1).padStart(2,'0');
  let cobradoMes = 0;
  let totalAdeudo = 0;
  props.forEach(r => {
    if (!r.clienteId) return;
    const abonos = r.abonos || [];
    cobradoMes += abonos.filter(a => a.mes === mesActual).reduce((s,a) => s + Number(a.monto), 0);
    const totalPagado = abonos.reduce((s,a) => s + Number(a.monto), 0);
    // Simple adeudo: based on months since inicio
    // (simplified version - main app has more complex logic)
    const monto = Number(r.monto || 0);
    if (monto > 0 && r.clienteId) {
      const inicio = r.inicio || r.createdAt || hoy.toISOString().slice(0,10);
      const inicioDate = new Date(inicio);
      let months = (hoy.getFullYear() - inicioDate.getFullYear()) * 12 + (hoy.getMonth() - inicioDate.getMonth());
      if (hoy.getDate() >= (Number(r.dia) || 1) + 6) months++;
      const esperado = Math.max(0, months) * monto;
      totalAdeudo += Math.max(0, esperado - totalPagado);
    }
  });

  // Trial info
  let trialHTML = '';
  if (t.stripeStatus === 'trialing' && t.trialEnds) {
    const ends = new Date(t.trialEnds);
    const days = Math.ceil((ends - hoy) / (1000*60*60*24));
    trialHTML = `
      <div class="info-box full" style="background:${days <= 3 ? 'var(--danger-light)' : '#e8f4fd'};border-color:${days <= 3 ? 'rgba(192,57,43,0.2)' : 'rgba(29,111,164,0.2)'}">
        <div class="info-val sm" style="color:${days <= 3 ? 'var(--danger)' : '#1d6fa4'}">
          ${days > 0 ? days + ' d√≠as restantes' : '‚ö†Ô∏è Trial expirado'}
        </div>
        <div class="info-label">Trial vence: ${ends.toLocaleDateString('es-MX', {day:'numeric', month:'long', year:'numeric'})}</div>
      </div>`;
  }

  // Property type breakdown
  const tipoBreakdown = {};
  props.forEach(r => {
    const tipo = r.tipo || 'Otro';
    tipoBreakdown[tipo] = (tipoBreakdown[tipo] || 0) + 1;
  });

  const created = t.createdAt ? new Date(t.createdAt).toLocaleDateString('es-MX', {day:'numeric', month:'long', year:'numeric'}) : '‚Äî';

  document.getElementById('drawer-body').innerHTML = `
    <!-- Plan & Status -->
    <div class="drawer-section">
      <div class="drawer-section-title">Plan y Estado</div>
      <div class="info-grid">
        <div class="info-box">
          <div class="info-val sm">${PLAN_LABELS[t.plan] || t.plan || '‚Äî'}</div>
          <div class="info-label">Plan actual</div>
        </div>
        <div class="info-box">
          <div class="info-val sm">$${getPlanPrice(t.plan).toLocaleString()}/mes</div>
          <div class="info-label">Precio</div>
        </div>
        <div class="info-box">
          <span class="badge status-${(t.stripeStatus||'').replace('_','')}" style="font-size:12px;padding:5px 14px">${STATUS_LABELS[t.stripeStatus] || t.stripeStatus || '‚Äî'}</span>
          <div class="info-label" style="margin-top:6px">Estado de suscripci√≥n</div>
        </div>
        <div class="info-box">
          <div class="info-val sm">${created}</div>
          <div class="info-label">Fecha de registro</div>
        </div>
        ${trialHTML}
      </div>

      <!-- Status Actions -->
      <div class="drawer-actions" style="margin-top:14px">
        <select class="status-select" id="drawer-status-select" onchange="updateTenantStatus('${t.uid}', this.value)">
          <option value="" disabled selected>Cambiar estado...</option>
          <option value="active" ${t.stripeStatus==='active'?'disabled':''}>‚úÖ Marcar Activo</option>
          <option value="trialing" ${t.stripeStatus==='trialing'?'disabled':''}>üîµ Marcar Trial</option>
          <option value="past_due" ${t.stripeStatus==='past_due'?'disabled':''}>üü° Marcar Vencido</option>
          <option value="suspended" ${t.stripeStatus==='suspended'?'disabled':''}>‚õî Suspender</option>
          <option value="canceled">üóëÔ∏è Cancelar</option>
        </select>
        <select class="status-select" id="drawer-plan-select" onchange="updateTenantPlan('${t.uid}', this.value)">
          <option value="" disabled selected>Cambiar plan...</option>
          <option value="basico" ${t.plan==='basico'?'disabled':''}>B√°sico ($199)</option>
          <option value="pro" ${t.plan==='pro'?'disabled':''}>Pro ($399)</option>
          <option value="enterprise" ${t.plan==='enterprise'?'disabled':''}>Enterprise ($799)</option>
        </select>
      </div>
    </div>

    <!-- Usage Metrics -->
    <div class="drawer-section">
      <div class="drawer-section-title">Uso de la Plataforma</div>
      <div class="info-grid">
        <div class="info-box">
          <div class="info-val" style="color:var(--accent)">${props.length}</div>
          <div class="info-label">Propiedades</div>
        </div>
        <div class="info-box">
          <div class="info-val">${clientes.length}</div>
          <div class="info-label">Inquilinos</div>
        </div>
        <div class="info-box">
          <div class="info-val ${rentadas > 0 ? 'success' : ''}">${rentadas}</div>
          <div class="info-label">Rentadas (${ocupacion}%)</div>
        </div>
        <div class="info-box">
          <div class="info-val ${vacias > 0 ? 'warning' : ''}">${vacias}</div>
          <div class="info-label">Vac√≠as</div>
        </div>
        <div class="info-box">
          <div class="info-val success">$${cobradoMes.toLocaleString()}</div>
          <div class="info-label">Cobrado este mes</div>
        </div>
        <div class="info-box">
          <div class="info-val ${totalAdeudo > 0 ? 'danger' : ''}">${totalAdeudo > 0 ? '$'+totalAdeudo.toLocaleString() : '$0'}</div>
          <div class="info-label">Adeudo total</div>
        </div>
        <div class="info-box full">
          <div class="info-val sm">$${totalRenta.toLocaleString()}/mes</div>
          <div class="info-label">Renta mensual potencial (${props.length} propiedades)</div>
        </div>
      </div>

      ${Object.keys(tipoBreakdown).length > 0 ? `
      <div style="margin-top:12px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:8px">Tipos de propiedad</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          ${Object.entries(tipoBreakdown).sort((a,b) => b[1]-a[1]).map(([tipo, count]) =>
            `<span style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:12px;color:var(--text2)">${tipo} <strong>${count}</strong></span>`
          ).join('')}
        </div>
      </div>` : ''}
    </div>

    <!-- Users -->
    <div class="drawer-section">
      <div class="drawer-section-title">Usuarios (${users.length})</div>
      ${users.length === 0 ? '<div style="font-size:13px;color:var(--text3)">Sin usuarios registrados</div>' :
        users.map(u => `
          <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
            <div style="width:32px;height:32px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0">
              ${(u.nombre||'?').split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;font-size:13px">${esc(u.nombre || '‚Äî')}</div>
              <div style="font-size:11px;color:var(--text3)">${u.role === 'titular' ? 'üëë Titular' : 'üë§ Usuario'} ¬∑ ${esc(u.username || '')}</div>
            </div>
          </div>
        `).join('')}
    </div>

    <!-- Admin Notes -->
    <div class="drawer-section">
      <div class="drawer-section-title">Notas de Admin</div>
      <textarea class="notes-area" id="drawer-notes" placeholder="Escribe notas internas sobre este cliente..."
        onblur="saveNotes('${t.uid}')">${esc(t.adminNotes || '')}</textarea>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">Se guarda autom√°ticamente al salir del campo</div>
    </div>

    <!-- Danger Zone -->
    <div class="drawer-section">
      <div class="drawer-section-title" style="color:var(--danger)">Zona de Riesgo</div>
      <div style="background:var(--danger-light);border:1px solid rgba(192,57,43,0.2);border-radius:10px;padding:14px">
        <div style="font-size:13px;color:var(--danger);margin-bottom:10px">Estas acciones no se pueden deshacer f√°cilmente.</div>
        <div class="drawer-actions">
          <button class="btn btn-danger" onclick="extendTrial('${t.uid}')">‚è∞ Extender Trial +15 d√≠as</button>
          <button class="btn btn-danger" onclick="if(confirm('¬øSeguro que quieres suspender a ${esc(t.nombre)}?')) updateTenantStatus('${t.uid}','suspended')">‚õî Suspender cuenta</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('drawerOverlay').classList.add('open');
  document.getElementById('drawer').classList.add('open');
}

function closeDrawer() {
  document.getElementById('drawerOverlay').classList.remove('open');
  document.getElementById('drawer').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updateTenantStatus(uid, status) {
  if (!status) return;
  try {
    await db.collection('tenants').doc(uid).update({ stripeStatus: status });
    const t = tenants.find(x => x.uid === uid);
    if (t) t.stripeStatus = status;
    renderKPIs();
    renderTenants();
    toast(`‚úÖ Estado cambiado a "${STATUS_LABELS[status] || status}"`);
    // Re-open drawer to refresh
    openDrawer(uid);
  } catch(e) {
    toast('‚ùå Error: ' + e.message);
  }
}

async function updateTenantPlan(uid, plan) {
  if (!plan) return;
  try {
    await db.collection('tenants').doc(uid).update({ plan });
    const t = tenants.find(x => x.uid === uid);
    if (t) t.plan = plan;
    renderKPIs();
    renderTenants();
    toast(`‚úÖ Plan cambiado a "${PLAN_LABELS[plan]}"`);
    openDrawer(uid);
  } catch(e) {
    toast('‚ùå Error: ' + e.message);
  }
}

async function extendTrial(uid) {
  try {
    const newEnd = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString();
    await db.collection('tenants').doc(uid).update({
      stripeStatus: 'trialing',
      trialEnds: newEnd
    });
    const t = tenants.find(x => x.uid === uid);
    if (t) { t.stripeStatus = 'trialing'; t.trialEnds = newEnd; }
    renderKPIs();
    renderTenants();
    toast('‚úÖ Trial extendido +15 d√≠as');
    openDrawer(uid);
  } catch(e) {
    toast('‚ùå Error: ' + e.message);
  }
}

async function saveNotes(uid) {
  const notes = document.getElementById('drawer-notes')?.value || '';
  try {
    await db.collection('tenants').doc(uid).update({ adminNotes: notes });
    const t = tenants.find(x => x.uid === uid);
    if (t) t.adminNotes = notes;
    toast('üíæ Notas guardadas');
  } catch(e) {
    toast('‚ùå Error guardando notas');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

// Keyboard shortcut: Escape to close drawer
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDrawer();
});
</script>

</body>
</html>
